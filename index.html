<?php
// index.php
// This PHP file serves as the wrapper for the single-page application (SPA).
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP (Cyber Social Platform)</title>

<link rel="icon" type="image/x-icon" href="https://your-domain.com/favicon.ico">Â 
<link rel="apple-touch-icon" href="https://your-domain.com/apple-touch-icon.png">

<meta property="og:title" content="DUO UP: Find Your Next Cyber Social Partner">
<meta property="og:description" content="The ultimate platform for cyber warriors to connect, build duos, and dominate the digital landscape.">
<meta property="og:image" content="https://your-domain.com/duo-up-thumbnail.png">
<meta property="og:url" content="https://your-domain.com/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@YourTwitterHandle">
<meta name="twitter:title" content="DUO UP: Cyber Social Platform">
<meta name="twitter:description" content="Connect, duo up, and conquer. Find your next teammate today.">
<meta name="twitter:image" content="https://your-domain.com/duo-up-thumbnail.png">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
<style>
/* --- Base styles --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none !important; }
/* Header */
.header { background:#111; border-bottom:3px solid cyan; box-shadow:0 0 20px rgba(0,255,255,0.5); padding:10px 0; margin-bottom:20px; display:flex; align-items:center; justify-content:center; }
.header h1 { font-size:2.5em; color:#fff; text-shadow:0 0 5px cyan,0 0 10px cyan,0 0 15px magenta; margin:0; }
/* Icon Container for Lightning Bolt */
.icon-container { margin-right:15px; font-size:2.5em; color:yellow; text-shadow:0 0 5px yellow,0 0 10px orange; }
/* Buttons */
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; transition:all 0.2s ease-in-out; text-transform:uppercase; font-family:'Orbitron',sans-serif; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; transform: translateY(-1px); }
.neon-btn:disabled { border-color:#555; box-shadow:none; color:#555; cursor:not-allowed; }
.neon-btn.add { border-color:lime; box-shadow:0 0 10px lime; }
.neon-btn.add:hover { border-color:green; box-shadow:0 0 15px green; }
.neon-btn.remove { border-color:red; box-shadow:0 0 10px red; }
.neon-btn.remove:hover { border-color:orange; box-shadow:0 0 15px orange; }
.neon-btn.pending { border-color:yellow; box-shadow:0 0 10px yellow; color:yellow; cursor:default; }
/* Input fields */
input[type="text"], input[type="number"], textarea, select { flex-grow:1; padding:10px; border:1px solid cyan; background:#181818; color:white; border-radius:6px; font-family:inherit; outline:none; transition:border-color 0.2s, box-shadow 0.2s; }
input:focus, textarea:focus, select:focus { border-color: magenta; box-shadow: 0 0 8px magenta; }
textarea { resize: vertical; }
/* Cards */
.card-container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; padding-top: 10px; }
.card { width: 100%; max-width:300px; padding:20px; border:3px solid transparent; border-radius:8px; background:#181818; box-shadow:0 0 15px rgba(0,255,255,0.4), inset 0 0 5px rgba(0,255,255,0.2); border-image-source: linear-gradient(45deg, cyan, magenta, cyan); border-image-slice:1; display:flex; flex-direction:column; align-items:center; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s; }
.card:hover { transform: translateY(-5px); box-shadow:0 0 30px magenta, inset 0 0 10px rgba(255,0,255,0.5); }
.request-card { cursor:default; border:3px solid orange; box-shadow:0 0 15px orange; }
.request-card:hover { transform:none; box-shadow:0 0 15px orange; }

.card-content-box { display:flex; flex-direction:column; align-items:center; width:100%; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #333; }
.avatar { width:80px; height:80px; border-radius:50%; border:4px solid magenta; object-fit:cover; margin-bottom:15px; }
.skill-rating { color:gold; font-size:1.4em; margin-bottom:10px; }

/* Game Category (formerly Discipline) styling */
.game-category { font-size:0.9em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:5px; text-transform:uppercase; color:#0b0b0b; }
.game-category-leagueoflegends { background-color:#0077B6; color:white; }
.game-category-fortnite { background-color:#5a189a; color:white; }
.game-category-valorant { background-color:#FF4655; color:white; }
.game-category-cybersecurity { background-color:lime; color:#0b0b0b; }
.game-category-other { background-color:gray; color:white; }

/* Game Role styling */
.game-role { font-size:0.8em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:5px; text-transform:uppercase; background-color:cyan; color:#0b0b0b;}

/* Looking For Category styling */
.lfd-category { font-size:0.8em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:10px; text-transform:uppercase; background-color:#ff00ff; color:white; border:1px solid white;}


.status-indicator { font-size:0.9em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:10px; text-transform:uppercase; }
.status-online { background-color:#00cc00; color:#0b0b0b; box-shadow:0 0 5px #00ff00; }
.status-ingame { background-color:#ffaa00; color:#0b0b0b; box-shadow:0 0 5px #ffaa00; }
.status-lfd { background-color:#ff00ff; color:white; box-shadow:0 0 5px #ff00ff; border:1px solid #ff00ff; }

/* Co-Founder Badge Style */
.nickname-group { display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
.co-founder-badge {Â 
Â  Â  background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);Â 
Â  Â  color: #333;Â 
Â  Â  font-size: 0.75em;Â 
Â  Â  padding: 2px 8px;Â 
Â  Â  border-radius: 4px;Â 
Â  Â  font-weight: bold;
Â  Â  text-transform: uppercase;
Â  Â  margin-left: 8px; /* Spacing next to nickname */
Â  Â  box-shadow: 0 0 5px #FFD700;
}
/* Nav */
#navigationBar { display:flex; justify-content:center; flex-wrap:wrap; padding:10px; background:#151515; border-radius:8px; margin-bottom:30px; border:1px solid #333; }
#searchControls { display:flex; gap:15px; margin-bottom:20px; align-items:center; flex-wrap:wrap; background:#1a1a1a; padding:15px; border-radius:8px; border:1px solid #004444; }
/* Messaging */
#messagingTab { display:flex; gap:20px; height:75vh; }
#chatList { width:300px; padding:15px; border:2px solid cyan; border-radius:8px; background:#1a1a1a; overflow-y:auto; }
#activeDuoList { margin-top:10px; }
.chat-entry { padding:10px; border-bottom:1px dashed #333; cursor:pointer; transition: background 0.2s; }
.chat-entry:hover { background:#2a2a2a; }
.chat-entry.active { background:#004444; border-left:5px solid lime; font-weight:bold; }
#chatWindow { flex-grow:1; display:flex; flex-direction:column; border:2px solid magenta; border-radius:8px; background:#1a1a1a; }
#chatHeader { padding:10px; border-bottom:2px solid magenta; margin:0; background:#330033; }
#messageDisplay { flex-grow:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
/* Message Bubbles - Styling the chat */
.message { max-width:70%; padding:10px 15px; border-radius:18px; font-size:0.95em; position:relative; }
.message span { display:block; font-size:0.7em; opacity:0.6; text-align:right; margin-top:3px; }
.message.sent {Â 
Â  Â  background:#005555;Â 
Â  Â  align-self:flex-end;Â 
Â  Â  border-bottom-right-radius:5px;
Â  Â  box-shadow: 0 0 5px #00ffff;
}
.message.received {Â 
Â  Â  background:#333333;Â 
Â  Â  align-self:flex-start;Â 
Â  Â  border-bottom-left-radius:5px;
Â  Â  box-shadow: 0 0 5px #ff00ff;
}
#messageInputArea { padding:10px; border-top:2px solid magenta; background:#0b0b0b; display:flex; gap:10px; }
/* Profile view */
#viewProfileTab { display:none; }
/* Refined Profile Content Style */
#viewProfileContent { padding:30px; border:3px solid magenta; border-radius:12px; background:#1a1a1a; margin-top:20px; display:flex; flex-direction:column; align-items:center; }
.profile-stat { width:100%; max-width:400px; display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #333; margin-bottom:5px; }
.profile-stat span:first-child { color: cyan; font-weight:bold; }
.profile-stat span:last-child { text-align:right; }
</style>
</head>
<body>
<div class="header"><div class="icon-container">âš¡</div><h1>DUO UP (Cyber Social Platform)</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Log in to connect and find your next cyber-duo.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>
<div id="navigationBar">
<button class="neon-btn" id="tab-suggested" onclick="showTab('allUsers')">Suggested</button>
<button class="neon-btn" id="tab-search" onclick="showTab('search')">Find Players</button>
<button class="neon-btn" id="tab-duos" onclick="showTab('friends')">Duos</button>
<button class="neon-btn" id="tab-messaging" onclick="showTab('messaging')">Messaging</button>
<button class="neon-btn" id="tab-profile" onclick="showTab('profile')">Profile</button>
<button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="allUsersTab" class="card-container"></div>

<div id="searchTab" class="hidden container">
<h2>Player Search Filter</h2>
<div id="searchControls">
<input type="text" id="searchInput" placeholder="Search by Nickname or Bio..." onkeyup="filterSearchResults()">
<label style="color:cyan; margin-left:15px;">Status:</label>
<select id="statusFilter" onchange="filterSearchResults()">
<option value="">Any Status</option>
<option value="Online">Online</option>
<option value="In Game">In Game</option>
<option value="LFD">Looking For Duo (LFD)</option>
</select>
<label style="color:cyan; margin-left:15px;">Game/Category:</label>
<select id="gameCategoryFilter" onchange="filterSearchResults()">
<option value="">Any Game/Category</option>
<option value="LeagueOfLegends">League of Legends</option>
<option value="Fortnite">Fortnite</option>
<option value="Valorant">Valorant</option>
<option value="CyberSecurity">Cyber Security</option>
<option value="Other">Other</option>
</select>
<label style="color:cyan; margin-left:15px;">Game Role/Mode:</label>
<select id="gameRoleFilter" onchange="filterSearchResults()">
<option value="">Any Role/Mode</option>
<option value="TopTank">Top Tank (LoL)</option>
<option value="JungleCarry">Jungle Carry (LoL)</option>
<option value="Duo">Duo (Fortnite/Valorant)</option>
<option value="Squad">Squad (Fortnite)</option>
<option value="Support">Support (LoL/Valorant)</option>
<option value="ExploitDev">Exploit Dev (Cyber)</option>
<option value="RedTeamOp">Red Team Op (Cyber)</option>
</select>
<label style="color:cyan; margin-left:15px;">Looking For:</label>
<select id="lfdCategoryFilter" onchange="filterSearchResults()">
<option value="">Any LFD Type</option>
<option value="Duo">Duo (2-person team)</option>
<option value="Squad">Squad (3+ person team)</option>
<option value="Team">Full Team (Permanent)</option>
<option value="Mentor">Mentor/Mentee</option>
</select>
</div>
<div id="searchResults" class="card-container"></div>
</div>

<div id="friendsTab" class="container hidden">
<h2>Incoming Friend Requests</h2>
<div id="pendingRequestsList" class="card-container"></div>
<h2 style="margin-top:40px;">Your Accepted Duos</h2>
<div id="friendList" class="card-container">
Â  Â  <p style="width:100%; text-align:center; color:magenta;">
Â  Â  Load accepted duos here.
Â  Â  </p>
</div>
</div>

<div id="messagingTab" class="hidden">
<div id="chatList">
<h3>Active Duos</h3>
<div id="activeDuoList">No Duos yet.</div>
</div>
<div id="chatWindow">
<h3 id="chatHeader">Select a Duo to start messaging</h3>
<div id="messageDisplay"></div>
<div id="messageInputArea" class.hidden">
<input type="text" id="messageInput" placeholder="Type your message..." onkeyup="if(event.key==='Enter') sendMessage()">
<button class="neon-btn" id="sendMessageBtn" onclick="sendMessage()">Send</button>
</div>
</div>
</div>

<div id="viewProfileTab" class="hidden container">
<button class="neon-btn" onclick="showTab('allUsers')">â† Back to Suggested</button>
<div id="viewProfileContent"></div>
</div>

<div id="profileTab" class="hidden container">
<h2>Gamer-Profile Editor</h2>
<div style="padding:20px; border:2px solid magenta; border-radius:10px; background:#1a1a1a;">
<div style="display:flex; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
Â  Â  <div style="margin-right:20px; display:flex; flex-direction:column; align-items:center;">
Â  Â  Â  Â  <img id="profileAvatar" class="avatar" src="" style="width:100px;height:100px;border-color:cyan;">
Â  Â  Â  Â  <p style="font-size:0.8em; margin:5px 0 0 0;">Upload New:</p>
Â  Â  Â  Â  <input type="file" id="avatarFile" accept="image/*" style="width:150px; font-size:0.8em; border:none;" onchange="previewAvatar(event)">
Â  Â  </div>
Â  Â  <div style="flex-grow:1; min-width:200px;">
Â  Â  Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">Unique Identifier:</label>
Â  Â  Â  Â  <input type="text" id="profileNickname" value="User Nickname" placeholder="Your Unique Nickname">
Â  Â  Â  Â  <p id="nicknameChangeInfo" style="color:yellow; font-size:0.8em; margin:5px 0 0 0;">(You get one free nickname change.)</p>
Â  Â  </div>
</div>
<div style="margin-bottom:15px;">
<label style="color: cyan; display:block; margin-bottom:5px;">Bio/Tagline:</label>
<textarea id="profileBio" rows="3" style="width:100%;"></textarea>
</div>
<div style="display:flex; gap:30px; margin-bottom:20px; flex-wrap:wrap;">
<div>
Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">Skill Rating (1-5):</label>
Â  Â  <input id="profileSkillRating" type="number" min="1" max="5">
</div>
<div>
Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">Primary Game/Category:</label>
Â  Â  <select id="profileGameCategory">
Â  Â  Â  Â  <option value="LeagueOfLegends">League of Legends</option>
Â  Â  Â  Â  <option value="Fortnite">Fortnite</option>
Â  Â  Â  Â  <option value="Valorant">Valorant</option>
Â  Â  Â  Â  <option value="CyberSecurity">Cyber Security</option>
Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  </select>
</div>
</div>
<div style="display:flex; gap:30px; margin-bottom:20px; flex-wrap:wrap;">
Â  Â  <div>
Â  Â  Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">Game Role/Mode:</label>
Â  Â  Â  Â  <select id="profileGameRole">
Â  Â  Â  Â  Â  Â  <option value="TopTank">Top Tank (LoL)</option>
Â  Â  Â  Â  Â  Â  <option value="JungleCarry">Jungle Carry (LoL)</option>
Â  Â  Â  Â  Â  Â  <option value="Duo">Duo (Fortnite/Valorant)</option>
Â  Â  Â  Â  Â  Â  <option value="Squad">Squad (Fortnite)</option>
Â  Â  Â  Â  Â  Â  <option value="Support">Support (LoL/Valorant)</option>
Â  Â  Â  Â  Â  Â  <option value="ExploitDev">Exploit Dev (Cyber)</option>
Â  Â  Â  Â  Â  Â  <option value="RedTeamOp">Red Team Op (Cyber)</option>
Â  Â  Â  Â  Â  Â  <option value="Generalist">Generalist/Flex</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div>
Â  Â  Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">Current Status:</label>
Â  Â  Â  Â  <select id="profileStatus" onchange="toggleLfdCategory()">
Â  Â  Â  Â  Â  Â  <option value="Online">Online</option>
Â  Â  Â  Â  Â  Â  <option value="In Game">In Game</option>
Â  Â  Â  Â  Â  Â  <option value="LFD">Looking For Duo (LFD)</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div id="lfdCategoryGroup" class="hidden">
Â  Â  Â  Â  <label style="color: cyan; display:block; margin-bottom:5px;">LFD Goal:</label>
Â  Â  Â  Â  <select id="profileLfdCategory">
Â  Â  Â  Â  Â  Â  <option value="Duo">Duo (2-person team)</option>
Â  Â  Â  Â  Â  Â  <option value="Squad">Squad (3+ person team)</option>
Â  Â  Â  Â  Â  Â  <option value="Team">Full Team (Permanent)</option>
Â  Â  Â  Â  Â  Â  <option value="Mentor">Mentor/Mentee</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
</div>
<button class="neon-btn" style="border-color:#00ff00; box-shadow:0 0 10px #00ff00;" onclick="saveProfile()">Save Profile</button>
<p id="saveMessage" style="color:#00ff00; margin-top:10px;"></p>
</div>
</div>

<script>
// ----------------------------------------------------
// 0. GLOBAL VARS (Initialized in initFirebase)
// ----------------------------------------------------
let auth;
let db;
let storage;

let currentUser = null;
let currentProfileData = {};
let allUsersCache = [];
let requestCache = {};
let currentChatId = null;
let chatListener = null;

const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

// ---------------------------
// Firebase Configuration (REPLACE THESE PLACEHOLDERS!)
// ---------------------------
const firebaseConfig = {
Â  Â  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
Â  Â  authDomain:"duoup-cfae6.firebaseapp.com",
Â  Â  projectId:"duoup-cfae6",
Â  Â  storageBucket:"duoup-cfae6.firebasestorage.app",
Â  Â  messagingSenderId:"812263060524",
Â  Â  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};

// ----------------------------------------------------
// ğŸŒŸ CO-FOUNDER / BADGE LOGICÂ 
// ----------------------------------------------------
const CO_FOUNDER_UIDS = [
Â  Â  "GmH4xJp92vY8sbwIWgJWjFw9MOQ2", // UID provided by user
];

function getCoFounderBadge(uid) {
Â  Â  if (CO_FOUNDER_UIDS.includes(uid)) {
Â  Â  Â  Â  return '<div class="co-founder-badge">Co-Founder / Developer</div>';
Â  Â  }
Â  Â  return '';
}
// ----------------------------------------------------


// ----------------------------------------------------
// 1. INITIALIZATION & AUTHENTICATION ENTRY POINT (FIXED)
// ----------------------------------------------------
function initFirebase() {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();

    // Listener is the main entry point to ensure user is ready
    auth.onAuthStateChanged(user => {
        currentUser = user;
        
        // Hide/Show main application sections
        const loginPage = document.getElementById('loginPage');
        const dashboard = document.getElementById('dashboard');
        
        if (currentUser) {
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
            document.getElementById('welcome').textContent = `Welcome, ${currentUser.displayName || 'Cyber Warrior'}!`;
            
            // CRITICAL: Initialize the dashboard view *after* authentication is confirmed
            showTab('allUsers'); 
            
            // In case user profile is not fully created, ensure it exists or redirect to profile setup
            // (You would add a check for the user's profile document existence here)

        } else {
            loginPage.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }
    });
}

// ---------------------------
// Utility Functions
function getChatId(otherUid) {
Â  Â  // Standardized Chat ID format: UID1_UID2 (alphabetically sorted)
Â  Â  return [currentUser.uid, otherUid].sort().join('_');
}

function findUserInCache(uid) {
Â  Â  return allUsersCache.find(user => user.id === uid);
}

// ---------------------------
// Authentication
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function logout(){ 
    if(chatListener) chatListener(); 
    auth.signOut(); 
}

// ---------------------------
// Profile Editor Helper
function toggleLfdCategory() {
Â  Â  const status = document.getElementById('profileStatus').value;
Â  Â  const group = document.getElementById('lfdCategoryGroup');
Â  Â  if (status === 'LFD') {
Â  Â  Â  Â  group.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  Â  group.classList.add('hidden');
Â  Â  }
}

// ---------------------------
// Tab switching
function showTab(tab){
Â  Â  document.querySelectorAll('#allUsersTab,#searchTab,#friendsTab,#messagingTab,#profileTab,#viewProfileTab').forEach(e=>e.classList.add('hidden'));

    // Reset Chat Listener if not navigating to messaging
Â  Â  if(tab!=='messaging' && chatListener){
Â  Â  Â  Â  chatListener();
Â  Â  Â  Â  chatListener=null;
Â  Â  Â  Â  currentChatId=null;
Â  Â  Â  Â  document.getElementById('messageDisplay').innerHTML = '';
Â  Â  Â  Â  document.getElementById('chatHeader').textContent = 'Select a Duo to start messaging';
Â  Â  Â  Â  document.getElementById('messageInputArea').classList.add('hidden');
Â  Â  }

    // Highlight active navigation button
    document.querySelectorAll('#navigationBar button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tab)?.classList.add('active');


Â  Â  switch(tab){
Â  Â  Â  Â  case 'allUsers': loadAllUsers(); break;
Â  Â  Â  Â  case 'search': filterSearchResults(); break;
Â  Â  Â  Â  case 'friends': loadFriends(); break;
Â  Â  Â  Â  case 'messaging': loadChatList(); break;
Â  Â  Â  Â  case 'profile': loadUserProfile(); toggleLfdCategory(); break; // Initialize LFD selector visibility
Â  Â  Â  Â  default: break;
Â  Â  }
    // Ensure the tab element exists before trying to remove 'hidden'
Â  Â  document.getElementById(tab+'Tab')?.classList.remove('hidden'); 
}

// ---------------------------
// Load Users and Rendering
async function loadAllUsers(){
Â  Â  if(!currentUser) return;
Â  Â  const container=document.getElementById('allUsersTab');
Â  Â  container.innerHTML="<h3>Loading Suggested Players...</h3>";
    
    // Check for user document existence (for new users)
    const userDocRef = db.collection('users').doc(currentUser.uid);
    const userDoc = await userDocRef.get();
    if (!userDoc.exists) {
        // Redirect new users to profile creation
        await userDocRef.set({
            nickname: currentUser.displayName || 'New Cyber Warrior',
            profileImageUrl: currentUser.photoURL || DEFAULT_AVATAR,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'Online',
            bio: 'Ready to connect!',
            skillRating: 3
        });
        showTab('profile');
        return;
    }


Â  Â  try{
Â  Â  Â  Â  // 1. Load ALL users (this is the query that was failing)
Â  Â  Â  Â  const snapshot=await db.collection('users').get();
Â  Â  Â  Â  allUsersCache=snapshot.docs.map(d=>({id:d.id,...d.data()}));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Load all friend requests involving the current user
Â  Â  Â  Â  // NOTE: The Security Rules must allow this query (which they do, using array-contains).
Â  Â  Â  Â  const requestsSnap = await db.collection('friendRequests') // Corrected collection name if 'requests' was a typo
Â  Â  Â  Â  Â  Â  .where(firebase.firestore.FieldPath.documentId(), 'array-contains', currentUser.uid) // Assuming friendRequests ID is UID1_UID2
Â  Â  Â  Â  Â  Â  .get();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  // Rebuild requestCache
Â  Â  Â  Â  requestCache = {};
Â  Â  Â  Â  requestsSnap.forEach(doc => {
Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  // Determine the UID of the *other* user in this request
Â  Â  Â  Â  Â  Â  // If you used the canonical ID (UID1_UID2), parsing is cleaner.
            const participantUids = doc.id.split('_');
            const otherUid = participantUids.find(uid => uid !== currentUser.uid);

            if (otherUid) {
                requestCache[otherUid] = {Â 
                    id: doc.id,Â 
                    status: data.status,Â 
                    senderId: data.senderId,
                    receiverId: data.receiverId
                };
            }
Â  Â  Â  Â  });

Â  Â  Â  Â  container.innerHTML="";Â 

Â  Â  Â  Â  allUsersCache.forEach(user=>{
Â  Â  Â  Â  Â  Â  if(user.id===currentUser.uid) return;
Â  Â  Â  Â  Â  Â  const card=renderUserCard(user.id, user, requestCache[user.id]);
Â  Â  Â  Â  Â  Â  if(card) container.appendChild(card);
Â  Â  Â  Â  });

Â  Â  }catch(e){ 
        // If this error still appears, the deployed rules are WRONG or AUTH failed.
        container.innerHTML=`<p style="width:100%; text-align:center; color:red;">
            ACCESS DENIED [UID: ${currentUser?.uid || 'NONE'}] - 
            Error loading users: ${e.message}</p>
            <p style="width:100%; text-align:center; color:yellow;">
            Action Required: Confirm user is signed in AND Firestore Rules for /users are 'allow read: if isSignedIn();'.
            </p>`; 
    }
}

function renderUserCard(uid, data, requestInfo){
Â  Â  if(!data) return null;
Â  Â  const card=document.createElement('div');
Â  Â  card.className='card';
Â  Â  card.onclick=()=>viewProfile(uid, data);
Â  Â  const statusClass=(data.status||'Online').replace(/\s/g,'').toLowerCase();
Â  Â  const badge = getCoFounderBadge(uid);
Â  Â Â 
Â  Â  // NEW FIELDS
Â  Â  const gameCategory = data.gameCategory || 'Other';
Â  Â  const gameCategoryClass = `game-category-${gameCategory.toLowerCase().replace(/\s/g, '')}`;
Â  Â  const gameRole = data.gameRole || 'Generalist';
Â  Â  const lfdCategory = data.lfdCategory || null;Â 

Â  Â  let cardButtons;
Â  Â Â 
Â  Â  // Logic to determine the correct button based on request status
Â  Â  if (requestInfo) {
Â  Â  Â  Â  if (requestInfo.status === 'pending') {
Â  Â  Â  Â  Â  Â  if (requestInfo.senderId === currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  cardButtons = `<button class="neon-btn pending" disabled>Pending (Waiting for reply)</button>`;Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  cardButtons = `<button class="neon-btn add" onclick="event.stopPropagation(); acceptFriendRequest('${requestInfo.id}')">Accept Request</button>
                               <button class="neon-btn remove" onclick="event.stopPropagation(); rejectFriendRequest('${requestInfo.id}')">Reject</button>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (requestInfo.status === 'accepted') {
Â  Â  Â  Â  Â  Â  cardButtons = `<button class="neon-btn" style="border-color:lime; color:lime;" onclick="event.stopPropagation(); showTab('messaging'); selectChat('${requestInfo.id}', '${uid}')">Duo Active</button>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  cardButtons = `<button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${uid}')">Send Request</button>`;
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  cardButtons = `<button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${uid}')">Send Request</button>`;
Â  Â  }
Â  Â Â 
Â  Â  // Optional LFD Category Display
Â  Â  let lfdCategoryDisplay = '';
Â  Â  if (data.status === 'LFD' && lfdCategory) {
Â  Â  Â  Â  lfdCategoryDisplay = `<div class="lfd-category">${lfdCategory}</div>`;
Â  Â  }

Â  Â  card.innerHTML=`
Â  Â  Â  Â  <div class="card-content-box">
Â  Â  Â  Â  <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar">
Â  Â  Â  Â  <div class="nickname-group">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0;">${data.nickname||'Unknown'}</h3>
Â  Â  Â  Â  Â  Â  ${badge}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="game-category ${gameCategoryClass}">${gameCategory.replace(/([A-Z])/g, ' $1').trim()}</div>
Â  Â  Â  Â  <div class="game-role">${gameRole.replace(/([A-Z])/g, ' $1').trim()}</div>
Â  Â  Â  Â  ${lfdCategoryDisplay}Â 
Â  Â  Â  Â  <div class="skill-rating">${'â­'.repeat(data.skillRating||3)}</div>
Â  Â  Â  Â  <div class="status-indicator status-${statusClass}">${data.status||'Online'}</div>
Â  Â  Â  Â  <p style="margin:5px 0; font-size:0.9em; text-align:center; color:#ccc;">${data.bio||'No bio provided.'}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  ${cardButtons}
Â  Â  `;
Â  Â  return card;
}

// FIX: Completed the partially included function signature
function renderDuoCard(uid, data) {
    if(!data) return null;
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => viewProfile(uid, data); 

    const statusClass = (data.status || 'Online').replace(/\s/g,'').toLowerCase();
    const badge = getCoFounderBadge(uid);

    // Assuming you want the accepted duo card to link to the chat directly
    const chatId = getChatId(uid);

    card.innerHTML = `
        <div class="card-content-box" style="border-bottom: none;">
            <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar">
            <div class="nickname-group">
                <h3 style="margin:0;">${data.nickname||'Unknown'}</h3>
                ${badge}
            </div>
            <p style="margin:5px 0; font-size:0.9em; color:lime;">DUO PARTNER</p>
            <div class="status-indicator status-${statusClass}">${data.status||'Online'}</div>
        </div>
        <button class="neon-btn" style="border-color:magenta; box-shadow:0 0 10px magenta;" 
                onclick="event.stopPropagation(); showTab('messaging'); selectChat('${chatId}', '${uid}')">
            Message Duo
        </button>
    `;
    return card;
}


// --- Missing Application Functions (Need to be implemented) ---
async function filterSearchResults() { /* TODO: Implement search logic */ }
async function loadFriends() { /* TODO: Implement friend/request list loading */ }
async function loadChatList() { /* TODO: Implement chat list loading */ }
async function loadUserProfile() { /* TODO: Implement profile loading */ }
function previewAvatar(event) { /* TODO: Implement avatar preview logic */ }
async function saveProfile() { /* TODO: Implement profile saving logic */ }
async function viewProfile(uid, data) { /* TODO: Implement viewing external profile */ }
async function sendFriendRequest(otherUid) { /* TODO: Implement request logic */ }
async function acceptFriendRequest(requestId) { /* TODO: Implement accept logic */ }
async function rejectFriendRequest(requestId) { /* TODO: Implement reject logic */ }
async function sendMessage() { /* TODO: Implement messaging logic */ }
async function selectChat(chatId, otherUid) { /* TODO: Implement chat selection logic */ }


// ----------------------------------------------------
// 4. START APPLICATION
// ----------------------------------------------------
// Ensure this runs only once when the script loads
initFirebase();
</script>

</body>
</html>
