<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Friends & Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* --- BASE STYLES --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width: 1000px; margin:auto; padding:20px; }
.hidden { display:none; }

/* --- HEADER & ICON STYLES --- */
.header {
    background: #111;
    border-bottom: 3px solid cyan;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    padding: 10px 0;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.header h1 {
    font-size: 2.5em;
    color: #fff;
    text-shadow: 0 0 5px cyan, 0 0 10px cyan, 0 0 15px magenta;
    margin: 0;
}
.icon-container {
    margin-right: 15px;
    font-size: 2.5em;
    color: cyan;
    text-shadow: 0 0 5px cyan, 0 0 10px magenta;
}

/* --- BUTTON STYLES --- */
.neon-btn { 
    border:2px solid cyan; 
    background:transparent; 
    color:white; 
    padding:8px 14px; 
    margin:5px; 
    border-radius:6px; 
    cursor:pointer; 
    box-shadow:0 0 10px cyan; 
    transition: all 0.2s ease-in-out;
    text-transform: uppercase;
    font-family: 'Orbitron', sans-serif; 
}
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.neon-btn.remove { border-color: red; box-shadow: 0 0 10px red; }
.neon-btn.remove:hover { border-color: orange; box-shadow: 0 0 15px orange; }

/* --- CARD/LAYOUT STYLES --- */
.flex { display:flex; gap:15px; flex-wrap:wrap; }
.card { 
    width:250px; 
    padding:15px; 
    border:2px solid cyan; 
    border-radius:12px; 
    background:#111; 
    box-shadow:0 0 10px cyan; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    margin-bottom: 15px;
    cursor: pointer; 
}
.avatar { width:50px; height:50px; border-radius:50%; border:2px solid cyan; object-fit:cover; margin-bottom:10px; }


/* --- CHAT BOX STYLES --- */
#chatBox {
    position: fixed;
    bottom: 0;
    right: 20px;
    width: 300px;
    height: 400px;
    background: #1a1a1a;
    border: 2px solid magenta;
    border-radius: 10px 10px 0 0;
    box-shadow: 0 0 15px magenta;
    display: flex;
    flex-direction: column;
    z-index: 1000;
}
#chatHeader {
    background: magenta;
    padding: 10px;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
}
#chatMessages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
}
#chatInput {
    display: flex;
    border-top: 1px solid #333;
}
#chatInput input {
    flex-grow: 1;
    padding: 10px;
    border: none;
    background: #222;
    color: white;
    font-family: inherit;
    outline: none;
}
.message {
    padding: 5px 10px;
    margin: 5px 0;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word; 
}
.message.me {
    align-self: flex-end;
    background: cyan;
    color: #0b0b0b;
    text-align: right;
    box-shadow: 0 0 5px cyan;
}
.message.them {
    align-self: flex-start;
    background: #333;
    color: white;
    text-align: left;
}
</style>
</head>
<body>

<div class="header">
    <div class="icon-container">
        âš¡
    </div>
    <h1>DUO UP</h1>
</div>

<div id="loginPage" class="container">
  <p>Find your perfect partner and dominate the cyber-arena.</p>
  <button class="neon-btn" onclick="login()">Login with Google</button>
</div>

<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <div style="margin-bottom: 20px;">
    <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
    <button class="neon-btn" onclick="showTab('requests')">Requests</button>
    <button class="neon-btn" onclick="showTab('friends')">Friends</button>
    <button class="neon-btn" onclick="logout()">Logout</button>
  </div>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
</div>

<div id="chatBox" class="hidden">
    <div id="chatHeader">
        <span id="chatFriendNickname"></span>
        <button class="neon-btn" style="border:none; box-shadow:none; padding: 0 5px; margin: 0; background: transparent; color: white; font-size: 1.2em;" onclick="closeChat()">X</button>
    </div>
    <div id="chatMessages">
        </div>
    <div id="chatInput">
        <input type="text" id="messageInput" placeholder="Send Message..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="neon-btn" onclick="sendMessage()">Send</button>
    </div>
</div>


<script>
// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const suggestedTab = document.getElementById("suggestedTab");
const requestsTab = document.getElementById("requestsTab");
const friendsTab = document.getElementById("friendsTab");
const chatBox = document.getElementById("chatBox");
const chatMessages = document.getElementById("chatMessages");
const messageInput = document.getElementById("messageInput");

let currentUser = null;
let currentChatId = null;
let currentFriendId = null;
let unsubscribeChatListener = null; 

// ---------------- LOGIN/AUTH ----------------
function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  currentUser = user;

  const userDoc = await db.collection("users").doc(user.uid).get();
  if(!userDoc.exists){
    await db.collection("users").doc(user.uid).set({
      uid: user.uid,
      nickname: user.displayName||"Player",
      friends: [],
      profileImageUrl: user.photoURL||DEFAULT_AVATAR
    });
  }

  const data = (await db.collection("users").doc(user.uid).get()).data();
  document.getElementById("welcome").innerText = "Welcome, "+data.nickname;

  // Initial loads
  loadSuggested();
  loadRequests();
  loadFriends();
});

function logout(){ 
    closeChat();
    auth.signOut(); 
}

function showTab(tab){
  closeChat(); 
  
  if (tab === 'suggested') loadSuggested();
  if (tab === 'requests') loadRequests();
  if (tab === 'friends') loadFriends();

  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(tab+"Tab").classList.remove("hidden");
}

// ---------------- LOAD FUNCTIONS ----------------
async function loadSuggested(){
  suggestedTab.innerHTML="<p>Loading suggested users...</p>";
  
  try {
      const usersSnap = await db.collection("users").get(); 
      const me = (await db.collection("users").doc(currentUser.uid).get()).data();
      suggestedTab.innerHTML = ""; 

      const myFriends = me.friends || [];
      const mySentRequestsSnap = await db.collection("friendRequests").where("senderId", "==", currentUser.uid).get();
      const myReceivedRequestsSnap = await db.collection("friendRequests").where("receiverId", "==", currentUser.uid).get();

      const pendingUsers = new Set();
      mySentRequestsSnap.forEach(doc => pendingUsers.add(doc.data().receiverId));
      myReceivedRequestsSnap.forEach(doc => pendingUsers.add(doc.data().senderId));

      let suggestedCount = 0;
      usersSnap.forEach(doc=>{
        if(doc.id === currentUser.uid) return; 
        if(myFriends.includes(doc.id)) return; 
        if(pendingUsers.has(doc.id)) return; 
        
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
          <button class="neon-btn" onclick="sendRequest('${doc.id}')">Send Request</button>`;
        suggestedTab.appendChild(card);
        suggestedCount++;
      });

      if (suggestedCount === 0) {
          suggestedTab.innerHTML="<p>No suggested players available right now.</p>";
      }
  } catch(error) {
      suggestedTab.innerHTML = `<p style="color:red;">Error loading suggested users: ${error.message}</p>`;
      console.error("Suggested Load Error:", error);
  }
}

async function loadRequests(){
  requestsTab.innerHTML="<p>Loading requests...</p>";
  
  try {
      const snap = await db.collection("friendRequests").where("receiverId","==",currentUser.uid).get();
      requestsTab.innerHTML = ""; 
      if(snap.empty){ 
        requestsTab.innerHTML="<p>No friend requests</p>"; 
        return; 
      }

      const requestPromises = snap.docs.map(async doc => {
        const r = doc.data();
        const senderDoc = await db.collection("users").doc(r.senderId).get();
        if (!senderDoc.exists) return null; 
        return { 
          requestId: doc.id,
          senderId: r.senderId,
          user: senderDoc.data()
        };
      });
      
      const requestsData = (await Promise.all(requestPromises)).filter(item => item !== null);

      requestsData.forEach(data => {
        const u = data.user;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
          <button class="neon-btn" onclick="acceptRequest('${data.requestId}','${data.senderId}')">Accept</button>
          <button class="neon-btn" onclick="rejectRequest('${data.requestId}')">Reject</button>`;
        requestsTab.appendChild(card);
      });
  } catch (error) {
      requestsTab.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
      console.error("Requests Load Error:", error);
  }
}

async function loadFriends(){
  friendsTab.innerHTML="<p>Loading friends...</p>";
  
  try {
      const me = (await db.collection("users").doc(currentUser.uid).get()).data();
      friendsTab.innerHTML = ""; 
      
      const myFriends = me.friends || [];

      if(myFriends.length===0){ 
        friendsTab.innerHTML="<p>No friends yet. Time to find a duo!</p>"; 
        return; 
      }
      
      const friendPromises = myFriends.map(fid => db.collection("users").doc(fid).get());
      const friendDocs = await Promise.all(friendPromises);

      friendDocs.forEach(doc => {
        if (!doc.exists) return; 
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute('onclick', `startChat('${doc.id}', '${u.nickname}')`);
        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
          <button class="neon-btn remove" onclick="event.stopPropagation(); removeFriend('${doc.id}')">Remove</button>`;
        friendsTab.appendChild(card);
      });
  } catch (error) {
      friendsTab.innerHTML = `<p style="color:red;">Error loading friends: ${error.message}</p>`;
      console.error("Friends Load Error:", error);
  }
}

// ---------------- FRIEND ACTIONS ----------------
async function sendRequest(receiverId){
  try {
      const existingRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", currentUser.uid)
        .where("receiverId", "==", receiverId)
        .get();

      const reverseRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", receiverId)
        .where("receiverId", "==", currentUser.uid)
        .get();

      if (!existingRequestSnap.empty || !reverseRequestSnap.empty) {
        alert("A friend request is already pending with this user!");
        return; 
      }

      await db.collection("friendRequests").add({
        senderId: currentUser.uid,
        receiverId: receiverId
      });
      
      alert("Request sent!"); 
      loadSuggested(); 
  } catch(err) {
      alert("Error sending request: " + err.message);
      console.error("Send Request Error:", err);
  }
}

function acceptRequest(requestId,senderId){
  const meRef = db.collection("users").doc(currentUser.uid);
  const senderRef = db.collection("users").doc(senderId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayUnion(senderId)});
    transaction.update(senderRef, {friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
    transaction.delete(db.collection("friendRequests").doc(requestId));
  }).then(() => {
    alert("Request accepted! You are now friends.");
    loadRequests();
    loadFriends();
    loadSuggested(); 
  }).catch(err => {
    alert("Transaction failed (Accept Request): " + err.message);
    console.error("Accept Request Error:", err);
  });
}

function rejectRequest(requestId){
  db.collection("friendRequests").doc(requestId).delete().then(() => {
    alert("Request rejected.");
    loadRequests();
  }).catch(err => {
    alert("Error rejecting request: " + err.message);
    console.error("Reject Request Error:", err);
  });
}

function removeFriend(friendId){
  if(!confirm("Are you sure you want to remove this friend?")) return;

  const meRef = db.collection("users").doc(currentUser.uid);
  const friendRef = db.collection("users").doc(friendId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayRemove(friendId)});
    transaction.update(friendRef, {friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)});
  }).then(() => {
    alert("Friend removed successfully.");
    loadFriends(); 
    loadSuggested(); 
  }).catch(err => {
    alert("Removal failed (Remove Friend): " + err.message);
    console.error("Remove Friend Error:", err);
  });
}

// ---------------- CHAT FUNCTIONS ----------------

function getChatId(id1, id2) {
    return id1 < id2 ? `${id1}-${id2}` : `${id2}-${id1}`;
}

function startChat(friendId, friendNickname) {
    if (unsubscribeChatListener) {
        unsubscribeChatListener(); 
    }

    currentFriendId = friendId;
    currentChatId = getChatId(currentUser.uid, friendId);

    document.getElementById("chatFriendNickname").innerText = friendNickname;
    chatBox.classList.remove("hidden");
    
    listenForMessages(currentChatId);
    messageInput.focus();
}

function closeChat() {
    if (unsubscribeChatListener) {
        unsubscribeChatListener();
        unsubscribeChatListener = null;
    }
    chatBox.classList.add("hidden");
    chatMessages.innerHTML = '';
    currentChatId = null;
    currentFriendId = null;
}

function listenForMessages(chatId) {
    const chatRef = db.collection('chats').doc(chatId).collection('messages');
    
    // THIS LINE REQUIRES the Collection Group Index on 'messages' / 'timestamp' Ascending
    unsubscribeChatListener = chatRef
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            chatMessages.innerHTML = ''; 
            snapshot.forEach(doc => {
                const message = doc.data();
                const isMe = message.senderId === currentUser.uid;
                
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${isMe ? 'me' : 'them'}`;
                
                let time = '';
                if (message.timestamp) {
                    const date = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                    time = ` <small>${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;
                }

                msgDiv.innerHTML = `${message.text}${time}`;
                chatMessages.appendChild(msgDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, error => {
            console.error("Error listening to chat:", error);
            // This is the read error, often caused by a missing index
            chatMessages.innerHTML = '<p style="color:red;">Error loading messages. (Check Firebase Indexing!)</p>';
        });
}

async function sendMessage() {
    const text = messageInput.value.trim();
    if (text === '' || !currentChatId) return;

    try {
        // DIRECT FIREBASE WRITE (Requires strict security rules to pass)
        await db.collection('chats').doc(currentChatId).collection('messages').add({
            senderId: currentUser.uid,
            receiverId: currentFriendId,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = ''; 
    } catch (error) {
        // This is the write error, usually caused by the strict security rules failing
        alert("Failed to send message: Please verify your Firebase Security Rules and Indexing for chat.");
        console.error("Send message error:", error);
    }
}
</script>
</body>
</html>
