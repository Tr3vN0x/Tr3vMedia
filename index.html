<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DuoUp - Social Gaming</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/3UQx9gR.png">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root { --duoup-primary:#00FFFF; --duoup-secondary:#FF5733; --duoup-accent:#8A2BE2; --duoup-dark:#050510; --duoup-light:#F0F8FF; --duoup-muted:#80809C; --font-main:'Rajdhani',sans-serif; --font-header:'Orbitron',sans-serif; }
html,body{margin:0;height:100%;font-family:var(--font-main);background-color:var(--duoup-dark);color:var(--duoup-light);}
h1,h2,h3{margin:0;font-family:var(--font-header);}
h2{display:flex;align-items:baseline;border-bottom:2px solid var(--duoup-secondary);padding-bottom:5px;margin-bottom:20px;font-size:1.8em;background:linear-gradient(90deg,var(--duoup-primary),var(--duoup-accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
#userCount{color:var(--duoup-secondary);font-size:0.55em;font-weight:600;margin-left:10px;}
a{color:var(--duoup-primary);text-decoration:none;}
button, select{cursor:pointer;border:none;border-radius:5px;transition:0.2s;}
header{position:fixed;top:0;width:100%;height:60px;background:rgba(20,20,38,0.98);display:flex;align-items:center;justify-content:space-between;padding:0 15px;z-index:1000;border-bottom:3px solid var(--duoup-secondary);}
header .logo{display:flex;align-items:center;gap:10px;}
header h1{font-size:2em;font-weight:700;color:var(--duoup-primary);text-shadow:0 0 10px var(--duoup-primary);}
header h1 span{color:var(--duoup-secondary);}
header nav{display:flex;align-items:center;gap:15px;flex-wrap:wrap;}
#logoutBtnHeader{background:var(--duoup-secondary);color:var(--duoup-dark);padding:6px 12px;font-weight:bold;display:flex;align-items:center;gap:5px;}
#auth-section{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding-top:60px;}
form:not(#duoSearchForm):not(#postForm):not(#messageForm){display:flex;flex-direction:column;background:#141426;padding:25px;border-radius:12px;margin:10px;width:90%;max-width:360px;}
input,textarea,select{margin:8px 0;padding:12px;border-radius:6px;border:1px solid var(--duoup-primary);background:#2D2D44;color:var(--duoup-light);}
button:not(.google-btn):not(#duoSearchForm button):not(.like-btn):not(.accept-btn):not(.reject-btn){margin-top:10px;padding:12px;font-weight:bold;background:linear-gradient(90deg,var(--duoup-primary),var(--duoup-accent));color:var(--duoup-dark);}
.google-btn{background:linear-gradient(90deg,#DB4437,#EA4335);color:white;width:90%;max-width:360px;display:none;align-items:center;justify-content:center;gap:10px;margin-top:15px;}
#app-section{width:100%;padding-top:60px;display:none;}

/* NEW MESSAGES LAYOUT */
#messages-section {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 15px;
    display: flex; /* Flex container for the two columns */
    gap: 20px;
    height: calc(100vh - 100px); /* Adjust height for full-screen feel */
}
.conversation-list-panel {
    width: 350px; /* Fixed width for the list of friends/requests */
    flex-shrink: 0;
    background: #141426; 
    padding: 15px; 
    border-radius: 12px; 
    overflow-y: auto; 
    border: 1px solid var(--duoup-accent);
}
.active-chat-window {
    flex-grow: 1; /* Takes up remaining space */
    display: flex;
    flex-direction: column;
    min-width: 0;
}
.chat-container-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    padding: 10px;
    background: #1A1A2E;
    border-radius: 8px 8px 0 0;
    border-bottom: 2px solid var(--duoup-secondary);
}
.chat-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--duoup-muted);
    font-size: 1.5em;
    text-align: center;
}

/* Friend and Request Item Styles */
.friend-item, .request-item { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 10px; 
    border-bottom: 1px dashed #2D2D44; 
    cursor: pointer;
    transition: background 0.2s;
}
.friend-item:hover, .request-item:hover { background: #2D2D44; }
.friend-item:last-child { border-bottom: none; }
.friend-item span { color: var(--duoup-light); }
.status-icon { 
    width: 10px; 
    height: 10px; 
    border-radius: 50%; 
    margin-right: 8px; 
    display: inline-block;
}
.status-online { background-color: #3CFF3C; } /* Green */
.status-offline { background-color: var(--duoup-muted); }

.request-item { 
    border: 1px solid var(--duoup-secondary);
    margin-bottom: 8px;
    border-radius: 5px;
}
.request-actions button { 
    padding: 5px 10px; 
    margin-left: 5px;
}
.accept-btn { background-color: #3CFF3C; color: var(--duoup-dark); }
.reject-btn { background-color: var(--duoup-secondary); color: var(--duoup-dark); }

/* Chat Message Styles */
#messagesContainer {
    flex-grow: 1; 
    background: #1A1A2E; 
    padding: 15px; 
    overflow-y: auto; 
    display: flex;
    flex-direction: column;
}
.my-message, .friend-message {
    max-width: 70%; 
    padding: 10px 14px; 
    border-radius: 18px; 
    font-size: 0.95em;
    word-wrap: break-word;
}
.my-message {
    background: var(--duoup-accent); /* Purple/Blue */
    color: var(--duoup-light);
    align-self: flex-end;
    margin-bottom: 10px;
    border-bottom-right-radius: 4px;
}
.friend-message {
    background: #3A3A52; /* Darker Gray */
    color: var(--duoup-light);
    align-self: flex-start;
    margin-bottom: 10px;
    border-bottom-left-radius: 4px;
}
.message-time { 
    font-size: 0.7em; 
    color: var(--duoup-dark); /* Dark color for contrast on bubble */
    text-align: right; 
    margin-top: 5px;
}
.friend-message .message-time {
    color: var(--duoup-muted);
}
#messageForm {
    display: flex;
    padding: 10px 0;
    background: #1A1A2E;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #3A3A52;
}
#messageInput {
    flex-grow: 1;
    margin: 0 10px 0 0;
    padding: 10px;
}
#messageForm button {
    padding: 10px 15px;
    margin: 0;
    background: var(--duoup-primary);
    color: var(--duoup-dark);
    font-weight: bold;
}


/* General App Styles */
.container{max-width:1200px;margin:20px auto;padding:0 15px;}
.results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
.duo-card{background:linear-gradient(145deg,#1A1A2E,#2D2D44);color:var(--duoup-light);border-radius:12px;overflow:hidden;border:1px solid #3A3A52;transition:.3s;box-shadow:0 4px 8px rgba(0,0,0,0.4);margin-bottom:15px;}
.card-header{display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #3A3A52;}
.avatar{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;background:var(--duoup-secondary);color:var(--duoup-dark);flex-shrink: 0;}
.bio, .post-content{padding:10px 15px;font-size:0.9em;color:var(--duoup-muted);white-space: pre-wrap;}
.action-button{width:100%;padding:12px;background:linear-gradient(90deg,var(--duoup-primary),var(--duoup-accent));color:var(--duoup-dark);font-weight:bold;border-radius:0 0 12px 12px;}
.nickname-display{display:flex;align-items:center;font-size:1.1em;}
.verified-badge{color:#1DA1F2;margin-left:5px;}
#postForm{background:#1A1A2E;padding:15px;border-radius:12px;margin-bottom:20px;display:flex;flex-direction:column;}
.post-list{max-width:700px;margin:0 auto;}
.post-footer { display: flex; align-items: center; justify-content: space-between; padding: 0 15px 10px; }
.like-btn { background: transparent; color: var(--duoup-muted); padding: 5px 10px; font-size: 1em; display: flex; align-items: center; gap: 5px; }
.like-btn:hover { color: var(--duoup-primary); }
.like-btn.liked { color: var(--duoup-secondary); }
.like-btn.liked i { color: var(--duoup-secondary); }
@media(max-width:500px){
    .results-grid{grid-template-columns:1fr;}
    #messages-section { flex-direction: column; height: auto; }
    .conversation-list-panel { width: 100%; height: auto; }
}
</style>
</head>
<body>

<header style="display:none;" id="mainHeader">
    <div class="logo">
        <img src="https://i.imgur.com/3UQx9gR.png" alt="DuoUp" width="40"/>
        <h1>DUO<span>UP</span></h1>
    </div>
    <nav>
        <a href="#" onclick="showSection('feed')">Feed</a>
        <a href="#" onclick="showSection('home')">Duo Search</a>
        <a href="#" onclick="showSection('messages')">Messages</a> <button id="logoutBtnHeader"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </nav>
</header>

<div id="auth-section">
    <h2>Welcome to DuoUp</h2>
    <form id="signin">
        <h3>Sign In</h3>
        <input id="signin-email" type="text" placeholder="Nickname or Email" required>
        <input id="signin-password" type="password" placeholder="Password" required>
        <button type="submit">Sign In</button>
    </form>
    <form id="signup">
        <h3>New Player? Sign Up</h3>
        <input id="signup-nickname" type="text" placeholder="Nickname (Permanent)" required>
        <input id="signup-email" type="email" placeholder="Email" required>
        <input id="signup-password" type="password" placeholder="Password" required>
        <button type="submit">Create Account</button>
    </form>
</div>

<div id="app-section">
    
    <div id="feed-section" class="container" style="display:none;">
        <h2>Global Feed</h2>
        <form id="postForm">
            <textarea id="postContent" placeholder="What's your duo thought?" required></textarea>
            <button type="submit" id="postBtn">Post to Feed</button>
        </form>
        <div id="postsList" class="post-list">
            </div>
    </div>
    
    <div id="home-section" class="container" style="display:none;">
        <h2>Duo Search <span id="userCount"></span></h2>
        <div class="results-grid" id="usersGrid"></div>
    </div>

    <div id="messages-section" style="display:none;">
        
        <div class="conversation-list-panel">
            <h3 style="margin-top: 0;">Friend Requests (<span id="requestsCount">0</span>)</h3>
            <div id="requestsList"></div>
            
            <h3 style="margin-top: 20px;">Friends (<span id="friendsCount">0</span>)</h3>
            <div id="friendsList"></div>
        </div>
        
        <div id="activeChatWindow" class="active-chat-window">
            
            <div id="chatContainerHeader" class="chat-container-header" style="display:none;">
                <h2 id="chatHeader" style="border-bottom: none; margin-bottom: 0;"></h2>
                </div>

            <div id="messagesContainer">
                <div id="chatPlaceholder" class="chat-placeholder">
                    Select a friend on the left to start chatting.
                </div>
                </div>

            <form id="messageForm" style="display:none;">
                <input id="messageInput" type="text" placeholder="Type your message..." required/>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</div>

<script type="module">
'use strict';

import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    updateDoc, 
    collection, 
    getDocs, 
    query, 
    orderBy, 
    addDoc, 
    arrayUnion, 
    arrayRemove,
    where, 
    onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

// --- Firebase Config & Initialization ---
const firebaseConfig = {
    apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
    authDomain: "duoup-cfae6.firebaseapp.com",
    projectId: "duoup-cfae6",
    storageBucket: "duoup-cfae6.appspot.com",
    messagingSenderId: "812263060524",
    appId: "1:812263060524:web:ac09c3ae610db1cd110d89"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- DOM Elements ---
const signinForm = document.getElementById("signin");
const signupForm = document.getElementById("signup");
const authSection = document.getElementById("auth-section");
const appSection = document.getElementById("app-section");
const mainHeader = document.getElementById("mainHeader");
const usersGrid = document.getElementById("usersGrid");
const userCountElement = document.getElementById("userCount");
const postForm = document.getElementById("postForm"); 
const postsList = document.getElementById("postsList"); 

// New/Updated Chat/Friends DOM Elements
const requestsList = document.getElementById("requestsList");
const friendsList = document.getElementById("friendsList");
const requestsCount = document.getElementById("requestsCount");
const friendsCount = document.getElementById("friendsCount");
const messageForm = document.getElementById("messageForm");
const messageInput = document.getElementById("messageInput");
const chatHeader = document.getElementById("chatHeader");
const messagesContainer = document.getElementById("messagesContainer");
const chatPlaceholder = document.getElementById("chatPlaceholder");
const chatContainerHeader = document.getElementById("chatContainerHeader");


// --- Constants & Local State ---
const SEVEN_DAYS_IN_MS = 7 * 24 * 60 * 60 * 1000;
let activityInterval; 
let currentNickname = ""; 
let currentBio = ""; 
let currentFriendsData = {}; 
let currentChatId = null;    
let unsubscribeChat = null; 
let unsubscribeRequests = null; 
let unsubscribeFriends = null;  
let allUsersMap = {}; 

// --- Utility Functions ---
function getVerifiedBadge(nickname) {
    return nickname === 'Tr3vN0x' ? '<i class="fas fa-badge-check verified-badge" title="Verified Player"></i>' : '';
}

function timeSince(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes";
    return Math.floor(seconds) + " seconds";
}

function getChatId(user1Id, user2Id) {
    const participants = [user1Id, user2Id].sort();
    return participants.join('_'); 
}

async function updateLastActiveStatus(uid) {
    if (!uid) return;
    try {
        await updateDoc(doc(db, "users", uid), {
            lastActive: Date.now()
        });
    } catch (err) {
        console.warn("Could not update lastActive status:", err.message);
    }
}

async function loadUserData(user) {
    const userDocRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(userDocRef);
    let userData = docSnap.exists() ? docSnap.data() : {};

    if (!docSnap.exists() || !userData.nickname) { 
        const authType = 'email'; 
        const defaultNickname = user.email.split('@')[0] || "New Player";

        userData = {
            uid: user.uid,
            email: user.email,
            nickname: defaultNickname, 
            bio: "",
            profileImageUrl: user.photoURL || "",
            friends: [],
            lastActive: Date.now(),
            authType: authType 
        };
        await setDoc(userDocRef, userData);
    }
    return userData;
}

// --- Auth Functions ---
async function handleSignIn(e) {
    e.preventDefault();
    const email = document.getElementById("signin-email").value;
    const password = document.getElementById("signin-password").value;
    try{
        await signInWithEmailAndPassword(auth, email, password);
    } catch(err){ alert(err.message); }
}

async function handleSignUp(e) {
    e.preventDefault();
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const nickname = document.getElementById("signup-nickname").value; 

    try{
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const { user } = userCredential;

        await setDoc(doc(db,"users", user.uid), {
            uid: user.uid,
            email: email,
            nickname: nickname, 
            bio: "",
            profileImageUrl: "",
            friends: [], 
            lastActive: Date.now(),
            authType: 'email' 
        });
    } catch(err){ alert(err.message); }
}

async function handleLogout() {
    clearInterval(activityInterval); 
    activityInterval = null;
    await signOut(auth); 
}

// Attach Auth Listeners
signinForm.addEventListener("submit", handleSignIn);
signupForm.addEventListener("submit", handleSignUp);
document.getElementById("logoutBtnHeader").addEventListener("click", handleLogout);

// --- Core Logic: Friend Requests & Chat Management ---

window.sendFriendRequest = async function(receiverId) {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in.");

    if (currentFriendsData[receiverId]) {
        return alert(`${currentFriendsData[receiverId].nickname} is already your friend!`);
    }
    
    try {
        await addDoc(collection(db, "friendRequests"), {
            senderId: user.uid,
            receiverId: receiverId,
            status: "pending",
            timestamp: Date.now()
        });
        alert(`Friend request sent to ${allUsersMap[receiverId].nickname}!`);
    } catch (err) {
        console.error("Error sending request:", err);
        alert("Failed to send request.");
    }
}

window.handleFriendRequest = async function(requestId, action) {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const requestRef = doc(db, "friendRequests", requestId);
        await updateDoc(requestRef, { status: action }); 

        if (action === 'accepted') {
            const requestSnap = await getDoc(requestRef);
            const data = requestSnap.data();
            
            await updateDoc(doc(db, "users", data.senderId), {
                friends: arrayUnion(data.receiverId)
            });
            await updateDoc(doc(db, "users", data.receiverId), {
                friends: arrayUnion(data.senderId)
            });
            
            const chatId = getChatId(data.senderId, data.receiverId);
            await setDoc(doc(db, "chats", chatId), { 
                participants: [data.senderId, data.receiverId].sort(),
                createdAt: Date.now()
            }, { merge: true });

            alert(`Friend request accepted from ${allUsersMap[data.senderId].nickname}!`);
        } else {
             alert(`Friend request rejected.`);
        }
    } catch (err) {
        console.error("Error handling request:", err);
        alert("Failed to process request.");
    }
}

window.openChat = async function(friendId) {
    const user = auth.currentUser;
    if (!user) return;

    const chatId = getChatId(user.uid, friendId);
    currentChatId = chatId;
    
    // Clear previous view
    messagesContainer.innerHTML = '';
    chatPlaceholder.style.display = 'none';
    chatContainerHeader.style.display = 'flex';
    messageForm.style.display = 'flex';

    // Update Header
    const friendNickname = currentFriendsData[friendId].nickname || 'Unknown Player';
    chatHeader.innerText = friendNickname;
    
    // Set up Real-time listener for messages
    if (unsubscribeChat) {
        unsubscribeChat(); 
    }

    const messagesQuery = query(
        collection(db, "chats", chatId, "messages"),
        orderBy("timestamp", "asc")
    );

    unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
        messagesContainer.innerHTML = '';
        snapshot.forEach(doc => {
            const msg = doc.data();
            const isMe = msg.senderId === user.uid;
            
            const messageClass = isMe ? 'my-message' : 'friend-message';
            const timeStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messagesContainer.innerHTML += `
                <div class="${messageClass}">
                    ${msg.text}
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
        });
        // Auto-scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

async function startMessageListeners(user) {
    // 1. Load ALL users for mapping UIDs to Nicknames
    const userSnap = await getDocs(collection(db, "users"));
    allUsersMap = {};
    userSnap.forEach(doc => {
        allUsersMap[doc.id] = doc.data();
    });

    // 2. Real-time Friend Requests (where I am the receiver)
    const requestsQuery = query(
        collection(db, "friendRequests"),
        where("receiverId", "==", user.uid),
        where("status", "==", "pending")
    );
    if (unsubscribeRequests) unsubscribeRequests();
    unsubscribeRequests = onSnapshot(requestsQuery, (snapshot) => {
        requestsList.innerHTML = '';
        requestsCount.innerText = snapshot.size;
        snapshot.forEach(doc => {
            const req = doc.data();
            const senderNickname = allUsersMap[req.senderId]?.nickname || 'Unknown Player';

            requestsList.innerHTML += `
                <div class="request-item">
                    <span>${senderNickname}</span>
                    <div class="request-actions">
                        <button class="accept-btn" onclick="handleFriendRequest('${doc.id}', 'accepted')">Accept</button>
                        <button class="reject-btn" onclick="handleFriendRequest('${doc.id}', 'rejected')">Reject</button>
                    </div>
                </div>
            `;
        });
        if (snapshot.empty) requestsList.innerHTML = `<p style="color:var(--duoup-muted);font-size:0.9em;">No pending requests.</p>`;
    });

    // 3. Real-time Friends List (watching my own user document)
    const userDocRef = doc(db, "users", user.uid);
    if (unsubscribeFriends) unsubscribeFriends();
    unsubscribeFriends = onSnapshot(userDocRef, (docSnap) => {
        if (!docSnap.exists()) return;
        const friendsUids = docSnap.data().friends || []; 
        friendsList.innerHTML = '';
        friendsCount.innerText = friendsUids.length;
        currentFriendsData = {};

        friendsUids.forEach(friendId => {
            const friendData = allUsersMap[friendId];
            if (!friendData) return;
            
            const isOnline = friendData.lastActive > (Date.now() - 300000); 
            const statusClass = isOnline ? 'status-online' : 'status-offline';
            const statusText = isOnline ? 'Online' : 'Offline';
            
            currentFriendsData[friendId] = friendData; 
            
            friendsList.innerHTML += `
                <div class="friend-item" onclick="openChat('${friendId}')">
                    <div>
                        <span class="status-icon ${statusClass}"></span>
                        <strong>${friendData.nickname}</strong>
                    </div>
                    <span style="color: ${isOnline ? '#3CFF3C' : 'var(--duoup-muted)'}; font-size: 0.8em;">${statusText}</span>
                </div>
            `;
        });
        if (friendsUids.length === 0) friendsList.innerHTML = `<p style="color:var(--duoup-muted);font-size:0.9em;">Find players in Duo Search!</p>`;
        
        currentNickname = docSnap.data().nickname || '';
    });
}

messageForm.addEventListener("submit", async e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !currentChatId) return;

    const user = auth.currentUser;
    if (!user) return;

    try {
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            senderId: user.uid,
            text: text,
            timestamp: Date.now()
        });
        messageInput.value = ""; 
    } catch (err) {
        console.error("Error sending message:", err);
        alert("Failed to send message.");
    }
});


// --- User Search Update (Adding Send Request Button) ---
async function loadUsers(){
    const currentUser = auth.currentUser;
    if(!currentUser) return;

    const SEVEN_DAYS_AGO = Date.now() - SEVEN_DAYS_IN_MS;

    const qSnap = await getDocs(collection(db,"users"));
    usersGrid.innerHTML='';
    let count=0;

    qSnap.forEach(doc=>{
        const data = doc.data();
        
        if(!data.uid || data.uid === currentUser.uid) return;

        if (!data.lastActive || data.lastActive < SEVEN_DAYS_AGO) {
            return; 
        }
        
        const nickname = data.nickname; 
        const verifiedBadgeHtml = getVerifiedBadge(nickname);
        const isFriend = !!currentFriendsData[data.uid]; 

        count++;
        usersGrid.innerHTML+=`
        <div class="duo-card">
            <div class="card-header">
                <div class="avatar">${nickname[0]}</div>
                <div class="nickname-display">
                    <strong>${nickname}</strong>
                    ${verifiedBadgeHtml}
                </div>
            </div>
            <div class="bio">${data.bio||'No bio set.'}</div>
            <button 
                class="action-button" 
                ${isFriend ? 'disabled style="background: #3A3A52; color: #80809C;"' : ''}
                onclick="${isFriend ? `showSection('messages'); openChat('${data.uid}')` : `sendFriendRequest('${data.uid}')`}"
            >
                ${isFriend ? 'Message Friend' : 'Send Duo Request'}
            </button>
        </div>
        `;
    });
    userCountElement.innerText = count+" players online (active 7d)";
}

// --- Feed/Posts ---
// ... loadPosts, handlePostSubmit, toggleLikePost (All functions remain the same) ...

// --- Sections Update (Now handles 'messages' directly) ---
function showSection(section){
    // Include all sections
    ["feed","home","messages"].forEach(s=>document.getElementById(s+"-section").style.display="none");
    
    const targetSection = document.getElementById(section+"-section");
    if (targetSection) {
        targetSection.style.display="block";
    }

    // Unsubscribe from chat when leaving the messages section
    if (section !== 'messages' && unsubscribeChat) {
        unsubscribeChat();
        unsubscribeChat = null;
        currentChatId = null;
        // Reset chat window state when leaving the messages view
        chatPlaceholder.style.display = 'flex';
        chatContainerHeader.style.display = 'none';
        messageForm.style.display = 'none';
    }

    if(section==="home") loadUsers();
    if(section==="feed") loadPosts();
    // 'messages' listeners are started once on auth change, and the view updates automatically.
}


// --- Auth State ---
onAuthStateChanged(auth,async user=>{
    if(user){
        authSection.style.display="none";
        appSection.style.display="block";
        mainHeader.style.display="flex";
        
        const userData = await loadUserData(user); 
        currentNickname = userData.nickname || ''; 
        currentBio = userData.bio || '';
        
        // Start ALL real-time listeners for message/friend management
        await startMessageListeners(user); 
        
        await updateLastActiveStatus(user.uid); 
        
        if (!activityInterval) {
            activityInterval = setInterval(() => updateLastActiveStatus(user.uid), 60000); // 1 minute
        }

        showSection('feed'); 
    } else {
        authSection.style.display="flex";
        appSection.style.display="none";
        mainHeader.style.display="none";
        clearInterval(activityInterval); 
        activityInterval = null;
        
        // Cleanup all real-time listeners on logout
        if (unsubscribeChat) unsubscribeChat();
        if (unsubscribeRequests) unsubscribeRequests();
        if (unsubscribeFriends) unsubscribeFriends();
        unsubscribeChat = null;
        unsubscribeRequests = null;
        unsubscribeFriends = null;
    }
});

// Expose functions to global scope (for HTML onclick handlers)
window.showSection = showSection;
window.toggleLikePost = toggleLikePost;
window.sendFriendRequest = sendFriendRequest; 
window.handleFriendRequest = handleFriendRequest; 
window.openChat = openChat;
