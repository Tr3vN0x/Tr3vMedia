<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DUO UP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Orbitron',sans-serif;
  background:#0b0b0b;
  color:white;
}
.hidden{display:none}
.container{width:90%;margin:auto;padding:20px}
.neon-btn{
  border:2px solid cyan;
  background:transparent;
  color:white;
  padding:8px 14px;
  margin:5px;
  border-radius:6px;
  cursor:pointer;
  box-shadow:0 0 10px cyan;
}
.neon-btn:hover{
  border-color:magenta;
  box-shadow:0 0 15px magenta;
}
.flex{display:flex;gap:15px;flex-wrap:wrap}
.card{
  width:260px;
  padding:15px;
  border:2px solid cyan;
  border-radius:14px;
  background:#111;
  box-shadow:0 0 10px cyan;
}
.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  border:2px solid cyan;
  object-fit:cover;
}
.user{display:flex;gap:10px;align-items:center}
input{
  width:100%;
  padding:8px;
  margin:5px 0;
  background:#000;
  border:2px solid cyan;
  color:white;
  border-radius:6px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- USERNAME -->
<div id="usernamePage" class="container hidden">
  <h2>Choose a Username</h2>
  <input id="usernameInput" placeholder="Username">
  <button class="neon-btn" onclick="saveUsername()">Continue</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>

  <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
  <button class="neon-btn" onclick="showTab('requests')">Requests</button>
  <button class="neon-btn" onclick="showTab('friends')">Friends</button>
  <button class="neon-btn" onclick="openProfile()">Profile</button>
  <button class="neon-btn" onclick="logout()">Logout</button>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
</div>

<!-- PROFILE -->
<div id="profilePage" class="container hidden">
  <h2>Edit Profile</h2>
  <img id="profilePreview" class="avatar"><br><br>
  <input type="file" id="profileImage">
  <input id="statusInput" placeholder="Status">
  <button class="neon-btn" onclick="saveProfile()">Save</button>
  <button class="neon-btn" onclick="closeProfile()">Back</button>
</div>

<script>
// ---------------- FIREBASE ----------------
const firebaseConfig={
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const DEFAULT_AVATAR =
"https://www.shutterstock.com/image-vector/default-avatar-profile-icon-social-600nw-1677509740.jpg";

// ---------------- LOGIN ----------------
function loginWithGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .catch(err=>alert(err.message));
}

// ---------------- AUTH STATE ----------------
auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    usernamePage.classList.add("hidden");
    dashboard.classList.add("hidden");
    profilePage.classList.add("hidden");
    return;
  }

  loginPage.classList.add("hidden");

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();

  if(!snap.exists){
    usernamePage.classList.remove("hidden");
  }else{
    usernamePage.classList.add("hidden");
    loadDashboard(snap.data());
  }
});

// ---------------- SAVE USERNAME ----------------
function saveUsername(){
  const name = usernameInput.value.trim();
  if(!name) return alert("Username required");

  const user = auth.currentUser;

  db.collection("users").doc(user.uid).set({
    uid: user.uid,
    nickname: name,
    email: user.email,
    profileImageUrl: user.photoURL || DEFAULT_AVATAR,
    status: "Online",
    friends: [],
    isPremium: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    usernamePage.classList.add("hidden");
    loadDashboard({nickname:name});
  });
}

// ---------------- DASHBOARD ----------------
function loadDashboard(data){
  dashboard.classList.remove("hidden");
  welcome.innerText = "Welcome, " + data.nickname;
  loadSuggested();
  loadRequests();
  loadFriends();
  showTab("suggested");
}

function logout(){
  auth.signOut();
}

// ---------------- TABS ----------------
function showTab(tab){
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  document.getElementById(tab+"Tab").classList.remove("hidden");
}

// ---------------- SUGGESTED ----------------
function loadSuggested(){
  suggestedTab.innerHTML="";
  db.collection("users").get().then(snap=>{
    snap.forEach(u=>{
      if(u.id===auth.currentUser.uid) return;
      const d=u.data();
      suggestedTab.innerHTML+=`
      <div class="card">
        <div class="user">
          <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${d.nickname}</strong>
        </div><br>
        <button class="neon-btn" onclick="sendRequest('${u.id}')">DUO UP</button>
      </div>`;
    });
  });
}

function sendRequest(id){
  db.collection("friendRequests").add({
    senderId: auth.currentUser.uid,
    receiverId: id,
    status: "pending",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// ---------------- REQUESTS ----------------
function loadRequests(){
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(snap=>{
      requestsTab.innerHTML="";
      snap.forEach(r=>{
        db.collection("users").doc(r.data().senderId).get().then(u=>{
          requestsTab.innerHTML+=`
          <div class="card">
            <strong>${u.data().nickname}</strong><br><br>
            <button class="neon-btn" onclick="acceptRequest('${r.id}','${u.id}')">Accept</button>
            <button class="neon-btn" onclick="rejectRequest('${r.id}')">Reject</button>
          </div>`;
        });
      });
    });
}

function acceptRequest(rid,sender){
  db.collection("friendRequests").doc(rid).update({status:"accepted"});
  db.collection("users").doc(auth.currentUser.uid)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(sender)});
  db.collection("users").doc(sender)
    .update({friends:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)});
}

function rejectRequest(id){
  db.collection("friendRequests").doc(id).update({status:"rejected"});
}

// ---------------- FRIENDS ----------------
function loadFriends(){
  db.collection("users").doc(auth.currentUser.uid)
    .onSnapshot(doc=>{
      friendsTab.innerHTML="";
      (doc.data().friends||[]).forEach(fid=>{
        db.collection("users").doc(fid).get().then(u=>{
          friendsTab.innerHTML+=`
          <div class="card">
            <div class="user">
              <img class="avatar" src="${u.data().profileImageUrl||DEFAULT_AVATAR}">
              <strong>${u.data().nickname}</strong>
            </div>
          </div>`;
        });
      });
    });
}

// ---------------- PROFILE ----------------
function openProfile(){
  dashboard.classList.add("hidden");
  profilePage.classList.remove("hidden");

  db.collection("users").doc(auth.currentUser.uid).get().then(d=>{
    profilePreview.src = d.data().profileImageUrl || DEFAULT_AVATAR;
    statusInput.value = d.data().status || "";
  });
}

function closeProfile(){
  profilePage.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function saveProfile(){
  const file = profileImage.files[0];

  if(file){
    const ref = storage.ref("avatars/"+auth.currentUser.uid);
    ref.put(file).then(()=>{
      ref.getDownloadURL().then(url=>{
        updateProfile(url);
      });
    });
  }else{
    updateProfile(null);
  }
}

function updateProfile(url){
  const data={ status: statusInput.value };
  if(url) data.profileImageUrl = url;

  db.collection("users").doc(auth.currentUser.uid)
    .update(data)
    .then(closeProfile);
}
</script>

</body>
</html>
