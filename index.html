<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Find Your Duo</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #15171e; /* Deep dark background */
            color: #f0f0f0;
        }

        #matching-container {
            width: 90%;
            max-width: 420px;
            position: relative;
            padding: 20px 0 100px; /* Space for header and buttons */
        }
        
        #header {
            text-align: center;
            margin-bottom: 20px;
            color: #ffaa00;
        }
        
        #card-stack {
            position: relative;
            height: 550px; /* Fixed height for the card area */
        }

        /* üÉè The Card Itself */
        .gamer-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2a2a44;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            padding: 25px;
            display: flex;
            flex-direction: column;
            cursor: grab;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; /* For swipe animation */
        }
        
        /* Card Header */
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #3c3c5c;
            padding-bottom: 15px;
        }

        .profile-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid #ff4560; /* Highlight color */
        }

        .username {
            margin: 0;
            font-size: 1.8em;
            flex-grow: 1;
        }

        /* Tags and Details */
        .game-details {
            background: #1e1e2f;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 8px;
            margin-top: 8px;
            color: #fff;
        }
        .role { background: #ff4560; } /* Red/Pink */
        .rank { background: #5c6fff; } /* Blue */
        .platform { background: #ffaa00; } /* Orange */
        .vibe { background: #7c7c7c; } /* Gray */

        .card-bio p {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        /* Action Buttons */
        #action-buttons {
            display: flex;
            justify-content: space-around;
            position: absolute;
            bottom: 20px; /* Adjusted to be near the bottom */
            width: 100%;
        }

        .action-btn {
            padding: 15px 35px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .skip {
            background: #5c6fff; /* Blue */
            color: white;
            box-shadow: 0 4px 10px rgba(92, 111, 255, 0.4);
        }
        .request {
            background: #3dd022; /* Green */
            color: white;
            box-shadow: 0 4px 10px rgba(61, 208, 34, 0.4);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
    </style>
</head>
<body>
    <div id="matching-container">
        <h1 id="header">Find Your Duo</h1>
        
        <div id="card-stack">
            <div class="loading">Loading Gamer Cards...</div>
        </div>

        <div id="action-buttons">
            <button id="skip-btn" class="action-btn skip" disabled>SKIP</button>
            <button id="request-btn" class="action-btn request" disabled>DUO REQUEST</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Replace with your actual keys) ---
        const firebaseConfig = {
            // WARNING: NEVER expose actual production secrets in client-side code!
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- 2. CORE DOM ELEMENTS ---
        const cardStackEl = document.getElementById('card-stack');
        const skipBtn = document.getElementById('skip-btn');
        const requestBtn = document.getElementById('request-btn');

        // --- 3. STATE ---
        let currentUserId = 'PLACEHOLDER_UID'; // Placeholder - Must be replaced by auth.currentUser.uid
        let cards = [];
        let currentIndex = 0;
        
        // --- 4. AUTH & INITIALIZATION ---

        // Check auth state and initialize the app
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                console.log("User authenticated:", currentUserId);
                fetchGamerCards();
            } else {
                console.log("User not logged in. Using placeholder UID for demo.");
                // For a real app, you'd redirect to the login page here.
                fetchGamerCards(); // For demo purposes, fetch anyway
            }
        });

        // --- 5. DATA FETCHING AND RENDERING ---

        async function fetchGamerCards() {
            // Enable buttons while there might be cards
            skipBtn.disabled = false;
            requestBtn.disabled = false;
            
            // --- QUERY: Example Query on gamerCards Collection ---
            // NOTE: This query needs a composite index in Firestore!
            const cardsRef = db.collection('gamerCards');
            const q = cardsRef
                .where('gameSlug', '==', 'valorant') 
                .where('isActive', '==', true)     
                .limit(10); // Load a batch of 10 cards

            try {
                const querySnapshot = await q.get();
                cards = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // *** In a real app, you must filter out cards where the owner is already matched/requested! ***
                
                renderCurrentCard();

            } catch (error) {
                console.error("Error fetching documents:", error);
                cardStackEl.innerHTML = '<p>Error loading cards. Check console and Firebase Rules.</p>';
            }
        }

        function renderCurrentCard() {
            if (cards.length === 0 || currentIndex >= cards.length) {
                cardStackEl.innerHTML = '<h2>No more Duos found!</h2><p>Try adjusting your filters or check back later.</p>';
                skipBtn.disabled = true;
                requestBtn.disabled = true;
                return;
            }
            
            const cardData = cards[currentIndex];

            const newCardEl = document.createElement('div');
            newCardEl.className = 'gamer-card';
            newCardEl.dataset.targetUserId = cardData.userId;

            // Fallback for missing data is essential
            const username = cardData.username || 'Anonymous Gamer';
            const profileImg = cardData.profileImageUrl || 'https://via.placeholder.com/150';
            const description = cardData.description || 'No specific goals written yet.';
            
            newCardEl.innerHTML = `
                <div class="card-header">
                    <img src="${profileImg}" alt="Profile" class="profile-img">
                    <h2 class="username">${username}</h2>
                </div>
                <div class="game-details">
                    <div class="game-info">
                        <h3>${cardData.gameSlug ? cardData.gameSlug.toUpperCase().replace('_', ' ') : 'UNKNOWN GAME'}</h3>
                        <span class="tag role">ROLE: ${cardData.inGameRole || 'Any'}</span>
                        <span class="tag rank">RANK: ${cardData.skillLevel || 'Casual'}</span>
                    </div>
                </div>
                <div class="card-bio">
                    <p>${description}</p>
                    <span class="tag platform">${cardData.platform || 'Unknown Platform'}</span>
                    <span class="tag vibe">#${cardData.vibe || 'Neutral'}</span>
                </div>
            `;

            cardStackEl.innerHTML = '';
            cardStackEl.appendChild(newCardEl);
        }

        // --- 6. INTERACTION LOGIC (Swiping) ---

        function swipeCard(action) {
            const currentCardEl = document.querySelector('.gamer-card');
            if (!currentCardEl) return;

            let translateX = (action === 'request') ? '500px' : '-500px';

            // Visual exit animation
            currentCardEl.style.transform = `translateX(${translateX}) rotate(${action === 'request' ? '10deg' : '-10deg'})`;
            currentCardEl.style.opacity = '0';

            // Advance the index and render the next card after animation
            setTimeout(() => {
                currentIndex++;
                renderCurrentCard();
            }, 500); 
        }

        // --- 7. FIREBASE ACTION LISTENERS ---

        skipBtn.addEventListener('click', () => {
            if (currentIndex < cards.length) {
                console.log(`Skipped card for User ID: ${cards[currentIndex].userId}`);
                swipeCard('skip');
            }
        });

        requestBtn.addEventListener('click', async () => {
            if (currentIndex >= cards.length) return;
            
            const cardData = cards[currentIndex];
            
            // SECURITY CHECK: Ensure user is logged in before writing
            if (!auth.currentUser) {
                 alert('You must be logged in to send a Duo Request!');
                 return;
            }

            // Create the new document for the friendRequests collection
            const friendRequest = {
                senderId: auth.currentUser.uid, // Use actual authenticated UID
                receiverId: cardData.userId,
                gameSlug: cardData.gameSlug,
                status: 'pending', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Use server timestamp for accuracy
            };
            
            try {
                // The Security Rules we wrote will ensure this request is valid!
                await db.collection('friendRequests').add(friendRequest);
                console.log(`Duo Request SENT to User ID: ${cardData.userId}`);
                
                // Visually swipe the card after successful database write
                swipeCard('request');
                
            } catch (error) {
                console.error("Error sending Duo Request:", error);
                alert(`Failed to send request. Error: ${error.message}`);
            }
        });
        
    </script>
</body>
</html>
