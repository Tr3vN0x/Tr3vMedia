<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        #app { max-width: 800px; margin: 50px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #auth-container { text-align: center; padding: 50px; }
        #app-tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { flex-grow: 1; padding: 15px 10px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: bold; color: #666; transition: color 0.3s, border-bottom 0.3s; }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { padding: 15px 0; }
        .user-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #e9ecef; }
        .user-card-info { flex-grow: 1; }
        .user-card-info strong { display: block; font-size: 1.1em; }
        .neon-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; transition: background-color 0.3s; }
        .neon-btn.primary { background-color: #007bff; color: white; }
        .neon-btn.primary:hover { background-color: #0056b3; }
        .neon-btn.danger { background-color: #dc3545; color: white; }
        .neon-btn.danger:hover { background-color: #c82333; }
        #profile-info { padding: 15px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; }
        .badge { background-color: #dc3545; color: white; padding: 2px 7px; border-radius: 50%; font-size: 0.75em; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="app">
        <h1>Social App</h1>
        <div id="auth-container">
            <h2>Sign In</h2>
            <p>Sign in to continue. (Using dummy buttons for simplicity, actual Firebase Auth logic would be here).</p>
            <button class="neon-btn primary" onclick="signInWithEmailPassword()">Log In / Register</button>
        </div>

        <div id="main-content" style="display: none;">
            <div id="user-header" style="text-align: right; margin-bottom: 15px;">
                Logged in as: <strong id="current-username"></strong> | 
                <button class="neon-btn danger" onclick="signOutUser()">Sign Out</button>
            </div>

            <div id="app-tabs">
                <button class="tab-btn active" id="tab-suggested" onclick="showTab('suggested')">Suggested</button>
                <button class="tab-btn" id="tab-requests" onclick="showTab('requests')">
                    Requests <span id="requests-badge" class="badge" style="display: none;"></span>
                </button>
                <button class="tab-btn" id="tab-friends" onclick="showTab('friends')">Friends</button>
                <button class="tab-btn" id="tab-profile" onclick="showTab('profile')">Profile</button>
            </div>

            <div id="tab-contents">
                <div id="suggested-tab" class="tab-content">
                    <h3>Suggested Users</h3>
                    <div id="suggested-list"></div>
                </div>

                <div id="requests-tab" class="tab-content" style="display: none;">
                    <h3>Pending Friend Requests</h3>
                    <div id="requests-list"></div>
                </div>

                <div id="friends-tab" class="tab-content" style="display: none;">
                    <h3>Your Friends</h3>
                    <div id="friends-list"></div>
                </div>

                <div id="profile-tab" class="tab-content" style="display: none;">
                    <h3>My Profile</h3>
                    <div id="profile-info">
                        <p><strong>Username:</strong> <span id="profile-username"></span></p>
                        <p><strong>User ID:</strong> <span id="profile-uid"></span></p>
                        <button class="neon-btn primary" onclick="startEditProfile()">Edit Profile</button>
                    </div>

                    <div id="edit-profile-form" style="display: none; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4>Edit Username</h4>
                        <input type="text" id="edit-username-input" placeholder="New Username" style="padding: 8px; margin-bottom: 10px; width: 90%;">
                        <button class="neon-btn primary" onclick="saveProfile()">Save</button>
                        <button class="neon-btn" onclick="cancelEditProfile()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // 1. FIREBASE CONFIGURATION & INITIALIZATION
        // ====================================================================

        // !!! CRITICAL: REPLACE THIS WITH YOUR ACTUAL CONFIGURATION !!!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // !!! CRITICAL: REPLACE THIS WITH YOUR ACTUAL CONFIGURATION !!!

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global state
        let currentUser = null;
        let currentUsername = "Loading...";

        // ====================================================================
        // 2. AUTHENTICATION (MOCK-UP FOR SIMPLICITY)
        // ====================================================================

        // Mock-up sign-in for demonstration. In a real app, this would use:
        // firebase.auth().signInWithEmailAndPassword() or signInWithPopup()
        function signInWithEmailPassword() {
            // Using a fixed dummy user for quick testing of friend system logic
            const dummyUid = "iSvCJ4tLVLYOECADhgx1trF3eIY2"; 
            
            // This is a simplified way to mock auth state without a full login UI
            // In a real app, onAuthStateChanged handles this after successful login.
            auth.signInAnonymously().then(userCredential => {
                // We use the dummy UID for the currentUser object to match your test data.
                currentUser = { uid: dummyUid, email: 'mock_user@example.com' }; 
                
                // Manually trigger the state change logic
                onUserLoggedIn(currentUser); 
            }).catch(error => {
                console.error("Mock Login Failed:", error);
                alert("Mock Login Failed. Check console.");
            });
        }
        
        function signOutUser() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
            });
        }

        // Real Firebase Auth Listener
        auth.onAuthStateChanged(user => {
            if (user && user.uid !== "iSvCJ4tLVLYOECADhgx1trF3eIY2") {
                 // For a real app, use the actual user object
                 onUserLoggedIn(user);
            } else if (currentUser && user === null) {
                 // Handles the mock user being set up above after sign out
                 document.getElementById('auth-container').style.display = 'block';
                 document.getElementById('main-content').style.display = 'none';
            }
        });

        function onUserLoggedIn(user) {
            currentUser = user; // Use mock user object if using the mock sign-in
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            checkAndCreateProfile(user);
            loadUnreadCount();
            loadSuggested();
            loadRequests();
            loadFriends();
            showTab('suggested');
        }

        // ====================================================================
        // 3. PROFILE MANAGEMENT (Setup, Read, Update)
        // ====================================================================

        async function checkAndCreateProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();

            if (!doc.exists) {
                // If it's a new user, create a minimal profile
                const defaultUsername = `User${Math.floor(Math.random() * 10000)}`;
                await userRef.set({
                    username: defaultUsername,
                    uid: user.uid,
                    friends: [],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentUsername = defaultUsername;
                loadProfile();
            } else {
                currentUsername = doc.data().username;
                loadProfile(doc.data());
            }

            document.getElementById('current-username').textContent = currentUsername;
        }

        async function loadProfile(data) {
            if (!currentUser) return;

            // Fetch if data isn't passed (e.g., after an edit)
            if (!data) {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) data = doc.data();
            }
            
            if (data) {
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-uid').textContent = data.uid;
                currentUsername = data.username;
                document.getElementById('current-username').textContent = currentUsername;
            }
        }
        
        function startEditProfile() {
            document.getElementById('profile-info').style.display = 'none';
            document.getElementById('edit-profile-form').style.display = 'block';
            document.getElementById('edit-username-input').value = currentUsername;
        }

        function cancelEditProfile() {
            document.getElementById('profile-info').style.display = 'block';
            document.getElementById('edit-profile-form').style.display = 'none';
        }

        async function saveProfile() {
            const newUsername = document.getElementById('edit-username-input').value.trim();
            if (!newUsername || newUsername.length < 3) {
                alert("Username must be at least 3 characters.");
                return;
            }
            
            try {
                // Update Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    username: newUsername
                });
                
                alert("Profile updated successfully!");
                cancelEditProfile();
                await loadProfile(); // Re-load the profile data and update UI
            } catch (error) {
                alert("Failed to save profile. Check permissions/console.");
                console.error("Save Profile Error:", error);
            }
        }

        // ====================================================================
        // 4. FRIEND SYSTEM FUNCTIONS (Send, Accept, Reject, Remove)
        // ====================================================================

        async function sendRequest(receiverId) {
            if (!currentUser) return;

            try {
                // 1. Check if a request already exists in either direction
                const existingRequest = await db.collection("friendRequests")
                    .where('receiverId', 'in', [currentUser.uid, receiverId])
                    .where('senderId', 'in', [currentUser.uid, receiverId])
                    .get();

                if (!existingRequest.empty) {
                    alert("A pending request already exists between you and this user.");
                    return;
                }

                // 2. Create the new request document
                await db.collection("friendRequests").add({
                    senderId: currentUser.uid,
                    receiverId: receiverId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("Friend request sent!");
                loadSuggested(); // Hide the requested user
            } catch (error) {
                alert("Failed to send request. Check console.");
                console.error("Send Request Error:", error);
            }
        }

        function acceptRequest(requestId, senderId){
            if (!currentUser) return;

            const meRef = db.collection("users").doc(currentUser.uid);
            const senderRef = db.collection("users").doc(senderId);
            
            // Use a transaction to ensure all three critical steps succeed or fail together.
            db.runTransaction(async (transaction) => {
                // 1. Add sender's ID to my friends list
                transaction.update(meRef, {
                    friends: firebase.firestore.FieldValue.arrayUnion(senderId)
                });
                
                // 2. Add my ID to the sender's friends list
                transaction.update(senderRef, {
                    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                // 3. Delete the pending request document
                transaction.delete(db.collection("friendRequests").doc(requestId));
            }).then(() => {
                alert("Request accepted! You are now friends.");
                
                // Refresh the necessary sections after a successful transaction
                loadRequests();   // Remove the accepted request from the list
                loadFriends();    // Show the new friend in the friends list
                loadSuggested();  // Remove friend from suggested list
                loadUnreadCount();
                showTab('friends'); 
            }).catch(err => {
                alert("Transaction failed (Accept Request). Check console for error details. (Likely Security Rules)");
                console.error("Accept Request Error:", err);
            });
        }
        
        function rejectRequest(requestId){
            if (!currentUser) return;
            
            // Only needs to delete the request document.
            db.collection("friendRequests").doc(requestId).delete().then(() => {
                alert("Request rejected.");
                
                // CRITICAL: Refresh both lists
                loadRequests();  // Clears the request from the pending list
                loadSuggested(); // Allows the sender to reappear on suggested (Goal 3)
            }).catch(err => {
                alert("Error rejecting request: " + err.message);
                console.error("Reject Request Error:", err);
            });
        }

        // ====================================================================
        // 5. UI LOADING FUNCTIONS (Suggested, Requests, Friends)
        // ====================================================================

        async function loadSuggested() {
            const suggestedList = document.getElementById('suggested-list');
            suggestedList.innerHTML = '<p>Loading suggested users...</p>';
            if (!currentUser) return;

            try {
                // Step 1: Get the current user's profile to know who their friends are
                const myProfile = await db.collection('users').doc(currentUser.uid).get();
                const myFriends = myProfile.exists ? (myProfile.data().friends || []) : [];
                
                // Step 2: Get all users who are NOT the current user
                const usersSnapshot = await db.collection('users')
                    .where('uid', '!=', currentUser.uid)
                    .limit(10) // Limit the number of users to load
                    .get();

                // Step 3: Get all pending requests involving the current user (sent or received)
                const requestsSnapshot = await db.collection('friendRequests')
                    .where('receiverId', '==', currentUser.uid) // Received
                    .get();

                const sentRequestsSnapshot = await db.collection('friendRequests')
                    .where('senderId', '==', currentUser.uid) // Sent
                    .get();

                const pendingUserIds = new Set();
                requestsSnapshot.forEach(doc => pendingUserIds.add(doc.data().senderId));
                sentRequestsSnapshot.forEach(doc => pendingUserIds.add(doc.data().receiverId));

                
                let html = '';
                usersSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const isFriend = myFriends.includes(data.uid);
                    const isPending = pendingUserIds.has(data.uid);

                    // Only show if they are NOT a friend and NOT involved in a pending request
                    if (!isFriend && !isPending) {
                        html += `
                            <div class="user-card">
                                <div class="user-card-info">
                                    <strong>${data.username}</strong>
                                    <small>(${data.uid.substring(0, 8)}...)</small>
                                </div>
                                <button class="neon-btn primary" onclick="sendRequest('${data.uid}')">Send Request</button>
                            </div>
                        `;
                    }
                });

                suggestedList.innerHTML = html || '<p>No new suggested users at the moment.</p>';

            } catch (error) {
                suggestedList.innerHTML = '<p style="color: red;">Failed to load suggested users. Check console and Security Rules.</p>';
                console.error("Load Suggested Error:", error);
            }
        }

        async function loadRequests() {
            const requestsList = document.getElementById('requests-list');
            requestsList.innerHTML = '<p>Loading pending requests...</p>';
            if (!currentUser) {
                requestsList.innerHTML = '<p>Please log in.</p>';
                return;
            }

            try {
                // Get all requests where the current user is the receiver
                const snapshot = await db.collection('friendRequests')
                    .where('receiverId', '==', currentUser.uid)
                    .get();

                if (snapshot.empty) {
                    requestsList.innerHTML = '<p>No pending friend requests.</p>';
                    loadUnreadCount(); // Update badge to 0
                    return;
                }
                
                // Get the user data for all senders
                const senderIds = snapshot.docs.map(doc => doc.data().senderId);
                
                // Batch read user profiles (using map/Promise.all for multiple reads)
                const senderProfiles = await Promise.all(
                    senderIds.map(id => db.collection('users').doc(id).get())
                );

                let html = '';
                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const senderProfile = senderProfiles[index].data();
                    
                    if (senderProfile) {
                        html += `
                            <div class="user-card">
                                <div class="user-card-info">
                                    <strong>${senderProfile.username}</strong>
                                    <small>sent you a request.</small>
                                </div>
                                <div>
                                    <button class="neon-btn primary" onclick="acceptRequest('${doc.id}','${data.senderId}')">Accept</button>
                                    <button class="neon-btn danger" onclick="rejectRequest('${doc.id}')">Reject</button>
                                </div>
                            </div>
                        `;
                    }
                });

                requestsList.innerHTML = html;
                loadUnreadCount(snapshot.size); // Update badge with the number of requests

            } catch (error) {
                requestsList.innerHTML = '<p style="color: red;">Failed to load requests. Check console and Security Rules.</p>';
                console.error("Load Requests Error:", error);
            }
        }

        async function loadFriends() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '<p>Loading friends list...</p>';
            if (!currentUser) return;

            try {
                // Step 1: Get the current user's profile to get the friends array
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (!doc.exists) return;
                
                const friendsArray = doc.data().friends || [];

                if (friendsArray.length === 0) {
                    friendsList.innerHTML = '<p>You have no friends yet! Check the Suggested tab.</p>';
                    return;
                }

                // Step 2: Batch read the profiles of all friends
                const friendProfiles = await Promise.all(
                    friendsArray.map(id => db.collection('users').doc(id).get())
                );
                
                let html = '';
                friendProfiles.forEach(friendDoc => {
                    if (friendDoc.exists) {
                        const data = friendDoc.data();
                        html += `
                            <div class="user-card">
                                <div class="user-card-info">
                                    <strong>${data.username}</strong>
                                    <small>Your friend.</small>
                                </div>
                                <button class="neon-btn primary" onclick="startChat('${data.uid}', '${data.username}')">Chat</button>
                            </div>
                        `;
                    }
                });

                friendsList.innerHTML = html;
            } catch (error) {
                friendsList.innerHTML = '<p style="color: red;">Failed to load friends. Check console.</p>';
                console.error("Load Friends Error:", error);
            }
        }

        function loadUnreadCount(count) {
            const badge = document.getElementById('requests-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else if (count === 0) {
                badge.style.display = 'none';
            } else {
                 // If count is not passed, fetch it
                 if (currentUser) {
                    db.collection('friendRequests')
                        .where('receiverId', '==', currentUser.uid)
                        .get()
                        .then(snapshot => loadUnreadCount(snapshot.size))
                        .catch(err => console.error("Badge Load Error:", err));
                 }
            }
        }
        
        // MOCK-UP for the next phase (Messaging)
        function startChat(friendId, friendName) {
            alert(`Opening chat with ${friendName} (${friendId}). This is the next feature we should build!`);
        }

        // ====================================================================
        // 6. GENERAL UI FUNCTIONS
        // ====================================================================

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

    </script>
</body>
</html>
