<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Profiles & Friends</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* --- BASE STYLES --- */
body { 
    margin:0; 
    font-family:'Orbitron',sans-serif; 
    background:#0b0b0b; 
    color:white; 
}
.container { width:90%; max-width: 1000px; margin:auto; padding:20px; }
.hidden { display:none; }

/* --- HEADER & ICON STYLES --- */
.header {
    background: #111;
    border-bottom: 3px solid cyan;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    padding: 10px 0;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.header h1 {
    font-size: 2.5em;
    color: #fff;
    text-shadow: 0 0 5px cyan, 0 0 10px cyan, 0 0 15px magenta;
    margin: 0;
}
.icon-container {
    margin-right: 15px;
    font-size: 2.5em;
    color: cyan;
    text-shadow: 0 0 5px cyan, 0 0 10px magenta;
}

/* --- BUTTON STYLES --- */
.neon-btn { 
    border:2px solid cyan; 
    background:transparent; 
    color:white; 
    padding:8px 14px; 
    margin:5px; 
    border-radius:6px; 
    cursor:pointer; 
    box-shadow:0 0 10px cyan; 
    transition: all 0.2s ease-in-out;
    text-transform: uppercase;
    font-family: 'Orbitron', sans-serif; 
}
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.neon-btn.remove { border-color: red; box-shadow: 0 0 10px red; }
.neon-btn.remove:hover { border-color: orange; box-shadow: 0 0 15px orange; }

/* --- CARD/LAYOUT STYLES --- */
.flex { display:flex; gap:15px; flex-wrap:wrap; }
.card { 
    width:250px; 
    padding:15px; 
    border:2px solid cyan; 
    border-radius:12px; 
    background:#111; 
    box-shadow:0 0 10px cyan; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    margin-bottom: 15px;
    cursor: pointer; 
}
.card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 10px; /* Space before buttons */
}
.avatar { width:50px; height:50px; border-radius:50%; border:2px solid cyan; object-fit:cover; margin-bottom:10px; }

/* --- LED OWNER BADGE STYLES --- */
.owner-badge-box {
    display: inline-block;
    padding: 2px 6px;
    margin-left: 8px;
    font-size: 0.7em; 
    font-weight: bold;
    letter-spacing: 1px;
    border-radius: 4px;
    text-transform: uppercase;
    
    background: #3a005c; 
    color: #ffccff; 
    border: 1px solid #ff00ff; 
    box-shadow: 
        0 0 5px #ff00ff,   
        0 0 10px #cc33ff,  
        inset 0 0 5px #ff00ff; 
    vertical-align: middle;
}

/* --- RATING AND STATUS STYLES --- */
.skill-rating {
    color: gold; /* Classic star color */
    font-size: 1.2em;
    margin-bottom: 5px;
}
.status-indicator {
    font-size: 0.8em;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
    margin-bottom: 10px;
}
.status-online { background-color: #00cc00; color: #0b0b0b; box-shadow: 0 0 5px #00ff00; }
.status-ingame { background-color: #ffaa00; color: #0b0b0b; box-shadow: 0 0 5px #ffaa00; }
.status-lfd { background-color: #00aaff; color: #0b0b0b; box-shadow: 0 0 5px #00aaff; }

/* --- MESSAGE STYLES --- */
.message-container { 
    background: #181818; 
    border-radius: 8px; 
    padding: 15px; 
    margin-top: 15px; 
    border: 1px solid #333;
}
.message-item {
    border-bottom: 1px dashed #444;
    padding: 10px 0;
}
.message-item:last-child { border-bottom: none; }
.message-header { font-size: 0.9em; color: cyan; margin-bottom: 5px; }
.message-body { font-size: 1em; }
.message-unread { background-color: #2a0038; border-left: 5px solid magenta; padding-left: 10px; }

/* --- UNREAD COUNT BADGE --- */
.unread-badge {
    background-color: magenta;
    color: white;
    border-radius: 50%;
    padding: 2px 7px;
    margin-left: 5px;
    font-size: 0.7em;
    font-weight: bold;
    box-shadow: 0 0 5px magenta;
}

/* --- PROFILE EDITOR STYLES --- */
#profileEditor {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 20px;
    border: 2px solid magenta;
    border-radius: 12px;
    background: #111;
    box-shadow: 0 0 15px magenta;
    max-width: 500px;
    margin: 20px auto;
}
#profileEditor label {
    font-weight: bold;
    color: cyan;
}
#profileEditor input, #profileEditor textarea, #profileEditor select {
    padding: 10px;
    border: 1px solid #333;
    background: #222;
    color: white;
    border-radius: 6px;
    font-family: inherit;
    outline: none;
}
#currentAvatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid cyan;
    align-self: center;
    object-fit: cover;
    margin-bottom: 15px;
}

/* --- PROFILE VIEWER STYLES --- */
#profileViewer {
    padding: 20px;
    border: 2px solid cyan;
    border-radius: 12px;
    background: #111;
    box-shadow: 0 0 15px cyan;
    max-width: 700px;
    margin: 20px auto;
}
.profile-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px dashed magenta;
    padding-bottom: 15px;
}
.profile-header img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid magenta;
    margin-right: 20px;
    object-fit: cover;
}
.profile-header h2 {
    margin: 0;
    font-size: 2.2em;
    color: magenta;
    text-shadow: 0 0 5px magenta;
}
.profile-section h3 {
    border-left: 5px solid cyan;
    padding-left: 10px;
    margin-top: 20px;
    color: cyan;
}
.game-tag {
    display: inline-block;
    background: #222;
    border: 1px solid #444;
    padding: 5px 10px;
    margin-right: 8px;
    margin-bottom: 8px;
    border-radius: 4px;
    font-size: 0.9em;
}
</style>
</head>
<body>

<div class="header">
    <div class="icon-container">
        ⚡
    </div>
    <h1>DUO UP</h1>
</div>

<div id="loginPage" class="container">
  <p>Find your perfect partner and dominate the cyber-arena.</p>
  <button class="neon-btn" onclick="login()">Login with Google</button>
</div>

<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <div style="margin-bottom: 20px;">
    <button class="neon-btn" onclick="showTab('suggested')">Suggested</button>
    <button class="neon-btn" onclick="showTab('requests')">Requests</button>
    <button id="friendsBtn" class="neon-btn" onclick="showTab('friends')">
        Friends <span id="unreadBadge" class="unread-badge hidden">0</span>
    </button>
    <button class="neon-btn" onclick="showTab('profile')">Profile</button>
    <button class="neon-btn" onclick="logout()">Logout</button>
  </div>

  <div id="suggestedTab" class="flex"></div>
  <div id="requestsTab" class="flex hidden"></div>
  <div id="friendsTab" class="flex hidden"></div>
  <div id="profileTab" class="hidden">
    <div id="profileEditor">
        <img id="currentAvatar" src="" alt="Current Profile Picture">
        
        <p><b>Nickname:</b> <span id="currentNicknameDisplay"></span></p>

        <label for="bioInput">Bio:</label>
        <textarea id="bioInput" rows="3" maxlength="150" placeholder="Tell the community about yourself..."></textarea>
        
        <label for="gamesInput">Favorite Games (Comma Separated):</label>
        <input type="text" id="gamesInput" placeholder="Valorant, League of Legends, Apex">
        
        <label for="skillRatingInput">Skill Rating (1-5 Stars):</label>
        <select id="skillRatingInput">
            <option value="1">⭐ 1 Star (Casual)</option>
            <option value="2">⭐⭐ 2 Stars (Intermediate)</option>
            <option value="3">⭐⭐⭐ 3 Stars (Competent)</option>
            <option value="4">⭐⭐⭐⭐ 4 Stars (Advanced)</option>
            <option value="5">⭐⭐⭐⭐⭐ 5 Stars (Expert)</option>
        </select>

        <label for="statusInput">Current Status:</label>
        <select id="statusInput">
            <option value="Online">Online</option>
            <option value="Looking for Duo">Looking for Duo</option>
            <option value="In Game">In Game</option>
            <option value="Away">Away</option>
        </select>
        
        <label for="avatarUrlInput">Profile Picture URL:</label>
        <input type="url" id="avatarUrlInput" placeholder="https://example.com/image.jpg" oninput="document.getElementById('currentAvatar').src = this.value || DEFAULT_AVATAR">

        <button class="neon-btn" onclick="saveProfile()">Save Profile</button>
    </div>
  </div>

  <div id="profileViewer" class="hidden">
    </div>
</div>


<script>
// --- FIREBASE CONFIGURATION (UPDATE THIS BLOCK) ---
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

// --- OWNER UID CONSTANT (CRITICAL: YOUR OWNER ID) ---
const OWNER_UID = "DecuxiBRxoSwb8wKMmaHQKql9HQ2"; 

let currentUser = null;
let unreadMessageCount = 0; 

// Helper function to render the Owner Badge (LED Box)
function getOwnerBadge(uid) {
    if (uid === OWNER_UID) {
        return '<span class="owner-badge-box" title="App Owner">OWNER</span>';
    }
    return '';
}

// Helper function to render star rating
function renderSkillRating(rating) {
    rating = parseInt(rating) || 0;
    const filledStars = '⭐'.repeat(rating);
    const emptyStars = '☆'.repeat(5 - rating);
    return `<div class="skill-rating" title="Skill Rating: ${rating}/5">${filledStars}${emptyStars}</div>`;
}

// Helper function to render status
function renderStatus(status) {
    let statusClass = '';
    let displayStatus = status || 'Away';
    
    if (displayStatus === 'Online') {
        statusClass = 'status-online';
    } else if (displayStatus === 'In Game') {
        statusClass = 'status-ingame';
    } else if (displayStatus === 'Looking for Duo') {
        statusClass = 'status-lfd';
    } else {
        statusClass = ''; // Default style for Away
    }

    return `<div class="status-indicator ${statusClass}">${displayStatus}</div>`;
}


// ---------------- LOGIN/AUTH ----------------
function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  currentUser = user;

  const userDocRef = db.collection("users").doc(user.uid);
  const userDoc = await userDocRef.get();
  
  if(!userDoc.exists){
    await userDocRef.set({
      uid: user.uid,
      nickname: user.displayName||"Player", 
      bio: "", 
      games: [], 
      friends: [],
      nicknames: {}, 
      profileImageUrl: user.photoURL||DEFAULT_AVATAR,
      skillRating: 3, 
      status: "Online"
    });
  }

  const data = (await userDocRef.get()).data();
  document.getElementById("welcome").innerHTML = `Welcome, ${data.nickname}${getOwnerBadge(data.uid)}`;

  loadUnreadCount(); 
  loadSuggested();
  loadRequests();
  loadFriends();
  loadProfileEditor(data); 
});

function logout(){ 
    auth.signOut(); 
}

function hideAllTabs() {
    suggestedTab.classList.add("hidden");
    requestsTab.classList.add("hidden");
    friendsTab.classList.add("hidden");
    profileTab.classList.add("hidden");
    profileViewer.classList.add("hidden");
}

function showTab(tab){
  hideAllTabs();

  const tabElement = document.getElementById(tab+"Tab");
  if (tabElement) {
    tabElement.classList.remove("hidden");
  }

  if (tab === 'profile') {
      db.collection("users").doc(currentUser.uid).get().then(doc => {
          loadProfileEditor(doc.data());
      });
  } else if (tab === 'suggested') {
      loadSuggested();
  } else if (tab === 'requests') {
      loadRequests();
  } else if (tab === 'friends') {
      loadFriends();
  }
}

// ---------------- MESSAGE FUNCTIONS ----------------

async function loadUnreadCount() {
    if (!currentUser) return;

    try {
        const snap = await db.collection("messages")
            .where("receiverId", "==", currentUser.uid)
            .where("read", "==", false)
            .get();
        
        unreadMessageCount = snap.docs.length;
        const badge = document.getElementById('unreadBadge');
        
        if (unreadMessageCount > 0) {
            badge.textContent = unreadMessageCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    } catch (error) {
        console.error("Error loading unread count:", error);
    }
}

async function sendMessage(receiverId) {
    if (!currentUser) return;

    const messageContent = prompt("Enter your message (max 150 chars):");
    if (messageContent === null || messageContent.trim() === "") return;
    
    const trimmedContent = messageContent.trim().substring(0, 150);

    try {
        await db.collection("messages").add({
            senderId: currentUser.uid,
            receiverId: receiverId,
            content: trimmedContent,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false
        });
        alert("Message sent!");
    } catch (error) {
        alert("Error sending message.");
        console.error("Send Message Error:", error);
    }
}

async function loadMessagesForProfile(targetUserId, targetNickname) {
    const messageContainer = document.getElementById('messageInbox');
    messageContainer.innerHTML = '<p>Loading messages...</p>';

    // Load messages sent TO ME from this friend
    const incomingSnap = await db.collection("messages")
        .where("senderId", "==", targetUserId)
        .where("receiverId", "==", currentUser.uid)
        .orderBy("timestamp", "desc")
        .get();

    // Load messages sent BY ME to this friend
    const outgoingSnap = await db.collection("messages")
        .where("senderId", "==", currentUser.uid)
        .where("receiverId", "==", targetUserId)
        .orderBy("timestamp", "desc")
        .get();

    const allMessages = [
        ...incomingSnap.docs.map(doc => ({ ...doc.data(), id: doc.id, type: 'incoming' })),
        ...outgoingSnap.docs.map(doc => ({ ...doc.data(), id: doc.id, type: 'outgoing' }))
    ];

    // Sort all messages by timestamp (newest first)
    allMessages.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

    if (allMessages.length === 0) {
        messageContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">No messages exchanged yet.</p>';
        return;
    }

    let messageHtml = '';
    const unreadIds = [];

    allMessages.forEach(msg => {
        const sender = msg.senderId === currentUser.uid ? "You" : targetNickname;
        const senderColor = msg.senderId === currentUser.uid ? 'cyan' : 'magenta';
        const date = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : 'N/A';
        const unreadClass = (msg.type === 'incoming' && !msg.read) ? ' message-unread' : '';
        
        if (msg.type === 'incoming' && !msg.read) {
            unreadIds.push(msg.id);
        }

        messageHtml += `
            <div class="message-item${unreadClass}">
                <div class="message-header" style="color:${senderColor};">
                    ${sender} @ ${date}
                </div>
                <div class="message-body">${msg.content}</div>
            </div>
        `;
    });

    messageContainer.innerHTML = messageHtml;

    // Mark messages as read and reload the unread count
    if (unreadIds.length > 0) {
        const batch = db.batch();
        unreadIds.forEach(id => {
            const msgRef = db.collection('messages').doc(id);
            batch.update(msgRef, { read: true });
        });
        batch.commit().then(() => {
            loadUnreadCount(); // Update the main dashboard badge
        }).catch(error => {
            console.error("Error marking messages as read:", error);
        });
    }
}


// ---------------- PROFILE VIEWER LOGIC ----------------

function loadOtherUsersFriendsStatic(friendCount, containerElement) {
    containerElement.innerHTML = `<p style="opacity: 0.8;">This player has **${friendCount}** connections. Connect with them to find your next duo!</p>`;
}

async function viewProfile(targetUserId) {
    if (targetUserId === currentUser.uid) {
        showTab('profile');
        return;
    }
    
    hideAllTabs();
    profileViewer.classList.remove("hidden");
    profileViewer.innerHTML = '<p style="text-align: center;">Loading profile data...</p>';

    try {
        const userDoc = await db.collection("users").doc(targetUserId).get();
        if (!userDoc.exists) {
            profileViewer.innerHTML = `<p style="color:red; text-align: center;">Error: User profile not found.</p>`;
            return;
        }

        const u = userDoc.data();
        const gamesList = (u.games || []).map(g => `<span class="game-tag">${g}</span>`).join('');
        const bioText = u.bio || "No biography provided.";
        const friendIds = u.friends || [];

        // Determine relationship status
        const myData = (await db.collection("users").doc(currentUser.uid).get()).data();
        const isFriend = myData.friends.includes(targetUserId);
        
        const hasPendingRequestSnap = await db.collection("friendRequests")
            .where("senderId", "in", [currentUser.uid, targetUserId])
            .where("receiverId", "in", [currentUser.uid, targetUserId])
            .get();
        const hasPendingRequest = !hasPendingRequestSnap.empty;

        let actionButtonHTML = '';
        if (isFriend) {
            actionButtonHTML = `<button class="neon-btn" onclick="event.stopPropagation(); sendMessage('${targetUserId}');">Send Message</button>
                                <button class="neon-btn remove" onclick="removeFriend('${targetUserId}'); showTab('friends');">Remove Friend</button>`;
        } else if (hasPendingRequest) {
            actionButtonHTML = '<button class="neon-btn" style="border-color: yellow; box-shadow: 0 0 10px yellow; cursor: default;">Request Pending</button>';
        } else {
            actionButtonHTML = `<button class="neon-btn" onclick="sendRequest('${targetUserId}'); showTab('suggested');">Send Request</button>`;
        }

        const badgeHtml = getOwnerBadge(u.uid);
        const statusHtml = renderStatus(u.status);
        const ratingHtml = renderSkillRating(u.skillRating);


        profileViewer.innerHTML = `
            <button class="neon-btn" style="margin-bottom: 20px;" onclick="showTab('suggested')">← Back</button>

            <div class="profile-header">
                <img src="${u.profileImageUrl || DEFAULT_AVATAR}" alt="${u.nickname}">
                <div>
                    <h2>${u.nickname}${badgeHtml}</h2>
                    ${statusHtml}
                    ${ratingHtml}
                    <div style="margin-top: 10px;">${actionButtonHTML}</div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Bio</h3>
                <p>${bioText}</p>
            </div>

            <div class="profile-section">
                <h3>Favorite Games</h3>
                <div>${gamesList || '<p>No favorite games listed.</p>'}</div>
            </div>
            
            ${isFriend ? `
                <div class="profile-section">
                    <h3>Messages with ${u.nickname}</h3>
                    <div id="messageInbox" class="message-container"></div>
                </div>
            ` : ''}

            <div class="profile-section">
                <h3>${u.nickname}'s Connections (${friendIds.length})</h3>
                <div id="otherUsersFriendsList" style="padding: 10px; border: 1px dashed #555; border-radius: 8px;">
                    </div>
            </div>
        `;
        
        loadOtherUsersFriendsStatic(friendIds.length, document.getElementById('otherUsersFriendsList'));

        if (isFriend) {
            // Only load messages if they are friends
            loadMessagesForProfile(targetUserId, u.nickname);
        }

    } catch(error) {
        profileViewer.innerHTML = `<p style="color:red; text-align: center;">Failed to load profile. Please check your browser console and ensure your Firebase Rules permit reading the /users and /messages collections.</p>`;
        console.error("View Profile Error:", error);
    }
}

// ---------------- PROFILE EDITOR FUNCTIONS ----------------
function loadProfileEditor(data){
    data = data || {};
    // Display current read-only nickname with badge
    currentNicknameDisplay.innerHTML = `${data.nickname || "Player"}${getOwnerBadge(currentUser.uid)}`;
    
    bioInput.value = data.bio || "";
    gamesInput.value = (data.games || []).join(', ');
    avatarUrlInput.value = data.profileImageUrl || currentUser.photoURL || "";
    currentAvatar.src = data.profileImageUrl || currentUser.photoURL || DEFAULT_AVATAR;

    // Load status and rating fields
    skillRatingInput.value = data.skillRating || "3";
    statusInput.value = data.status || "Online";
}

async function saveProfile(){
    if (!currentUser) return;
    
    // Fetch current nickname (since it's read-only)
    const currentData = (await db.collection("users").doc(currentUser.uid).get()).data();
    const currentNickname = currentData.nickname;

    const gamesArray = gamesInput.value.split(',').map(game => game.trim()).filter(game => game !== '');
    
    const profileUpdates = {
        bio: bioInput.value.trim(),
        games: gamesArray,
        profileImageUrl: avatarUrlInput.value.trim() || DEFAULT_AVATAR,
        skillRating: parseInt(skillRatingInput.value),
        status: statusInput.value
    };

    try {
        await db.collection("users").doc(currentUser.uid).update(profileUpdates);
        alert("Profile updated successfully!");
        
        // Update welcome message 
        document.getElementById("welcome").innerHTML = `Welcome, ${currentNickname}${getOwnerBadge(currentUser.uid)}`;
        
        loadSuggested();
        loadFriends();
    } catch(error) {
        alert("Error saving profile.");
        console.error("Profile Save Error:", error);
    }
}

async function saveFriendNickname(friendId, currentNickname) {
    const customName = prompt(`Enter a nickname for ${currentNickname}:`, currentNickname);
    if (customName === null) return; 

    const trimmedName = customName.trim();
    if (trimmedName === '') {
        alert("Nickname cannot be empty.");
        return;
    }

    const myRef = db.collection("users").doc(currentUser.uid);
    const nicknameField = `nicknames.${friendId}`;
    
    try {
        await myRef.update({
            [nicknameField]: trimmedName
        });
        
        alert(`Nickname for ${currentNickname} saved as "${trimmedName}".`);
        loadFriends(); 
    } catch (error) {
        alert("Failed to save friend nickname.");
        console.error("Save Nickname Error:", error);
    }
}

// ---------------- LOAD FUNCTIONS ----------------

async function loadSuggested(){
  suggestedTab.innerHTML="<p>Loading suggested users...</p>";
  
  try {
      const usersSnap = await db.collection("users").get(); 
      const me = (await db.collection("users").doc(currentUser.uid).get()).data();
      suggestedTab.innerHTML = ""; 

      const myFriends = me.friends || [];
      const mySentRequestsSnap = await db.collection("friendRequests").where("senderId", "==", currentUser.uid).get();
      const myReceivedRequestsSnap = await db.collection("friendRequests").where("receiverId", "==", currentUser.uid).get();

      const pendingUsers = new Set();
      mySentRequestsSnap.forEach(doc => pendingUsers.add(doc.data().receiverId));
      myReceivedRequestsSnap.forEach(doc => pendingUsers.add(doc.data().senderId));

      let suggestedCount = 0;
      usersSnap.forEach(doc=>{
        if(doc.id === currentUser.uid) return; 
        if(myFriends.includes(doc.id)) return; 
        if(pendingUsers.has(doc.id)) return; 
        
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute('onclick', `viewProfile('${doc.id}')`);
        
        const badgeHtml = getOwnerBadge(u.uid);
        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">Games: ${u.games.slice(0, 2).join(', ')}...</p>` : '';
        const ratingHtml = renderSkillRating(u.skillRating);
        const statusHtml = renderStatus(u.status);


        card.innerHTML = `
            <div class="card-content">
                <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
                <strong>${u.nickname}${badgeHtml}</strong>
                ${ratingHtml}
                ${statusHtml}
                ${gamesPreview}
            </div>
            <button class="neon-btn" onclick="event.stopPropagation(); sendRequest('${doc.id}')">Send Request</button>
        `;
        suggestedTab.appendChild(card);
        suggestedCount++;
      });

      if (suggestedCount === 0) {
          suggestedTab.innerHTML="<p>No suggested players available right now.</p>";
      }
  } catch(error) {
      suggestedTab.innerHTML = `<p style="color:red;">Error loading suggested users: ${error.message}</p>`;
      console.error("Suggested Load Error:", error);
  }
}

async function loadRequests(){
  requestsTab.innerHTML="<p>Loading requests...</p>";
  
  try {
      const snap = await db.collection("friendRequests").where("receiverId","==",currentUser.uid).get();
      requestsTab.innerHTML = ""; 
      if(snap.empty){ 
        requestsTab.innerHTML="<p>No friend requests</p>"; 
        return; 
      }

      const requestPromises = snap.docs.map(async doc => {
        const r = doc.data();
        const senderDoc = await db.collection("users").doc(r.senderId).get();
        if (!senderDoc.exists) return null; 
        return { 
          requestId: doc.id,
          senderId: r.senderId,
          user: senderDoc.data()
        };
      });
      
      const requestsData = (await Promise.all(requestPromises)).filter(item => item !== null);

      requestsData.forEach(data => {
        const u = data.user;
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute('onclick', `viewProfile('${data.senderId}')`);

        const badgeHtml = getOwnerBadge(u.uid);
        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">Games: ${u.games.slice(0, 2).join(', ')}...</p>` : '';
        const ratingHtml = renderSkillRating(u.skillRating);
        const statusHtml = renderStatus(u.status);


        card.innerHTML = `
            <div class="card-content">
                <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
                <strong>${u.nickname}${badgeHtml}</strong>
                ${ratingHtml}
                ${statusHtml}
                ${gamesPreview}
            </div>
            <button class="neon-btn" onclick="event.stopPropagation(); acceptRequest('${data.requestId}','${data.senderId}')">Accept</button>
            <button class="neon-btn" onclick="event.stopPropagation(); rejectRequest('${data.requestId}')">Reject</button>
        `;
        requestsTab.appendChild(card);
      });
  } catch (error) {
      requestsTab.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
      console.error("Requests Load Error:", error);
  }
}

async function loadFriends(){
  friendsTab.innerHTML="<p>Loading friends...</p>";
  
  try {
      const meDoc = await db.collection("users").doc(currentUser.uid).get();
      const me = meDoc.data();
      friendsTab.innerHTML = ""; 
      
      const myFriends = me.friends || [];
      const myNicknames = me.nicknames || {}; 

      if(myFriends.length===0){ 
        friendsTab.innerHTML="<p>No friends yet. Time to find a duo!</p>"; 
        return; 
      }
      
      const friendPromises = myFriends.map(fid => db.collection("users").doc(fid).get());
      const friendDocs = await Promise.all(friendPromises);

      friendDocs.forEach(doc => {
        if (!doc.exists) return; 
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute('onclick', `viewProfile('${doc.id}')`);

        const displayNickname = myNicknames[doc.id] || u.nickname;

        const badgeHtml = getOwnerBadge(u.uid);
        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">Games: ${u.games.slice(0, 2).join(', ')}...</p>` : '';
        const ratingHtml = renderSkillRating(u.skillRating);
        const statusHtml = renderStatus(u.status);


        card.innerHTML = `
            <div class="card-content">
                <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
                <strong>${displayNickname}${badgeHtml}</strong>
                ${ratingHtml}
                ${statusHtml}
                ${gamesPreview}
            </div>
            <button class="neon-btn" onclick="event.stopPropagation(); saveFriendNickname('${doc.id}', '${u.nickname}')">Edit Nickname</button>
            <button class="neon-btn remove" onclick="event.stopPropagation(); removeFriend('${doc.id}')">Remove</button>
        `;
        friendsTab.appendChild(card);
      });
  } catch (error) {
      friendsTab.innerHTML = `<p style="color:red;">Error loading friends: ${error.message}</p>`;
      console.error("Friends Load Error:", error);
  }
}

// ---------------- FRIEND ACTIONS ----------------

async function sendRequest(receiverId){
  try {
      const existingRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", currentUser.uid)
        .where("receiverId", "==", receiverId)
        .get();

      const reverseRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", receiverId)
        .where("receiverId", "==", currentUser.uid)
        .get();

      if (!existingRequestSnap.empty || !reverseRequestSnap.empty) {
        alert("A friend request is already pending with this user!");
        return; 
      }

      await db.collection("friendRequests").add({
        senderId: currentUser.uid,
        receiverId: receiverId
      });
      
      alert("Request sent!"); 
      loadSuggested(); 
  } catch(err) {
      alert("Error sending request: " + err.message);
      console.error("Send Request Error:", err);
  }
}

function acceptRequest(requestId,senderId){
  const meRef = db.collection("users").doc(currentUser.uid);
  const senderRef = db.collection("users").doc(senderId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayUnion(senderId)});
    transaction.update(senderRef, {friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
    transaction.delete(db.collection("friendRequests").doc(requestId));
  }).then(() => {
    alert("Request accepted! You are now friends.");
    showTab('friends'); 
  }).catch(err => {
    alert("Transaction failed (Accept Request): " + err.message);
    console.error("Accept Request Error:", err);
  });
}

function rejectRequest(requestId){
  db.collection("friendRequests").doc(requestId).delete().then(() => {
    alert("Request rejected.");
    loadRequests();
  }).catch(err => {
    alert("Error rejecting request: " + err.message);
    console.error("Reject Request Error:", err);
  });
}

function removeFriend(friendId){
  if(!confirm("Are you sure you want to remove this friend?")) return;

  const meRef = db.collection("users").doc(currentUser.uid);
  const friendRef = db.collection("users").doc(friendId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayRemove(friendId)});
    transaction.update(friendRef, {friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)});
  }).then(() => {
    alert("Friend removed successfully.");
    showTab('friends'); 
  }).catch(err => {
    alert("Removal failed (Remove Friend): " + err.message);
    console.error("Remove Friend Error:", err);
  });
}

</script>
</body>
</html>
