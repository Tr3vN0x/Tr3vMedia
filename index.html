<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO Up</title>
<link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body { margin:0; font-family:'Orbitron',sans-serif; background:linear-gradient(270deg,#0D0D0D,#1A1A1A,#0D0D0D); background-size:600% 600%; animation:gradientAnimation 15s ease infinite; color:white; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
@keyframes gradientAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
.hidden{ display:none; }
.neon-btn{ padding:8px 20px; font-weight:bold; color:white; background:transparent; border:2px solid #00FFFF; border-radius:6px; cursor:pointer; box-shadow:0 0 5px #00FFFF,0 0 10px #00FFFF,0 0 20px #00FFFF; margin:5px; }
.neon-btn:hover{ border-color:#FF00FF; box-shadow:0 0 10px #FF00FF,0 0 20px #FF00FF,0 0 30px #FF00FF; }
input, select{ padding:8px; border-radius:6px; border:2px solid #00FFFF; background:transparent; color:white; margin:5px 0; }
.header{ display:flex; justify-content:space-between; width:90%; margin-top:10px; }
.main{ display:flex; gap:20px; width:90%; margin-top:20px; }
.card-container{ display:flex; flex-wrap:wrap; gap:15px; }
.card{ background:#1A1A1A; border:2px solid #00FFFF; border-radius:16px; padding:15px; width:280px; box-shadow:0 0 5px #00FFFF,0 0 10px #00FFFF,0 0 20px #00FFFF; transition:0.3s; }
.card:hover{ border-color:#FF00FF; box-shadow:0 0 10px #FF00FF,0 0 20px #FF00FF,0 0 30px #FF00FF; }
.chat-panel{ background:#0D0D0D; border:2px solid #FF00FF; border-radius:16px; padding:15px; width:400px; max-height:400px; display:flex; flex-direction:column; gap:10px; overflow-y:auto; }
.message{ display:flex; align-items:flex-end; gap:10px; }
.message.outgoing{ flex-direction:row-reverse; }
.message-bubble{ padding:10px 15px; border-radius:12px; max-width:70%; word-wrap: break-word; position: relative; }
.neon-incoming{ background:#1A1A1A; border:2px solid #00FFFF; box-shadow:0 0 5px #00FFFF,0 0 10px #00FFFF,0 0 20px #00FFFF; }
.neon-outgoing{ background:#1A1A1A; border:2px solid #FF00FF; box-shadow:0 0 5px #FF00FF,0 0 10px #FF00FF,0 0 20px #FF00FF; }
#profileEditor{ background:#1A1A1A; border:2px solid #00FFFF; border-radius:12px; padding:15px; width:300px; margin-top:20px; }
#profilePreview{ width:80px; height:80px; border-radius:50%; border:2px solid #00FFFF; margin-bottom:10px; object-fit:cover; }
.status-dot{ width:12px; height:12px; border-radius:50%; display:inline-block; margin-left:5px; }
.avatar{ width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:10px; }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
  <h1>DUO Up</h1>
  <button type="button" class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- Pick Username Page -->
<div id="pickUsernamePage" class="hidden">
  <h2>Pick Your Username</h2>
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button type="button" class="neon-btn" onclick="saveUsername()">Submit</button>
  <button type="button" class="neon-btn" onclick="logout()">Logout</button>
</div>

<!-- Dashboard -->
<div id="dashboardPage" class="hidden">
  <div class="header">
    <span id="welcomeUsername">Welcome, Gamer</span>
    <div>
      <button class="neon-btn" onclick="openProfileEditor()">Edit Profile</button>
      <button class="neon-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">
    <div>
      <h2>Friend Requests</h2>
      <div class="card-container" id="requestsTab"></div>

      <h2>Friends</h2>
      <div class="card-container" id="friendsTab"></div>
    </div>

    <div>
      <h2>Chat</h2>
      <div class="chat-panel" id="chatPanel"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button class="neon-btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Profile Editor -->
  <div id="profileEditor" class="hidden">
    <h2>Edit Profile</h2>
    <div>
      <img id="profilePreview" src="" alt="Profile Preview">
      <input type="file" id="profileImageInput" accept="image/*">
    </div>
    <input type="text" id="editUsername" placeholder="Username">
    <input type="text" id="editStatus" placeholder="Status message">
    <div id="gameSelection"></div>
    <button class="neon-btn" onclick="saveProfile()">Save</button>
    <button class="neon-btn" onclick="closeProfileEditor()">Cancel</button>
  </div>
</div>

<script>
const DEFAULT_AVATAR="https://cdn-icons-png.flaticon.com/512/3135/3135715.png";

const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89",
  measurementId:"G-46B67F90FK"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

const loginPage=document.getElementById("loginPage");
const pickUsernamePage=document.getElementById("pickUsernamePage");
const dashboardPage=document.getElementById("dashboardPage");
const profileImageInput=document.getElementById("profileImageInput");
const profilePreview=document.getElementById("profilePreview");
const requestsTab=document.getElementById("requestsTab");
const friendsTab=document.getElementById("friendsTab");
let activeChatUser=null;

// ---------------- Google Login ----------------
function loginWithGoogle(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result=>{
    checkNickname(result.user);
  }).catch(err=>alert("Google login failed: "+err.message));
}

function checkNickname(user){
  const userRef=db.collection("users").doc(user.uid);
  userRef.get().then(doc=>{
    if(doc.exists && doc.data().nickname){
      showDashboard(doc.data());
    } else {
      loginPage.classList.add("hidden");
      pickUsernamePage.classList.remove("hidden");
    }
  });
}

// ---------------- Pick Username ----------------
function saveUsername(){
  const nickname=document.getElementById("usernameInput").value.trim();
  if(!nickname) return alert("Enter a username");
  const user=auth.currentUser;
  if(!user) return alert("No logged-in user found");

  db.collection("users").doc(user.uid).set({
    nickname: nickname,
    uid: user.uid,
    email: user.email,
    authType: "google",
    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
    bio: "",
    friends: [],
    profileImageUrl: user.photoURL || DEFAULT_AVATAR,
    isPremium: false,
    status: "online",
    favoriteGames: []
  }, {merge:true}).then(()=>{
    pickUsernamePage.classList.add("hidden");
    showDashboard({nickname: nickname, profileImageUrl: user.photoURL || DEFAULT_AVATAR});
  }).catch(err=>alert("Error saving username: "+err.message));
}

// ---------------- Dashboard ----------------
function showDashboard(userData){
  dashboardPage.classList.remove("hidden");
  loginPage.classList.add("hidden");
  pickUsernamePage.classList.add("hidden");
  document.getElementById("welcomeUsername").innerText="Welcome, "+userData.nickname;
  if(userData.profileImageUrl) profilePreview.src=userData.profileImageUrl;
  loadRequests();
  loadFriends();
}

// ---------------- Logout ----------------
function logout(){
  auth.signOut().then(()=>{
    loginPage.classList.remove("hidden");
    pickUsernamePage.classList.add("hidden");
    dashboardPage.classList.add("hidden");
  });
}

// ---------------- Profile Editor ----------------
profileImageInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(ev){ profilePreview.src = ev.target.result; };
    reader.readAsDataURL(file);
  }
});

function openProfileEditor(){
  document.getElementById("profileEditor").classList.remove("hidden");
  const userRef=db.collection("users").doc(auth.currentUser.uid);
  userRef.get().then(doc=>{
    const data=doc.data();
    document.getElementById("editUsername").value=data.nickname||"";
    document.getElementById("editStatus").value=data.status||"";
    profilePreview.src = data.profileImageUrl || DEFAULT_AVATAR;
  });
}

function closeProfileEditor(){
  document.getElementById("profileEditor").classList.add("hidden");
}

function saveProfile(){
  const nickname=document.getElementById("editUsername").value.trim();
  const status=document.getElementById("editStatus").value.trim();
  const file=profileImageInput.files[0];
  const userId=auth.currentUser.uid;
  if(!nickname) return alert("Username cannot be empty");

  function saveData(profileImageUrl){
    db.collection("users").doc(userId).set({
      nickname: nickname,
      status: status,
      profileImageUrl: profileImageUrl,
      lastActive: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true}).then(()=>{
      document.getElementById("welcomeUsername").innerText="Welcome, "+nickname;
      profilePreview.src=profileImageUrl;
      closeProfileEditor();
      loadFriends();
      loadRequests();
    }).catch(err=>alert("Error saving profile: "+err.message));
  }

  if(file){
    const storageRef=storage.ref(`profileImages/${userId}/${file.name}`);
    storageRef.put(file).then(snap=>snap.ref.getDownloadURL()).then(url=>saveData(url))
      .catch(err=>alert("Upload failed: "+err.message));
  } else {
    saveData(profilePreview.src || DEFAULT_AVATAR);
  }
}

// ---------------- FRIEND REQUESTS ----------------
function loadRequests(){
  db.collection("friendRequests")
    .where("receiverId","==",auth.currentUser.uid)
    .where("status","==","pending")
    .onSnapshot(snap=>{
      requestsTab.innerHTML="";
      if(snap.empty){ requestsTab.innerHTML="<p>No requests</p>"; return; }
      snap.forEach(r=>{
        db.collection("users").doc(r.data().senderId).get().then(u=>{
          const d=u.data();
          const card=document.createElement("div");
          card.className="card";
          card.innerHTML=`<div class="user">
            <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
            <strong>${d.nickname}</strong></div>
            <button class="neon-btn" onclick="acceptRequest('${r.id}','${u.id}')">Accept</button>
            <button class="neon-btn" onclick="rejectRequest('${r.id}')">Reject</button>`;
          requestsTab.appendChild(card);
        });
      });
    });
}

function acceptRequest(requestId, senderId){
  const currentUserId = auth.currentUser.uid;
  const batch = db.batch();
  batch.update(db.collection("friendRequests").doc(requestId), {status:"accepted"});
  batch.update(db.collection("users").doc(currentUserId), {friends: firebase.firestore.FieldValue.arrayUnion(senderId)});
  batch.update(db.collection("users").doc(senderId), {friends: firebase.firestore.FieldValue.arrayUnion(currentUserId)});
  batch.commit().then(()=>{
    loadFriends();
    loadRequests();
  }).catch(err=>alert("Error accepting request: "+err.message));
}

function rejectRequest(requestId){
  db.collection("friendRequests").doc(requestId).update({status:"rejected"})
    .then(()=>loadRequests());
}

// ---------------- FRIENDS ----------------
function loadFriends(){
  const userRef=db.collection("users").doc(auth.currentUser.uid);
  userRef.get().then(doc=>{
    friendsTab.innerHTML="";
    const friends=doc.data().friends||[];
    if(friends.length===0){ friendsTab.innerHTML="<p>No friends yet</p>"; return; }
    friends.forEach(fid=>{
      db.collection("users").doc(fid).get().then(u=>{
        const d=u.data();
        const avatar=d.profileImageUrl||DEFAULT_AVATAR;
        const statusColor=d.status==="online"?"green":"gray";
        if(document.getElementById("friend-"+fid)) return;
        const card=document.createElement("div");
        card.id="friend-"+fid;
        card.className="card";
        card.innerHTML=`<div class="user">
          <img class="avatar" src="${avatar}">
          <strong>${d.nickname}</strong>
          <span class="status-dot" style="background:${statusColor}"></span>
        </div>
        <button class="neon-btn" onclick="openChat('${fid}')">Chat</button>`;
        friendsTab.appendChild(card);
      });
    });
  });
}

// ---------------- CHAT ----------------
function openChat(friendId){
  activeChatUser=friendId;
  const friendDataRef=db.collection("users").doc(friendId);
  friendDataRef.get().then(doc=>{
    chatPanel.innerHTML=`<h3>Chat with ${doc.data().nickname}</h3>`;
    loadMessages();
  });
}

function loadMessages(){
  if(!activeChatUser) return;
  db.collection("messages")
    .where("senderId","in",[auth.currentUser.uid, activeChatUser])
    .where("receiverId","in",[auth.currentUser.uid, activeChatUser])
    .orderBy("timestamp")
    .onSnapshot(snap=>{
      chatPanel.innerHTML="";
      snap.forEach(m=>{
        if(!((m.data().senderId===auth.currentUser.uid && m.data().receiverId===activeChatUser) ||
             (m.data().senderId===activeChatUser && m.data().receiverId===auth.currentUser.uid))) return;
        const div=document.createElement("div");
        div.className="message "+(m.data().senderId===auth.currentUser.uid?"outgoing":"incoming");
        div.innerHTML=`<div class="message-bubble ${m.data().senderId===auth.currentUser.uid?"neon-outgoing":"neon-incoming"}">
          ${m.data().content} <br><small>${m.data().timestamp?.toDate?.()?.toLocaleString()||""}</small>
        </div>`;
        chatPanel.appendChild(div);
      });
      chatPanel.scrollTop=chatPanel.scrollHeight;
    });
}

function sendMessage(){
  const input=document.getElementById("messageInput");
  if(!activeChatUser || !input.value.trim()) return;
  db.collection("messages").add({
    content: input.value.trim(),
    senderId: auth.currentUser.uid,
    receiverId: activeChatUser,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>input.value="");
}

// ---------------- Auth State ----------------
auth.onAuthStateChanged(user=>{
  if(user) checkNickname(user);
  else {
    loginPage.classList.remove("hidden");
    pickUsernamePage.classList.add("hidden");
    dashboardPage.classList.add("hidden");
  }
});
</script>
</body>
</html>
