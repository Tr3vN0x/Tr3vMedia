<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Profiles & Friends (Fully Integrated)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<style>
/* --- BASE STYLES --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none !important; }
.header { background:#111; border-bottom:3px solid cyan; box-shadow:0 0 20px rgba(0,255,255,0.5); padding:10px 0; margin-bottom:20px; display:flex; align-items:center; justify-content:center; }
.header h1 { font-size:2.5em; color:#fff; text-shadow:0 0 5px cyan,0 0 10px cyan,0 0 15px magenta; margin:0; }
.icon-container { margin-right:15px; font-size:2.5em; color:cyan; text-shadow:0 0 5px cyan,0 0 10px magenta; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; transition:all 0.2s ease-in-out; text-transform:uppercase; font-family:'Orbitron',sans-serif; white-space: nowrap; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.neon-btn:disabled { border-color: #555; box-shadow: none; color: #555; cursor: not-allowed; }
.neon-btn.remove { border-color:red; box-shadow:0 0 10px red; }
.neon-btn.remove:hover { border-color:orange; box-shadow:0 0 15px orange; }
.neon-btn.add { border-color:lime; box-shadow:0 0 10px lime; }
.neon-btn.add:hover { border-color:green; box-shadow:0 0 15px green; }
#messageInput, #profileBio, #profileSkillRating, #profileStatus, #searchInput, #statusFilter, #skillFilter, #profileNickname, #newUsernameInput { flex-grow:1; padding:10px; border:1px solid cyan; background:#181818; color:white; border-radius:6px; font-family:inherit; outline:none; }
#profileBio { resize: vertical; }
.flex { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
.card-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; }
.card {
    width: 100%;
    max-width: 320px; 
    padding: 15px;
    border: 3px solid transparent; 
    border-radius: 6px;
    background: #181818; 
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), inset 0 0 5px rgba(0, 255, 255, 0.2);
    border-image-source: linear-gradient(45deg, cyan, magenta, cyan);
    border-image-slice: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 25px magenta, inset 0 0 10px rgba(255, 0, 255, 0.5); 
}
.card-content-box { 
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 10px; 
    padding-bottom: 10px;
    border-bottom: 1px dashed #333; 
}
.avatar { width:60px; height:60px; border-radius:50%; border:3px solid magenta; object-fit:cover; margin-bottom:10px; }
.owner-badge-box { 
    display:inline-block; 
    padding:2px 6px; 
    margin-left:8px; 
    font-size:0.7em; 
    font-weight:bold; 
    letter-spacing:1px; 
    border-radius:4px; 
    text-transform:uppercase; 
    background:#3a005c; 
    color:#ffccff;
    border:1px solid #ff00ff; 
    box-shadow:0 0 5px #ff00ff, 0 0 10px #cc33ff, inset 0 0 5px #ff00ff; 
    vertical-align:middle; 
    font-size: 0.8em; 
}
.owner-badge-box:before {
    content: "⚡ "; 
    color: yellow;
    text-shadow: 0 0 5px yellow;
    margin-right: 2px;
}
.skill-rating { color:gold; font-size:1.2em; margin-bottom:5px; }
.status-indicator { font-size:0.8em; padding:3px 8px; border-radius:4px; font-weight:bold; margin-bottom:10px; }
.status-online { background-color:#00cc00; color:#0b0b0b; box-shadow:0 0 5px #00ff00; }
.status-ingame { background-color:#ffaa00; color:#0b0b0b; box-shadow:0 0 5px #ffaa00; }
.status-lfd { background-color:#00aaff; color:#0b0b0b; box-shadow:0 0 5px #00aaff; }
.game-badge {
    display: inline-block;
    background: #004444; 
    color: #ccffff;
    padding: 3px 8px;
    border-radius: 4px;
    margin: 4px; 
    font-weight: bold;
    font-size: 0.85em;
    border: 1px solid cyan;
}

/* --- MESSAGING SPECIFIC STYLES --- */
#messagingTab { display: flex; gap: 20px; height: 70vh; }
#chatList { width: 300px; padding: 15px; border: 2px solid cyan; border-radius: 8px; background: #1a1a1a; overflow-y: auto; }
#activeDuoList { margin-top: 10px; }
.chat-entry { padding: 10px; border-bottom: 1px dashed #333; cursor: pointer; transition: background 0.2s; }
.chat-entry:hover { background: #2a2a2a; }
.chat-entry.active { background: #004444; border-left: 5px solid lime; font-weight: bold; }
.last-message-snippet { font-size: 0.8em; color: #bbb; }
#chatWindow { flex-grow: 1; display: flex; flex-direction: column; border: 2px solid magenta; border-radius: 8px; background: #1a1a1a; }
#chatHeader { padding: 10px; border-bottom: 2px solid magenta; margin: 0; background: #330033; }
#messageDisplay { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.message { max-width: 70%; padding: 8px 12px; border-radius: 15px; font-size: 0.9em; }
.message.sent { background: #005555; align-self: flex-end; border-bottom-right-radius: 5px; }
.message.received { background: #333333; align-self: flex-start; border-bottom-left-radius: 5px; }
#messageInputArea { padding: 10px; border-top: 2px solid magenta; background: #0b0b0b; display: flex; gap: 10px; }
</style>
</head>
<body>

<div class="header"><div class="icon-container">⚡</div><h1>DUO UP (Direct)</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Find your perfect partner and dominate the cyber-arena.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>

<div id="navigationBar" style="margin-bottom:20px;">
    <button class="neon-btn" onclick="showTab('allUsers')">Suggested</button>
    <button class="neon-btn" onclick="showTab('search')">Find Players</button>
    <button id="friendsBtn" class="neon-btn" onclick="showTab('friends')">Duos</button>
    <button class="neon-btn" onclick="showTab('messaging')">Messaging</button>
    <button class="neon-btn" onclick="showTab('profile')">Profile</button>
    <button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="allUsersTab" class="card-container"></div>
<div id="searchTab" class="hidden container">
    <h2>Player Search Filter</h2>
    <div id="searchControls" style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
        <input type="text" id="searchInput" placeholder="Search by Nickname or Bio..." onkeyup="filterSearchResults()">
        <label style="color:cyan;">Filter Status:</label>
        <select id="statusFilter" onchange="filterSearchResults()">
            <option value="">Any Status</option>
            <option value="Online">Online</option>
            <option value="In Game">In Game</option>
            <option value="LFD">Looking For Duo (LFD)</option>
        </select>
        <label style="color:cyan;">Min Skill:</label>
        <select id="skillFilter" onchange="filterSearchResults()">
            <option value="0">Any Skill</option>
            <option value="1">⭐ 1+</option>
            <option value="2">⭐⭐ 2+</option>
            <option value="3">⭐⭐⭐ 3+</option>
            <option value="4">⭐⭐⭐⭐ 4+</option>
            <option value="5">⭐⭐⭐⭐⭐ 5</option>
        </select>
    </div>
    <div id="searchResults" class="card-container"></div>
</div>

<div id="friendsTab" class="flex hidden" style="flex-direction: column;">
    </div>

<div id="messagingTab" class="hidden">
    <div id="chatList">
        <h3>Active Duos</h3>
        <div id="activeDuoList">No Duos to chat with.</div>
    </div>
    <div id="chatWindow">
        <h3 id="chatHeader">Select a Duo</h3>
        <div id="messageDisplay"></div>
        <div id="messageInputArea" class="hidden">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button class="neon-btn" id="sendMessageBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>
<div id="viewProfileTab" class="hidden container">
    <button class="neon-btn" onclick="showTab('allUsers')">← Back to Suggested</button>
    <div id="viewProfileContent" style="padding: 20px; border: 2px solid magenta; border-radius: 10px; background: #1a1a1a; margin-top: 20px;">
    </div>
</div>

<div id="profileTab" class="hidden">
    <h2>Cyber-Profile Editor</h2>
    <div style="padding: 20px; border: 2px solid magenta; border-radius: 10px; background: #1a1a1a;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <img id="profileAvatar" class="avatar" style="width: 80px; height: 80px; margin-right: 20px; border-color: magenta;" src="">
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Unique Identifier:</label>
                <input type="text" id="profileNickname" value="User Nickname" disabled>
            </div>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="color: cyan; display: block; margin-bottom: 5px;">Upload Avatar:</label>
            <input type="file" id="avatarUpload" accept="image/*" onchange="previewAvatar(this)">
        </div>

        <h3 style="color:cyan; margin-top: 25px;">Unique Username (@)</h3>
        <p id="usernameDisplay">@Loading...</p>
        <div id="usernameEditor" style="margin-bottom: 20px; display:flex; gap:10px;">
            <input type="text" id="newUsernameInput" placeholder="Enter new username (a-z, 0-9, 3-20 chars)" style="flex-grow: 1;">
            <button class="neon-btn" id="changeUsernameBtn" onclick="attemptUsernameChange()">Set/Change Username</button>
        </div>
        <p id="usernameMessage" style="color: yellow;"></p>
            
        <div style="margin-bottom: 15px;">
            <label style="color: cyan; display: block; margin-bottom: 5px;">Bio/Tagline:</label>
            <textarea id="profileBio" rows="3" style="width: 100%;"></textarea>
        </div>
        <div style="display: flex; gap: 30px; margin-bottom: 20px;">
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Skill Rating (1-5):</label>
                <select id="profileSkillRating">
                    <option value="1">⭐</option>
                    <option value="2">⭐⭐</option>
                    <option value="3">⭐⭐⭐</option>
                    <option value="4">⭐⭐⭐⭐</option>
                    <option value="5">⭐⭐⭐⭐⭐</option>
                </select>
            </div>
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Current Status:</label>
                <select id="profileStatus">
                    <option value="Online">Online</option>
                    <option value="In Game">In Game</option>
                    <option value="LFD">Looking For Duo (LFD)</option>
                </select>
            </div>
        </div>
            
        <h3 style="color:cyan; margin-top: 25px;">Featured Games & Needs (Max 4)</h3>
        <button class="neon-btn" onclick="addGameSlot()" id="addGameBtn">Add Game</button>
        <div id="gameSlotList" class="game-slot-container">
        </div>

        <h3 style="color:cyan; margin-top: 25px;">Gamer Card Manager (Max 8)</h3>
        <p style="font-size: 0.9em; color: gray;">Click the "+" slot to upload a new card (Max 2MB per image).</p>
        <div id="gamerCardList" class="gamer-card-container" style="border: 1px dashed cyan; padding: 10px; border-radius: 6px; margin-bottom: 15px;"></div>
        <button class="neon-btn" style="border-color: #00ff00; box-shadow: 0 0 10px #00ff00;" onclick="saveProfile()">Save Profile</button>
        <p id="saveMessage" style="color: #00ff00; margin-top: 10px;"></p>
    </div>
</div>

<script>
// ------------------------------------------------
// 1. FIREBASE INIT AND CONSTANTS
// ------------------------------------------------
const firebaseConfig = {
    // !! IMPORTANT: REPLACE WITH YOUR OWN FIREBASE CONFIG !!
    apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
    authDomain: "duoup-cfae6.firebaseapp.com",
    projectId: "duoup-cfae6",
    storageBucket: "duoup-cfae6.firebasestorage.app",
    messagingSenderId: "812263060524",
    appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
    measurementId: "G-46B67F90FK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";


// ------------------------------------------------
// 2. GLOBAL STATE VARIABLES
// ------------------------------------------------
let currentUser = null, 
    currentChatUid = null, 
    unsubscribeMessages = null, 
    unsubscribeUnread = null; 
let currentProfileData = {}; 
let allUsersCache = [];    
let friendProfiles = {}; 
let blockedUsers = {}; 


// ------------------------------------------------
// 3. CORE HELPER FUNCTIONS
// ------------------------------------------------

// --- TAB MANAGEMENT ---
function showTab(tab){
    document.querySelectorAll('#allUsersTab, #searchTab, #friendsTab, #messagingTab, #profileTab, #viewProfileTab').forEach(el => el.classList.add('hidden'));
    
    switch(tab){
      case "allUsers": document.getElementById('allUsersTab').classList.remove("hidden"); loadAllUsers(); break; 
      case "search": document.getElementById('searchTab').classList.remove("hidden"); filterSearchResults(); break; 
      case "friends": document.getElementById('friendsTab').classList.remove("hidden"); loadFriends(); break; 
      case "messaging": document.getElementById('messagingTab').classList.remove("hidden"); loadChatList(); break; 
      case "profile": document.getElementById('profileTab').classList.remove("hidden"); loadUserProfile(); break; 
      case "viewProfile": document.getElementById('viewProfileTab').classList.remove("hidden"); break; 
    }
}

// --- PROFILE LOADING ---
async function loadUserProfile() {
    if (!currentUser) return;
    const userDoc = await db.collection("users").doc(currentUser.uid).get();
    currentProfileData = userDoc.data() || {}; 

    const currentDisplayUsername = currentProfileData.username || 'Loading...';

    // Update Profile Tab UI
    document.getElementById("profileAvatar").src = currentProfileData.profileImageUrl || DEFAULT_AVATAR;
    document.getElementById("profileNickname").value = currentProfileData.nickname || currentUser.displayName || "Unknown User";
    document.getElementById("profileBio").value = currentProfileData.bio || "";
    document.getElementById("profileSkillRating").value = String(currentProfileData.skillRating || "3");
    document.getElementById("profileStatus").value = currentProfileData.status || "Online";
    document.getElementById("usernameDisplay").textContent = `@${currentDisplayUsername}`;
    
    const changeBtn = document.getElementById("changeUsernameBtn");
    const input = document.getElementById("newUsernameInput");
    const messageElement = document.getElementById("usernameMessage");

    const hasChanged = currentProfileData.usernameChanged === true;
    
    if (hasChanged) {
        changeBtn.textContent = "Changed Once (Locked)";
        changeBtn.disabled = true;
        input.disabled = true;
        messageElement.textContent = `Your unique username (@${currentProfileData.username}) has been permanently set.`;
        messageElement.style.color = 'lime';
    } else {
        changeBtn.textContent = "Set/Change Username";
        changeBtn.disabled = false;
        input.disabled = false;
        messageElement.textContent = "You have one change remaining to set your unique @handle.";
        messageElement.style.color = 'yellow';
    }
}

// --- PROFILE SAVE FUNCTION ---
async function saveProfile() {
    if (!currentUser) return;

    const bio = document.getElementById("profileBio").value.trim();
    const skillRating = parseInt(document.getElementById("profileSkillRating").value);
    const status = document.getElementById("profileStatus").value;
    
    const saveMessageElement = document.getElementById("saveMessage");
    saveMessageElement.textContent = "Saving profile...";
    saveMessageElement.style.color = 'yellow';

    try {
        // This relies on the 'allow update: if request.auth.uid == userId;' rule
        await db.collection("users").doc(currentUser.uid).update({
            bio: bio,
            skillRating: skillRating,
            status: status
        });

        saveMessageElement.textContent = "Profile Saved Successfully! Reloading...";
        saveMessageElement.style.color = '#00ff00';
        
        await loadUserProfile(); 
        await loadAllUsers(); 
        setTimeout(() => {
            saveMessageElement.textContent = "";
        }, 3000);

    } catch (e) {
        console.error("Profile Save Error:", e);
        saveMessageElement.textContent = `Save Failed: ${e.message}. Check your rules!`;
        saveMessageElement.style.color = 'red';
    }
}


// --- USERNAME CHANGE FUNCTION ---
async function attemptUsernameChange() {
    if (!currentUser || currentProfileData.usernameChanged) return;

    const input = document.getElementById("newUsernameInput");
    const newUsername = input.value.trim().toLowerCase();
    const messageElement = document.getElementById("usernameMessage");
    
    if (newUsername.length < 3 || newUsername.length > 20 || !/^[a-z0-9]+$/.test(newUsername)) {
        messageElement.textContent = "Username must be 3-20 lowercase letters/numbers.";
        messageElement.style.color = 'red';
        return;
    }

    messageElement.textContent = "Checking availability...";
    messageElement.style.color = 'yellow';

    try {
        const usernameDoc = await db.collection("usernames").doc(newUsername).get();
        if (usernameDoc.exists) {
            messageElement.textContent = `@${newUsername} is already taken. Try another.`;
            messageElement.style.color = 'red';
            return;
        }

        // Use transaction for atomic username swap
        await db.runTransaction(async (transaction) => {
            const userRef = db.collection("users").doc(currentUser.uid);
            
            // a. Update the main user document
            transaction.update(userRef, {
                username: newUsername,
                usernameChanged: true 
            });

            // b. Create the new reservation (Rule: allow create: if request.auth != null)
            transaction.set(db.collection("usernames").doc(newUsername), {
                uid: currentUser.uid,
                username: newUsername
            });
            
            // c. Delete the OLD username document (Rule: allow delete: if request.auth.uid == resource.data.uid)
            const oldUsername = currentProfileData.username;
            if (oldUsername && oldUsername !== newUsername) {
                const oldUsernameRef = db.collection("usernames").doc(oldUsername);
                transaction.delete(oldUsernameRef);
            }
        });

        messageElement.textContent = `Success! Your unique handle is now @${newUsername}.`;
        messageElement.style.color = 'lime';
        await loadUserProfile(); 

    } catch (e) {
        console.error("Username Change Error:", e);
        messageElement.textContent = `Error changing username: ${e.message}`;
        messageElement.style.color = 'red';
    }
}


// --- USER LIST LOADING (CRITICAL FIX FOR 'Suggested Players' ERROR) ---
async function loadAllUsers(){
    const allUsersTab = document.getElementById('allUsersTab');
    allUsersTab.innerHTML = "<h3>Suggested Players</h3>";
    if (!currentUser) {
        allUsersTab.innerHTML += "<p style='color:yellow;'>Please log in to see suggested players.</p>";
        return;
    }
    try {
        // This operation requires 'allow read: if request.auth != null;' on /users
        const snapshot = await db.collection("users").get(); 
        
        allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        allUsersCache.forEach(user => {
            // Only render users that are NOT the current user
            if (user.id !== currentUser.uid) { 
                allUsersTab.appendChild(renderUserCard({ uid: user.id }, user));
            }
        });
        if (allUsersTab.children.length <= 1) { 
             allUsersTab.innerHTML += "<p>No other users found in the system.</p>";
        }

    } catch(e) {
        allUsersTab.innerHTML += `<p style="color:red; font-weight:bold;">Error loading users: ${e.message}</p>
                                  <p style="color:red;">Check if 'allow read: if request.auth != null;' is set on /users collection.</p>`;
        console.error("Load All Users Error:", e);
    }
}

// --- SEARCH AND FILTERING FUNCTION ---
function filterSearchResults() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const skillFilter = parseInt(document.getElementById('skillFilter').value); 
    const searchResultsDiv = document.getElementById('searchResults');
    searchResultsDiv.innerHTML = ""; 

    const filteredUsers = allUsersCache.filter(user => {
        if (user.id === currentUser.uid) return false;

        const userNickname = (user.nickname || "").toLowerCase();
        const userUsername = (user.username || "").toLowerCase();
        const userBio = (user.bio || "").toLowerCase();
        
        const textMatch = userNickname.includes(searchInput) || userUsername.includes(searchInput) || userBio.includes(searchInput);
        if (!textMatch) return false;

        if (statusFilter && user.status !== statusFilter) return false;

        const userSkill = user.skillRating || 0; 
        if (userSkill < skillFilter) return false;

        return true;
    });

    if (filteredUsers.length === 0) {
        searchResultsDiv.innerHTML = "<p>No players matched your current filter criteria.</p>";
        return;
    }

    filteredUsers.forEach(user => {
        searchResultsDiv.appendChild(renderUserCard({ uid: user.id }, user));
    });
}


// --- FRIEND/REQUEST LOADING (DUOS TAB) ---
async function loadFriends() {
    const friendsTab = document.getElementById('friendsTab');
    friendsTab.innerHTML = ""; 
    friendProfiles = {}; 
    const friendUids = Array.isArray(currentProfileData.friends) ? currentProfileData.friends : [];
    
    let incomingRequests = [];
    
    try {
        // 1. FETCH INCOMING REQUESTS
        const requestsSnapshot = await db.collection("requests")
            .where("receiverId", "==", currentUser.uid)
            .where("status", "==", "pending")
            .get();
            
        requestsSnapshot.forEach(doc => {
            const data = doc.data();
            incomingRequests.push({ 
                requestId: doc.id, 
                senderId: data.senderId,
                sentAt: data.sentAt
            });
        });
        
    } catch(e) {
        console.error("Error loading incoming requests:", e);
        friendsTab.innerHTML += `<p style="color:red;">Error fetching requests. Check /requests READ rule: ${e.message}</p>`;
    }
    
    // --- 2. DISPLAY INCOMING REQUESTS ---
    if (incomingRequests.length > 0) {
        friendsTab.innerHTML += `<h3>Pending Requests (${incomingRequests.length})</h3><div class="card-container" id="pendingRequestsContainer"></div>`;
        const requestContainer = friendsTab.querySelector('#pendingRequestsContainer');
        
        const senderPromises = incomingRequests.map(req => db.collection("users").doc(req.senderId).get());
        const senderDocs = await Promise.all(senderPromises);

        senderDocs.forEach((doc, index) => {
            if (!doc.exists) return;
            const senderData = doc.data();
            const senderUid = doc.id;
            const requestId = incomingRequests[index].requestId;
            
            requestContainer.appendChild(renderRequestCard({ uid: senderUid }, senderData, requestId));
        });
    } else {
        friendsTab.innerHTML += `<p style="color:gray;">No pending requests at this time.</p>`;
    }

    // --- 3. DISPLAY ESTABLISHED DUOS ---
    friendsTab.innerHTML += "<h3 style='margin-top:20px;'>Established Duos</h3><div class='card-container' id='establishedDuosContainer'></div>";
    const duoContainer = friendsTab.querySelector('#establishedDuosContainer');

    if (friendUids.length === 0) {
        duoContainer.innerHTML = "<p>You have no Duo Partners yet. Find someone in Suggested or Search!</p>";
    }
    
    const friendPromises = friendUids.map(uid => db.collection("users").doc(uid).get());
    const friendDocs = await Promise.all(friendPromises);

    friendDocs.forEach(doc => {
        if (!doc.exists) return;
        const friendData = doc.data();
        friendProfiles[doc.id] = friendData;
        duoContainer.appendChild(renderUserCard(doc, friendData));
    });
    
    if (!document.getElementById('messagingTab').classList.contains('hidden')) {
        loadChatList();
    }
}


// --- RENDERING A REQUEST CARD ---
function renderRequestCard(d, data, requestId) {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.borderColor = 'yellow';
    card.style.boxShadow = '0 0 15px rgba(255, 255, 0, 0.6), inset 0 0 5px rgba(255, 255, 0, 0.4)';
    card.style.cursor = 'default';
    
    const statusClass = (data.status || 'Online').replace(/\s/g, '').toLowerCase();
    
    let primaryName = data.nickname || (data.email ? data.email.split('@')[0] : 'Unknown User');
    const displayName = data.username ? `@${data.username}` : primaryName;

    card.innerHTML = `
        <div class="card-content-box" style="border-bottom: 2px solid yellow;">
            <p style="color:yellow; font-weight:bold; margin: 0 0 10px 0;">INCOMING REQUEST</p>
            <img src="${data.profileImageUrl || DEFAULT_AVATAR}" class="avatar" style="border-color: yellow;">
            <h3 style="margin:0; font-size:1.2em;">${displayName}</h3>
            <div class="status-indicator status-${statusClass}">${data.status || 'Online'}</div>
            <p style="margin:5px 0; font-size:0.9em; text-align:center; color:#ccc;">${data.bio || 'No bio provided.'}</p>
        </div>
        <div style="margin-top: 10px;">
            <button class="neon-btn add" style="border-color:lime; box-shadow:0 0 10px lime;" onclick="acceptFriendRequest('${d.uid}', '${requestId}')">Accept Duo</button>
            <button class="neon-btn remove" style="border-color:red; box-shadow:0 0 10px red;" onclick="declineFriendRequest('${requestId}')">Decline</button>
        </div>
    `;

    return card;
}


// --- RENDERING A STANDARD USER CARD ---
function renderUserCard(d, data) {
    const card = document.createElement('div');
    card.dataset.uid = d.uid; 
    card.className = 'card';
    
    let actionButton = '';
    const isFriend = Array.isArray(currentProfileData.friends) && currentProfileData.friends.includes(d.uid);
    const isSelf = d.uid === currentUser.uid;

    if (isSelf) {
        actionButton = `<span class="owner-badge-box">You</span>`;
    } else if (isFriend) {
        actionButton = `<button class="neon-btn remove" onclick="event.stopPropagation(); removeFriend('${d.uid}')">Remove Duo</button>`;
    } else {
        actionButton = `<button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${d.uid}')">Send Request</button>`;
    }

    let gameBadges = '';
    (data.featuredGames || []).slice(0, 3).forEach(g => {
        if (typeof g === 'object' && g !== null && g.game) {
            gameBadges += `<span class="game-badge">${g.game} (${g.role || 'Any'})</span>`;
        }
    });

    const statusClass = (data.status || 'Online').replace(/\s/g, '').toLowerCase();
    let primaryName = data.nickname || (data.email ? data.email.split('@')[0] : 'Unknown User');
    const displayName = data.username ? `@${data.username}` : primaryName;

    card.innerHTML = `
        <div class="card-content-box">
            <img src="${data.profileImageUrl || DEFAULT_AVATAR}" class="avatar">
            <h3 style="margin:0; font-size:1.2em;">${displayName}</h3>
            <div class="skill-rating">${'⭐'.repeat(data.skillRating || 3)}</div>
            <div class="status-indicator status-${statusClass}">${data.status || 'Online'}</div>
            <p style="margin:5px 0; font-size:0.9em; text-align:center; color:#ccc;">${data.bio || 'No bio provided.'}</p>
        </div>
        <div style="margin-bottom: 10px;">${actionButton}</div>
        <div class="card-games">${gameBadges || '<p style="color:gray;">No games featured.</p>'}</div>
    `;

    return card;
}


// --- FRIEND REQUEST FUNCTIONS (RULE-SAFE) ---

async function sendFriendRequest(targetUid) {
    if (!currentUser) return;

    if (!targetUid || typeof targetUid !== "string" || targetUid.length < 10) {
        alert("Invalid target user ID.");
        return;
    }

    if (targetUid === currentUser.uid) {
        alert("You cannot send a request to yourself.");
        return;
    }

    const friends = Array.isArray(currentProfileData.friends) ? currentProfileData.friends : [];
    if (friends.includes(targetUid)) {
        alert("You are already Duo partners.");
        return;
    }

    const senderUid = currentUser.uid;
    const receiverUid = targetUid;
    const requestId = `${senderUid}_${receiverUid}`;
    const reverseRequestId = `${receiverUid}_${senderUid}`;

    try {
        const requestRef = db.collection("requests").doc(requestId);
        const reverseRef = db.collection("requests").doc(reverseRequestId);

        // 1. Check for request from this user (A->B)
        const existing = await requestRef.get();
        if (existing.exists) {
            alert("Request already sent.");
            return;
        }

        // 2. Check for reverse request (B->A) -> Auto-accept
        const reverse = await reverseRef.get();
        if (reverse.exists) {
            await acceptFriendRequest(receiverUid, reverse.id);
            alert("Duo request found — automatically accepted!");
            return;
        }

        // 3. Create request (MUST match security rules exactly)
        await requestRef.set({
            senderId: senderUid,
            receiverId: receiverUid,
            status: "pending",
            sentAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Duo request sent!");
        // Only refresh the UI sections affected
        await loadAllUsers();
        filterSearchResults();

    } catch (e) {
        console.error("Send Friend Request FAILED:", e);
        // This is the error indicating the rule failed or the token is invalid
        alert("CRITICAL FIREBASE ERROR: Failed to send request. Check published Security Rules AND ensure you are on a secure (HTTPS) host.");
    }
}

async function acceptFriendRequest(targetUid, requestId) {
    if (!currentUser) return;
    
    try {
        const batch = db.batch();
        const userRef = db.collection("users").doc(currentUser.uid);
        const targetRef = db.collection("users").doc(targetUid);
        const requestRef = db.collection("requests").doc(requestId);

        // 1. Add both UIDs to each other's 'friends' arrays
        batch.update(userRef, { friends: firebase.firestore.FieldValue.arrayUnion(targetUid) });
        batch.update(targetRef, { friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });

        // 2. Delete the request document (Rule: allow delete for sender/receiver)
        batch.delete(requestRef);

        await batch.commit();

        alert(`Successfully added ${targetUid.substring(0, 8)}... as a Duo partner!`);
        await loadUserProfile(); 
        await loadFriends(); // Reloads Duos tab
        loadAllUsers(); 
        filterSearchResults();

    } catch (e) {
        console.error("Accept Request Error:", e);
        alert("Failed to accept request: " + (e.message || "Check Security Rules."));
    }
}

async function declineFriendRequest(requestId) {
    if (!currentUser) return;
    
    try {
        // Only sender or receiver can delete this document (matching security rules)
        await db.collection("requests").doc(requestId).delete();
        
        alert("Duo request declined.");
        await loadFriends(); // Reloads Duos tab

    } catch (e) {
        console.error("Decline Request Error:", e);
        alert("Failed to decline request: " + (e.message || "Check Security Rules."));
    }
}

async function removeFriend(friendId) {
    if (!currentUser) return;
    try {
        await db.collection("users").doc(currentUser.uid).update({
            friends: firebase.firestore.FieldValue.arrayRemove(friendId)
        });
        
        await db.collection("users").doc(friendId).update({ friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });

        alert(`Successfully removed ${friendId.substring(0, 8)}... from Duos.`);
        await loadUserProfile(); 
        await loadFriends();
        loadAllUsers(); 
        filterSearchResults();
    } catch (e) {
        console.error("Remove Friend Error:", e);
        alert("Remove Duo Failed: " + (e.message || "Check Security Rules."));
    }
}


// --- MESSAGING FUNCTIONS (Placeholders) ---

function getCanonicalChatId(uid1, uid2) {
    const participants = [uid1, uid2].sort();
    return participants.join('_');
}

function loadChatList() { /* Placeholder */ }
async function startChat(targetUid, targetProfile) { /* Placeholder */ }
async function sendMessage() { /* Placeholder */ }


// --- AUTHENTICATION FUNCTIONS ---
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message)); }
function logout(){ 
    if(unsubscribeMessages) unsubscribeMessages(); 
    if(unsubscribeUnread) unsubscribeUnread(); 
    auth.signOut(); 
}


// --- OTHER PLACEHOLDERS ---
function viewUserProfile(uid) {
    alert(`Viewing profile of ${uid}`);
}
function previewAvatar(input) {
    alert("Avatar preview placeholder called.");
}
function addGameSlot() {
     alert("Add Game Slot placeholder called.");
}


// --- USER DATA REPAIR FUNCTION ---
async function ensureUserProfileDefaults(user) {
    const userRef = db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();
    
    const defaults = {
        nickname: user.displayName || user.email.split('@')[0], 
        bio: "New Cyber Warrior seeking a Duo partner!",
        skillRating: 3,
        status: "Online",
        profileImageUrl: user.photoURL || DEFAULT_AVATAR,
        friends: [],
        gamerCards: [],
        featuredGames: [],
        usernameChanged: false,
    };
    
    const existingData = userDoc.data() || {};
    let updateData = {};
    let needsUpdate = false;

    for (const key in defaults) {
        if (existingData[key] === undefined || existingData[key] === null || 
            (key === 'friends' && !Array.isArray(existingData[key])) ||
            (key === 'gamerCards' && !Array.isArray(existingData[key])) ||
            (key === 'featuredGames' && !Array.isArray(existingData[key])) ||
            (key === 'skillRating' && typeof existingData[key] !== 'number')) 
        {
            updateData[key] = defaults[key];
            needsUpdate = true;
        }
    }
    
    if (existingData.username === undefined || existingData.username === null || existingData.username === "") {
        const baseName = (user.displayName || user.email.split('@')[0]).replace(/\s/g, '').toLowerCase();
        const randomSuffix = Math.floor(1000 + Math.random() * 9000); 
        const defaultUsername = baseName.substring(0, 16).replace(/[^a-z0-9]/g, '').slice(0, 16 - 4) + randomSuffix; 
        
        updateData.username = defaultUsername;
        needsUpdate = true;
        
        try {
             await db.collection("usernames").doc(defaultUsername).set({
                uid: user.uid,
                username: defaultUsername
            }, { merge: true }); 
        } catch(e) {
            console.warn("Could not set username reservation during repair:", e);
        }
    }

    if (needsUpdate) {
        console.log("Repairing missing user profile fields for:", user.uid, updateData);
        await userRef.set(updateData, { merge: true });
    }
}


// ------------------------------------------------
// 4. MAIN EXECUTION BLOCK 
// ------------------------------------------------

auth.onAuthStateChanged(async user=>{
    if(!user){ 
        document.getElementById("loginPage").classList.remove("hidden"); 
        document.getElementById("dashboard").classList.add("hidden"); 
        return; 
    }
    
    document.getElementById("loginPage").classList.add("hidden"); 
    document.getElementById("dashboard").classList.remove("hidden"); 
    currentUser=user;
    
    const userRef=db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();

    // 1. Initial User Setup or Data Repair
    if(!userDoc.exists){
        const baseName = (user.displayName || user.email.split('@')[0]).replace(/\s/g, '').toLowerCase();
        const randomSuffix = Math.floor(1000 + Math.random() * 9000); 
        const defaultUsername = baseName.substring(0, 16).replace(/[^a-z0-9]/g, '').slice(0, 16 - 4) + randomSuffix; 
        
        const profileUpdate = {
            uid: user.uid,
            username: defaultUsername,
            usernameChanged: false, 
            bio: "New Cyber Warrior seeking a Duo partner!", 
            skillRating: 3, 
            status: "Online", 
            friends: [], 
            profileImageUrl: user.photoURL || DEFAULT_AVATAR, 
            nickname: user.displayName, 
            gamerCards: [], 
            featuredGames: [], 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userRef.set(profileUpdate);
        await db.collection("usernames").doc(defaultUsername).set({
            uid: user.uid,
            username: defaultUsername
        });
        
    } else {
        await ensureUserProfileDefaults(user);
    }
    
    // 2. Load Core Data
    await loadUserProfile(); 

    // 3. Load UI Data
    document.getElementById("welcome").textContent=`Welcome, ${currentProfileData.nickname || currentUser.displayName || currentUser.email}`;
    await loadAllUsers(); 
    await loadFriends();
    showTab('allUsers'); 
});

</script>
</body>
</html>
