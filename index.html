<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr3vMedia</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
/* ---------------------------------- */
/* --- üé® COLOR REVERTED TO GREEN --- */
/* ---------------------------------- */

/* --- Core Styling & Typography --- */
body {
    margin: 0;
    font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
    background: #0a0a0a; 
    color: #00FF00; /* Main text color: Bright Green */
    line-height: 1.6;
}
header {
    background: #111111; 
    padding: 15px 30px;
    color: #00FF00;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); 
    border-bottom: 1px solid #004400;
    position:sticky;
    top:0;
    z-index:1000; 
}
main {padding: 30px 40px;}
h2, h3, h4 {color: #00CC00; margin-top: 0;} /* Green Accent */
.verified {
    color: #00CC00;
    font-weight: bold;
    margin-left: 5px;
    background: rgba(0, 204, 0, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}
.tab-content {display:none;}
#welcome-banner {
    background: #004400; /* Darker Green */
    color: #FFFFFF;
    text-align: center;
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 8px; 
}

/* --- Header & Navigation (Desktop/Tablet) --- */
header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.header-left {
    display: flex;
    align-items: center;
    gap: 30px; 
}
.logo-container {
    display: flex; 
    align-items: center;
    gap: 15px;
}
.logo-container img {
    height: 35px;
    border-radius: 5px;
    filter: drop-shadow(0 0 5px #00CC00); 
}

/* Search Bar Styling */
#search-bar {
    position: relative; 
    min-width: 250px;
}
#search-input {
    padding: 8px 12px;
    border-radius: 20px; 
    background: #1e1e1e;
    color: #00FF00;
    border: 1px solid #004400;
    width: 100%;
    box-sizing: border-box;
    transition: all 0.3s;
}
#search-input:focus {
    background: #222222;
    border-color: #00CC00;
    box-shadow: 0 0 8px rgba(0, 204, 0, 0.5);
    outline: none;
}

/* Search Results Dropdown Styling */
#search-results {
    position: absolute;
    top: 100%; 
    left: 0;
    width: 100%;
    background: #1e1e1e;
    border: 1px solid #004400;
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
}
.search-result-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #001a00;
    transition: background 0.2s;
}
.search-result-item:hover {
    background: #003300;
    color: #FFFFFF;
}


/* Tabs Styling (Desktop) */
.header-actions {
    display: flex; 
    gap: 10px; 
    align-items: center;
}
.nav-tab {
    cursor:pointer;
    padding: 8px 15px; 
    border-radius: 20px; 
    border: 1px solid #004400;
    font-size: 0.9em; 
    transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
    position: relative; /* For the notification badge */
}
.nav-tab.active {
    background: #003300;
    border-color: #00CC00;
    box-shadow: 0 0 10px rgba(0, 204, 0, 0.5);
    color: #FFFFFF;
}
.nav-tab:hover:not(.active) {
    background: #1e1e1e;
    border-color: #00CC00;
}
/* Notification Badge */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: red;
    color: white;
    border-radius: 50%;
    padding: 3px 6px;
    font-size: 0.7em;
    font-weight: bold;
    pointer-events: none; /* Allows click-through */
    z-index: 5;
}

/* --- Forms & Inputs (General) --- */
input:not([type="file"], #search-input), textarea {
    width: 100%; 
    box-sizing: border-box;
    padding: 10px;
    margin-bottom: 15px; 
    border-radius: 6px;
    background: #1e1e1e;
    color: #00FF00;
    border: 1px solid #004400;
    margin-top: 5px;
    resize: vertical;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus:not([type="file"], #search-input), textarea:focus {
    border-color: #00CC00;
    box-shadow: 0 0 5px rgba(0, 204, 0, 0.4);
    outline: none;
}
/* File input styling is subtle */
input[type="file"] {margin-top:10px; margin-bottom: 15px; background: #1e1e1e; color: #00FF00; padding: 10px; border-radius: 6px; border: 1px solid #004400;}

button {
    cursor:pointer;
    padding:10px 18px; 
    border-radius: 20px; 
    background: #006600; /* Standard Button Green */
    color: #FFFFFF;
    border: none;
    margin-top: 5px;
    transition: background 0.3s, box-shadow 0.3s;
    font-weight: bold;
}
button:hover {
    background: #008800;
    box-shadow: 0 4px 10px rgba(0, 204, 0, 0.4);
}
button:active {
    background: #004400;
}
/* New button styles for Settings */
.settings-button {
    width: 100%; 
    display: block;
    margin-top: 10px;
}


#new-post {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    border: 1px solid #004400;
}
#new-post button {margin-top: 10px; width: 100%;}

/* Follow/Unfollow Button Specific Styling */
#follow-button.unfollow {
    background: #CC0000; /* Red for Unfollow */
}
#follow-button.unfollow:hover {
    background: #FF3333;
}

/* --- DM Specific Styling --- */
.chat-messages {
    /* Adjust margin for mobile fixed footer */
    max-height: 400px; 
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
    background: #0d0d0d;
    border-radius: 8px;
    border: 1px solid #004400;
}
/* ... (Keep other styles like post, profile, gallery) ... */


/* --- Mobile Navigation Bar (NEW) --- */
#mobile-nav {
    display: none; /* Hidden by default (desktop) */
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #111111;
    border-top: 1px solid #004400;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
    z-index: 2000;
    padding-bottom: env(safe-area-inset-bottom); /* For modern phones */
}

.mobile-tab-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 60px;
}

.mobile-nav-item {
    cursor: pointer;
    flex: 1;
    text-align: center;
    padding: 5px 0;
    color: #666666; /* Default inactive color */
    font-size: 0.75em;
    transition: color 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.mobile-nav-item .material-icons {
    font-size: 24px;
}

.mobile-nav-item.active {
    color: #00CC00; /* Active green color */
    font-weight: bold;
}
.mobile-nav-item:hover {
    color: #00FF00;
}
/* Mobile Notification Badge */
.mobile-notification-badge {
    position: absolute;
    top: 0px;
    right: 20%;
    background: red;
    color: white;
    border-radius: 50%;
    padding: 2px 5px;
    font-size: 0.6em;
    font-weight: bold;
}
/* Content padding adjustment for mobile footer */
@media (max-width: 768px) {
    main {
        padding-bottom: 80px; /* Make space for the fixed footer */
    }
}


/* --- Media Queries for Mobile Experience --- */
@media (max-width: 768px) {
    /* Hide Desktop elements */
    .header-actions {
        display: none !important;
    }
    #search-bar {
        min-width: 100px; /* Allow search bar to shrink */
        width: 60%;
    }
    header {
        padding: 10px 15px;
    }
    .header-left {
        gap: 15px;
    }
    .logo-container img {
        height: 28px;
    }
    main {
        padding: 15px 15px;
    }

    /* Show Mobile Navigation */
    #mobile-nav {
        display: block;
    }
    /* Hide footer on mobile */
    footer {
        display: none;
    }
    /* Adjust DM section height for smaller screens */
    .chat-messages {
        max-height: 350px;
    }
}


/* --- Post, Profile, Gallery Styles (Kept for completeness) --- */
.post {
    display:flex;
    flex-direction: column; 
    background:#1e1e1e;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 1px solid #004400;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}
.post-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}
.post-content {
    margin-bottom: 15px;
    white-space: pre-wrap; 
}
.post-image-container {
    max-width: 100%;
    margin: 10px 0 15px 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #004400;
}
.post-image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
}
.post-actions {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-top: 10px;
    border-top: 1px dashed #004400;
    padding-top: 10px;
}
.post-actions button {
    padding: 5px 10px;
    margin-top: 0;
    font-size: 0.9em;
    background: #333333;
    color: #00FF00;
}
.post-actions button:hover {
    background: #005500;
    box-shadow: none;
}
.reaction-count {
    margin-left: -15px; 
    font-size: 0.9em;
    color: #00CC00;
}
.post img, .profile-image-small {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid #00CC00;
    object-fit:cover;
    background: #0d0d0d; 
}
#profile-pic-display {width: 90px; height: 90px;}
.comments-section {
    margin-top: 20px;
    padding: 10px 0;
    border-top: 1px solid #004400;
    border-bottom: 1px solid #004400;
}
.comment {
    background: #0d0d0d;
    padding: 8px 12px;
    margin-bottom: 6px;
    border-left: 3px solid #00CC00;
    border-radius: 4px;
    font-size: 0.9em;
}
.comment-user {
    font-weight: bold;
    color: #00CC00;
}
.comment-input-area {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.comment-input-area input {
    flex-grow: 1;
    margin-bottom: 0;
    padding: 8px;
    border-radius: 4px;
}
.comment-input-area button {
    margin-top: 0;
    padding: 8px 15px;
    white-space: nowrap;
    background: #00CC00;
}
.comment-input-area button:hover {
    background: #00FF00;
}
#profile, #view-profile {
    background: #1e1e1e;
    padding: 25px;
    border-radius: 10px;
    border: 1px solid #004400;
}
#view-profile-content #profile-pic-view {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid #00CC00;
    background: #0d0d0d;
    margin-bottom: 10px;
}
.clickable-username {
    cursor: pointer;
    text-decoration: none; 
    color: #00CC00;
    transition: color 0.2s, text-decoration 0.2s;
}
.clickable-username:hover {
    color: #00FF00;
    text-decoration: underline;
}
.post-timestamp {
    font-size: 0.8em;
    color: #555555;
    margin-left: 10px;
}
.status-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
.active-dot {
    width: 12px;
    height: 12px;
    background: #00FF00; /* Bright Green */
    border-radius: 50%;
    box-shadow: 0 0 8px #00FF00;
}
.last-online-text {
    font-size: 0.9em;
    color: #777777;
}
.gallery-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: #111111;
    border-radius: 8px;
}
@media (max-width: 600px) {
    .gallery-container {
        grid-template-columns: repeat(3, 1fr); /* 3 columns on small screens */
        gap: 10px;
    }
}
.gallery-slot {
    background: #222222;
    border: 1px solid #004400;
    border-radius: 6px;
    padding: 5px;
    text-align: center;
    overflow: hidden;
}
.gallery-image-display {
    width: 100%;
    aspect-ratio: 1 / 1; 
    object-fit: cover;
    margin-bottom: 5px;
    border-radius: 4px;
    border: 1px solid #00CC00;
    cursor: pointer;
    transition: transform 0.3s, opacity 0.3s;
}
.gallery-image-display:hover {
    opacity: 0.8;
    transform: scale(1.02);
}
#messages-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.chat-summary {
    background: #1e1e1e;
    padding: 15px;
    border-radius: 8px;
    border-left: 5px solid #00CC00;
    cursor: pointer;
    transition: background 0.2s;
}
.chat-summary:hover {
    background: #222222;
}
.message {
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 70%;
    word-wrap: break-word;
    font-size: 0.95em;
    line-height: 1.4;
    position: relative;
}
.message-time {
    display: block;
    font-size: 0.75em;
    color: #555555;
    margin-top: 5px;
    text-align: right;
}
.sent {
    background: #005500; /* Darker Green for self */
    color: #FFFFFF;
    align-self: flex-end;
    border-top-right-radius: 5px;
}
.received {
    background: #333333;
    color: #00FF00;
    align-self: flex-start;
    border-top-left-radius: 5px;
}
#send-message-area {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}
#send-message-area input {
    flex-grow: 1;
    margin-bottom: 0;
}
#send-message-area button {
    margin-top: 0;
    padding: 10px 20px;
}
#notifications-display {
    background: #1e1e1e;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #004400;
}
.notification-item {
    padding: 10px;
    border-bottom: 1px dashed #004400;
}
</style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="logo-container">
            <img src="https://see.fontimg.com/api/rf5/vXL4/YTM3ZmYyMWFkMzNiNGY5MGEwY2ZmZTZmNDhiZGI4NzkudHRm/VHIzdk1lZGlh/chimpanzee-website-report.png?r=fs&h=65&w=1000&fg=E8E4E4&bg=27E2A1&tb=1&s=65" 
                 alt="Tr3vMedia Icon 1">
            <img src="https://scontent-iad3-2.xx.fbcdn.net/v/t39.30808-6/596009832_838710972097270_9022730636766278745_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=FV-kAQTMc9sQ7kNvwHtnXUJ&_nc_oc=AdnMy32z6EqV3KBKYoxV9lXa4sxDC5HGtKjqXOn1Ft5DhugILwP1VuHdODGDfKtXeMswLEwyf_07cIoNby3di58u&_nc_zt=23&_nc_ht=scontent-iad3-2.xx&_nc_gid=ffAPLrP0wQ4lRnuf3eL46g&oh=00_Afk9OB0-t0OJNQksLxcPV1gJpw_C1Z8IwkKu4li6rX9bgA&oe=6940AF3A" 
                 alt="Tr3vMedia Icon 2">
        </div>
        
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Search usernames..." onkeyup="searchUsers()">
            <div id="search-results"></div>
        </div>
        
    </div>
    
    <div class="header-actions" id="header-tabs"></div>
</header>

<div id="welcome-banner"></div>

<main id="main-content">
    <div id="auth" class="tab-content">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p>Or <span class="clickable-username" onclick="showSignup()">Sign Up</span></p>
    </div>

    <div id="signup" class="tab-content">
        <h2>Sign Up </h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signup()">Create Account</button>
        <p>Or <span class="clickable-username" onclick="showLogin()">Login</span></p>
    </div>

    <div id="home" class="tab-content">
        <div id="new-post">
            <textarea id="post-text" rows="3" placeholder="What's on your mind?"></textarea>
            <label for="post-image-upload">Add Image (Optional):</label>
            <input type="file" id="post-image-upload" accept="image/*" onchange="previewPostImage()">
            <div id="post-image-preview" class="post-image-container" style="display:none; height: 150px; background: #000000;">
                <img id="post-image-tag" class="post-image" style="max-height: 100%; object-fit: contain;">
            </div>

            <button onclick="addPost()">Post</button>
        </div>
        <div id="posts"></div>
    </div>

    <div id="profile" class="tab-content">
        <h2>My Profile</h2>
        <img id="profile-pic-display" class="profile-image-small" src="" alt="Profile Picture"><br>
        <label>Main Profile Picture:</label>
        <input type="file" id="profile-upload" accept="image/*" onchange="uploadProfilePic()">
        <textarea id="profile-bio" placeholder="Write your bio..."></textarea><br>
        
        <p>Username: <span id="my-profile-username"></span> <span id="owner-tag-me"></span></p>
        <p>Total Posts: <span id="my-profile-posts-count"></span></p>
        <p>Total Reactions Received: <span id="my-profile-likes-count"></span></p>
        
        <hr style="border-top: 1px solid #004400; margin: 20px 0;">

        <h3>ü§ù Following: <span id="my-profile-following-count">0</span> | Followers: <span id="my-profile-followers-count">0</span></h3>

        <hr style="border-top: 1px solid #004400; margin: 20px 0;">

        <h3>üñºÔ∏è Gallery (8 Images)</h3>
        <p style="font-size:0.9em; color:#00CC00;">Click the current image to upload a replacement.</p>
        <div class="gallery-container" id="my-gallery-edit">
            </div>

        <button onclick="saveProfile()" style="margin-top: 30px;">Save Profile & Bio</button>
    </div>
    
    <div id="view-profile" class="tab-content">
        <div id="view-profile-content">
            <img id="profile-pic-view" src="" alt="User Profile Picture"><br>
            <h2 id="view-username"></h2>
            <p id="view-owner-tag"></p>

            <div id="view-user-status" class="status-container"></div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="follow-button" onclick="toggleFollow()"></button>
                <button onclick="startDM(viewingUsername)">Message</button>
            </div>
            
            <p style="margin-top: 15px;">Bio: <span id="view-bio"></span></p>
            <p>Posts: <span id="view-posts-count"></span></p>
            <p>Reactions Received: <span id="view-likes-received"></span></p>
            <h3>ü§ù Following: <span id="view-following-count">0</span> | Followers: <span id="view-followers-count">0</span></h3>

            <hr style="border-top: 1px solid #004400; margin: 20px 0;">
            <h3>üñºÔ∏è Gallery</h3>
            <div class="gallery-container" id="view-gallery">
                </div>

            <hr style="border-top: 1px solid #004400; margin: 20px 0;">
            <h3>User Posts</h3>
            <div id="view-user-posts"></div>
        </div>
        <button onclick="showTab('home')" style="margin-top: 30px;">Back to Feed</button>
    </div>
    
    <div id="messages" class="tab-content">
        <h2>Direct Messages</h2>
        <div id="message-view">
            <h3>Chats:</h3>
            <div id="messages-list">
                </div>
        </div>
        
        <div id="conversation-container" style="display: none; margin-top: 30px;">
            <h3 id="chat-header"></h3>
            <div id="chat-messages" class="chat-messages">
                </div>
            <div id="send-message-area">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button onclick="sendMessage()">Send</button>
            </div>
            <button onclick="renderMessageList()" style="margin-top: 20px; width: auto; background: #333333;">&larr; Back to Chats</button>
        </div>
    </div>
    
    <div id="notifications" class="tab-content">
        <h2>üîî Notifications</h2>
        <div id="notifications-display">
            </div>
    </div>


    <div id="settings" class="tab-content">
        <h2>Settings</h2>
        
        <h3>Account Management</h3>
        <label>Change username: <input type="text" id="change-username"></label><br>
        <button onclick="changeUsername()">Save New Username</button>
        <button onclick="logout()" class="settings-button" style="background: #CC0000;">Logout</button>

        <hr style="border-top: 1px solid #004400; margin: 30px 0;">
        
        <h3>üåê Cross-Device Sync (Manual)</h3>
        <p style="font-size: 0.9em; color: #00CC00; line-height: 1.4;">
            To synchronize data between devices (e.g., PC and Mobile), use the Export button on the device with the *newest* data, 
            and use the Import button on the device with the *older* data.
        </p>
        <button onclick="exportData()" class="settings-button" style="background: #333333;">Export Data (Copy to Clipboard)</button>
        <button onclick="importData()" class="settings-button" style="background: #0088AA;">Import Data (Paste & Overwrite)</button>
        
    </div>
</main>

<footer>&copy; 2025 Tr3vMedia ‚Äî All Rights Reserved</footer>

<nav id="mobile-nav">
    <div class="mobile-tab-container">
        <div class="mobile-nav-item" onclick="showTab('home')">
            <span class="material-icons">home</span>
            Home
        </div>
        <div class="mobile-nav-item" id="mobile-messages-tab" onclick="showTab('messages')">
            <span class="material-icons">message</span>
            Messages
        </div>
        <div class="mobile-nav-item" id="mobile-notifications-tab" onclick="showTab('notifications')">
            <span class="material-icons">notifications</span>
            Notifications
        </div>
        <div class="mobile-nav-item" onclick="showTab('profile')">
            <span class="material-icons">person</span>
            Profile
        </div>
        <div class="mobile-nav-item" onclick="showTab('settings')">
            <span class="material-icons">settings</span>
            Settings
        </div>
    </div>
</nav>

<script>
// --- Global Constants & State ---
const DEFAULT_PIC = 'https://via.placeholder.com/60';
const DEFAULT_GALLERY_ITEM = 'https://via.placeholder.com/150x150?text=Empty+Slot';
const REACTIONS = ['like', 'heart', 'star']; 
const GALLERY_SIZE = 8; 

let currentPostImage = null; 
let viewingUsername = null; 
let currentChatPartner = null; 

// Helper function to format date
function formatTimestamp(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diff = now - then;

    if (diff < 60000) return 'Just now'; 
    if (diff < 3600000) return Math.round(diff / 60000) + 'm ago'; 
    if (diff < 86400000) return Math.round(diff / 3600000) + 'h ago'; 
    if (diff < 604800000) return Math.round(diff / 86400000) + 'd ago';
    
    return then.toLocaleDateString(); 
}

// Helper to create a standardized conversation ID (alphabetical sorting ensures consistency)
function getChatID(user1, user2) {
    return [user1, user2].sort().join('_');
}

// ------------------ Data Setup ------------------

// Define the absolute default data
const DEFAULT_USER_DATA = {
    'Tr3vN0x': {
        password:'ownerpass', 
        profilePic:DEFAULT_PIC, 
        bio:'Owner of Tr3vMedia', 
        gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM), 
        followers: ['TestUser1'], 
        following: ['TestUser1'], 
        isActive: false, 
        lastOnline: Date.now() - 600000, 
        notifications: [], 
        posts:[
            {
                text: 'Welcome to Tr3vMedia! This site just got a whole lot cooler. Check out this placeholder!', 
                imageUrl: 'https://via.placeholder.com/400x200?text=Site+Launch+Image', 
                date: Date.now(), 
                reactions: {like: [], heart: [], star: []},
                comments: [
                    {user: 'TestUser1', text: 'Looks awesome!'},
                    {user: 'Tr3vN0x', text: 'Thanks! Enjoy the new features.'}
                ]
            }
        ]
    },
    'TestUser1': {
        password:'password', 
        profilePic:DEFAULT_PIC, 
        bio:'Just a friendly user.', 
        gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM).map((_, i) => i === 0 ? 'https://via.placeholder.com/150x150?text=Cool+Pic' : DEFAULT_GALLERY_ITEM), 
        followers: ['Tr3vN0x'], 
        following: ['Tr3vN0x'], 
        isActive: false, 
        lastOnline: Date.now() - 10000000, 
        notifications: [], 
        posts:[
            {
                text: 'Testing the new clean style overhaul. Looking very polished!', 
                imageUrl: null,
                date: Date.now() - 5000000, 
                reactions: {like: ['Tr3vN0x'], heart: [], star: []},
                comments: []
            }
        ]
    }
};

const DEFAULT_MESSAGES_DATA = {
    [getChatID('Tr3vN0x', 'TestUser1')]: [
        { sender: 'TestUser1', text: 'Hey Tr3v, love the new DM feature!', date: Date.now() - 3600000 },
        { sender: 'Tr3vN0x', text: 'Thanks! Let me know if you run into any bugs.', date: Date.now() - 3500000 }
    ]
};

// Function to initialize or merge data 
function initializeOrMergeData() {
    let currentUsers = {};
    let currentMessages = {};
    let dataChanged = false;

    // Load existing data from localStorage
    try {
        const storedUsers = localStorage.getItem('users');
        if (storedUsers) {
            currentUsers = JSON.parse(storedUsers);
        }
    } catch (e) { console.error("Error parsing stored users.", e); }

    try {
        const storedMessages = localStorage.getItem('messages');
        if (storedMessages) {
            currentMessages = JSON.parse(storedMessages);
        }
    } catch (e) { console.error("Error parsing stored messages.", e); }
    
    let mergedUsers = {...currentUsers};
    let mergedMessages = {...currentMessages};
    
    // 1. Inject default users if missing
    for (const defaultUser in DEFAULT_USER_DATA) {
        if (!mergedUsers[defaultUser]) {
            mergedUsers[defaultUser] = DEFAULT_USER_DATA[defaultUser];
            dataChanged = true;
        }
    }
    
    // 2. Ensure all data structure properties are present for all users
    for (const username of Object.keys(mergedUsers)) {
        const user = mergedUsers[username];
        if (!user.notifications) { user.notifications = []; dataChanged = true; }
        if (!user.followers) { user.followers = []; dataChanged = true; }
        if (!user.following) { user.following = []; dataChanged = true; }
        if (!user.gallery || user.gallery.length !== GALLERY_SIZE) { 
            user.gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM); 
            dataChanged = true; 
        }
    }

    // 3. Inject default messages if missing
    for (const chatID in DEFAULT_MESSAGES_DATA) {
        if (!mergedMessages[chatID]) {
            mergedMessages[chatID] = DEFAULT_MESSAGES_DATA[chatID];
            dataChanged = true;
        }
    }

    // 4. Save if any changes were made
    if (dataChanged) {
        localStorage.setItem('users', JSON.stringify(mergedUsers));
        localStorage.setItem('messages', JSON.stringify(mergedMessages));
    }
    
    return dataChanged;
}

// Function to safely get all users (always triggers a merge first)
function getAllUsers() {
    initializeOrMergeData(); 
    return JSON.parse(localStorage.getItem('users'));
}

// Function to safely get all messages (always triggers a merge first)
function getAllMessages() {
    initializeOrMergeData();
    return JSON.parse(localStorage.getItem('messages'));
}


// ------------------ Data Export/Import (THE CROSS-PLATFORM FIX) ------------------

function exportData() {
    const data = {
        users: localStorage.getItem('users'),
        messages: localStorage.getItem('messages'),
        currentUser: localStorage.getItem('currentUser') 
    };
    
    const dataString = JSON.stringify(data);

    // Use modern Clipboard API if available, otherwise fallback to deprecated method
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(dataString).then(() => {
            alert("Data exported! The entire app data has been copied to your clipboard. Paste this into the 'Import Data' prompt on your other device.");
        }).catch(err => {
            console.error('Could not copy text: ', err);
            alert("Could not copy data to clipboard automatically. Please check the console for the data string and copy it manually.");
        });
    } else {
        // Fallback for older browsers or non-secure contexts (e.g., local files)
        prompt("Data Exported (Copy the text below):", dataString);
    }
}

function importData() {
    const dataString = prompt("Paste the exported data string here. WARNING: This will overwrite your current app data.");
    
    if (!dataString) return; 

    try {
        const importedData = JSON.parse(dataString);

        if (!importedData.users || !importedData.messages) {
            alert("Import failed: The pasted data is missing required sections (users or messages).");
            return;
        }

        // Apply imported data
        localStorage.setItem('users', importedData.users);
        localStorage.setItem('messages', importedData.messages);
        
        // Only set currentUser if the imported data has one (it should)
        if (importedData.currentUser) {
            localStorage.setItem('currentUser', importedData.currentUser);
        }

        alert("Data successfully imported! The app will now reload to apply the changes.");
        location.reload();

    } catch (e) {
        alert("Import failed: The pasted data is not valid JSON format. Please ensure you copied the entire string.");
        console.error("Import Error:", e);
    }
}

// ------------------ Auth Tabs ------------------
function showLogin() {document.getElementById('signup').style.display='none'; document.getElementById('auth').style.display='block';}
function showSignup() {document.getElementById('auth').style.display='none'; document.getElementById('signup').style.display='block';}

// ------------------ Signup / Login ------------------
function signup(){
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value.trim();
    if(!username||!password){alert("Fill all fields"); return;}
    
    const users = getAllUsers(); // Use new helper
    if(users[username]){alert("Username taken"); return;}
    
    users[username]={
        password,
        profilePic:DEFAULT_PIC,
        bio:'',
        posts:[],
        gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM),
        followers: [], 
        following: [],
        isActive: false, 
        lastOnline: Date.now(), 
        notifications: [] 
    }; 
    
    localStorage.setItem('users', JSON.stringify(users));
    alert("Account created! Login now.");
    showLogin();
}

function login(){
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const users = getAllUsers(); // Use new helper

    if(!users[username] || users[username].password!==password){alert("Invalid credentials"); return;}
    
    // Update active status when logging in
    users[username].isActive = true; 
    localStorage.setItem('users', JSON.stringify(users));
    
    localStorage.setItem('currentUser', username);
    initApp();
}

// ------------------ App Init ------------------
function initApp(){
    document.getElementById('auth').style.display='none';
    document.getElementById('signup').style.display='none';
    
    document.getElementById('welcome-banner').innerText=`Hello ${localStorage.getItem('currentUser')}!`;
    
    // Desktop Tabs
    document.getElementById('header-tabs').innerHTML=`
        <div class="nav-tab" onclick="showTab('home')">Home</div>
        <div class="nav-tab" id="messages-tab" onclick="showTab('messages')">Messages</div>
        <div class="nav-tab" id="notifications-tab" onclick="showTab('notifications')">Notifications</div>
        <div class="nav-tab" onclick="showTab('profile')">Profile</div>
        <div class="nav-tab" onclick="showTab('settings')">Settings</div>
        <div class="nav-tab" onclick="logout()">Logout</div>`;
    
    loadUser();
    updateNotificationBadges(); 
    showTab('home'); 
}

// ------------------ Logout ------------------
function logout(){
    const users = getAllUsers(); // Use new helper
    const currentUser = localStorage.getItem('currentUser');
    if (users[currentUser]) {
        users[currentUser].isActive = false;
        users[currentUser].lastOnline = Date.now();
        localStorage.setItem('users', JSON.stringify(users));
    }
    localStorage.removeItem('currentUser'); 
    location.reload();
}

// ------------------ Tab Switching ------------------
function showTab(tabId){
    document.querySelectorAll('.tab-content').forEach(tab=>tab.style.display='none');
    document.getElementById(tabId).style.display='block';
    
    // Handle Desktop Tabs
    document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));
    const activeTabElementDesktop = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
    if (activeTabElementDesktop) {
        activeTabElementDesktop.classList.add('active');
    }

    // Handle Mobile Tabs (NEW)
    document.querySelectorAll('.mobile-nav-item').forEach(tab=>tab.classList.remove('active'));
    const activeTabElementMobile = document.querySelector(`.mobile-nav-item[onclick*="showTab('${tabId}')"]`);
    if (activeTabElementMobile) {
        activeTabElementMobile.classList.add('active');
    }
    
    // ----------------------------------------------------
    // FIX: Force Synchronization before rendering key tabs
    // ----------------------------------------------------
    if (tabId === 'home') {
        initializeOrMergeData(); 
        renderPosts();
    } else if (tabId === 'profile') {
        renderGalleryEdit();
        loadUser(); 
    } else if (tabId === 'messages') { 
        clearMessageNotifications(); 
        renderMessageList();
    } else if (tabId === 'notifications') { 
        renderNotifications();
    }
}

// ------------------ Notifications ------------------

function updateNotificationBadges() {
    const currentUser = localStorage.getItem('currentUser');
    const users = getAllUsers(); // Use new helper
    const user = users[currentUser];
    
    // Helper to add/remove badge on an element
    const manageBadge = (elementId, count, isMessageBadge) => {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.querySelector('.notification-badge')?.remove();
        element.querySelector('.mobile-notification-badge')?.remove();

        if (count > 0) {
            const badge = document.createElement('span');
            badge.innerText = count;
            
            // Desktop uses standard badge, mobile uses its own class
            if (elementId.startsWith('mobile-')) {
                 badge.className = 'mobile-notification-badge';
            } else {
                 badge.className = 'notification-badge';
            }
            
            // Message badge only shows 1 for any unread message
            if (isMessageBadge) {
                badge.innerText = '‚Ä¢'; 
                badge.style.padding = '0 5px';
            }
            element.appendChild(badge);
        }
    };

    // Calculate message notifications (only count new messages)
    const messageNotifCount = user.notifications.filter(n => n.includes('YOU GOT A NEW MESSAGE!')).length;
    // General notifications are all other types
    const generalNotifCount = user.notifications.length; 
    
    // Desktop tabs
    manageBadge('messages-tab', messageNotifCount, true);
    manageBadge('notifications-tab', generalNotifCount, false);
    
    // Mobile tabs
    manageBadge('mobile-messages-tab', messageNotifCount, true);
    manageBadge('mobile-notifications-tab', generalNotifCount, false);
}

function clearMessageNotifications() {
    const currentUser = localStorage.getItem('currentUser');
    const users = getAllUsers(); // Use new helper
    
    // Remove badges from both desktop and mobile message tabs
    document.getElementById('messages-tab')?.querySelector('.notification-badge')?.remove();
    document.getElementById('mobile-messages-tab')?.querySelector('.mobile-notification-badge')?.remove();

    // Clear notifications of type 'message' from data
    users[currentUser].notifications = users[currentUser].notifications.filter(
        n => !n.includes('YOU GOT A NEW MESSAGE!')
    );
    localStorage.setItem('users', JSON.stringify(users));
    
    // Update the notification badge (which might still show general notifs)
    updateNotificationBadges(); 
}

function addNotification(recipient, message) {
    const users = getAllUsers(); // Use new helper
    if (!users[recipient].notifications) {
        users[recipient].notifications = [];
    }
    
    const notificationText = `Tr3vMedia: YOU GOT A NEW MESSAGE! (From ${message.sender})`;

    // Add new notification
    users[recipient].notifications.unshift(notificationText);
    
    localStorage.setItem('users', JSON.stringify(users));
    updateNotificationBadges();
}

function renderNotifications() {
    const currentUser = localStorage.getItem('currentUser');
    const users = getAllUsers(); // Use new helper
    const notifications = users[currentUser].notifications;
    const display = document.getElementById('notifications-display');
    display.innerHTML = '';

    if (notifications.length === 0) {
        display.innerHTML = '<p style="font-style: italic; color: #555555;">No new notifications.</p>';
        return;
    }

    notifications.forEach((note, index) => {
        const div = document.createElement('div');
        div.className = 'notification-item';
        div.innerText = note;
        display.appendChild(div);
    });

    // Clear all general notifications after viewing
    users[currentUser].notifications = users[currentUser].notifications.filter(
        n => n.includes('YOU GOT A NEW MESSAGE!')
    ); 
    localStorage.setItem('users', JSON.stringify(users));
    updateNotificationBadges(); // Update badge to only show message count if any remain
}
// ------------------ Rest of the Functions (Kept unchanged) ------------------

function loadUser(){
    const users=getAllUsers(); // Use new helper
    const currentUser=localStorage.getItem('currentUser');
    if(!currentUser) return;
    const user = users[currentUser];
    
    if (!user.followers) user.followers = [];
    if (!user.following) user.following = [];
    if (!user.notifications) user.notifications = [];


    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    document.getElementById('profile-pic-display').src=user.profilePic;
    document.getElementById('my-profile-username').innerText=currentUser;
    document.getElementById('my-profile-posts-count').innerText=user.posts.length;
    document.getElementById('my-profile-likes-count').innerText=totalReactions;
    document.getElementById('owner-tag-me').innerHTML=currentUser==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':'';
    document.getElementById('profile-bio').value=user.bio;
    
    document.getElementById('my-profile-following-count').innerText = user.following.length;
    document.getElementById('my-profile-followers-count').innerText = user.followers.length;

    renderPosts();
}
function uploadProfilePic(){
    const file = document.getElementById('profile-upload').files[0]; 
    if(file){
        if (!file.type.startsWith('image/')) {
            alert("Only image files are allowed for profile pictures.");
            document.getElementById('profile-upload').value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload=function(){
            const users=getAllUsers(); // Use new helper
            const currentUser=localStorage.getItem('currentUser');
            users[currentUser].profilePic=reader.result;
            localStorage.setItem('users',JSON.stringify(users));
            document.getElementById('profile-pic-display').src=reader.result;
            renderPosts();
        };
        reader.readAsDataURL(file);
    }
}
function saveProfile(){
    const users=getAllUsers(); // Use new helper
    const currentUser=localStorage.getItem('currentUser');
    users[currentUser].bio=document.getElementById('profile-bio').value;
    localStorage.setItem('users',JSON.stringify(users));
    alert("Profile saved!");
}
function uploadGalleryImage(index) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert("Only image files are allowed in the gallery.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function() {
                const users = getAllUsers(); // Use new helper
                const currentUser = localStorage.getItem('currentUser');
                
                if (!users[currentUser].gallery || users[currentUser].gallery.length !== GALLERY_SIZE) {
                    users[currentUser].gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
                }
                
                users[currentUser].gallery[index] = reader.result;
                localStorage.setItem('users', JSON.stringify(users));
                
                document.getElementById(`gallery-img-${index}`).src = reader.result;
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}
function renderGalleryEdit() {
    const users = getAllUsers(); // Use new helper
    const currentUser = localStorage.getItem('currentUser');
    const user = users[currentUser];
    const galleryContainer = document.getElementById('my-gallery-edit');
    galleryContainer.innerHTML = '';

    if (!user.gallery || user.gallery.length !== GALLERY_SIZE) {
        user.gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
        localStorage.setItem('users', JSON.stringify(users));
    }
    
    for (let i = 0; i < GALLERY_SIZE; i++) {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'gallery-slot';
        
        const img = document.createElement('img');
        img.id = `gallery-img-${i}`;
        img.className = 'gallery-image-display';
        img.src = user.gallery[i];
        img.alt = `Gallery Slot ${i + 1}`;
        img.onclick = () => uploadGalleryImage(i); 

        slotDiv.appendChild(img);
        
        const label = document.createElement('p');
        label.style.fontSize = '0.8em';
        label.style.margin = '5px 0 0 0';
        label.style.color = '#00CC00';
        label.innerText = `Slot ${i + 1}`;
        slotDiv.appendChild(label);

        galleryContainer.appendChild(slotDiv);
    }
}
function renderFollowButton(targetUser) {
    const currentUser = localStorage.getItem('currentUser');
    const users = getAllUsers(); // Use new helper
    const followButton = document.getElementById('follow-button');
    followButton.style.display = 'inline-block';

    if (currentUser === targetUser) {
        followButton.style.display = 'none'; 
        return;
    }

    const isFollowing = users[currentUser].following.includes(targetUser);

    if (isFollowing) {
        followButton.innerText = 'Unfollow';
        followButton.classList.add('unfollow');
    } else {
        followButton.innerText = 'Follow';
        followButton.classList.remove('unfollow');
    }
}
function toggleFollow() {
    const targetUser = viewingUsername;
    const currentUser = localStorage.getItem('currentUser');
    const users = getAllUsers(); // Use new helper
    
    let currentFollowing = users[currentUser].following;
    let targetFollowers = users[targetUser].followers;

    const isFollowing = currentFollowing.includes(targetUser);

    if (isFollowing) {
        users[currentUser].following = currentFollowing.filter(u => u !== targetUser);
        users[targetUser].followers = targetFollowers.filter(u => u !== currentUser);
    } else {
        if (!currentFollowing.includes(targetUser)) users[currentUser].following.push(targetUser);
        if (!targetFollowers.includes(currentUser)) users[targetUser].followers.push(currentUser);
    }

    localStorage.setItem('users', JSON.stringify(users));
    viewProfile(targetUser); 
}
function renderViewGallery(username, targetElement) {
    const users = getAllUsers(); // Use new helper
    const user = users[username];
    targetElement.innerHTML = '';
    
    const galleryImages = user.gallery || Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
    let galleryContent = '';
    let hasImages = false;

    galleryImages.forEach((imgUrl, index) => {
        if (imgUrl !== DEFAULT_GALLERY_ITEM) {
            hasImages = true;
            galleryContent += `
                <div class="gallery-slot" style="border: none; background: transparent; padding: 0;">
                    <img class="gallery-image-display" 
                         src="${imgUrl}" 
                         alt="${username}'s Gallery Image ${index + 1}"
                         style="cursor: default; border: 2px solid #006600;">
                </div>
            `;
        }
    });

    if (hasImages) {
        targetElement.innerHTML = galleryContent;
    } else {
        targetElement.innerHTML = '<p style="font-style: italic; color: #555555; padding: 10px;">User has no images in their gallery.</p>';
    }
}
function viewProfile(username){
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-input').value = ''; 
    viewingUsername = username; 
    
    const users=getAllUsers(); // Use new helper
    const user = users[username];
    if (!user) return alert("User not found.");
    
    if (!user.followers) user.followers = [];
    if (!user.following) user.following = [];
    if (user.isActive === undefined) user.isActive = false; 

    document.getElementById('profile-pic-view').src = user.profilePic;
    document.getElementById('view-username').innerText = username;
    document.getElementById('view-owner-tag').innerHTML = username === 'Tr3vN0x' ? '<span class="verified">‚úîÔ∏è Owner</span>' : '';
    
    renderUserStatus(username, user); 

    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    document.getElementById('view-bio').innerText = user.bio || 'No bio set.';
    document.getElementById('view-posts-count').innerText = user.posts.length;
    document.getElementById('view-likes-received').innerText = totalReactions;
    document.getElementById('view-following-count').innerText = user.following.length;
    document.getElementById('view-followers-count').innerText = user.followers.length;


    renderFollowButton(username);

    renderViewGallery(username, document.getElementById('view-gallery'));
    renderUserPosts(username, document.getElementById('view-user-posts'));
    
    showTab('view-profile');
}
function renderUserStatus(username, user) {
    const statusDiv = document.getElementById('view-user-status');
    statusDiv.innerHTML = '';
    
    if (user.isActive === true) {
        statusDiv.innerHTML = '<div class="active-dot"></div><strong>Active Now</strong>';
    } else {
        const lastOnlineTime = user.lastOnline || Date.now(); 
        statusDiv.innerHTML = `
            <div class="last-online-text">Last online: ${formatTimestamp(lastOnlineTime)}</div>
        `;
    }
}
function searchUsers() {
    const input = document.getElementById('search-input').value.toLowerCase();
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    
    if (input.length < 2) {
        return;
    }

    const users = getAllUsers(); // Use new helper
    const userKeys = Object.keys(users);
    
    const matchedUsers = userKeys.filter(username => 
        username.toLowerCase().includes(input)
    );

    if (matchedUsers.length > 0) {
        matchedUsers.forEach(username => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerText = username;
            resultItem.onclick = () => viewProfile(username);
            resultsDiv.appendChild(resultItem);
        });
    } else {
        const noResultItem = document.createElement('div');
        noResultItem.className = 'search-result-item';
        noResultItem.innerText = 'No users found.';
        resultsDiv.appendChild(noResultItem);
    }
}
function previewPostImage() {
    const fileInput = document.getElementById('post-image-upload');
    const previewContainer = document.getElementById('post-image-preview');
    const previewImage = document.getElementById('post-image-tag');
    const file = fileInput.files[0];
    
    currentPostImage = null;

    if (file) {
        if (!file.type.startsWith('image/')) {
            alert("Only image files are allowed in posts.");
            fileInput.value = ''; 
            previewContainer.style.display = 'none';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            currentPostImage = e.target.result; 
            previewImage.src = currentPostImage;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        previewContainer.style.display = 'none';
    }
}
function addPost(){
    const text=document.getElementById('post-text').value.trim();
    
    if(!text && !currentPostImage){alert("Cannot post empty text or image"); return;}
    
    const users=getAllUsers(); // Use new helper
    const currentUser=localStorage.getItem('currentUser');
    
    users[currentUser].posts.unshift({
        text,
        imageUrl: currentPostImage, 
        date:Date.now(), 
        reactions: {like: [], heart: [], star: []}, 
        comments: []
    }); 
    
    localStorage.setItem('users',JSON.stringify(users));
    
    document.getElementById('post-text').value='';
    document.getElementById('post-image-upload').value = '';
    document.getElementById('post-image-preview').style.display = 'none';
    currentPostImage = null;

    loadUser(); 
}
function toggleReaction(postUser, postIndex, reactionType){
    const users=getAllUsers(); // Use new helper
    const currentUser=localStorage.getItem('currentUser');
    const post = users[postUser].posts[postIndex];
    
    if(!post.reactions) post.reactions = {like: [], heart: [], star: []}; 

    REACTIONS.forEach(r => {
        const index = post.reactions[r].indexOf(currentUser);
        if (index !== -1) {
            post.reactions[r].splice(index, 1);
        }
    });

    const indexInTargetReaction = post.reactions[reactionType].indexOf(currentUser);
    if (indexInTargetReaction === -1) {
        post.reactions[reactionType].push(currentUser);
    } 
    
    localStorage.setItem('users',JSON.stringify(users));
    
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}
function addComment(postUser, postIndex) {
    const currentUser = localStorage.getItem('currentUser');
    const commentInput = document.getElementById(`comment-input-${postUser}-${postIndex}`);
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const users = getAllUsers(); // Use new helper
    const post = users[postUser].posts[postIndex];

    if (!post.comments) post.comments = []; 

    post.comments.push({
        user: currentUser,
        text: commentText
    });

    localStorage.setItem('users', JSON.stringify(users));
    
    commentInput.value = '';
    
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}
function renderComments(comments) {
    let html = '<div class="comments-section">';
    html += '<h4>Comments:</h4>';
    
    if (comments.length === 0) {
        html += '<p style="margin-left: 10px; font-style: italic; color: #555555;">No comments yet.</p>';
    }
    comments.forEach(c => {
        html += `<div class="comment">
                    <span class="comment-user clickable-username" onclick="viewProfile('${c.user}')">${c.user}</span>: ${c.text}
                 </div>`;
    });
    html += '</div>';
    return html;
}
function renderPostActions(postUser, postIndex, reactions, currentUser) {
    let actionsHTML = '';
    const reactionEmojis = {
        'like': 'üëç',
        'heart': '‚ù§Ô∏è',
        'star': '‚≠êÔ∏è'
    };

    REACTIONS.forEach(type => {
        const count = reactions[type] ? reactions[type].length : 0;
        const isActive = reactions[type].includes(currentUser);
        const buttonClass = isActive ? 'active-reaction' : '';
        
        actionsHTML += `
            <button class="${buttonClass}" onclick="toggleReaction('${postUser}', ${postIndex}, '${type}')">
                ${reactionEmojis[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}
            </button>
            <span class="reaction-count">${count}</span>
        `;
    });
    return actionsHTML;
}
function renderPostImage(imageUrl) {
    if (imageUrl) {
        return `
            <div class="post-image-container">
                <img src="${imageUrl}" class="post-image" alt="Post Image">
            </div>
        `;
    }
    return '';
}
function renderUserPosts(username, targetElement) {
    const users = getAllUsers(); // Use new helper
    const currentUser = localStorage.getItem('currentUser');
    const userPosts = users[username].posts;
    targetElement.innerHTML = '';

    userPosts.forEach((p, index) => {
        const postId = `${username}-${index}`; 
        const div = document.createElement('div'); 
        div.className = 'post';
        
        if (!p.comments) p.comments = [];

        div.innerHTML = `
            <div class="post-header">
                <img src="${users[username].profilePic}" class="profile-image-small" alt="${username}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${username}')">${username}</span>${username==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            
            ${renderPostImage(p.imageUrl)} 

            <div class="post-actions">
                ${renderPostActions(username, index, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment...">
                <button onclick="addComment('${username}', ${index})">Comment</button>
            </div>
        `;
        targetElement.appendChild(div);
    });
}
function renderPosts(){
    const users=getAllUsers(); // Use new helper
    const postsDiv=document.getElementById('posts'); postsDiv.innerHTML='';
    const currentUser=localStorage.getItem('currentUser');
    const allPosts=[];
    
    for(let user in users){
        users[user].posts.forEach((p, index) => {
            allPosts.push({
                user,
                text: p.text,
                imageUrl: p.imageUrl, 
                date: p.date,
                profilePic: users[user].profilePic,
                postIndex: index, 
                reactions: p.reactions || {like: [], heart: [], star: []},
                comments: p.comments || []
            });
        });
    }
    
    allPosts.sort((a,b)=>b.date-a.date);
    
    allPosts.forEach(p=>{
        const postId = `${p.user}-${p.postIndex}`; 
        const div=document.createElement('div'); div.className='post';
        div.innerHTML=`
            <div class="post-header">
                <img src="${p.profilePic}" class="profile-image-small" alt="${p.user}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${p.user}')">${p.user}</span>${p.user==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            
            ${renderPostImage(p.imageUrl)} 
            
            <div class="post-actions">
                ${renderPostActions(p.user, p.postIndex, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment..." class="comment-input">
                <button onclick="addComment('${p.user}', ${p.postIndex})">Comment</button>
            </div>
        `;
        postsDiv.appendChild(div);
    });
}
function changeUsername(){
    const newName=document.getElementById('change-username').value.trim();
    if(!newName) return alert("Username cannot be empty");
    
    const users=getAllUsers(); // Use new helper
    const currentUser=localStorage.getItem('currentUser');
    if(users[newName]) return alert("Username taken");
    
    if (currentUser === 'Tr3vN0x') return alert("The owner's username cannot be changed.");
    
    users[newName]=users[currentUser]; 
    delete users[currentUser];
    
    for (let userKey in users) {
        const userObj = users[userKey];
        
        let followerIndex = userObj.followers.indexOf(currentUser);
        if (followerIndex !== -1) userObj.followers[followerIndex] = newName;

        let followingIndex = userObj.following.indexOf(currentUser);
        if (followingIndex !== -1) userObj.following[followingIndex] = newName;
        
        let notificationIndex = userObj.notifications.findIndex(n => n.includes(`(From ${currentUser})`));
        if (notificationIndex !== -1) {
             userObj.notifications[notificationIndex] = userObj.notifications[notificationIndex].replace(currentUser, newName);
        }

        userObj.posts.forEach(post => {
            if (post.reactions) {
                REACTIONS.forEach(r => {
                    const index = post.reactions[r].indexOf(currentUser);
                    if (index !== -1) {
                        post.reactions[r][index] = newName;
                    }
                });
            }
            if (post.comments) {
                post.comments.forEach(comment => {
                    if (comment.user === currentUser) {
                        comment.user = newName;
                    }
                });
            }
        });
    }
    
    const messages = getAllMessages(); // Use new helper
    const newMessages = {};

    for (const chatID in messages) {
        const [u1, u2] = chatID.split('_');
        let newU1 = u1 === currentUser ? newName : u1;
        let newU2 = u2 === currentUser ? newName : u2;
        const newChatID = getChatID(newU1, newU2);

        const conversation = messages[chatID];
        conversation.forEach(msg => {
            if (msg.sender === currentUser) {
                msg.sender = newName;
            }
        });
        newMessages[newChatID] = conversation;
    }

    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('messages', JSON.stringify(newMessages));
    localStorage.setItem('currentUser',newName);
    
    document.getElementById('change-username').value = '';
    loadUser();
    
    alert("Username changed! You must log in again with your new username.");
    logout(); 
}
function startDM(targetUser) {
    currentChatPartner = targetUser;
    showTab('messages');
    renderConversation(targetUser);
}

function renderMessageList() {
    const currentUser = localStorage.getItem('currentUser');
    const messages = getAllMessages(); // Use new helper
    const listDiv = document.getElementById('messages-list');
    listDiv.innerHTML = '';
    
    document.getElementById('message-view').style.display = 'block';
    document.getElementById('conversation-container').style.display = 'none';
    currentChatPartner = null;

    const chatPartners = [];
    for (const chatID in messages) {
        if (chatID.includes(currentUser)) {
            const partners = chatID.split('_');
            const partner = partners.find(p => p !== currentUser);
            if (partner) chatPartners.push(partner);
        }
    }
    
    if (chatPartners.length === 0) {
        listDiv.innerHTML = '<p style="font-style: italic; color: #555555;">No current conversations. Start one from a user\'s profile!</p>';
        return;
    }

    chatPartners.forEach(partner => {
        const chatID = getChatID(currentUser, partner);
        const chat = messages[chatID];
        const lastMessage = chat[chat.length - 1];
        
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'chat-summary';
        summaryDiv.onclick = () => renderConversation(partner);
        summaryDiv.innerHTML = `
            <strong>Chat with ${partner}</strong>
            <p style="font-size: 0.9em; margin: 5px 0 0 0; color: #999999;">
                ${lastMessage.sender === currentUser ? 'You' : lastMessage.sender}: ${lastMessage.text.substring(0, 40)}...
                <span style="float: right; font-size: 0.8em; color: #555555;">${formatTimestamp(lastMessage.date)}</span>
            </p>
        `;
        listDiv.appendChild(summaryDiv);
    });
}

function renderConversation(partner) {
    const currentUser = localStorage.getItem('currentUser');
    const messages = getAllMessages(); // Use new helper
    const chatID = getChatID(currentUser, partner);
    const chat = messages[chatID] || [];
    
    currentChatPartner = partner;
    document.getElementById('message-view').style.display = 'none';
    document.getElementById('conversation-container').style.display = 'block';
    document.getElementById('chat-header').innerText = `Chatting with ${partner}`;
    
    const chatMessagesDiv = document.getElementById('chat-messages');
    chatMessagesDiv.innerHTML = '';

    chat.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
        msgDiv.innerHTML = `
            ${msg.text}
            <span class="message-time">${formatTimestamp(msg.date)}</span>
        `;
        chatMessagesDiv.appendChild(msgDiv);
    });
    
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
}

function sendMessage() {
    const currentUser = localStorage.getItem('currentUser');
    const partner = currentChatPartner;
    const input = document.getElementById('message-input');
    const text = input.value.trim();

    if (!text || !partner) return;

    const messages = getAllMessages(); // Use new helper
    const users = getAllUsers(); // Use new helper
    const chatID = getChatID(currentUser, partner);

    if (!messages[chatID]) {
        messages[chatID] = [];
    }

    const newMessage = {
        sender: currentUser,
        text: text,
        date: Date.now()
    };

    messages[chatID].push(newMessage);
    localStorage.setItem('messages', JSON.stringify(messages));
    
    addNotification(partner, newMessage);

    input.value = '';
    renderConversation(partner); 
}


// ------------------ Check login on reload ------------------

if(localStorage.getItem('currentUser')) {
    const users = getAllUsers(); // Use new helper
    const currentUser = localStorage.getItem('currentUser');
    if (users[currentUser]) {
        users[currentUser].isActive = true;
        localStorage.setItem('users', JSON.stringify(users));
    }
    initApp(); 
} else {
    showLogin();
}
</script>

</body>
</html>
