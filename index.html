<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Gaming Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS VARIABLES (Neon LED Cyan Dominant Theme) --- */
        :root {
            --color-dark-bg: #03030F; /* Deepest black/blue */
            --color-card-bg: #0D0D26; /* Dark navy card base */
            --color-primary: #00FFFF; /* NEON LED CYAN DOMINANT */
            --color-secondary: #FF3366; /* NEON PINK ACTION ACCENT */
            --color-text-light: #E0FFFF;
            --color-text-fade: #A0FFFF;
            --color-border: #1A1A4A;
            --color-status-online: #4CAF50;
            --color-status-ingame: var(--color-secondary); 
            --font-main: 'Electrolize', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --neon-shadow-primary: 0 0 10px rgba(0, 255, 255, 0.9), 0 0 20px rgba(0, 255, 255, 0.4); /* Intense Cyan Glow */
            --neon-shadow-secondary: 0 0 8px rgba(255, 51, 102, 0.7);
        }

        /* Global & Reset */
        @import url('https://fonts.googleapis.com/css2?family=Electrolize&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--color-dark-bg);
            color: var(--color-text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* --- Global Neon Styles --- */
        .glow {
            text-shadow: var(--neon-shadow-primary);
        }
        .btn-action {
            background-color: var(--color-secondary); /* Pink for action */
            color: var(--color-dark-bg);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-action:hover {
            background-color: #CC2B53;
            box-shadow: 0 0 15px var(--color-secondary);
        }
        .form-group input, .form-group textarea, .filter-bar select {
            background-color: var(--color-dark-bg);
            border: 1px solid var(--color-primary);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        
        /* --- NAVIGATION BAR --- */
        .navbar {
            border-bottom: 3px solid var(--color-primary);
            box-shadow: 0 0 15px var(--color-primary);
        }
        .navbar .logo {
            color: var(--color-primary);
            text-shadow: var(--neon-shadow-primary);
        }
        .navbar .logo i {
            color: var(--color-secondary); 
        }
        .nav-link:hover {
            text-shadow: var(--neon-shadow-primary);
            color: var(--color-primary);
        }

        /* --- HOME GRID / PLAYER CARD STYLES --- */
        .player-card {
            border: 1px solid var(--color-border);
        }
        .player-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            transform: translateY(-8px);
        }
        .player-card::before {
            background: var(--color-primary);
        }
        .card-header img {
            border: 3px solid var(--color-primary);
            box-shadow: var(--neon-shadow-primary);
        }
        .card-tags li {
            background-color: #1A1A3A;
            color: var(--color-primary);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        .btn-duoup {
            background-color: var(--color-secondary);
            color: var(--color-dark-bg);
        }
        .btn-duoup.sent {
            background-color: var(--color-border);
            color: var(--color-text-fade);
            box-shadow: none;
            pointer-events: none;
        }

        /* --- PROFILE VIEW STYLES --- */
        .profile-view-card {
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 20px var(--color-primary);
        }
        .profile-header h1 {
            color: var(--color-primary);
            text-shadow: var(--neon-shadow-primary);
        }
        .btn-edit-profile {
            background-color: var(--color-primary);
            color: var(--color-dark-bg);
            box-shadow: var(--neon-shadow-primary);
        }
        .profile-stat span:last-child {
            color: var(--color-primary);
        }

        /* --- MESSAGING VIEW STYLES --- */
        .chat-list h3 {
            color: var(--color-primary);
            text-shadow: var(--neon-shadow-primary);
        }
        .chat-item.active {
            border-left: 4px solid var(--color-secondary);
        }
        .message.outgoing {
            background-color: var(--color-secondary);
        }
    </style>
</head>
<body>

    <main style="width: 100%;">

        <div class="navbar" id="main-nav" style="display: none;">
            <div class="logo"><i class="fas fa-satellite-dish"></i> Duoup</div>
            <div>
                <a href="#" class="nav-link" onclick="showView('home-view')"><i class="fas fa-home"></i> Home</a>
                <a href="#" class="nav-link" onclick="showView('messaging-view')"><i class="fas fa-envelope"></i> Messages</a>
                <a href="#" class="nav-link" onclick="showView('profile-preview-view')"><i class="fas fa-user-circle"></i> Profile</a>
            </div>
        </div>

        <div class="app-view" id="signup-view" style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
            <div class="signup-card centered-card">
                <h2 class="glow">Join Duoup</h2>
                <form id="signup-form">
                    <div class="form-group"><label for="username">Gamertag</label><input type="text" id="username" required></div>
                    <div class="form-group"><label for="email">Email</label><input type="email" id="email" required></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
                    <div class="form-group"><label for="age">Age</label><input type="number" id="age" required min="13"></div>
                    <div class="form-group"><label for="gameCode">Main Game / Platform</label><input type="text" id="gameCode" required></div>
                    <button type="submit" class="btn-action">Sign Up (Email/Pass)</button>
                    <p class="error-message" id="signup-error"></p>
                </form>
                <button class="btn-action" style="background-color: #4285F4; margin-top: 10px;" onclick="handleGoogleSignIn()">
                    <i class="fab fa-google"></i> Sign Up with Google
                </button>
            </div>
        </div>

        <div class="app-view" id="home-view">
            <h2 class="section-heading glow" style="max-width: 1400px; margin: 20px auto; padding-left: 20px; border-color: var(--color-secondary);">Looking For Duo (LFD) Feed</h2>
            
            <div class="filter-bar">
                <select id="game-filter"><option value="">All Games</option></select>
                <select id="platform-filter"><option value="">All Platforms</option></select>
                <select id="style-filter"><option value="">All Styles</option></select>
            </div>
            
            <div class="player-grid" id="player-card-grid">
                <p style="text-align: center; width: 100%; color: var(--color-text-fade);">Connecting to the Duoup Network...</p>
            </div>
        </div>

        <div class="app-view" id="profile-preview-view">
            <div class="profile-view-card">
                <button class="btn-edit-profile" onclick="showView('profile-edit-view')"><i class="fas fa-edit"></i> Edit Profile</button>
                <div class="profile-header">
                    <img id="profile-img-preview" src="https://via.placeholder.com/100/00FFFF/050510?text=U" alt="Your Profile">
                    <div>
                        <h1 id="profile-username" class="glow">Loading...</h1>
                        <p id="profile-gamecode">Main Game: N/A</p>
                    </div>
                </div>
                
                <h3 style="color: var(--color-primary); border-color: var(--color-border);">About Me</h3>
                <p id="profile-bio" style="margin-bottom: 15px;">Loading...</p>
                
                <div class="profile-details">
                    <h3 style="color: var(--color-primary); border-color: var(--color-border);">Stats & Details</h3>
                    <div class="profile-stat"><span>Age</span><span id="stat-age">N/A</span></div>
                    <div class="profile-stat"><span>Friends</span><span id="stat-friends">0</span></div>
                    <div class="profile-stat"><span>Joined</span><span id="stat-joined">N/A</span></div>
                    <h3 style="color: var(--color-primary); border-color: var(--color-border);">Tags</h3>
                    <div class="tag-list" id="profile-tags-preview"></div>
                </div>
            </div>
        </div>

        <div class="app-view" id="profile-edit-view" style="display: flex; justify-content: center;">
            <div class="profile-edit centered-card">
                <h2 class="glow"><i class="fas fa-wrench"></i> Edit Your Profile</h2>
                <form id="profile-edit-form">
                    <div class="form-group"><label for="edit-username">Gamertag</label><input type="text" id="edit-username"></div>
                    <div class="form-group"><label for="edit-bio">Current Objective / Bio</label><textarea id="edit-bio" rows="3"></textarea></div>
                    <div class="form-group"><label for="edit-age">Age</label><input type="number" id="edit-age" min="13"></div>
                    <div class="form-group"><label for="edit-gamecode">Main Game / Platform</label><input type="text" id="edit-gamecode"></div>
                    <p style="color: var(--color-primary); margin-top: 15px;">Tags (separate by comma)</p>
                    <div class="form-group"><input type="text" id="edit-tags" placeholder="e.g., Competitive, Voice Chat, DPS"></div>
                    <button type="submit" class="btn-action"><i class="fas fa-save"></i> Save Changes</button>
                    <button type="button" class="btn-action" style="background-color: var(--color-border);" onclick="showView('profile-preview-view')">Cancel</button>
                    <p class="error-message" id="profile-edit-error" style="color: var(--color-secondary);"></p>
                </form>
            </div>
        </div>

        <div class="app-view" id="messaging-view" style="padding: 0;">
            <div class="messaging-container">
                <div class="chat-list" id="chat-list-container">
                    <h3 style="padding: 15px; color: var(--color-primary); text-shadow: var(--neon-shadow-primary);">Duoup Chats</h3>
                    </div>
                <div class="chat-window">
                    <div class="messages" id="chat-messages">
                        <p style="text-align: center; color: var(--color-text-fade); margin-top: 50px;">Select a chat to begin messaging.</p>
                    </div>
                    <div class="message-input">
                        <input type="text" id="message-text" placeholder="Send a message...">
                        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ====================================================================
        // 1. FIREBASE CONFIGURATION & INITIALIZATION
        // ====================================================================

        // !! IMPORTANT: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL FIREBASE CONFIG !!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        
        let currentUserData = null; // Stores user profile from Firestore

        // --- View Management ---
        const views = {
            'signup-view': document.getElementById('signup-view'),
            'home-view': document.getElementById('home-view'),
            'profile-preview-view': document.getElementById('profile-preview-view'),
            'profile-edit-view': document.getElementById('profile-edit-view'),
            'messaging-view': document.getElementById('messaging-view'),
        };
        const nav = document.getElementById('main-nav');
        
        function showView(viewId) {
            Object.values(views).forEach(v => v.style.display = 'none');
            const targetView = views[viewId];
            if (targetView) {
                targetView.style.display = 'block';
            }
            nav.style.display = (viewId !== 'signup-view') ? 'flex' : 'none';
            
            if (viewId === 'home-view') fetchDuoupUsers();
            if (viewId.startsWith('profile')) loadProfileData(viewId);
            if (viewId === 'messaging-view') setupChatListListener(); 
            
            document.body.style.alignItems = (viewId === 'signup-view') ? 'center' : 'flex-start';
        }


        // ====================================================================
        // 2. AUTHENTICATION (Sign-up and State Management)
        // ====================================================================

        // Handles Email/Password Sign Up
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const age = document.getElementById('age').value;
            const gameCode = document.getElementById('gameCode').value;
            const errorDisplay = document.getElementById('signup-error');
            errorDisplay.textContent = '';

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 1. Update Auth Profile (set display name)
                await user.updateProfile({ displayName: username });

                // 2. Create Firestore User Profile
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    username: username,
                    email: email,
                    age: parseInt(age),
                    gameCode: gameCode,
                    bio: `Hey, I just joined Duoup! Maining ${gameCode}.`,
                    friends: [],
                    joinedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    tags: [gameCode.split('-')[1] || 'Casual', 'Voice Chat'],
                    status: 'Online'
                });
                
                // Auth state listener handles the redirect
            } catch (error) {
                errorDisplay.textContent = 'Error: ' + error.message;
            }
        });
        
        // Handles Google Sign In (Requires Google Provider setup in Firebase console)
        async function handleGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const errorDisplay = document.getElementById('signup-error');
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user profile exists in Firestore (for new users)
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    await db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        username: user.displayName,
                        email: user.email,
                        age: 0, // Placeholder
                        gameCode: 'N/A',
                        bio: `Joined via Google! Looking for players.`,
                        friends: [],
                        joinedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        tags: ['Newbie', 'LFG'],
                        status: 'Online'
                    });
                }
                // Auth state listener handles the redirect
            } catch (error) {
                errorDisplay.textContent = 'Error: ' + error.message;
            }
        }

        // Firebase Auth State Listener (The core of the app flow)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in, fetch their data and go home
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    currentUserData = doc.data();
                    showView('home-view');
                } else {
                    // Should not happen if signup was successful
                    console.error("User profile missing in Firestore.");
                    auth.signOut();
                }
            } else {
                // User is signed out, show sign-up page
                currentUserData = null;
                showView('signup-view');
            }
        });


        // ====================================================================
        // 3. HOME VIEW (Fetching & Rendering Users)
        // ====================================================================

        // Fetches users from Firestore and renders the cards
        async function fetchDuoupUsers() {
            const grid = document.getElementById('player-card-grid');
            grid.innerHTML = '<p style="text-align: center; width: 100%; color: var(--color-primary);">Fetching LFD posts...</p>';
            
            try {
                // Query for users who are NOT the current user
                const snapshot = await db.collection('users')
                    .where('uid', '!=', auth.currentUser.uid)
                    .limit(10)
                    .get();

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align: center; width: 100%; color: var(--color-text-fade);">No other Duoup users found right now.</p>';
                    return;
                }
                
                grid.innerHTML = snapshot.docs.map(doc => {
                    const user = doc.data();
                    const tags = user.tags.map(tag => `<li style="color: var(--color-primary);">${tag}</li>`).join('');
                    const statusClass = user.status === 'Online' ? 'status-online' : user.status === 'In Game' ? 'status-ingame' : 'status-offline';
                    
                    return `
                        <div class="player-card">
                            <div class="card-header">
                                <img src="https://via.placeholder.com/70/00FFFF/0D0D26?text=${user.username[0]}" alt="Profile" />
                                <div class="card-info">
                                    <h3>${user.username}</h3>
                                    <span class="status-badge ${statusClass}">${user.status}</span>
                                </div>
                            </div>
                            <h4 style="color:var(--color-text-fade); margin-bottom: 5px;">${user.gameCode}</h4>
                            <p class="card-objective">${user.bio}</p>
                            <ul class="card-tags">${tags}</ul>
                            <button class="btn-duoup btn-action" onclick="sendFriendRequest('${user.uid}', this)">
                                <i class="fas fa-handshake"></i> Duo Up
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                grid.innerHTML = `<p style="text-align: center; width: 100%; color: var(--color-secondary);">Error loading users: ${error.message}</p>`;
                console.error("Error fetching users:", error);
            }
        }

        // Sends a friend request (requires Firestore Security Rules to allow writes to 'friendRequests')
        async function sendFriendRequest(targetUid, buttonElement) {
            if (!auth.currentUser) return;

            try {
                // Check if a request already exists (optional, but good practice)
                const existingRequest = await db.collection('friendRequests')
                    .where('senderId', '==', auth.currentUser.uid)
                    .where('receiverId', '==', targetUid)
                    .get();

                if (!existingRequest.empty) {
                    buttonElement.textContent = 'Request Already Sent';
                    buttonElement.classList.add('sent');
                    return;
                }

                // Write the friend request to Firestore
                await db.collection('friendRequests').add({
                    senderId: auth.currentUser.uid,
                    receiverId: targetUid,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });
                
                buttonElement.textContent = 'Request Sent';
                buttonElement.classList.add('sent');
                buttonElement.style.boxShadow = 'none';

            } catch (error) {
                console.error("Error sending request:", error);
                alert('Failed to send request. Check console for details.');
            }
        }


        // ====================================================================
        // 4. PROFILE MANAGEMENT (Preview and Edit)
        // ====================================================================

        function loadProfileData(viewId) {
            if (!currentUserData) return;

            // PREVIEW VIEW
            const date = currentUserData.joinedDate ? new Date(currentUserData.joinedDate.seconds * 1000) : new Date();
            
            document.getElementById('profile-username').textContent = currentUserData.username;
            document.getElementById('profile-gamecode').textContent = `Main Game: ${currentUserData.gameCode}`;
            document.getElementById('profile-bio').textContent = currentUserData.bio;
            document.getElementById('stat-age').textContent = currentUserData.age;
            document.getElementById('stat-friends').textContent = currentUserData.friends.length;
            document.getElementById('stat-joined').textContent = date.toLocaleDateString();
            document.getElementById('profile-tags-preview').innerHTML = currentUserData.tags.map(tag => `<li class="tag">${tag}</li>`).join('');

            // EDIT VIEW
            if (viewId === 'profile-edit-view') {
                document.getElementById('edit-username').value = currentUserData.username;
                document.getElementById('edit-bio').value = currentUserData.bio;
                document.getElementById('edit-age').value = currentUserData.age;
                document.getElementById('edit-gamecode').value = currentUserData.gameCode;
                document.getElementById('edit-tags').value = currentUserData.tags.join(', ');
                document.getElementById('profile-edit-error').textContent = '';
            }
        }

        document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editError = document.getElementById('profile-edit-error');
            editError.textContent = 'Saving...';
            
            const newUsername = document.getElementById('edit-username').value.trim();
            const newBio = document.getElementById('edit-bio').value;
            const newAge = parseInt(document.getElementById('edit-age').value);
            const newGameCode = document.getElementById('edit-gamecode').value;
            const newTags = document.getElementById('edit-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (newUsername.length < 3) {
                editError.textContent = 'Username must be at least 3 characters.';
                return;
            }
            if (newUsername !== currentUserData.username) {
                 // **CRITICAL CHECK:** Check for username uniqueness before updating
                 const usernameCheck = await db.collection('users').where('username', '==', newUsername).get();
                 if (!usernameCheck.empty) {
                     editError.textContent = 'That username is already taken.';
                     return;
                 }
            }

            try {
                // 1. Update Firestore Profile
                await db.collection('users').doc(auth.currentUser.uid).update({ 
                    username: newUsername,
                    bio: newBio, 
                    age: newAge, 
                    gameCode: newGameCode, 
                    tags: newTags 
                });
                
                // 2. Update Auth Display Name
                await auth.currentUser.updateProfile({ displayName: newUsername });

                // 3. Update local cache and redirect
                currentUserData.username = newUsername;
                currentUserData.bio = newBio;
                currentUserData.age = newAge;
                currentUserData.gameCode = newGameCode;
                currentUserData.tags = newTags;

                editError.textContent = 'Profile successfully updated!';
                setTimeout(() => showView('profile-preview-view'), 1000);

            } catch (error) {
                editError.textContent = 'Error saving profile: ' + error.message;
                console.error("Error updating profile:", error);
            }
        });


        // ====================================================================
        // 5. MESSAGING (Real-time Listeners)
        // ====================================================================
        
        let currentChatId = null;

        // Listener for the user's list of active chats
        function setupChatListListener() {
            if (!auth.currentUser) return;
            const chatListContainer = document.getElementById('chat-list-container');
            chatListContainer.innerHTML = '<h3 style="padding: 15px; color: var(--color-primary);">Duoup Chats</h3>';

            // Find all chat documents where the current user is a participant
            db.collection('chats')
                .where('participants', 'array-contains', auth.currentUser.uid)
                .orderBy('lastMessage.timestamp', 'desc')
                .onSnapshot(snapshot => {
                    chatListContainer.innerHTML = '<h3 style="padding: 15px; color: var(--color-primary);">Duoup Chats</h3>';
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        const participantId = chat.participants.find(uid => uid !== auth.currentUser.uid);
                        // In a real app, you'd fetch the participant's name/data from the 'users' collection
                        
                        // Placeholder for participant name (use the ID for now)
                        const participantName = `User ${participantId.substring(0, 5)}...`; 
                        
                        // Render chat item
                        const item = document.createElement('div');
                        item.className = `chat-item ${doc.id === currentChatId ? 'active' : ''}`;
                        item.setAttribute('onclick', `loadChat('${doc.id}', '${participantName}')`);
                        item.innerHTML = `
                             <img src="https://via.placeholder.com/40/FF3366/050510?text=${participantName[0]}" style="border-radius:50%; margin-right: 10px;"/>
                            <div class="chat-item-info">
                                <h4>${participantName}</h4>
                                <p>${chat.lastMessage ? chat.lastMessage.content : 'New Chat'}</p>
                            </div>
                            <span class="chat-time">${chat.lastMessage ? new Date(chat.lastMessage.timestamp.seconds * 1000).toLocaleTimeString() : ''}</span>
                        `;
                        chatListContainer.appendChild(item);
                    });
                }, error => console.error("Error listening to chats:", error));
        }

        // Loads a specific chat and sets up a message listener
        function loadChat(chatId, participantName) {
            currentChatId = chatId;
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.chat-item[onclick*='${chatId}']`).classList.add('active');

            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `<p style="text-align: center; color: var(--color-primary); margin-top: 50px;">Loading chat with ${participantName}...</p>`;

            // Real-time listener for messages in the selected chat
            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    messagesContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const type = message.senderId === auth.currentUser.uid ? 'outgoing' : 'incoming';
                        
                        const msgDiv = document.createElement('div');
                        msgDiv.className = `message ${type}`;
                        msgDiv.textContent = message.content;
                        messagesContainer.appendChild(msgDiv);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Auto-scroll
                }, error => console.error("Error listening to messages:", error));
        }

        // Sends a message to the active chat
        async function sendMessage() {
            const input = document.getElementById('message-text');
            const content = input.value.trim();
            if (!content || !currentChatId) return;

            const message = {
                senderId: auth.currentUser.uid,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };

            try {
                // 1. Add message to the subcollection
                await db.collection('chats').doc(currentChatId).collection('messages').add(message);
                
                // 2. Update the parent chat document (for last message preview/sorting)
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: {
                        content: content,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    }
                });
                
                input.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }
        
        // --- Logout Function ---
        function logout() {
            auth.signOut();
            currentChatId = null;
        }

        // Initial setup on load
        document.addEventListener('DOMContentLoaded', () => {
            // Link a logout button (if you add one to the nav bar)
            // Example: document.getElementById('logout-btn').onclick = logout;
        });

    </script>
</body>
</html>
