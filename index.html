<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DuoUp</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:Arial;background:#050510;color:white}
button{cursor:pointer}
header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#141426}
.hidden{display:none}
.container{padding:20px}
input,textarea{width:100%;padding:8px;margin:5px 0}
.duo-card{background:#1A1A2E;border-radius:8px;margin:10px 0;padding:10px}
.avatar{width:40px;height:40px;border-radius:50%;background:#FF5733;display:flex;align-items:center;justify-content:center;font-weight:bold}
</style>
</head>

<body>

<header id="mainHeader" class="hidden">
  <strong>DuoUp</strong>
  <nav>
    <button id="homeBtn">Home</button>
    <button id="profileBtn">Profile</button>
    <button id="logoutBtn">Logout</button>
  </nav>
</header>

<div id="authSection" class="container">
  <form id="signinForm">
    <h3>Sign In</h3>
    <input id="signinEmail" placeholder="Email" required>
    <input id="signinPassword" type="password" placeholder="Password" required>
    <button type="submit">Sign In</button>
  </form>

  <form id="signupForm">
    <h3>Sign Up</h3>
    <input id="signupNickname" placeholder="Nickname" required>
    <input id="signupEmail" type="email" placeholder="Email" required>
    <input id="signupPassword" type="password" placeholder="Password" required>
    <button type="submit">Create Account</button>
  </form>
</div>

<div id="appSection" class="hidden">
  <div id="homeSection" class="container">
    <h2>Duo Search</h2>
    <div id="usersGrid"></div>
  </div>

  <div id="profileSection" class="container hidden">
    <h2>Profile</h2>
    <textarea id="profileBio" placeholder="Your bio"></textarea>
    <input id="profileImageUrl" placeholder="Image URL">
    <button id="saveProfileBtn">Save</button>
    <div id="preview"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  getDocs,
  collection
} from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* DOM */
const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");
const mainHeader = document.getElementById("mainHeader");

const signinForm = document.getElementById("signinForm");
const signupForm = document.getElementById("signupForm");

const signinEmail = document.getElementById("signinEmail");
const signinPassword = document.getElementById("signinPassword");

const signupEmail = document.getElementById("signupEmail");
const signupPassword = document.getElementById("signupPassword");
const signupNickname = document.getElementById("signupNickname");

const logoutBtn = document.getElementById("logoutBtn");

const homeSection = document.getElementById("homeSection");
const profileSection = document.getElementById("profileSection");
const usersGrid = document.getElementById("usersGrid");

const profileBio = document.getElementById("profileBio");
const profileImageUrl = document.getElementById("profileImageUrl");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const preview = document.getElementById("preview");

let currentUserData = {};

/* Auth */
signinForm.onsubmit = async e => {
  e.preventDefault();
  await signInWithEmailAndPassword(auth, signinEmail.value, signinPassword.value);
};

signupForm.onsubmit = async e => {
  e.preventDefault();
  const cred = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    uid:cred.user.uid,
    nickname:signupNickname.value,
    bio:"",
    profileImageUrl:"",
    friends:[]
  });
};

logoutBtn.onclick = () => signOut(auth);

/* State */
onAuthStateChanged(auth, async user => {
  if(user){
    authSection.classList.add("hidden");
    appSection.classList.remove("hidden");
    mainHeader.classList.remove("hidden");
    await loadUser(user);
    loadUsers();
  } else {
    authSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    mainHeader.classList.add("hidden");
  }
});

/* Data */
async function loadUser(user){
  const snap = await getDoc(doc(db,"users",user.uid));
  currentUserData = snap.data();
  profileBio.value = currentUserData.bio || "";
  profileImageUrl.value = currentUserData.profileImageUrl || "";
  renderPreview();
}

async function loadUsers(){
  usersGrid.innerHTML="";
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    usersGrid.innerHTML += `<div class="duo-card">${d.data().nickname}</div>`;
  });
}

/* Profile */
function renderPreview(){
  preview.innerHTML = `
    <div class="duo-card">
      <strong>${currentUserData.nickname}</strong>
      <p>${profileBio.value}</p>
    </div>`;
}

saveProfileBtn.onclick = async () => {
  await setDoc(doc(db,"users",auth.currentUser.uid),{
    bio:profileBio.value,
    profileImageUrl:profileImageUrl.value,
    friends:currentUserData.friends || []
  },{merge:true});
  renderPreview();
};
</script>

</body>
</html>
