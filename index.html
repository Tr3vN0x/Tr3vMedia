<?php
// index.php
// This PHP file serves as the wrapper for the single-page application (SPA).
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP (Cyber Social Platform)</title>

<link rel="icon" type="image/x-icon" href="https://your-domain.com/favicon.ico"> 
<link rel="apple-touch-icon" href="https://your-domain.com/apple-touch-icon.png">

<meta property="og:title" content="DUO UP: Find Your Next Cyber Social Partner">
<meta property="og:description" content="The ultimate platform for cyber warriors to connect, build duos, and dominate the digital landscape.">
<meta property="og:image" content="https://your-domain.com/duo-up-thumbnail.png">
<meta property="og:url" content="https://your-domain.com/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@YourTwitterHandle">
<meta name="twitter:title" content="DUO UP: Cyber Social Platform">
<meta name="twitter:description" content="Connect, duo up, and conquer. Find your next teammate today.">
<meta name="twitter:image" content="https://your-domain.com/duo-up-thumbnail.png">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
<style>
/* --- Base styles --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none !important; }
/* Header */
.header { background:#111; border-bottom:3px solid cyan; box-shadow:0 0 20px rgba(0,255,255,0.5); padding:10px 0; margin-bottom:20px; display:flex; align-items:center; justify-content:center; }
.header h1 { font-size:2.5em; color:#fff; text-shadow:0 0 5px cyan,0 0 10px cyan,0 0 15px magenta; margin:0; }
/* Icon Container for Lightning Bolt */
.icon-container { margin-right:15px; font-size:2.5em; color:yellow; text-shadow:0 0 5px yellow,0 0 10px orange; }
/* Buttons */
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; transition:all 0.2s ease-in-out; text-transform:uppercase; font-family:'Orbitron',sans-serif; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; transform: translateY(-1px); }
.neon-btn:disabled { border-color:#555; box-shadow:none; color:#555; cursor:not-allowed; }
.neon-btn.add { border-color:lime; box-shadow:0 0 10px lime; }
.neon-btn.add:hover { border-color:green; box-shadow:0 0 15px green; }
.neon-btn.remove { border-color:red; box-shadow:0 0 10px red; }
.neon-btn.remove:hover { border-color:orange; box-shadow:0 0 15px orange; }
.neon-btn.pending { border-color:yellow; box-shadow:0 0 10px yellow; color:yellow; cursor:default; }
/* Input fields */
input[type="text"], input[type="number"], textarea, select { flex-grow:1; padding:10px; border:1px solid cyan; background:#181818; color:white; border-radius:6px; font-family:inherit; outline:none; transition:border-color 0.2s, box-shadow 0.2s; }
input:focus, textarea:focus, select:focus { border-color: magenta; box-shadow: 0 0 8px magenta; }
textarea { resize: vertical; }
/* Cards */
.card-container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; padding-top: 10px; }
.card { width: 100%; max-width:300px; padding:20px; border:3px solid transparent; border-radius:8px; background:#181818; box-shadow:0 0 15px rgba(0,255,255,0.4), inset 0 0 5px rgba(0,255,255,0.2); border-image-source: linear-gradient(45deg, cyan, magenta, cyan); border-image-slice:1; display:flex; flex-direction:column; align-items:center; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s; }
.card:hover { transform: translateY(-5px); box-shadow:0 0 30px magenta, inset 0 0 10px rgba(255,0,255,0.5); }
.request-card { cursor:default; border:3px solid orange; box-shadow:0 0 15px orange; }
.request-card:hover { transform:none; box-shadow:0 0 15px orange; }

.card-content-box { display:flex; flex-direction:column; align-items:center; width:100%; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #333; }
.avatar { width:80px; height:80px; border-radius:50%; border:4px solid magenta; object-fit:cover; margin-bottom:15px; }
.skill-rating { color:gold; font-size:1.4em; margin-bottom:10px; }

/* Game Category (formerly Discipline) styling */
.game-category { font-size:0.9em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:5px; text-transform:uppercase; color:#0b0b0b; }
.game-category-leagueoflegends { background-color:#0077B6; color:white; }
.game-category-fortnite { background-color:#5a189a; color:white; }
.game-category-valorant { background-color:#FF4655; color:white; }
.game-category-cybersecurity { background-color:lime; color:#0b0b0b; }
.game-category-other { background-color:gray; color:white; }

/* Game Role styling */
.game-role { font-size:0.8em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:5px; text-transform:uppercase; background-color:cyan; color:#0b0b0b;}

/* Looking For Category styling */
.lfd-category { font-size:0.8em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:10px; text-transform:uppercase; background-color:#ff00ff; color:white; border:1px solid white;}


.status-indicator { font-size:0.9em; padding:4px 10px; border-radius:4px; font-weight:bold; margin-bottom:10px; text-transform:uppercase; }
.status-online { background-color:#00cc00; color:#0b0b0b; box-shadow:0 0 5px #00ff00; }
.status-ingame { background-color:#ffaa00; color:#0b0b0b; box-shadow:0 0 5px #ffaa00; }
.status-lfd { background-color:#ff00ff; color:white; box-shadow:0 0 5px #ff00ff; border:1px solid #ff00ff; }

/* Co-Founder Badge Style */
.nickname-group { display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
.co-founder-badge { 
    background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700); 
    color: #333; 
    font-size: 0.75em; 
    padding: 2px 8px; 
    border-radius: 4px; 
    font-weight: bold;
    text-transform: uppercase;
    margin-left: 8px; /* Spacing next to nickname */
    box-shadow: 0 0 5px #FFD700;
}
/* Nav */
#navigationBar { display:flex; justify-content:center; flex-wrap:wrap; padding:10px; background:#151515; border-radius:8px; margin-bottom:30px; border:1px solid #333; }
#searchControls { display:flex; gap:15px; margin-bottom:20px; align-items:center; flex-wrap:wrap; background:#1a1a1a; padding:15px; border-radius:8px; border:1px solid #004444; }
/* Messaging */
#messagingTab { display:flex; gap:20px; height:75vh; }
#chatList { width:300px; padding:15px; border:2px solid cyan; border-radius:8px; background:#1a1a1a; overflow-y:auto; }
#activeDuoList { margin-top:10px; }
.chat-entry { padding:10px; border-bottom:1px dashed #333; cursor:pointer; transition: background 0.2s; }
.chat-entry:hover { background:#2a2a2a; }
.chat-entry.active { background:#004444; border-left:5px solid lime; font-weight:bold; }
#chatWindow { flex-grow:1; display:flex; flex-direction:column; border:2px solid magenta; border-radius:8px; background:#1a1a1a; }
#chatHeader { padding:10px; border-bottom:2px solid magenta; margin:0; background:#330033; }
#messageDisplay { flex-grow:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
/* Message Bubbles - Styling the chat */
.message { max-width:70%; padding:10px 15px; border-radius:18px; font-size:0.95em; position:relative; }
.message span { display:block; font-size:0.7em; opacity:0.6; text-align:right; margin-top:3px; }
.message.sent { 
    background:#005555; 
    align-self:flex-end; 
    border-bottom-right-radius:5px;
    box-shadow: 0 0 5px #00ffff;
}
.message.received { 
    background:#333333; 
    align-self:flex-start; 
    border-bottom-left-radius:5px;
    box-shadow: 0 0 5px #ff00ff;
}
#messageInputArea { padding:10px; border-top:2px solid magenta; background:#0b0b0b; display:flex; gap:10px; }
/* Profile view */
#viewProfileTab { display:none; }
/* Refined Profile Content Style */
#viewProfileContent { padding:30px; border:3px solid magenta; border-radius:12px; background:#1a1a1a; margin-top:20px; display:flex; flex-direction:column; align-items:center; }
.profile-stat { width:100%; max-width:400px; display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #333; margin-bottom:5px; }
.profile-stat span:first-child { color: cyan; font-weight:bold; }
.profile-stat span:last-child { text-align:right; }
</style>
</head>
<body>
<div class="header"><div class="icon-container">‚ö°</div><h1>DUO UP (Cyber Social Platform)</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Log in to connect and find your next cyber-duo.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>
<div id="navigationBar">
<button class="neon-btn" onclick="showTab('allUsers')">Suggested</button>
<button class="neon-btn" onclick="showTab('search')">Find Players</button>
<button class="neon-btn" onclick="showTab('friends')">Duos</button>
<button class="neon-btn" onclick="showTab('messaging')">Messaging</button>
<button class="neon-btn" onclick="showTab('profile')">Profile</button>
<button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="allUsersTab" class="card-container"></div>

<div id="searchTab" class="hidden container">
<h2>Player Search Filter</h2>
<div id="searchControls">
<input type="text" id="searchInput" placeholder="Search by Nickname or Bio..." onkeyup="filterSearchResults()">
<label style="color:cyan; margin-left:15px;">Status:</label>
<select id="statusFilter" onchange="filterSearchResults()">
<option value="">Any Status</option>
<option value="Online">Online</option>
<option value="In Game">In Game</option>
<option value="LFD">Looking For Duo (LFD)</option>
</select>
<label style="color:cyan; margin-left:15px;">Game/Category:</label>
<select id="gameCategoryFilter" onchange="filterSearchResults()">
<option value="">Any Game/Category</option>
<option value="LeagueOfLegends">League of Legends</option>
<option value="Fortnite">Fortnite</option>
<option value="Valorant">Valorant</option>
<option value="CyberSecurity">Cyber Security</option>
<option value="Other">Other</option>
</select>
<label style="color:cyan; margin-left:15px;">Game Role/Mode:</label>
<select id="gameRoleFilter" onchange="filterSearchResults()">
<option value="">Any Role/Mode</option>
<option value="TopTank">Top Tank (LoL)</option>
<option value="JungleCarry">Jungle Carry (LoL)</option>
<option value="Duo">Duo (Fortnite/Valorant)</option>
<option value="Squad">Squad (Fortnite)</option>
<option value="Support">Support (LoL/Valorant)</option>
<option value="ExploitDev">Exploit Dev (Cyber)</option>
<option value="RedTeamOp">Red Team Op (Cyber)</option>
</select>
<label style="color:cyan; margin-left:15px;">Looking For:</label>
<select id="lfdCategoryFilter" onchange="filterSearchResults()">
<option value="">Any LFD Type</option>
<option value="Duo">Duo (2-person team)</option>
<option value="Squad">Squad (3+ person team)</option>
<option value="Team">Full Team (Permanent)</option>
<option value="Mentor">Mentor/Mentee</option>
</select>
</div>
<div id="searchResults" class="card-container"></div>
</div>

<div id="friendsTab" class="container hidden">
<h2>Incoming Friend Requests</h2>
<div id="pendingRequestsList" class="card-container"></div>
<h2 style="margin-top:40px;">Your Accepted Duos</h2>
<div id="friendList" class="card-container">
    <p style="width:100%; text-align:center; color:magenta;">
    Load accepted duos here.
    </p>
</div>
</div>

<div id="messagingTab" class="hidden">
<div id="chatList">
<h3>Active Duos</h3>
<div id="activeDuoList">No Duos yet.</div>
</div>
<div id="chatWindow">
<h3 id="chatHeader">Select a Duo to start messaging</h3>
<div id="messageDisplay"></div>
<div id="messageInputArea" class.hidden">
<input type="text" id="messageInput" placeholder="Type your message..." onkeyup="if(event.key==='Enter') sendMessage()">
<button class="neon-btn" id="sendMessageBtn" onclick="sendMessage()">Send</button>
</div>
</div>
</div>

<div id="viewProfileTab" class="hidden container">
<button class="neon-btn" onclick="showTab('allUsers')">‚Üê Back to Suggested</button>
<div id="viewProfileContent"></div>
</div>

<div id="profileTab" class="hidden container">
<h2>Gamer-Profile Editor</h2>
<div style="padding:20px; border:2px solid magenta; border-radius:10px; background:#1a1a1a;">
<div style="display:flex; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
    <div style="margin-right:20px; display:flex; flex-direction:column; align-items:center;">
        <img id="profileAvatar" class="avatar" src="" style="width:100px;height:100px;border-color:cyan;">
        <p style="font-size:0.8em; margin:5px 0 0 0;">Upload New:</p>
        <input type="file" id="avatarFile" accept="image/*" style="width:150px; font-size:0.8em; border:none;" onchange="previewAvatar(event)">
    </div>
    <div style="flex-grow:1; min-width:200px;">
        <label style="color: cyan; display:block; margin-bottom:5px;">Unique Identifier:</label>
        <input type="text" id="profileNickname" value="User Nickname" placeholder="Your Unique Nickname">
        <p id="nicknameChangeInfo" style="color:yellow; font-size:0.8em; margin:5px 0 0 0;">(You get one free nickname change.)</p>
    </div>
</div>
<div style="margin-bottom:15px;">
<label style="color: cyan; display:block; margin-bottom:5px;">Bio/Tagline:</label>
<textarea id="profileBio" rows="3" style="width:100%;"></textarea>
</div>
<div style="display:flex; gap:30px; margin-bottom:20px; flex-wrap:wrap;">
<div>
    <label style="color: cyan; display:block; margin-bottom:5px;">Skill Rating (1-5):</label>
    <input id="profileSkillRating" type="number" min="1" max="5">
</div>
<div>
    <label style="color: cyan; display:block; margin-bottom:5px;">Primary Game/Category:</label>
    <select id="profileGameCategory">
        <option value="LeagueOfLegends">League of Legends</option>
        <option value="Fortnite">Fortnite</option>
        <option value="Valorant">Valorant</option>
        <option value="CyberSecurity">Cyber Security</option>
        <option value="Other">Other</option>
    </select>
</div>
</div>
<div style="display:flex; gap:30px; margin-bottom:20px; flex-wrap:wrap;">
    <div>
        <label style="color: cyan; display:block; margin-bottom:5px;">Game Role/Mode:</label>
        <select id="profileGameRole">
            <option value="TopTank">Top Tank (LoL)</option>
            <option value="JungleCarry">Jungle Carry (LoL)</option>
            <option value="Duo">Duo (Fortnite/Valorant)</option>
            <option value="Squad">Squad (Fortnite)</option>
            <option value="Support">Support (LoL/Valorant)</option>
            <option value="ExploitDev">Exploit Dev (Cyber)</option>
            <option value="RedTeamOp">Red Team Op (Cyber)</option>
            <option value="Generalist">Generalist/Flex</option>
        </select>
    </div>
    <div>
        <label style="color: cyan; display:block; margin-bottom:5px;">Current Status:</label>
        <select id="profileStatus" onchange="toggleLfdCategory()">
            <option value="Online">Online</option>
            <option value="In Game">In Game</option>
            <option value="LFD">Looking For Duo (LFD)</option>
        </select>
    </div>
    <div id="lfdCategoryGroup" class="hidden">
        <label style="color: cyan; display:block; margin-bottom:5px;">LFD Goal:</label>
        <select id="profileLfdCategory">
            <option value="Duo">Duo (2-person team)</option>
            <option value="Squad">Squad (3+ person team)</option>
            <option value="Team">Full Team (Permanent)</option>
            <option value="Mentor">Mentor/Mentee</option>
        </select>
    </div>
</div>
<button class="neon-btn" style="border-color:#00ff00; box-shadow:0 0 10px #00ff00;" onclick="saveProfile()">Save Profile</button>
<p id="saveMessage" style="color:#00ff00; margin-top:10px;"></p>
</div>
</div>

<script>
// ---------------------------
// Firebase Init
// NOTE: üõëüõë REPLACE THESE WITH YOUR ACTUAL CONFIG üõëüõë
const firebaseConfig = {
    apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
    authDomain:"duoup-cfae6.firebaseapp.com",
    projectId:"duoup-cfae6",
    storageBucket:"duoup-cfae6.firebasestorage.app",
    messagingSenderId:"812263060524",
    appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

let currentUser=null;
let currentProfileData={};
let allUsersCache=[]; 
let requestCache = {}; 
let currentChatId=null;
let chatListener=null;

// ----------------------------------------------------
// üåü CO-FOUNDER / BADGE LOGIC 
// ----------------------------------------------------
const CO_FOUNDER_UIDS = [
    "GmH4xJp92vY8sbwIWgJWjFw9MOQ2", // UID provided by user
];

function getCoFounderBadge(uid) {
    if (CO_FOUNDER_UIDS.includes(uid)) {
        return '<div class="co-founder-badge">Co-Founder / Developer</div>';
    }
    return '';
}
// ----------------------------------------------------


// ---------------------------
// Utility Functions
function getChatId(otherUid) {
    // Standardized Chat ID format: UID1_UID2 (alphabetically sorted)
    return [currentUser.uid, otherUid].sort().join('_');
}

function findUserInCache(uid) {
    return allUsersCache.find(user => user.id === uid);
}

// ---------------------------
// Authentication
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function logout(){ if(chatListener) chatListener(); auth.signOut(); }

// ---------------------------
// Profile Editor Helper
function toggleLfdCategory() {
    const status = document.getElementById('profileStatus').value;
    const group = document.getElementById('lfdCategoryGroup');
    if (status === 'LFD') {
        group.classList.remove('hidden');
    } else {
        group.classList.add('hidden');
    }
}

// ---------------------------
// Tab switching
function showTab(tab){
    document.querySelectorAll('#allUsersTab,#searchTab,#friendsTab,#messagingTab,#profileTab,#viewProfileTab').forEach(e=>e.classList.add('hidden'));

    if(tab!=='messaging' && chatListener){
        chatListener();
        chatListener=null;
        currentChatId=null;
        document.getElementById('messageDisplay').innerHTML = '';
        document.getElementById('chatHeader').textContent = 'Select a Duo to start messaging';
        document.getElementById('messageInputArea').classList.add('hidden');
    }

    switch(tab){
        case 'allUsers': loadAllUsers(); break;
        case 'search': filterSearchResults(); break;
        case 'friends': loadFriends(); break;
        case 'messaging': loadChatList(); break;
        case 'profile': loadUserProfile(); toggleLfdCategory(); break; // Initialize LFD selector visibility
        default: break;
    }
    document.getElementById(tab+'Tab')?.classList.remove('hidden');
}

// ---------------------------
// Load Users and Rendering
async function loadAllUsers(){
    if(!currentUser) return;
    const container=document.getElementById('allUsersTab');
    container.innerHTML="<h3>Loading Suggested Players...</h3>";
    try{
        const snapshot=await db.collection('users').get();
        allUsersCache=snapshot.docs.map(d=>({id:d.id,...d.data()}));
        
        // Load all requests involving the current user (accepted or pending)
        const requestsSnap = await db.collection('requests')
            .where('participants', 'array-contains', currentUser.uid)
            .get();
            
        requestCache = {};
        requestsSnap.forEach(doc => {
            const data = doc.data();
            // Determine the UID of the *other* user in this request
            const otherUid = data.senderId === currentUser.uid ? data.receiverId : data.senderId;
            requestCache[otherUid] = { 
                id: doc.id, 
                status: data.status, 
                senderId: data.senderId,
                receiverId: data.receiverId
            };
        });

        container.innerHTML=""; 

        allUsersCache.forEach(user=>{
            if(user.id===currentUser.uid) return;
            const card=renderUserCard(user.id, user, requestCache[user.id]);
            if(card) container.appendChild(card);
        });
    }catch(e){ container.innerHTML+=`<p style="width:100%; text-align:center; color:red;">Error loading users: ${e.message}</p>`; }
}

function renderUserCard(uid, data, requestInfo){
    if(!data) return null;
    const card=document.createElement('div');
    card.className='card';
    card.onclick=()=>viewProfile(uid, data);
    const statusClass=(data.status||'Online').replace(/\s/g,'').toLowerCase();
    const badge = getCoFounderBadge(uid);
    
    // NEW FIELDS
    const gameCategory = data.gameCategory || 'Other';
    const gameCategoryClass = `game-category-${gameCategory.toLowerCase()}`;
    const gameRole = data.gameRole || 'Generalist';
    const lfdCategory = data.lfdCategory || null; 

    let cardButtons;
    
    // Logic to determine the correct button based on request status (omitted for brevity)
    if (requestInfo) {
        if (requestInfo.status === 'pending') {
            if (requestInfo.senderId === currentUser.uid) {
                cardButtons = `<button class="neon-btn pending">Pending (Waiting for reply)</button>`; 
            } else {
                cardButtons = `<button class="neon-btn pending">Request Sent To You</button>`;
            }
        } else if (requestInfo.status === 'accepted') {
            cardButtons = `<button class="neon-btn" style="border-color:lime; color:lime;">Duo</button>`;
        } else {
            cardButtons = `<button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${uid}')">Send Request</button>`;
        }
    } else {
        cardButtons = `<button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${uid}')">Send Request</button>`;
    }
    
    // Optional LFD Category Display
    let lfdCategoryDisplay = '';
    if (data.status === 'LFD' && lfdCategory) {
        lfdCategoryDisplay = `<div class="lfd-category">${lfdCategory}</div>`;
    }

    card.innerHTML=`
        <div class="card-content-box">
        <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar">
        <div class="nickname-group">
            <h3 style="margin:0;">${data.nickname||'Unknown'}</h3>
            ${badge}
        </div>
        <div class="game-category ${gameCategoryClass}">${gameCategory.replace(/([A-Z])/g, ' $1').trim()}</div>
        <div class="game-role">${gameRole.replace(/([A-Z])/g, ' $1').trim()}</div>
        ${lfdCategoryDisplay} 
        <div class="skill-rating">${'‚≠ê'.repeat(data.skillRating||3)}</div>
        <div class="status-indicator status-${statusClass}">${data.status||'Online'}</div>
        <p style="margin:5px 0; font-size:0.9em; text-align:center; color:#ccc;">${data.bio||'No bio provided.'}</p>
        </div>
        ${cardButtons}
    `;
    return card;
}

function renderDuoCard(uid, data){
    if(!data) return null;
    const card=document.createElement('div');
    card.className='card';
    card.onclick=()=>viewProfile(uid, data);
    const statusClass=(data.status||'Online').replace(/\s/g,'').toLowerCase();
    const badge = getCoFounderBadge(uid);
    
    // NEW FIELDS
    const gameCategory = data.gameCategory || 'Other';
    const gameCategoryClass = `game-category-${gameCategory.toLowerCase()}`;
    const gameRole = data.gameRole || 'Generalist';
    const lfdCategory = data.lfdCategory || null; 

    // Optional LFD Category Display
    let lfdCategoryDisplay = '';
    if (data.status === 'LFD' && lfdCategory) {
        lfdCategoryDisplay = `<div class="lfd-category">${lfdCategory}</div>`;
    }

    card.innerHTML=`
        <div class="card-content-box">
        <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar" style="border-color:lime;">
        <div class="nickname-group">
            <h3 style="margin:0;">${data.nickname||'Unknown'}</h3>
            ${badge}
        </div>
        <div class="game-category ${gameCategoryClass}">${gameCategory.replace(/([A-Z])/g, ' $1').trim()}</div>
        <div class="game-role">${gameRole.replace(/([A-Z])/g, ' $1').trim()}</div>
        ${lfdCategoryDisplay}
        <div style="color:lime; margin:5px 0;">ACCEPTED DUO</div>
        <div class="status-indicator status-${statusClass}">${data.status||'Online'}</div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="neon-btn" onclick="event.stopPropagation(); openChat('${uid}', '${data.nickname}')">Message Duo</button>
            <button class="neon-btn remove" onclick="event.stopPropagation(); removeDuo('${uid}')">Remove Duo</button>
        </div>
    `;
    return card;
}


function renderRequestCard(senderUid, data, requestId){
    if(!data) return null;
    const card=document.createElement('div');
    card.className='card request-card';
    const statusClass=(data.status||'Online').replace(/\s/g,'').toLowerCase();
    const badge = getCoFounderBadge(senderUid);
    
    // NEW FIELDS
    const gameCategory = data.gameCategory || 'Other';
    const gameCategoryClass = `game-category-${gameCategory.toLowerCase()}`;
    const gameRole = data.gameRole || 'Generalist';
    const lfdCategory = data.lfdCategory || null; 

    const cardButtons = `
        <div style="display:flex; gap:10px;">
            <button class="neon-btn add" onclick="event.stopPropagation(); handleRequest('${requestId}', 'accepted')">Accept</button>
            <button class="neon-btn remove" onclick="event.stopPropagation(); handleRequest('${requestId}', 'rejected')">Reject</button>
        </div>
    `;
    
    // Optional LFD Category Display
    let lfdCategoryDisplay = '';
    if (data.status === 'LFD' && lfdCategory) {
        lfdCategoryDisplay = `<div class="lfd-category">${lfdCategory}</div>`;
    }

    card.innerHTML=`
        <div class="card-content-box">
        <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar" style="border-color:orange;">
        <div class="nickname-group">
            <h3 style="margin:0;">${data.nickname||'Unknown'}</h3>
            ${badge}
        </div>
        <div class="game-category ${gameCategoryClass}">${gameCategory.replace(/([A-Z])/g, ' $1').trim()}</div>
        <div class="game-role">${gameRole.replace(/([A-Z])/g, ' $1').trim()}</div>
        ${lfdCategoryDisplay}
        <div style="color:yellow; margin:5px 0;">Incoming Request</div>
        <div class="status-indicator status-${statusClass}">${data.status||'Online'}</div>
        </div>
        ${cardButtons}
    `;
    return card;
}


// ---------------------------
// Friends / Duos / Requests (omitted for brevity, remains unchanged)
// ... (handleRequest, removeDuo, sendFriendRequest remain the same)
// ---------------------------

async function loadFriends() {
    const pendingListEl = document.getElementById('pendingRequestsList');
    const friendListEl = document.getElementById('friendList');
    pendingListEl.innerHTML = 'Loading Requests...';
    friendListEl.innerHTML = 'Loading Duos...';
    
    await loadAllUsers(); 

    try {
        const pendingRequests = Object.values(requestCache).filter(req => 
            req.status === 'pending' && req.receiverId === currentUser.uid
        );

        if (pendingRequests.length === 0) {
            pendingListEl.innerHTML = '<p style="width:100%; text-align:center;">No pending requests at this time.</p>';
        } else {
            pendingListEl.innerHTML = '';
            pendingRequests.forEach(request => {
                const senderProfile = findUserInCache(request.senderId);
                
                if (senderProfile) {
                    const requestId = getChatId(request.senderId); 
                    const card = renderRequestCard(request.senderId, senderProfile, requestId);
                    if (card) pendingListEl.appendChild(card);
                }
            });
        }
    } catch (e) {
        console.error("Error loading Pending Requests:", e);
        pendingListEl.innerHTML = `<p style="width:100%; text-align:center; color:red;">ERROR loading Pending Requests: ${e.message}.</p>`;
    }
    
    try {
        const acceptedDuos = Object.values(requestCache).filter(req => req.status === 'accepted');
            
        if (acceptedDuos.length === 0) {
            friendListEl.innerHTML = '<p style="width:100%; text-align:center;">You have no accepted Duos yet.</p>';
        } else {
            friendListEl.innerHTML = '';
            acceptedDuos.forEach(request => {
                const otherUid = request.senderId === currentUser.uid ? request.receiverId : request.senderId;
                const otherProfile = findUserInCache(otherUid);

                if (otherProfile) {
                    const card = renderDuoCard(otherUid, otherProfile); 
                    if (card) friendListEl.appendChild(card);
                }
            });
        }
        
    } catch (e) {
        console.error("ERROR loading Accepted Duos:", e);
        friendListEl.innerHTML = `<p style="width:100%; text-align:center; color:red;">ERROR loading Accepted Duos: ${e.message}.</p>`;
    }
}


async function handleRequest(requestId, newStatus) {
    if (!currentUser) return;
    
    try {
        const docRef = db.collection('requests').doc(requestId);
        
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(docRef);
            if (!doc.exists || doc.data().status !== 'pending') {
                 throw new Error("Request no longer pending or does not exist.");
            }

            const [id1, id2] = requestId.split('_');
            const participants = [id1, id2].sort(); 

            transaction.update(docRef, {
                status: newStatus,
                ...(newStatus === 'accepted' && { participants: participants }), 
                handledAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            if (newStatus === 'accepted') {
                const chatRef = db.collection('chats').doc(requestId);
                const chatDoc = await transaction.get(chatRef);
                if (!chatDoc.exists) {
                    // Create the initial chat document for security rules to work
                    transaction.set(chatRef, {
                        participants: participants,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                }
            }
        });

        alert(`Request ${newStatus}!`);
        loadFriends(); 
        loadChatList();
    } catch (e) {
        console.error(`Failed to handle request (${newStatus}):`, e);
        alert(`Failed to ${newStatus} request. Error: ${e.message}`);
    }
}

async function removeDuo(otherUid) {
    if (!currentUser) return;
    const requestId = getChatId(otherUid);

    if (!confirm(`Are you sure you want to remove this Duo? This will end your connection.`)) {
        return;
    }

    try {
        await db.collection('requests').doc(requestId).delete();
        
        alert("Duo successfully removed.");
        loadFriends(); 
        
        if (currentChatId === requestId) {
            if (chatListener) chatListener();
            currentChatId = null;
            document.getElementById('messageDisplay').innerHTML = '';
            document.getElementById('chatHeader').textContent = 'Select a Duo to start messaging';
            document.getElementById('messageInputArea').classList.add('hidden');
        }

    } catch (e) {
        console.error("Error removing duo:", e);
        alert(`Failed to remove duo. Error: ${e.message}`);
    }
}


async function sendFriendRequest(uid){
    if(!currentUser || currentUser.uid === uid) return;
    const id = getChatId(uid); 

    try{
        const requestRef = db.collection('requests').doc(id);
        const requestDoc = await requestRef.get(); 

        if (requestDoc.exists) {
            const status = requestDoc.data().status;
            let message = status === 'pending' ? "Your request is already PENDING." : "You are already DUOS with this player!";
            alert(message);
            return;
        }

        const participants = [currentUser.uid, uid].sort();
        
        await requestRef.set({
            senderId: currentUser.uid,
            receiverId: uid,
            status: 'pending',
            participants: participants, 
            sentAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Request sent successfully!");
        loadAllUsers(); 
    }catch(e){
        console.error("Error sending friend request:", e);
        alert("Failed to send request. Check your security rules and console for details.");
    }
}


// ---------------------------
// Messaging Logic (omitted for brevity, remains unchanged)
// ... (loadChatList, openChat, sendMessage remain the same)
// ---------------------------

async function loadChatList() {
    const duoListEl = document.getElementById('activeDuoList');
    duoListEl.innerHTML = 'Loading Duos for chat...';

    try {
        const acceptedSnapshot = await db.collection('requests')
            .where('participants', 'array-contains', currentUser.uid)
            .where('status', '==', 'accepted')
            .get();

        if (acceptedSnapshot.empty) {
            duoListEl.innerHTML = 'No Duos yet.';
            return;
        }

        duoListEl.innerHTML = '';
        const duoPromises = [];
        
        acceptedSnapshot.forEach(doc => {
            const request = doc.data();
            const otherUid = request.senderId === currentUser.uid ? request.receiverId : request.senderId;
            const chatEntry = document.createElement('div');
            chatEntry.className = 'chat-entry';
            
            duoPromises.push(db.collection('users').doc(otherUid).get().then(userDoc => {
                const nickname = userDoc.data()?.nickname || 'Unknown Duo';
                chatEntry.textContent = nickname;
                chatEntry.onclick = () => {
                    document.querySelectorAll('.chat-entry').forEach(e => e.classList.remove('active'));
                    chatEntry.classList.add('active');
                    openChat(otherUid, nickname);
                };
                duoListEl.appendChild(chatEntry);
            }));
        });
        
        await Promise.all(duoPromises);

    } catch(e) {
        console.error("ERROR loading chat list:", e);
        duoListEl.innerHTML = `<p style="color:red;">Error loading chat list: ${e.message}</p>`;
    }
}

function openChat(otherUid, otherNickname) {
    if (chatListener) {
        chatListener();
    }

    currentChatId = getChatId(otherUid);
    document.getElementById('chatHeader').textContent = `Duo Chat: ${otherNickname}`;
    document.getElementById('messageDisplay').innerHTML = 'Loading messages...';
    document.getElementById('messageInputArea').classList.remove('hidden');

    const messagesRef = db.collection('chats').doc(currentChatId).collection('messages').orderBy('timestamp', 'asc');

    chatListener = messagesRef.onSnapshot(snapshot => {
        const messageDisplay = document.getElementById('messageDisplay');
        messageDisplay.innerHTML = '';

        snapshot.forEach(doc => {
            const data = doc.data();
            const messageEl = document.createElement('div');
            messageEl.className = `message ${data.senderId === currentUser.uid ? 'sent' : 'received'}`;
            
            const time = data.timestamp 
                ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                : 'N/A';
                
            messageEl.innerHTML = `${data.text} <span>${time}</span>`;
            
            messageDisplay.appendChild(messageEl);
        });

        messageDisplay.scrollTop = messageDisplay.scrollHeight;
    }, error => {
        console.error("Error listening to messages:", error);
        document.getElementById('messageDisplay').innerHTML = `<p style="color:red;">Error loading messages: ${error.message}</p>`;
    });
}

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const text = messageInput.value.trim();

    if (!text || !currentChatId) return;

    const chatRef = db.collection('chats').doc(currentChatId);
    try {
        await db.runTransaction(async (transaction) => {
            const chatDoc = await transaction.get(chatRef);
            const [id1, id2] = currentChatId.split('_');
            const participants = [id1, id2].sort();

            if (!chatDoc.exists) {
                transaction.set(chatRef, {
                    participants: participants,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
            }

            transaction.set(chatRef.collection('messages').doc(), {
                text: text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });

            transaction.update(chatRef, {
                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        messageInput.value = '';

    } catch(e) {
        console.error("Message send failed:", e);
        alert("Failed to send message. Error: " + e.message);
    }
}


// ---------------------------
// Search Filter Logic (now includes Game Category and Game Role)
function filterSearchResults() { 
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const gameCategoryFilter = document.getElementById('gameCategoryFilter').value; // RENAMED
    const gameRoleFilter = document.getElementById('gameRoleFilter').value; // NEW
    const lfdCategoryFilter = document.getElementById('lfdCategoryFilter').value; 

    const searchResultsEl = document.getElementById('searchResults');
    searchResultsEl.innerHTML = '';

    const filteredUsers = allUsersCache.filter(user => {
        if (user.id === currentUser.uid) return false;

        const nicknameMatch = (user.nickname || '').toLowerCase().includes(searchInput);
        const bioMatch = (user.bio || '').toLowerCase().includes(searchInput);
        const statusMatch = statusFilter ? (user.status === statusFilter) : true;
        const gameCategoryMatch = gameCategoryFilter ? (user.gameCategory === gameCategoryFilter) : true; // NEW
        const gameRoleMatch = gameRoleFilter ? (user.gameRole === gameRoleFilter) : true; // NEW
        
        // LFD Category match logic
        let lfdMatch = true;
        if (lfdCategoryFilter) {
            if (user.status === 'LFD') {
                lfdMatch = (user.lfdCategory === lfdCategoryFilter);
            } else {
                lfdMatch = false; 
            }
        }

        return (nicknameMatch || bioMatch) && statusMatch && gameCategoryMatch && gameRoleMatch && lfdMatch;
    });

    if (filteredUsers.length === 0) {
        searchResultsEl.innerHTML = '<p style="width:100%; text-align:center; color:magenta;">No players match your search criteria.</p>';
        return;
    }

    filteredUsers.forEach(user => {
        const card = renderUserCard(user.id, user, requestCache[user.id]);
        if (card) searchResultsEl.appendChild(card);
    });
}

function viewProfile(uid, data) {
    const requestInfo = requestCache[uid];
    let profileButton = '';
    const badge = getCoFounderBadge(uid);
    
    // NEW FIELDS
    const gameCategory = data.gameCategory || 'Other';
    const gameCategoryClass = `game-category-${gameCategory.toLowerCase()}`;
    const gameRole = data.gameRole || 'Generalist';
    const lfdCategory = data.lfdCategory || null; 

    // Logic for the profile viewing buttons (omitted for brevity)
    if (requestInfo && requestInfo.status === 'accepted') {
        profileButton = `<button class="neon-btn" style="margin-top:10px;" onclick="openChat('${uid}', '${data.nickname}')">Start Chat</button>
                         <button class="neon-btn remove" style="margin-top:10px;" onclick="removeDuo('${uid}')">Remove Duo</button>`;
    } else if (requestInfo && requestInfo.status === 'pending') {
        if (requestInfo.receiverId === currentUser.uid) {
            const requestId = getChatId(uid);
            profileButton = `
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button class="neon-btn add" onclick="handleRequest('${requestId}', 'accepted')">Accept Request</button>
                    <button class="neon-btn remove" onclick="handleRequest('${requestId}', 'rejected')">Reject Request</button>
                </div>`;
        } else {
            profileButton = `<button class="neon-btn pending" style="margin-top:20px;">Request Pending</button>`;
        }
    } else {
        profileButton = `<button class="neon-btn add" style="margin-top:20px;" onclick="sendFriendRequest('${uid}')">Send Request</button>`;
    }
    
    // Conditional LFD Category display for the profile view
    let lfdDisplayHtml = '';
    if (data.status === 'LFD' && lfdCategory) {
        lfdDisplayHtml = `<div class="profile-stat"><span>LFD Goal:</span><span class="lfd-category" style="margin:0;">${lfdCategory}</span></div>`;
    }


    document.getElementById('viewProfileContent').innerHTML = `
        <img src="${data.profileImageUrl||DEFAULT_AVATAR}" class="avatar" style="width:120px; height:120px; border-color:cyan;">
        <div class="nickname-group">
            <h2 style="margin:10px 0;">${data.nickname}</h2>
            ${badge}
        </div>
        <div class="profile-stat"><span>Game/Category:</span><span class="game-category ${gameCategoryClass}" style="margin:0;">${gameCategory.replace(/([A-Z])/g, ' $1').trim()}</span></div>
        <div class="profile-stat"><span>Role/Mode:</span><span class="game-role" style="margin:0;">${gameRole.replace(/([A-Z])/g, ' $1').trim()}</span></div>
        <div class="profile-stat"><span>Status:</span><span class="status-indicator status-${(data.status||'Online').replace(/\s/g,'').toLowerCase()}" style="margin:0;">${data.status||'Online'}</span></div>
        ${lfdDisplayHtml} 
        <div class="profile-stat"><span>Skill Rating:</span><span>${'‚≠ê'.repeat(data.skillRating||3)}</span></div>
        <p style="margin-top:20px; color:magenta; font-weight:bold;">Bio:</p>
        <p style="text-align:center; max-width:400px;">${data.bio||'No bio provided.'}</p>
        ${profileButton}
    `;
    showTab('viewProfile');
}


// ----------------------------------------------------
// üåü CUSTOM PROFILE PICTURE LOGIC (Upload and Save)
// ----------------------------------------------------
function previewAvatar(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profileAvatar').src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
}

async function uploadAvatar(file) {
    if (!file) return null;

    const storageRef = storage.ref();
    const avatarRef = storageRef.child(`avatars/${currentUser.uid}`);
    
    // Upload the file
    const snapshot = await avatarRef.put(file);
    
    // Get the public URL for the image
    const downloadURL = await snapshot.ref.getDownloadURL();
    return downloadURL;
}

async function loadUserProfile() {
    if(!currentUser) return;
    const data = currentProfileData;
    const nicknameInput = document.getElementById('profileNickname');
    const changeInfo = document.getElementById('nicknameChangeInfo');
    
    nicknameInput.value = data.nickname || currentUser.displayName;
    document.getElementById('profileBio').value = data.bio || '';
    document.getElementById('profileSkillRating').value = data.skillRating || 3;
    document.getElementById('profileStatus').value = data.status || 'Online';
    // NEW/RENAMED
    document.getElementById('profileGameCategory').value = data.gameCategory || 'LeagueOfLegends';
    document.getElementById('profileGameRole').value = data.gameRole || 'Generalist';
    document.getElementById('profileLfdCategory').value = data.lfdCategory || 'Duo'; 
    
    document.getElementById('profileAvatar').src = data.profileImageUrl || currentUser.photoURL || DEFAULT_AVATAR;

    document.getElementById('avatarFile').value = ''; 

    if (data.nicknameChangeCount && data.nicknameChangeCount >= 1) {
        nicknameInput.disabled = true;
        changeInfo.textContent = "(Your one-time nickname change has been used.)";
        changeInfo.style.color = "red";
    } else {
        nicknameInput.disabled = false;
        changeInfo.textContent = "(You get one free nickname change.)";
        changeInfo.style.color = "yellow";
    }
}

async function saveProfile() {
    if(!currentUser) return;
    const messageEl = document.getElementById('saveMessage');
    const nicknameInput = document.getElementById('profileNickname');
    const avatarFile = document.getElementById('avatarFile').files[0];
    const status = document.getElementById('profileStatus').value;

    messageEl.textContent = 'Saving...';
    messageEl.style.color = 'yellow';
    
    const newNickname = nicknameInput.value.trim();
    const oldNickname = currentProfileData.nickname;

    const updates = {
        bio: document.getElementById('profileBio').value,
        skillRating: parseInt(document.getElementById('profileSkillRating').value),
        status: status,
        // NEW/RENAMED FIELDS
        gameCategory: document.getElementById('profileGameCategory').value,
        gameRole: document.getElementById('profileGameRole').value,
    };
    
    // Only save lfdCategory if status is LFD
    updates.lfdCategory = status === 'LFD' ? document.getElementById('profileLfdCategory').value : null;


    // --- 1. Handle Nickname Change ---
    if (!nicknameInput.disabled && newNickname !== oldNickname) {
        if (!currentProfileData.nicknameChangeCount || currentProfileData.nicknameChangeCount === 0) {
            updates.nickname = newNickname;
            updates.nicknameChangeCount = (currentProfileData.nicknameChangeCount || 0) + 1;
        } else {
            messageEl.textContent = 'Error: Nickname change limit reached.';
            messageEl.style.color = 'red';
            return;
        }
    } else if (nicknameInput.disabled && newNickname !== oldNickname) {
         messageEl.textContent = 'Error: Nickname is locked and cannot be changed.';
         messageEl.style.color = 'red';
         return;
    }

    // --- 2. Handle Avatar Upload ---
    if (avatarFile) {
        messageEl.textContent = 'Uploading avatar and saving profile...';
        try {
            const imageUrl = await uploadAvatar(avatarFile);
            updates.profileImageUrl = imageUrl;
        } catch(e) {
            console.error("Avatar upload failed:", e);
            messageEl.textContent = `Error: Avatar upload failed. Check Storage Rules. ${e.message}`;
            messageEl.style.color = 'red';
            return; 
        }
    }

    // --- 3. Update Firestore Document ---
    try {
        await db.collection('users').doc(currentUser.uid).update(updates);
        
        currentProfileData = {...currentProfileData, ...updates};
        document.getElementById('welcome').textContent=`Welcome, ${currentProfileData.nickname||currentUser.displayName}`;
        
        messageEl.textContent = 'Profile Saved!';
        messageEl.style.color = '#00ff00';
        
        loadUserProfile(); 
        toggleLfdCategory();
        
        if (updates.profileImageUrl) {
            document.getElementById('profileAvatar').src = updates.profileImageUrl;
        }

        setTimeout(() => messageEl.textContent = '', 3000);
    } catch(e) {
        console.error("Profile update failed:", e);
        // This is where security rule errors for profile updates would appear
        messageEl.textContent = `Error: ${e.message}`;
        messageEl.style.color = 'red';
    }
}

// ----------------------------------------------------
// üåü INITIAL AUTHENTICATION AND USER SETUP
// ----------------------------------------------------
auth.onAuthStateChanged(async user=>{
    if(!user){
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
        return;
    }
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    currentUser=user;

    const uRef=db.collection('users').doc(user.uid);
    const uDoc=await uRef.get();

    if(!uDoc.exists){
        await uRef.set({
            nickname:user.displayName,
            profileImageUrl:user.photoURL,
            bio:'New Cyber Warrior!',
            skillRating:3,
            status:'Online',
            gameCategory:'LeagueOfLegends', // Initial default
            gameRole:'Generalist', // Initial default
            lfdCategory: null, 
            nicknameChangeCount: 0 
        });
    }

    currentProfileData=(await uRef.get()).data();
    document.getElementById('welcome').textContent=`Welcome, ${currentProfileData.nickname||user.displayName}`;
    showTab('allUsers');
});
</script>

</body>
</html>
