<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Profiles & Friends (Direct Add)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<style>
/* --- BASE STYLES (Keep the same) --- */
body { margin:0; font-family:'Orbitron',sans-serif; background:#0b0b0b; color:white; }
.container { width:90%; max-width:1000px; margin:auto; padding:20px; }
.hidden { display:none !important; }
.header { background:#111; border-bottom:3px solid cyan; box-shadow:0 0 20px rgba(0,255,255,0.5); padding:10px 0; margin-bottom:20px; display:flex; align-items:center; justify-content:center; }
.header h1 { font-size:2.5em; color:#fff; text-shadow:0 0 5px cyan,0 0 10px cyan,0 0 15px magenta; margin:0; }
.icon-container { margin-right:15px; font-size:2.5em; color:cyan; text-shadow:0 0 5px cyan,0 0 10px magenta; }
.neon-btn { border:2px solid cyan; background:transparent; color:white; padding:8px 14px; margin:5px; border-radius:6px; cursor:pointer; box-shadow:0 0 10px cyan; transition:all 0.2s ease-in-out; text-transform:uppercase; font-family:'Orbitron',sans-serif; white-space: nowrap; }
.neon-btn:hover { border-color:magenta; box-shadow:0 0 15px magenta; }
.neon-btn:disabled { border-color: #555; box-shadow: none; color: #555; cursor: not-allowed; }
.neon-btn.remove { border-color:red; box-shadow:0 0 10px red; }
.neon-btn.remove:hover { border-color:orange; box-shadow:0 0 15px orange; }
.neon-btn.add { border-color:lime; box-shadow:0 0 10px lime; }
.neon-btn.add:hover { border-color:green; box-shadow:0 0 15px green; }
#messageInput, #profileBio, #profileSkillRating, #profileStatus, #searchInput, #statusFilter, #skillFilter, #profileNickname, #newUsernameInput { flex-grow:1; padding:10px; border:1px solid cyan; background:#181818; color:white; border-radius:6px; font-family:inherit; outline:none; }
#profileBio { resize: vertical; }
.flex { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
.card-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; }
.card {
    width: 100%;
    max-width: 320px; 
    padding: 15px;
    border: 3px solid transparent; 
    border-radius: 6px;
    background: #181818; 
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), inset 0 0 5px rgba(0, 255, 255, 0.2);
    border-image-source: linear-gradient(45deg, cyan, magenta, cyan);
    border-image-slice: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}
/* ... (Other styles omitted for brevity) ... */
</style>
</head>
<body>

<div class="header"><div class="icon-container">⚡</div><h1>DUO UP (Direct)</h1></div>

<div id="loginPage" class="container">
<p style="text-align:center;">Find your perfect partner and dominate the cyber-arena.</p>
<div style="text-align:center;">
<button class="neon-btn" onclick="login()">Login with Google</button>
</div>
</div>

<div id="dashboard" class="container hidden">
<h2 id="welcome"></h2>

<div id="navigationBar" style="margin-bottom:20px;">
    <button class="neon-btn" onclick="showTab('allUsers')">Suggested</button>
    <button class="neon-btn" onclick="showTab('search')">Find Players</button>
    <button id="friendsBtn" class="neon-btn" onclick="showTab('friends')">Duos</button>
    <button class="neon-btn" onclick="showTab('messaging')">Messaging</button>
    <button class="neon-btn" onclick="showTab('profile')">Profile</button>
    <button class="neon-btn" onclick="logout()">Logout</button>
</div>

<div id="allUsersTab" class="card-container"></div>
<div id="searchTab" class="hidden container">
    <h2>Player Search Filter</h2>
    <div id="searchControls" style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
        <input type="text" id="searchInput" placeholder="Search by Nickname or Bio..." onkeyup="filterSearchResults()">
        <label style="color:cyan;">Filter Status:</label>
        <select id="statusFilter" onchange="filterSearchResults()">
            <option value="">Any Status</option>
            <option value="Online">Online</option>
            <option value="In Game">In Game</option>
            <option value="LFD">Looking For Duo (LFD)</option>
        </select>
        <label style="color:cyan;">Min Skill:</label>
        <select id="skillFilter" onchange="filterSearchResults()">
            <option value="0">Any Skill</option>
            <option value="1">⭐ 1+</option>
            <option value="2">⭐⭐ 2+</option>
            <option value="3">⭐⭐⭐ 3+</option>
            <option value="4">⭐⭐⭐⭐ 4+</option>
            <option value="5">⭐⭐⭐⭐⭐ 5</option>
        </select>
    </div>
    <div id="searchResults" class="card-container"></div>
</div>

<div id="friendsTab" class="flex hidden"></div>

<div id="messagingTab" class="hidden">
    <div id="chatList">
        <h3>Active Duos</h3>
        <div id="activeDuoList">No Duos to chat with.</div>
    </div>
    <div id="chatWindow">
        <h3 id="chatHeader">Select a Duo</h3>
        <div id="messageDisplay"></div>
        <div id="messageInputArea" class="hidden" style="display:flex; gap:10px;">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button class="neon-btn" id="sendMessageBtn">Send</button>
        </div>
    </div>
</div>

<div id="viewProfileTab" class="hidden container">
    <button class="neon-btn" onclick="showTab('allUsers')">← Back to Suggested</button>
    <div id="viewProfileContent" style="padding: 20px; border: 2px solid magenta; border-radius: 10px; background: #1a1a1a; margin-top: 20px;">
    </div>
</div>

<div id="profileTab" class="hidden">
    <h2>Cyber-Profile Editor</h2>
    <div style="padding: 20px; border: 2px solid magenta; border-radius: 10px; background: #1a1a1a;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <img id="profileAvatar" class="avatar" style="width: 80px; height: 80px; margin-right: 20px; border-color: magenta;" src="">
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Unique Identifier:</label>
                <input type="text" id="profileNickname" value="User Nickname" disabled>
            </div>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="color: cyan; display: block; margin-bottom: 5px;">Upload Avatar:</label>
            <input type="file" id="avatarUpload" accept="image/*" onchange="previewAvatar(this)">
        </div>

        <h3 style="color:cyan; margin-top: 25px;">Unique Username (@)</h3>
        <p id="usernameDisplay">@Loading...</p>
        <div id="usernameEditor" style="margin-bottom: 20px;">
            <input type="text" id="newUsernameInput" placeholder="Enter new username (a-z, 0-9, 3-20 chars)" style="flex-grow: 1;">
            <button class="neon-btn" id="changeUsernameBtn" onclick="attemptUsernameChange()">Set/Change Username</button>
        </div>
        <p id="usernameMessage" style="color: yellow;"></p>
            
        <div style="margin-bottom: 15px;">
            <label style="color: cyan; display: block; margin-bottom: 5px;">Bio/Tagline:</label>
            <textarea id="profileBio" rows="3" style="width: 100%;"></textarea>
        </div>
        <div style="display: flex; gap: 30px; margin-bottom: 20px;">
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Skill Rating (1-5):</label>
                <select id="profileSkillRating">
                    <option value="1">⭐</option>
                    <option value="2">⭐⭐</option>
                    <option value="3">⭐⭐⭐</option>
                    <option value="4">⭐⭐⭐⭐</option>
                    <option value="5">⭐⭐⭐⭐⭐</option>
                </select>
            </div>
            <div>
                <label style="color: cyan; display: block; margin-bottom: 5px;">Current Status:</label>
                <select id="profileStatus">
                    <option value="Online">Online</option>
                    <option value="In Game">In Game</option>
                    <option value="LFD">Looking For Duo (LFD)</option>
                </select>
            </div>
        </div>
            
        <h3 style="color:cyan; margin-top: 25px;">Featured Games & Needs (Max 4)</h3>
        <button class="neon-btn" onclick="addGameSlot()" id="addGameBtn">Add Game</button>
        <div id="gameSlotList" class="game-slot-container">
        </div>

        <h3 style="color:cyan; margin-top: 25px;">Gamer Card Manager (Max 8)</h3>
        <p style="font-size: 0.9em; color: gray;">Click the "+" slot to upload a new card (Max 2MB per image).</p>
        <div id="gamerCardList" class="gamer-card-container" style="border: 1px dashed cyan; padding: 10px; border-radius: 6px; margin-bottom: 15px;"></div>
        <button class="neon-btn" style="border-color: #00ff00; box-shadow: 0 0 10px #00ff00;" onclick="saveProfile()">Save Profile</button>
        <p id="saveMessage" style="color: #00ff00; margin-top: 10px;"></p>
    </div>
</div>

<script>
// ---------- FIREBASE INIT (YOUR CONFIG) ----------
const firebaseConfig = {
    apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",    
    authDomain: "duoup-cfae6.firebaseapp.com",
    projectId: "duoup-cfae6",
    storageBucket: "duoup-cfae6.firebasestorage.app",
    messagingSenderId: "812263060524",
    appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
    measurementId: "G-46B67F90FK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const OWNER_UID = "DecuxiBRxoSwb8wKMmaHQql9HQ2"; 
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const GAMES_LIST = [
    { name: "Apex Legends", roles: ["Tank", "DPS", "Support", "Any"] },
    { name: "Valorant", roles: ["Duelist", "Controller", "Sentinel", "Initiator", "Any"] },
    { name: "League of Legends", roles: ["Top", "Jungle", "Mid", "ADC", "Support", "Any"] },
    { name: "Dota 2", roles: ["Carry", "Mid", "Offlane", "Support 4", "Support 5", "Any"] },
    { name: "Overwatch 2", roles: ["Tank", "DPS", "Support", "Any"] },
    { name: "Fortnite", roles: ["Builder", "Zero Build", "Any"] },
    { name: "Destiny 2", roles: ["PVE", "PVP", "Any"] },
    { name: "Rocket League", roles: ["Attacker", "Defender", "Midfield", "Any"] },
    { name: "Other/Casual", roles: ["Chill", "Competitive", "Casual"] }
];

// Global State (Simplified: removed pending/sent requests)
let currentUser = null, 
    currentChatUid = null, 
    unsubscribeMessages = null, 
    unsubscribeUnread = null; 
let currentProfileData = {}; 
let allUsersCache = [];    
let friendUsers = {}; 
let blockedUsers = {}; 

// Helper function (NO LONGER NEEDED: removed getCanonicalRequestId)


// ---------- AUTH & INITIALIZATION ----------
function login(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message)); }
function logout(){ 
    if(unsubscribeMessages) unsubscribeMessages(); 
    if(unsubscribeUnread) unsubscribeUnread(); 
    auth.signOut(); 
}

auth.onAuthStateChanged(async user=>{
    if(!user){ 
        loginPage.classList.remove("hidden"); 
        dashboard.classList.add("hidden"); 
        return; 
    }
    
    loginPage.classList.add("hidden"); 
    dashboard.classList.remove("hidden"); 
    currentUser=user;
    
    const userRef=db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();

    // 1. New User Setup (Ensuring profile exists with all fields)
    if(!userDoc.exists || !userDoc.data().featuredGames){
        const baseName = (user.displayName || user.email.split('@')[0]).replace(/\s/g, '').toLowerCase();
        const defaultUsername = baseName.substring(0, 16).slice(0, 16 - 4) + Math.floor(1000 + Math.random() * 9000); 
        
        const existingData = userDoc.exists ? userDoc.data() : {};
        
        const profileUpdate = {
            uid: user.uid,
            username: existingData.username || defaultUsername,
            usernameChanged: existingData.usernameChanged || false,
            bio: existingData.bio || "New Cyber Warrior seeking a Duo partner!",
            skillRating: existingData.skillRating || 3,
            status: existingData.status || "Online",
            friends: existingData.friends || [],
            profileImageUrl: user.photoURL || DEFAULT_AVATAR,
            nickname: user.displayName, 
            gamerCards: existingData.gamerCards || [],
            featuredGames: existingData.featuredGames || [], 
        };
        
        await userRef.set(profileUpdate, { merge: true });

        if (!userDoc.exists) {
            await db.collection("usernames").doc(defaultUsername).set({
                uid: user.uid,
                username: defaultUsername
            });
        }
    }
    
    // 2. Load Core Data
    await loadUserProfile(); 
    await loadBlocks(); 

    // 3. Load UI Data
    welcome.textContent=`Welcome, ${currentUser.displayName || currentUser.email}`;
    await loadAllUsers(); 
    await loadFriends();
    showTab('allUsers'); // Ensure initial tab is loaded
});


// Helper to track sent/received requests (REMOVED: loadRelationshipStatus)

// Loads UIDs blocked by the current user
async function loadBlocks() {
    if (!currentUser) return;
    blockedUsers = {};
    
    const blocksSnap = await db.collection("blocks")
        .where("blockerId", "==", currentUser.uid) 
        .get();
        
    blocksSnap.forEach(doc => {
        const blockedUid = doc.id.split('_')[1];
        blockedUsers[blockedUid] = doc.id;
    });
}

// Loads user profile data for the editor (REMOVED: loadRelationshipStatus call)
async function loadUserProfile() {
    const userDoc = await db.collection("users").doc(currentUser.uid).get();
    currentProfileData = userDoc.data() || {}; 

    profileAvatar.src = currentProfileData.profileImageUrl || DEFAULT_AVATAR;
    
    const currentDisplayUsername = currentProfileData.username || 'Loading...';

    profileNickname.value = currentProfileData.nickname || currentUser.displayName || "Unknown User";
    
    profileBio.value = currentProfileData.bio || "";
    profileSkillRating.value = currentProfileData.skillRating || "3";
    profileStatus.value = currentProfileData.status || "Online";

    document.getElementById("usernameDisplay").textContent = `@${currentDisplayUsername}`;
    
    const changeBtn = document.getElementById("changeUsernameBtn");
    const input = document.getElementById("newUsernameInput");
    const messageElement = document.getElementById("usernameMessage");

    const hasChanged = currentProfileData.usernameChanged === true;
    
    if (hasChanged) {
        changeBtn.textContent = "Changed Once (Locked)";
        changeBtn.disabled = true;
        input.disabled = true;
        messageElement.textContent = "Your unique username has been permanently set.";
    } else {
        changeBtn.textContent = "Set/Change Username";
        changeBtn.disabled = false;
        input.disabled = false;
        messageElement.textContent = "You have one change remaining to set your unique @handle.";
    }
    
    renderGameSlots();
}


// --- GAME SLOTS LOGIC (Omitted for brevity, assumed working) ---
function renderGameSlots() { /* ... */ }
function generateRoleOptions(gameName, selectedRole) { /* ... */ }
function updateGameRoleOptions(gameName, index) { /* ... */ }
function addGameSlot() { /* ... */ }
function removeGameSlot(index) { /* ... */ }

async function saveProfile() {
    // Requires: allow update on /users/{userId}
    const featuredGames = [];
    const gameSlots = document.querySelectorAll('#gameSlotList .game-slot');
    let hasError = false;

    // ... (Game slot validation logic omitted) ...
    gameSlots.forEach((slot, index) => {
        const gameSelect = slot.querySelector(`select[data-field="game"]`);
        const roleSelect = slot.querySelector(`select[data-field="role"]`);
        if (gameSelect.value && roleSelect.value) {
            featuredGames.push({
                game: gameSelect.value,
                role: roleSelect.value
            });
        } else if (gameSelect.value || roleSelect.value) {
             hasError = true;
        }
    });

    if (hasError) {
        alert("Please ensure every selected game slot has both a Game Title and a Role/Need selected, or remove the slot.");
        return;
    }

    const updateData = {
        bio: profileBio.value,
        skillRating: parseInt(profileSkillRating.value),
        status: profileStatus.value,
        featuredGames: featuredGames, 
    };
    
    try {
        await db.collection("users").doc(currentUser.uid).update(updateData);
        document.getElementById('saveMessage').textContent = 'Profile saved successfully!';
        setTimeout(() => document.getElementById('saveMessage').textContent = '', 3000);
        await loadUserProfile(); 
        loadAllUsers();
    } catch(e) {
        document.getElementById('saveMessage').textContent = `Error saving profile: ${e.message}`;
        console.error("Save Profile Error:", e);
    }
}


// --- TAB MANAGEMENT ---
function showTab(tab){
    // REMOVED: requestsTab from this list
    document.querySelectorAll('#allUsersTab, #searchTab, #friendsTab, #messagingTab, #profileTab, #viewProfileTab').forEach(el => el.classList.add('hidden'));
    
    switch(tab){
      case "allUsers": document.getElementById('allUsersTab').classList.remove("hidden"); loadAllUsers(); break; 
      case "search": document.getElementById('searchTab').classList.remove("hidden"); filterSearchResults(); break; 
      // REMOVED: case "requests"
      case "friends": document.getElementById('friendsTab').classList.remove("hidden"); loadFriends(); break; 
      case "messaging": document.getElementById('messagingTab').classList.remove("hidden"); /* initMessaging(); */ break;
      case "profile": document.getElementById('profileTab').classList.remove("hidden"); loadUserProfile(); break; 
      case "viewProfile": document.getElementById('viewProfileTab').classList.remove("hidden"); break; 
    }
}


// ---------- CORE USER CARD RENDERING (UPDATED BUTTONS) ----------
function renderUserCard(d, data) {
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => viewUserProfile(d.uid);

    let actionButton = '';
    const isFriend = currentProfileData.friends && currentProfileData.friends.includes(d.uid);
    const isSelf = d.uid === currentUser.uid;

    if (!isSelf) {
        if (isFriend) {
            actionButton = `<button class="neon-btn remove" onclick="event.stopPropagation(); removeFriend('${d.uid}')">Remove Duo</button>`;
        } else {
            // NEW ACTION: Direct Add
            actionButton = `<button class="neon-btn add" onclick="event.stopPropagation(); addFriend('${d.uid}')">Add Duo</button>`;
        }
    } else {
        actionButton = `<span class="owner-badge-box">You</span>`;
    }

    // ... (Rest of card content) ...
    card.innerHTML = `
        <div class="card-content-box">
            <img src="${data.profileImageUrl || DEFAULT_AVATAR}" class="avatar">
            <h3 style="margin:0; font-size:1.2em;">@${data.username || data.nickname}</h3>
            <div class="status-indicator status-${data.status.replace(/\s/g, '').toLowerCase()}">${data.status}</div>
            <div class="skill-rating">${'⭐'.repeat(data.skillRating)}</div>
            <p style="margin:5px 0; font-size:0.9em; text-align:center; color:#ccc;">${data.bio}</p>
        </div>
        <div style="margin-bottom: 10px;">${actionButton}</div>
        `;

    return card;
}


// ---------- USER & SEARCH FUNCTIONS (Omitted for brevity, assumed working) ----------
async function loadAllUsers(){ /* ... */ }
function filterSearchResults() { /* ... */ }


// ---------- FRIENDSHIP FUNCTIONS (NEW & SIMPLIFIED) ----------

/**
 * NEW: Adds a user to the current user's friends list (One-way friendship).
 * @param {string} targetUid - The UID of the user to add.
 */
async function addFriend(targetUid) {
    if (!currentUser) return;
    
    try {
        // Requires: allow update on /users/{userId} (Simplified Rule)
        await db.collection("users").doc(currentUser.uid).update({
            friends: firebase.firestore.FieldValue.arrayUnion(targetUid)
        });
        
        alert(`Successfully added ${targetUid.substring(0, 8)}... as a Duo. Note: This is a one-way add.`);
        
        // Refresh UI
        await loadUserProfile();
        await loadFriends();
        loadAllUsers(); 
        
    } catch (e) {
        console.error("Add Friend Error (Rule 1 update failed):", e);
        alert("Add Duo Failed: " + e.message);
    }
}

/**
 * Removes a user from the current user's friends list.
 * @param {string} friendId - The UID of the friend to remove.
 */
async function removeFriend(friendId) {
    if (!currentUser) return;

    try {
        // Requires: allow update on /users/{userId} (Simplified Rule)
        await db.collection("users").doc(currentUser.uid).update({
            friends: firebase.firestore.FieldValue.arrayRemove(friendId)
        });
        
        alert(`Successfully removed ${friendId.substring(0, 8)}... from Duos.`);
        
        // Refresh UI
        await loadUserProfile();
        await loadFriends();
        loadAllUsers(); 
        
    } catch (e) {
        console.error("Remove Friend Error:", e);
        alert("Remove Duo Failed: " + e.message);
    }
}

/**
 * Loads the current user's friends and renders them. (Unchanged logic)
 */
async function loadFriends() {
    const friendsTab = document.getElementById('friendsTab');
    friendsTab.innerHTML = "<h3>Your Duo Partners</h3>";
    
    const friendUids = currentProfileData.friends || [];

    if (friendUids.length === 0) {
        friendsTab.innerHTML += "<p>You have no Duo Partners yet. Find someone in Suggested or Search!</p>";
        return;
    }

    // Get the profiles of the friends
    const friendPromises = friendUids.map(uid => db.collection("users").doc(uid).get());
    const friendDocs = await Promise.all(friendPromises);

    friendDocs.forEach(doc => {
        if (!doc.exists) return;
        const friendData = doc.data();
        friendsTab.appendChild(renderUserCard(doc, friendData));
    });
}


// ---------- REMAINING FUNCTIONS (Omitted for brevity, assumed working) ----------
async function blockUser(blockedId) { /* ... */ }
async function viewUserProfile(uid) { /* ... */ }
async function unblockUser(blockedId) { /* ... */ }
function startChat(friendId) { /* ... */ }
async function attemptUsernameChange() { /* ... */ }
function previewAvatar(input) { /* ... */ }

</script>
</body>
</html>
