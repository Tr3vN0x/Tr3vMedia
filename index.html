<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr3vMedia</title>
<style>
/* --- Core Styling --- */
body {margin:0;font-family:'Consolas',monospace;background:#0a0a0a;color:#00ff66;}
header, footer {background:#0d0d0d;padding:15px 30px;color:#00ff66;}
main {padding:20px 30px;}
.verified {color:#1DA1F2;font-weight:bold;margin-left:5px;}
.tab-content {display:none;}
#welcome-banner {background:#004400;color:white;text-align:center;padding:15px;margin-bottom:20px;}

/* --- Header & Navigation --- */
header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:2px solid #003300;
    position:sticky;
    top:0;
    z-index:10;
}
.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}
.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}
.logo-container img {
    height: 30px;
    width: auto;
    border: none;
    padding: 0;
    vertical-align: middle;
}

/* Search Bar Styling */
#search-bar {
    position: relative; 
    min-width: 200px;
}
#search-input {
    padding: 5px 10px;
    border-radius: 4px;
    background: #111;
    color: #00ff66;
    border: 1px solid #003300;
    width: 100%;
    box-sizing: border-box;
}

/* Search Results Dropdown Styling */
#search-results {
    position: absolute;
    top: 100%; 
    left: 0;
    width: 100%;
    background: #111;
    border: 1px solid #003300;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 20;
    box-shadow: 0 5px 10px rgba(0, 255, 102, 0.2);
}
.search-result-item {
    padding: 8px 10px;
    cursor: pointer;
    border-bottom: 1px dashed #002200;
}
.search-result-item:hover {
    background: #003300;
}

/* Tabs Styling */
.header-actions {
    display: flex; 
    gap: 5px; 
    align-items: center;
}
.nav-tab {
    cursor:pointer;
    padding: 6px 10px; 
    border-radius:4px; 
    border:1px solid #003300;
    font-size: 0.9em; 
    transition: background 0.2s;
}
.nav-tab.active {background:#003300;box-shadow:0 0 8px #33ff99;}
.nav-tab:hover:not(.active) {background: #001a00;}

/* --- Forms & Inputs (General) --- */
input:not([type="file"], #search-input), textarea {
    width: 100%; 
    box-sizing: border-box;
    padding: 10px;
    margin-bottom: 10px; 
    border-radius:6px;
    background:#111;
    color:#00ff66;
    border:1px solid #003300;
    margin-top:5px;
    resize: vertical;
}
input[type="file"] {margin-top:5px;}
button {
    cursor:pointer;
    padding:8px 12px; 
    border-radius:4px;
    background:#111;
    color:#00ff66;
    border:1px solid #003300;
    margin-top:5px;
    transition: background 0.2s;
}
button:hover {background: #003300;}

#new-post {
    background: #0d0d0d;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #003300;
}
#new-post button {margin-top: 5px;}

/* --- Posts & Profile Images --- */
.post {
    display:flex;
    flex-direction: column; 
    background:#111;
    padding:15px;
    margin-bottom:10px;
    border-radius:6px;
    border:1px solid #003300;
}
.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.post-content {
    margin-bottom: 10px;
}
.post-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 10px;
    border-top: 1px dashed #003300;
    padding-top: 8px;
}
.post-actions button {
    padding: 5px 10px;
    margin-top: 0;
}
.reaction-count {
    margin-left: 5px;
    font-size: 0.9em;
}
.post img, .profile-image-small {
    width:40px;
    height:40px;
    border-radius:50%;
    border:1px solid #00ff66;
    object-fit:cover;
    background: #0d0d0d; 
}
#profile-pic-display {width:80px;height:80px;}

/* --- Comments Styling --- */
.comments-section {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #002200;
}
.comment {
    background: #0d0d0d;
    padding: 5px 10px;
    margin-bottom: 5px;
    border-left: 3px solid #33ff99;
    font-size: 0.9em;
}
.comment-user {
    font-weight: bold;
    color: #33ff99;
}
.comment-input-area {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.comment-input-area input {
    flex-grow: 1;
    margin-bottom: 0;
    padding: 5px;
}
.comment-input-area button {
    margin-top: 0;
    padding: 5px 10px;
    white-space: nowrap;
}

/* --- Profile Styling (View & Edit) --- */
#view-profile-content #profile-pic-view {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 2px solid #33ff99;
    background: #0d0d0d;
}
.clickable-username {
    cursor: pointer;
    text-decoration: underline;
    color: #33ff99;
}
.post-timestamp {
    font-size: 0.8em;
    color: #009944;
    margin-left: 10px;
}

/* NEW: Gallery Styling */
.gallery-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 columns for desktop */
    gap: 10px;
    margin-top: 15px;
}

.gallery-slot {
    background: #111;
    border: 1px dashed #003300;
    border-radius: 4px;
    padding: 5px;
    text-align: center;
}

.gallery-image-display {
    width: 100%;
    aspect-ratio: 1 / 1; /* Make images square */
    object-fit: cover;
    margin-bottom: 5px;
    border-radius: 4px;
    border: 1px solid #33ff99;
    cursor: pointer;
}

/* Mobile adjustments for gallery */
@media (max-width: 600px) {
    .gallery-container {
        grid-template-columns: repeat(2, 1fr); /* 2 columns for mobile */
    }
}
</style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="logo-container">
            <img src="https://see.fontimg.com/api/rf5/vXL4/YTM3ZmYyMWFkMzNiNGY5MGEwY2ZmZTZmNDhiZGI4NzkudHRm/VHIzdk1lZGlh/chimpanzee-website-report.png?r=fs&h=65&w=1000&fg=E8E4E4&bg=27E2A1&tb=1&s=65" 
                 alt="Tr3vMedia Icon 1">
            
            <img src="https://scontent-iad3-2.xx.fbcdn.net/v/t39.30808-6/596009832_838710972097270_9022730636766278745_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=FV-kAQTMc9sQ7kNvwHtnXUJ&_nc_oc=AdnMy32z6EqV3KBKYoxV9lXa4sxDC5HGtKjqXOn1Ft5DhugILwP1VuHdODGDfKtXeMswLEwyf_07cIoNby3di58u&_nc_zt=23&_nc_ht=scontent-iad3-2.xx&_nc_gid=ffAPLrP0wQ4lRnuf3eL46g&oh=00_Afk9OB0-t0OJNQksLxcPV1gJpw_C1Z8IwkKu4li6rX9bgA&oe=6940AF3A" 
                 alt="Tr3vMedia Icon 2">
        </div>
        
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Search usernames..." onkeyup="searchUsers()">
            <div id="search-results"></div>
        </div>
        
    </div>
    
    <div class="header-actions" id="header-tabs"></div>
</header>

<div id="welcome-banner"></div>

<main id="main-content">
    <div id="auth" class="tab-content">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p>Or <span style="cursor:pointer;color:#33ff99;" onclick="showSignup()">Sign Up</span></p>
    </div>

    <div id="signup" class="tab-content">
        <h2>Sign Up </h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signup()">Create Account</button>
        <p>Or <span style="cursor:pointer;color:#33ff99;" onclick="showLogin()">Login</span></p>
    </div>

    <div id="home" class="tab-content">
        <div id="new-post">
            <textarea id="post-text" rows="3" placeholder="What's on your mind?"></textarea>
            <button onclick="addPost()">Post</button>
        </div>
        <div id="posts"></div>
    </div>

    <div id="profile" class="tab-content">
        <h2>My Profile</h2>
        <img id="profile-pic-display" class="profile-image-small" src="" alt="Profile Picture"><br>
        <label>Main Profile Picture:</label>
        <input type="file" id="profile-upload" accept="image/*" onchange="uploadProfilePic()">
        <textarea id="profile-bio" placeholder="Write your bio..."></textarea><br>
        
        <p>Username: <span id="my-profile-username"></span> <span id="owner-tag-me"></span></p>
        <p>Total Posts: <span id="my-profile-posts-count"></span></p>
        <p>Total Reactions Received: <span id="my-profile-likes-count"></span></p>
        
        <hr style="border-top: 1px dashed #003300;">

        <h3>üñºÔ∏è Gallery (8 Images)</h3>
        <p style="font-size:0.9em; color:#009944;">Click the current image to upload a replacement.</p>
        <div class="gallery-container" id="my-gallery-edit">
            </div>

        <button onclick="saveProfile()" style="margin-top: 20px;">Save Profile & Bio</button>
    </div>
    
    <div id="view-profile" class="tab-content">
        <div id="view-profile-content">
            <img id="profile-pic-view" src="" alt="User Profile Picture"><br>
            <h2 id="view-username"></h2>
            <p id="view-owner-tag"></p>
            <p>Bio: <span id="view-bio"></span></p>
            <p>Posts: <span id="view-posts-count"></span></p>
            <p>Reactions Received: <span id="view-likes-received"></span></p>

            <hr style="border-top: 1px dashed #003300;">
            <h3>üñºÔ∏è Gallery</h3>
            <div class="gallery-container" id="view-gallery">
                </div>

            <hr style="border-top: 1px dashed #003300;">
            <h3>User Posts</h3>
            <div id="view-user-posts"></div>
        </div>
        <button onclick="showTab('home')" style="margin-top: 20px;">Back to Feed</button>
    </div>

    <div id="settings" class="tab-content">
        <h2>Settings</h2>
        <label>Change username: <input type="text" id="change-username"></label><br>
        <button onclick="changeUsername()">Save</button>
    </div>
</main>

<footer>&copy; 2025 Tr3vMedia ‚Äî All Rights Reserved</footer>

<script>
// --- Global Constants ---
const DEFAULT_PIC = 'https://via.placeholder.com/60';
const DEFAULT_GALLERY_ITEM = 'https://via.placeholder.com/150x150?text=Empty+Slot';
const REACTIONS = ['like', 'heart', 'star']; // Available reaction types
const GALLERY_SIZE = 8; // Max number of gallery images

// Helper function to format date
function formatTimestamp(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diff = now - then;

    if (diff < 60000) return 'Just now'; 
    if (diff < 3600000) return Math.round(diff / 60000) + 'm ago'; 
    if (diff < 86400000) return Math.round(diff / 3600000) + 'h ago'; 
    
    return then.toLocaleDateString(); 
}

// ------------------ Users Setup (Updated) ------------------
if(!localStorage.getItem('users')) {
    const defaultGallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);

    const defaultUsers = {
        'Tr3vN0x': {
            password:'ownerpass', 
            profilePic:DEFAULT_PIC, 
            bio:'Owner of Tr3vMedia', 
            gallery: defaultGallery, // NEW
            posts:[
                {
                    text: 'Welcome to Tr3vMedia! This site just got a whole lot cooler.', 
                    date: Date.now(), 
                    reactions: {like: [], heart: [], star: []},
                    comments: [
                        {user: 'TestUser1', text: 'Looks awesome!'},
                        {user: 'Tr3vN0x', text: 'Thanks! Enjoy the new features.'}
                    ]
                }
            ]
        },
        'TestUser1': {
            password:'password', 
            profilePic:DEFAULT_PIC, 
            bio:'Just a friendly user.', 
            gallery: defaultGallery.map((_, i) => i === 0 ? 'https://via.placeholder.com/150x150?text=Cool+Pic' : DEFAULT_GALLERY_ITEM), // Example one gallery image
            posts:[
                {
                    text: 'Testing the new search feature and the clean UI!', 
                    date: Date.now() - 5000000, 
                    reactions: {like: ['Tr3vN0x'], heart: [], star: []},
                    comments: []
                }
            ]
        }
    };
    localStorage.setItem('users', JSON.stringify(defaultUsers));
}

// ------------------ Auth Tabs ------------------
function showLogin() {document.getElementById('signup').style.display='none'; document.getElementById('auth').style.display='block';}
function showSignup() {document.getElementById('auth').style.display='none'; document.getElementById('signup').style.display='block';}

// ------------------ Signup / Login ------------------
function signup(){
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value.trim();
    if(!username||!password){alert("Fill all fields"); return;}
    const users = JSON.parse(localStorage.getItem('users'));
    if(users[username]){alert("Username taken"); return;}
    
    // Initialize new user with empty gallery
    users[username]={
        password,
        profilePic:DEFAULT_PIC,
        bio:'',
        posts:[],
        gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM) // NEW INIT
    }; 
    
    localStorage.setItem('users', JSON.stringify(users));
    alert("Account created! Login now.");
    showLogin();
}
function login(){
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const users = JSON.parse(localStorage.getItem('users'));
    if(!users[username] || users[username].password!==password){alert("Invalid credentials"); return;}
    localStorage.setItem('currentUser', username);
    initApp();
}

// ------------------ App Init ------------------
function initApp(){
    document.getElementById('auth').style.display='none';
    document.getElementById('signup').style.display='none';
    
    document.getElementById('welcome-banner').innerText=`Hello ${localStorage.getItem('currentUser')}!`;
    
    document.getElementById('header-tabs').innerHTML=`
        <div class="nav-tab" onclick="showTab('home')">Home</div>
        <div class="nav-tab" onclick="showTab('profile')">Profile</div>
        <div class="nav-tab" onclick="showTab('settings')">Settings</div>
        <div class="nav-tab" onclick="logout()">Logout</div>`;
    
    loadUser();
    showTab('home'); 
}

// ------------------ Logout ------------------
function logout(){localStorage.removeItem('currentUser'); location.reload();}

// ------------------ Tab Switching ------------------
function showTab(tabId){
    document.querySelectorAll('.tab-content').forEach(tab=>tab.style.display='none');
    document.getElementById(tabId).style.display='block';
    
    document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));
    
    const activeTabElement = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
    if (activeTabElement) {
        activeTabElement.classList.add('active');
    }
    
    if (tabId === 'profile') {
        renderGalleryEdit();
    }
}

// ------------------ Profile (My Profile) ------------------
function loadUser(){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    if(!currentUser) return;
    const user = users[currentUser];
    
    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    document.getElementById('profile-pic-display').src=user.profilePic;
    document.getElementById('my-profile-username').innerText=currentUser;
    document.getElementById('my-profile-posts-count').innerText=user.posts.length;
    document.getElementById('my-profile-likes-count').innerText=totalReactions;
    document.getElementById('owner-tag-me').innerHTML=currentUser==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':'';
    document.getElementById('profile-bio').value=user.bio;
    renderPosts();
}

// Main Profile Picture Upload
function uploadProfilePic(){
    const file = document.getElementById('profile-upload').files[0]; 
    if(file){
        if (!file.type.startsWith('image/')) {
            alert("Only image files are allowed for profile pictures.");
            document.getElementById('profile-upload').value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload=function(){
            const users=JSON.parse(localStorage.getItem('users'));
            const currentUser=localStorage.getItem('currentUser');
            users[currentUser].profilePic=reader.result;
            localStorage.setItem('users',JSON.stringify(users));
            document.getElementById('profile-pic-display').src=reader.result;
            renderPosts();
        };
        reader.readAsDataURL(file);
    }
}


function saveProfile(){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    users[currentUser].bio=document.getElementById('profile-bio').value;
    localStorage.setItem('users',JSON.stringify(users));
    alert("Profile saved!");
}

// NEW: Gallery Upload Function
function uploadGalleryImage(index) {
    // Create a temporary file input for the specific slot
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert("Only image files are allowed in the gallery.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function() {
                const users = JSON.parse(localStorage.getItem('users'));
                const currentUser = localStorage.getItem('currentUser');
                
                // Ensure gallery array exists and is the correct size
                if (!users[currentUser].gallery || users[currentUser].gallery.length !== GALLERY_SIZE) {
                    users[currentUser].gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
                }
                
                // Update the specific slot with the new image data URL
                users[currentUser].gallery[index] = reader.result;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Update the displayed image instantly
                document.getElementById(`gallery-img-${index}`).src = reader.result;
            };
            reader.readAsDataURL(file);
        }
    };
    
    // Programmatically click the hidden input element
    input.click();
}

// NEW: Render Gallery Edit (on My Profile tab)
function renderGalleryEdit() {
    const users = JSON.parse(localStorage.getItem('users'));
    const currentUser = localStorage.getItem('currentUser');
    const user = users[currentUser];
    const galleryContainer = document.getElementById('my-gallery-edit');
    galleryContainer.innerHTML = '';

    // Initialize gallery if missing or incorrect size
    if (!user.gallery || user.gallery.length !== GALLERY_SIZE) {
        user.gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
        localStorage.setItem('users', JSON.stringify(users)); // Save initialization
    }
    
    for (let i = 0; i < GALLERY_SIZE; i++) {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'gallery-slot';
        
        // Use an image element to display the current picture
        const img = document.createElement('img');
        img.id = `gallery-img-${i}`;
        img.className = 'gallery-image-display';
        img.src = user.gallery[i];
        img.alt = `Gallery Slot ${i + 1}`;
        img.onclick = () => uploadGalleryImage(i); // Clicking the image triggers upload

        slotDiv.appendChild(img);
        
        // Add a small label
        const label = document.createElement('p');
        label.style.fontSize = '0.8em';
        label.style.margin = '5px 0 0 0';
        label.innerText = `Slot ${i + 1}`;
        slotDiv.appendChild(label);

        galleryContainer.appendChild(slotDiv);
    }
}


// ------------------ Profile (View Other User) ------------------
function renderViewGallery(username, targetElement) {
    const users = JSON.parse(localStorage.getItem('users'));
    const user = users[username];
    targetElement.innerHTML = '';
    
    const galleryImages = user.gallery || Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);

    galleryImages.forEach((imgUrl, index) => {
        // Only render the slot if it's not the default placeholder (optional, but cleaner)
        if (imgUrl !== DEFAULT_GALLERY_ITEM) {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'gallery-slot';
            slotDiv.style.border = 'none'; // No dashed border for view mode
            slotDiv.style.padding = '0';

            const img = document.createElement('img');
            img.className = 'gallery-image-display';
            img.src = imgUrl;
            img.alt = `${username}'s Gallery Image ${index + 1}`;
            
            // Remove click action for viewing
            img.style.cursor = 'default'; 

            slotDiv.appendChild(img);
            targetElement.appendChild(slotDiv);
        }
    });

    if (targetElement.innerHTML === '') {
        targetElement.innerHTML = '<p style="font-style: italic;">User has no images in their gallery.</p>';
    }
}


function viewProfile(username){
    // Hides search results when clicking a profile
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-input').value = ''; 
    
    const users=JSON.parse(localStorage.getItem('users'));
    const user = users[username];
    if (!user) return alert("User not found.");

    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    // Load data into the view-profile tab elements
    document.getElementById('profile-pic-view').src = user.profilePic;
    document.getElementById('view-username').innerText = username;
    document.getElementById('view-owner-tag').innerHTML = username === 'Tr3vN0x' ? '<span class="verified">‚úîÔ∏è Owner</span>' : '';
    document.getElementById('view-bio').innerText = user.bio || 'No bio set.';
    document.getElementById('view-posts-count').innerText = user.posts.length;
    document.getElementById('view-likes-received').innerText = totalReactions;

    // NEW: Render the gallery for the viewed user
    renderViewGallery(username, document.getElementById('view-gallery'));

    // Render only this user's posts in the view-profile tab
    renderUserPosts(username, document.getElementById('view-user-posts'));
    
    showTab('view-profile');
}

// ------------------ Search Functionality ------------------
function searchUsers() {
    const input = document.getElementById('search-input').value.toLowerCase();
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    
    if (input.length < 2) {
        return;
    }

    const users = JSON.parse(localStorage.getItem('users'));
    const userKeys = Object.keys(users);
    
    const matchedUsers = userKeys.filter(username => 
        username.toLowerCase().includes(input)
    );

    if (matchedUsers.length > 0) {
        matchedUsers.forEach(username => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerText = username;
            resultItem.onclick = () => viewProfile(username);
            resultsDiv.appendChild(resultItem);
        });
    } else {
        const noResultItem = document.createElement('div');
        noResultItem.className = 'search-result-item';
        noResultItem.innerText = 'No users found.';
        resultsDiv.appendChild(noResultItem);
    }
}

// ------------------ Posts & Reactions & Comments ------------------
function addPost(){
    const text=document.getElementById('post-text').value.trim();
    if(!text){alert("Cannot post empty"); return;}
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    
    // New posts initialize with an empty reactions and comments object
    users[currentUser].posts.unshift({text,date:Date.now(), reactions: {like: [], heart: [], star: []}, comments: []}); 
    
    localStorage.setItem('users',JSON.stringify(users));
    document.getElementById('post-text').value='';
    loadUser(); 
}

function toggleReaction(postUser, postIndex, reactionType){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    const post = users[postUser].posts[postIndex];
    
    if(!post.reactions) post.reactions = {like: [], heart: [], star: []}; 

    // 1. Check and remove current user from ALL other reaction arrays on this post
    REACTIONS.forEach(r => {
        const index = post.reactions[r].indexOf(currentUser);
        if (index !== -1) {
            post.reactions[r].splice(index, 1);
        }
    });

    // 2. Add or remove the reactionType
    const indexInTargetReaction = post.reactions[reactionType].indexOf(currentUser);
    if (indexInTargetReaction === -1) {
        post.reactions[reactionType].push(currentUser);
    } 
    
    localStorage.setItem('users',JSON.stringify(users));
    
    // Re-render the current view
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}


function addComment(postUser, postIndex) {
    const currentUser = localStorage.getItem('currentUser');
    const commentInput = document.getElementById(`comment-input-${postUser}-${postIndex}`);
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const users = JSON.parse(localStorage.getItem('users'));
    const post = users[postUser].posts[postIndex];

    if (!post.comments) post.comments = []; 

    post.comments.push({
        user: currentUser,
        text: commentText
    });

    localStorage.setItem('users', JSON.stringify(users));
    
    // Clear input and re-render the posts to show the new comment
    commentInput.value = '';
    
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}


function renderComments(comments) {
    let html = '<div class="comments-section">';
    html += '<h4>Comments:</h4>';
    
    if (comments.length === 0) {
        html += '<p style="margin-left: 10px; font-style: italic;">No comments yet.</p>';
    } else {
        comments.forEach(c => {
            html += `<div class="comment">
                        <span class="comment-user clickable-username" onclick="viewProfile('${c.user}')">${c.user}</span>: ${c.text}
                     </div>`;
        });
    }
    html += '</div>';
    return html;
}

function renderPostActions(postUser, postIndex, reactions, currentUser) {
    let actionsHTML = '';
    const reactionEmojis = {
        'like': 'üëç',
        'heart': '‚ù§Ô∏è',
        'star': '‚≠êÔ∏è'
    };

    REACTIONS.forEach(type => {
        const count = reactions[type] ? reactions[type].length : 0;
        const isActive = reactions[type].includes(currentUser);
        const buttonClass = isActive ? 'active-reaction' : '';
        
        actionsHTML += `
            <button class="${buttonClass}" onclick="toggleReaction('${postUser}', ${postIndex}, '${type}')">
                ${reactionEmojis[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}
            </button>
            <span class="reaction-count">${count}</span>
        `;
    });
    return actionsHTML;
}

function renderUserPosts(username, targetElement) {
    const users = JSON.parse(localStorage.getItem('users'));
    const currentUser = localStorage.getItem('currentUser');
    const userPosts = users[username].posts;
    targetElement.innerHTML = '';

    userPosts.forEach((p, index) => {
        const postId = `${username}-${index}`; // Unique ID for comment input
        const div = document.createElement('div'); 
        div.className = 'post';
        
        // Ensure comments are initialized
        if (!p.comments) p.comments = [];

        div.innerHTML = `
            <div class="post-header">
                <img src="${users[username].profilePic}" class="profile-image-small" alt="${username}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${username}')">${username}</span>${username==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            <div class="post-actions">
                ${renderPostActions(username, index, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment...">
                <button onclick="addComment('${username}', ${index})">Comment</button>
            </div>
        `;
        targetElement.appendChild(div);
    });
}

function renderPosts(){
    const postsDiv=document.getElementById('posts'); postsDiv.innerHTML='';
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    const allPosts=[];
    
    // Collect all posts from all users, adding the index of the post in the original array
    for(let user in users){
        users[user].posts.forEach((p, index) => {
            allPosts.push({
                user,
                text: p.text,
                date: p.date,
                profilePic: users[user].profilePic,
                postIndex: index, 
                reactions: p.reactions || {like: [], heart: [], star: []},
                comments: p.comments || []
            });
        });
    }
    
    allPosts.sort((a,b)=>b.date-a.date);
    
    allPosts.forEach(p=>{
        const postId = `${p.user}-${p.postIndex}`; 
        const div=document.createElement('div'); div.className='post';
        div.innerHTML=`
            <div class="post-header">
                <img src="${p.profilePic}" class="profile-image-small" alt="${p.user}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${p.user}')">${p.user}</span>${p.user==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            <div class="post-actions">
                ${renderPostActions(p.user, p.postIndex, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment..." class="comment-input">
                <button onclick="addComment('${p.user}', ${p.postIndex})">Comment</button>
            </div>
        `;
        postsDiv.appendChild(div);
    });
}

// ------------------ Settings ------------------
function changeUsername(){
    const newName=document.getElementById('change-username').value.trim();
    if(!newName) return alert("Username cannot be empty");
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    if(users[newName]) return alert("Username taken");
    
    if (currentUser === 'Tr3vN0x') return alert("The owner's username cannot be changed.");
    
    // 1. Move user data to new username key
    users[newName]=users[currentUser]; 
    delete users[currentUser];
    
    // 2. Update reactions and comments on ALL posts to reflect the new username
    for (let userKey in users) {
        users[userKey].posts.forEach(post => {
            if (post.reactions) {
                REACTIONS.forEach(r => {
                    const index = post.reactions[r].indexOf(currentUser);
                    if (index !== -1) {
                        post.reactions[r][index] = newName;
                    }
                });
            }
            if (post.comments) {
                post.comments.forEach(comment => {
                    if (comment.user === currentUser) {
                        comment.user = newName;
                    }
                });
            }
        });
    }

    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('currentUser',newName);
    
    document.getElementById('change-username').value = '';
    loadUser();
    
    alert("Username changed! You must log in again with your new username.");
    logout(); 
}

// ------------------ Check login on reload ------------------
if(localStorage.getItem('currentUser')) initApp(); else {showLogin();}
</script>

</body>
</html>
