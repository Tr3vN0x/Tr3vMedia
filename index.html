<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUO UP Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body{margin:0;font-family:'Orbitron',sans-serif;background:#0b0b0b;color:white;}
.hidden{display:none;}
.container{width:90%;margin:auto;padding:20px;}
.neon-btn{border:2px solid cyan;background:transparent;color:white;padding:8px 14px;margin:5px;border-radius:6px;cursor:pointer;box-shadow:0 0 10px cyan;}
.neon-btn:hover{border-color:magenta;box-shadow:0 0 15px magenta;}
.flex{display:flex;gap:15px;flex-wrap:wrap;}
.card{width:260px;padding:15px;border:2px solid cyan;border-radius:14px;background:#111;box-shadow:0 0 10px cyan;}
.avatar{width:48px;height:48px;border-radius:50%;border:2px solid cyan;object-fit:cover;}
.user{display:flex;gap:10px;align-items:center;}
.input{width:100%;padding:8px;margin:5px 0;background:#000;border:2px solid cyan;color:white;border-radius:6px;}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:5px;}
#chatMessages{flex-direction:column;max-height:400px;overflow-y:auto;}
.message-bubble{padding:8px 12px;border-radius:12px;max-width:70%;margin:5px 0;position:relative;word-wrap:break-word;}
.message-incoming{background:#111;border:2px solid cyan;align-self:flex-start;box-shadow:0 0 5px cyan;}
.message-outgoing{background:#111;border:2px solid magenta;align-self:flex-end;box-shadow:0 0 5px magenta;}
.message-header{font-size:0.8em;color:gray;margin-bottom:2px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <h1>DUO UP</h1>
  <button class="neon-btn" onclick="loginWithGoogle()">Login with Google</button>
</div>

<!-- USERNAME -->
<div id="usernamePage" class="container hidden">
  <h2>Choose a Username</h2>
  <input id="usernameInput" class="input" placeholder="Username">
  <button class="neon-btn" onclick="saveUsername()">Continue</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container hidden">
  <h2 id="welcome"></h2>
  <button class="neon-btn" onclick="openProfile()">Profile</button>
  <button class="neon-btn" onclick="logout()">Logout</button>
  <h3>Users:</h3>
  <div id="usersList" class="flex"></div>
</div>

<!-- PROFILE -->
<div id="profilePage" class="container hidden">
  <h2>Edit Profile</h2>
  <img id="profilePreview" class="avatar"><br><br>
  <input type="file" id="profileImage">
  <input id="statusInput" class="input" placeholder="Status">
  <button class="neon-btn" onclick="saveProfile()">Save</button>
  <button class="neon-btn" onclick="closeProfile()">Back</button>
</div>

<!-- CHAT -->
<div id="chatPage" class="container hidden">
  <h2 id="chatWith"></h2>
  <div id="chatMessages" class="flex"></div>
  <input id="chatInput" class="input" placeholder="Type a message">
  <button class="neon-btn" onclick="sendMessage()">Send</button>
  <button class="neon-btn" onclick="closeChat()">Back</button>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();
const DEFAULT_AVATAR="https://cdn-icons-png.flaticon.com/512/149/149071.png";

let currentChatUser = null;

// ---------------- LOGIN ----------------
function loginWithGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err=>alert(err.message));
}

// ---------------- AUTH STATE ----------------
auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    usernamePage.classList.add("hidden");
    dashboard.classList.add("hidden");
    profilePage.classList.add("hidden");
    chatPage.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  const ref=db.collection("users").doc(user.uid);
  const snap=await ref.get();
  if(!snap.exists){ 
    usernamePage.classList.remove("hidden"); 
  } else { 
    usernamePage.classList.add("hidden"); 
    loadDashboard(snap.data()); 
  }
});

// ---------------- SAVE USERNAME ----------------
function saveUsername(){
  const name=usernameInput.value.trim();
  if(!name) return alert("Username required");
  const user=auth.currentUser;
  db.collection("users").doc(user.uid).set({
    uid:user.uid,
    nickname:name,
    email:user.email,
    authType:"google",
    lastActive:firebase.firestore.FieldValue.serverTimestamp(),
    bio:"",
    profileImageUrl:user.photoURL||DEFAULT_AVATAR,
    status:"online"
  }).then(()=>{
    usernamePage.classList.add("hidden");
    loadDashboard({nickname:name});
  }).catch(err=>alert("Error creating profile: "+err.message));
}

// ---------------- DASHBOARD ----------------
function loadDashboard(data){
  dashboard.classList.remove("hidden");
  welcome.innerText="Welcome, "+data.nickname;
  loadUsers();
}

function logout(){ auth.signOut(); }

// ---------------- USERS LIST ----------------
function loadUsers(){
  usersList.innerHTML="";
  const currentUserId=auth.currentUser.uid;
  db.collection("users").get().then(snap=>{
    snap.forEach(u=>{
      if(u.id===currentUserId) return;
      const d=u.data();
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<div class="user">
        <img class="avatar" src="${d.profileImageUrl||DEFAULT_AVATAR}">
        <strong>${d.nickname}</strong></div><br>
        <button class="neon-btn" onclick="openChat('${u.id}')">Message</button>`;
      usersList.appendChild(card);
    });
  });
}

// ---------------- PROFILE ----------------
function openProfile(){
  dashboard.classList.add("hidden");
  profilePage.classList.remove("hidden");
  db.collection("users").doc(auth.currentUser.uid).get().then(d=>{
    profilePreview.src=d.data().profileImageUrl||DEFAULT_AVATAR;
    statusInput.value=d.data().status||"";
  });
}

function closeProfile(){
  profilePage.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function saveProfile(){
  const file=profileImage.files[0];
  if(file){
    const ref=storage.ref("avatars/"+auth.currentUser.uid);
    ref.put(file).then(()=>ref.getDownloadURL().then(url=>updateProfile(url)));
  } else { updateProfile(null); }
}

function updateProfile(url){
  const data={ status:statusInput.value };
  if(url) data.profileImageUrl=url;
  db.collection("users").doc(auth.currentUser.uid).update(data).then(closeProfile);
}

// ---------------- CHAT ----------------
function openChat(friendId){
  currentChatUser = friendId;
  dashboard.classList.add("hidden");
  chatPage.classList.remove("hidden");
  db.collection("users").doc(friendId).get().then(doc=>{
    chatWith.innerText = "Chat with " + doc.data().nickname;
  });
  loadMessages();
}

function loadMessages(){
  if(!currentChatUser) return;
  chatMessages.innerHTML = "";
  db.collection("messages")
    .where("senderId","in",[auth.currentUser.uid,currentChatUser])
    .where("receiverId","in",[auth.currentUser.uid,currentChatUser])
    .orderBy("timestamp")
    .onSnapshot(snap=>{
      chatMessages.innerHTML="";
      snap.forEach(m=>{
        const msg = m.data();
        const bubble=document.createElement("div");
        bubble.className="message-bubble "+(msg.senderId===auth.currentUser.uid?"message-outgoing":"message-incoming");
        bubble.innerHTML=`<div class="message-header">${msg.senderId===auth.currentUser.uid?"You":"Friend"} - ${msg.timestamp?.toDate().toLocaleTimeString()||""}</div>
        <div>${msg.content}</div>`;
        chatMessages.appendChild(bubble);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    });
}

function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !currentChatUser) return;
  db.collection("messages").add({
    senderId: auth.currentUser.uid,
    receiverId: currentChatUser,
    content: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  chatInput.value = "";
}

function closeChat(){
  currentChatUser = null;
  chatPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
}
</script>
</body>
</html>
