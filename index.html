<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr3vMedia</title>
<style>
/* ---------------------------------- */
/* --- üé® STYLISTIC CLEAN OVERHAUL --- */
/* ---------------------------------- */

/* --- Core Styling & Typography --- */
body {
    margin: 0;
    font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace;
    background: #0a0a0a; 
    color: #00FFFF; 
    line-height: 1.6;
}
header, footer {
    background: #111111; 
    padding: 15px 30px;
    color: #00FFFF;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); 
}
main {padding: 30px 40px;}
h2, h3, h4 {color: #00CCCC; margin-top: 0;} 
.verified {
    color: #1DA1F2;
    font-weight: bold;
    margin-left: 5px;
    background: rgba(29, 161, 242, 0.1);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}
.tab-content {display:none;}
#welcome-banner {
    background: #004444; 
    color: #FFFFFF;
    text-align: center;
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 8px; 
}

/* --- Header & Navigation --- */
header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom: 1px solid #004444;
    position:sticky;
    top:0;
    z-index:1000; 
}
.header-left {
    display: flex;
    align-items: center;
    gap: 30px; 
}
.logo-container {
    display: flex; 
    align-items: center;
    gap: 15px;
}
.logo-container img {
    height: 35px;
    border-radius: 5px;
    filter: drop-shadow(0 0 5px #00CCCC); 
}

/* Search Bar Styling */
#search-bar {
    position: relative; 
    min-width: 250px;
}
#search-input {
    padding: 8px 12px;
    border-radius: 20px; 
    background: #1e1e1e;
    color: #00FFFF;
    border: 1px solid #004444;
    width: 100%;
    box-sizing: border-box;
    transition: all 0.3s;
}
#search-input:focus {
    background: #222222;
    border-color: #00CCCC;
    box-shadow: 0 0 8px rgba(0, 204, 204, 0.5);
    outline: none;
}

/* Search Results Dropdown Styling */
#search-results {
    position: absolute;
    top: 100%; 
    left: 0;
    width: 100%;
    background: #1e1e1e;
    border: 1px solid #004444;
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
}
.search-result-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #001a1a;
    transition: background 0.2s;
}
.search-result-item:hover {
    background: #003333;
    color: #FFFFFF;
}


/* Tabs Styling */
.header-actions {
    display: flex; 
    gap: 10px; 
    align-items: center;
}
.nav-tab {
    cursor:pointer;
    padding: 8px 15px; 
    border-radius: 20px; 
    border: 1px solid #004444;
    font-size: 0.9em; 
    transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
}
.nav-tab.active {
    background: #003333;
    border-color: #00CCCC;
    box-shadow: 0 0 10px rgba(0, 204, 204, 0.5);
    color: #FFFFFF;
}
.nav-tab:hover:not(.active) {
    background: #1e1e1e;
    border-color: #00CCCC;
}

/* --- Forms & Inputs (General) --- */
input:not([type="file"], #search-input), textarea {
    width: 100%; 
    box-sizing: border-box;
    padding: 10px;
    margin-bottom: 15px; 
    border-radius: 6px;
    background: #1e1e1e;
    color: #00FFFF;
    border: 1px solid #004444;
    margin-top: 5px;
    resize: vertical;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus:not([type="file"], #search-input), textarea:focus {
    border-color: #00CCCC;
    box-shadow: 0 0 5px rgba(0, 204, 204, 0.4);
    outline: none;
}
/* File input styling is subtle */
input[type="file"] {margin-top:10px; margin-bottom: 15px; background: #1e1e1e; color: #00FFFF; padding: 10px; border-radius: 6px; border: 1px solid #004444;}

button {
    cursor:pointer;
    padding:10px 18px; 
    border-radius: 20px; 
    background: #006666;
    color: #FFFFFF;
    border: none;
    margin-top: 5px;
    transition: background 0.3s, box-shadow 0.3s;
    font-weight: bold;
}
button:hover {
    background: #008888;
    box-shadow: 0 4px 10px rgba(0, 204, 204, 0.4);
}
button:active {
    background: #004444;
}

#new-post {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    border: 1px solid #004444;
}
#new-post button {margin-top: 10px; width: 100%;}

/* --- Posts & Post Images --- */
.post {
    display:flex;
    flex-direction: column; 
    background:#1e1e1e;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 1px solid #004444;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}
.post-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}
.post-content {
    margin-bottom: 15px;
    white-space: pre-wrap; 
}
.post-image-container {
    max-width: 100%;
    margin: 10px 0 15px 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #004444;
}
.post-image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
}
.post-actions {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-top: 10px;
    border-top: 1px dashed #004444;
    padding-top: 10px;
}
.post-actions button {
    padding: 5px 10px;
    margin-top: 0;
    font-size: 0.9em;
    background: #333333;
    color: #00FFFF;
}
.post-actions button:hover {
    background: #005555;
    box-shadow: none;
}
.reaction-count {
    margin-left: -15px; 
    font-size: 0.9em;
    color: #00CCCC;
}
.post img, .profile-image-small {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid #00CCCC;
    object-fit:cover;
    background: #0d0d0d; 
}
#profile-pic-display {width: 90px; height: 90px;}

/* --- Comments Styling (Remains Clean) --- */
.comments-section {
    margin-top: 20px;
    padding: 10px 0;
    border-top: 1px solid #004444;
    border-bottom: 1px solid #004444;
}
.comment {
    background: #0d0d0d;
    padding: 8px 12px;
    margin-bottom: 6px;
    border-left: 3px solid #00CCCC;
    border-radius: 4px;
    font-size: 0.9em;
}
.comment-user {
    font-weight: bold;
    color: #00CCCC;
}
.comment-input-area {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.comment-input-area input {
    flex-grow: 1;
    margin-bottom: 0;
    padding: 8px;
    border-radius: 4px;
}
.comment-input-area button {
    margin-top: 0;
    padding: 8px 15px;
    white-space: nowrap;
    background: #00CCCC;
}
.comment-input-area button:hover {
    background: #00FFFF;
}

/* --- Profile Styling (View & Edit) (Remains Clean) --- */
#profile, #view-profile {
    background: #1e1e1e;
    padding: 25px;
    border-radius: 10px;
    border: 1px solid #004444;
}

#view-profile-content #profile-pic-view {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid #00CCCC;
    background: #0d0d0d;
    margin-bottom: 10px;
}
.clickable-username {
    cursor: pointer;
    text-decoration: none; 
    color: #00CCCC;
    transition: color 0.2s, text-decoration 0.2s;
}
.clickable-username:hover {
    color: #00FFFF;
    text-decoration: underline;
}
.post-timestamp {
    font-size: 0.8em;
    color: #555555;
    margin-left: 10px;
}

/* Gallery Styling (Remains Clean) */
.gallery-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: #111111;
    border-radius: 8px;
}

.gallery-slot {
    background: #222222;
    border: 1px solid #004444;
    border-radius: 6px;
    padding: 5px;
    text-align: center;
    overflow: hidden;
}

.gallery-image-display {
    width: 100%;
    aspect-ratio: 1 / 1; 
    object-fit: cover;
    margin-bottom: 5px;
    border-radius: 4px;
    border: 1px solid #00CCCC;
    cursor: pointer;
    transition: transform 0.3s, opacity 0.3s;
}
.gallery-image-display:hover {
    opacity: 0.8;
    transform: scale(1.02);
}

/* Mobile adjustments (Remains Clean) */
@media (max-width: 600px) {
    main {padding: 15px 15px;}
    header {padding: 10px 15px;}
    .header-left {gap: 10px;}
    .logo-container img {height: 30px;}
    .gallery-container {
        grid-template-columns: repeat(2, 1fr); 
        gap: 10px;
    }
}
</style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="logo-container">
            <img src="https://see.fontimg.com/api/rf5/vXL4/YTM3ZmYyMWFkMzNiNGY5MGEwY2ZmZTZmNDhiZGI4NzkudHRm/VHIzdk1lZGlh/chimpanzee-website-report.png?r=fs&h=65&w=1000&fg=E8E4E4&bg=27E2A1&tb=1&s=65" 
                 alt="Tr3vMedia Icon 1">
            
            <img src="https://scontent-iad3-2.xx.fbcdn.net/v/t39.30808-6/596009832_838710972097270_9022730636766278745_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=FV-kAQTMc9sQ7kNvwHtnXUJ&_nc_oc=AdnMy32z6EqV3KBKYoxV9lXa4sxDC5HGtKjqXOn1Ft5DhugILwP1VuHdODGDfKtXeMswLEwyf_07cIoNby3di58u&_nc_zt=23&_nc_ht=scontent-iad3-2.xx&_nc_gid=ffAPLrP0wQ4lRnuf3eL46g&oh=00_Afk9OB0-t0OJNQksLxcPV1gJpw_C1Z8IwkKu4li6rX9bgA&oe=6940AF3A" 
                 alt="Tr3vMedia Icon 2">
        </div>
        
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Search usernames..." onkeyup="searchUsers()">
            <div id="search-results"></div>
        </div>
        
    </div>
    
    <div class="header-actions" id="header-tabs"></div>
</header>

<div id="welcome-banner"></div>

<main id="main-content">
    <div id="auth" class="tab-content">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p>Or <span class="clickable-username" onclick="showSignup()">Sign Up</span></p>
    </div>

    <div id="signup" class="tab-content">
        <h2>Sign Up </h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signup()">Create Account</button>
        <p>Or <span class="clickable-username" onclick="showLogin()">Login</span></p>
    </div>

    <div id="home" class="tab-content">
        <div id="new-post">
            <textarea id="post-text" rows="3" placeholder="What's on your mind?"></textarea>
            <label for="post-image-upload">Add Image (Optional):</label>
            <input type="file" id="post-image-upload" accept="image/*" onchange="previewPostImage()">
            <div id="post-image-preview" class="post-image-container" style="display:none; height: 150px; background: #000000;">
                <img id="post-image-tag" class="post-image" style="max-height: 100%; object-fit: contain;">
            </div>

            <button onclick="addPost()">Post</button>
        </div>
        <div id="posts"></div>
    </div>

    <div id="profile" class="tab-content">
        <h2>My Profile</h2>
        <img id="profile-pic-display" class="profile-image-small" src="" alt="Profile Picture"><br>
        <label>Main Profile Picture:</label>
        <input type="file" id="profile-upload" accept="image/*" onchange="uploadProfilePic()">
        <textarea id="profile-bio" placeholder="Write your bio..."></textarea><br>
        
        <p>Username: <span id="my-profile-username"></span> <span id="owner-tag-me"></span></p>
        <p>Total Posts: <span id="my-profile-posts-count"></span></p>
        <p>Total Reactions Received: <span id="my-profile-likes-count"></span></p>
        
        <hr style="border-top: 1px solid #004444; margin: 20px 0;">

        <h3>üñºÔ∏è Gallery (8 Images)</h3>
        <p style="font-size:0.9em; color:#00CCCC;">Click the current image to upload a replacement.</p>
        <div class="gallery-container" id="my-gallery-edit">
            </div>

        <button onclick="saveProfile()" style="margin-top: 30px;">Save Profile & Bio</button>
    </div>
    
    <div id="view-profile" class="tab-content">
        <div id="view-profile-content">
            <img id="profile-pic-view" src="" alt="User Profile Picture"><br>
            <h2 id="view-username"></h2>
            <p id="view-owner-tag"></p>
            <p>Bio: <span id="view-bio"></span></p>
            <p>Posts: <span id="view-posts-count"></span></p>
            <p>Reactions Received: <span id="view-likes-received"></span></p>

            <hr style="border-top: 1px solid #004444; margin: 20px 0;">
            <h3>üñºÔ∏è Gallery</h3>
            <div class="gallery-container" id="view-gallery">
                </div>

            <hr style="border-top: 1px solid #004444; margin: 20px 0;">
            <h3>User Posts</h3>
            <div id="view-user-posts"></div>
        </div>
        <button onclick="showTab('home')" style="margin-top: 30px;">Back to Feed</button>
    </div>

    <div id="settings" class="tab-content">
        <h2>Settings</h2>
        <label>Change username: <input type="text" id="change-username"></label><br>
        <button onclick="changeUsername()">Save</button>
    </div>
</main>

<footer>&copy; 2025 Tr3vMedia ‚Äî All Rights Reserved</footer>

<script>
// --- Global Constants ---
const DEFAULT_PIC = 'https://via.placeholder.com/60';
const DEFAULT_GALLERY_ITEM = 'https://via.placeholder.com/150x150?text=Empty+Slot';
const REACTIONS = ['like', 'heart', 'star']; 
const GALLERY_SIZE = 8; 

// Temp variable to hold the image data URL for a new post
let currentPostImage = null; 

// Helper function to format date
function formatTimestamp(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diff = now - then;

    if (diff < 60000) return 'Just now'; 
    if (diff < 3600000) return Math.round(diff / 60000) + 'm ago'; 
    if (diff < 86400000) return Math.round(diff / 3600000) + 'h ago'; 
    
    return then.toLocaleDateString(); 
}

// ------------------ Users Setup (Updated) ------------------
if(!localStorage.getItem('users')) {
    const defaultGallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);

    const defaultUsers = {
        'Tr3vN0x': {
            password:'ownerpass', 
            profilePic:DEFAULT_PIC, 
            bio:'Owner of Tr3vMedia', 
            gallery: defaultGallery, 
            posts:[
                {
                    text: 'Welcome to Tr3vMedia! This site just got a whole lot cooler. Check out this placeholder!', 
                    imageUrl: 'https://via.placeholder.com/400x200?text=Site+Launch+Image', // ADDED IMAGE
                    date: Date.now(), 
                    reactions: {like: [], heart: [], star: []},
                    comments: [
                        {user: 'TestUser1', text: 'Looks awesome!'},
                        {user: 'Tr3vN0x', text: 'Thanks! Enjoy the new features.'}
                    ]
                }
            ]
        },
        'TestUser1': {
            password:'password', 
            profilePic:DEFAULT_PIC, 
            bio:'Just a friendly user.', 
            gallery: defaultGallery.map((_, i) => i === 0 ? 'https://via.placeholder.com/150x150?text=Cool+Pic' : DEFAULT_GALLERY_ITEM), 
            posts:[
                {
                    text: 'Testing the new clean style overhaul. Looking very polished!', 
                    imageUrl: null,
                    date: Date.now() - 5000000, 
                    reactions: {like: ['Tr3vN0x'], heart: [], star: []},
                    comments: []
                }
            ]
        }
    };
    localStorage.setItem('users', JSON.stringify(defaultUsers));
}

// ------------------ Auth Tabs ------------------
function showLogin() {document.getElementById('signup').style.display='none'; document.getElementById('auth').style.display='block';}
function showSignup() {document.getElementById('auth').style.display='none'; document.getElementById('signup').style.display='block';}

// ------------------ Signup / Login ------------------
function signup(){
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value.trim();
    if(!username||!password){alert("Fill all fields"); return;}
    const users = JSON.parse(localStorage.getItem('users'));
    if(users[username]){alert("Username taken"); return;}
    
    users[username]={
        password,
        profilePic:DEFAULT_PIC,
        bio:'',
        posts:[],
        gallery: Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM) 
    }; 
    
    localStorage.setItem('users', JSON.stringify(users));
    alert("Account created! Login now.");
    showLogin();
}
function login(){
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const users = JSON.parse(localStorage.getItem('users'));
    if(!users[username] || users[username].password!==password){alert("Invalid credentials"); return;}
    localStorage.setItem('currentUser', username);
    initApp();
}

// ------------------ App Init ------------------
function initApp(){
    document.getElementById('auth').style.display='none';
    document.getElementById('signup').style.display='none';
    
    document.getElementById('welcome-banner').innerText=`Hello ${localStorage.getItem('currentUser')}!`;
    
    document.getElementById('header-tabs').innerHTML=`
        <div class="nav-tab" onclick="showTab('home')">Home</div>
        <div class="nav-tab" onclick="showTab('profile')">Profile</div>
        <div class="nav-tab" onclick="showTab('settings')">Settings</div>
        <div class="nav-tab" onclick="logout()">Logout</div>`;
    
    loadUser();
    showTab('home'); 
}

// ------------------ Logout ------------------
function logout(){localStorage.removeItem('currentUser'); location.reload();}

// ------------------ Tab Switching ------------------
function showTab(tabId){
    document.querySelectorAll('.tab-content').forEach(tab=>tab.style.display='none');
    document.getElementById(tabId).style.display='block';
    
    document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));
    
    const activeTabElement = document.querySelector(`.nav-tab[onclick*="showTab('${tabId}')"]`);
    if (activeTabElement) {
        activeTabElement.classList.add('active');
    }
    
    if (tabId === 'profile') {
        renderGalleryEdit();
    }
}

// ------------------ Profile (My Profile) ------------------
function loadUser(){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    if(!currentUser) return;
    const user = users[currentUser];
    
    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    document.getElementById('profile-pic-display').src=user.profilePic;
    document.getElementById('my-profile-username').innerText=currentUser;
    document.getElementById('my-profile-posts-count').innerText=user.posts.length;
    document.getElementById('my-profile-likes-count').innerText=totalReactions;
    document.getElementById('owner-tag-me').innerHTML=currentUser==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':'';
    document.getElementById('profile-bio').value=user.bio;
    renderPosts();
}

// Main Profile Picture Upload
function uploadProfilePic(){
    const file = document.getElementById('profile-upload').files[0]; 
    if(file){
        if (!file.type.startsWith('image/')) {
            alert("Only image files are allowed for profile pictures.");
            document.getElementById('profile-upload').value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload=function(){
            const users=JSON.parse(localStorage.getItem('users'));
            const currentUser=localStorage.getItem('currentUser');
            users[currentUser].profilePic=reader.result;
            localStorage.setItem('users',JSON.stringify(users));
            document.getElementById('profile-pic-display').src=reader.result;
            renderPosts();
        };
        reader.readAsDataURL(file);
    }
}


function saveProfile(){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    users[currentUser].bio=document.getElementById('profile-bio').value;
    localStorage.setItem('users',JSON.stringify(users));
    alert("Profile saved!");
}

// Gallery Upload Function
function uploadGalleryImage(index) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert("Only image files are allowed in the gallery.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function() {
                const users = JSON.parse(localStorage.getItem('users'));
                const currentUser = localStorage.getItem('currentUser');
                
                if (!users[currentUser].gallery || users[currentUser].gallery.length !== GALLERY_SIZE) {
                    users[currentUser].gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
                }
                
                users[currentUser].gallery[index] = reader.result;
                localStorage.setItem('users', JSON.stringify(users));
                
                document.getElementById(`gallery-img-${index}`).src = reader.result;
            };
            reader.readAsDataURL(file);
        }
    };
    
    input.click();
}

// Render Gallery Edit (on My Profile tab)
function renderGalleryEdit() {
    const users = JSON.parse(localStorage.getItem('users'));
    const currentUser = localStorage.getItem('currentUser');
    const user = users[currentUser];
    const galleryContainer = document.getElementById('my-gallery-edit');
    galleryContainer.innerHTML = '';

    if (!user.gallery || user.gallery.length !== GALLERY_SIZE) {
        user.gallery = Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
        localStorage.setItem('users', JSON.stringify(users));
    }
    
    for (let i = 0; i < GALLERY_SIZE; i++) {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'gallery-slot';
        
        const img = document.createElement('img');
        img.id = `gallery-img-${i}`;
        img.className = 'gallery-image-display';
        img.src = user.gallery[i];
        img.alt = `Gallery Slot ${i + 1}`;
        img.onclick = () => uploadGalleryImage(i); 

        slotDiv.appendChild(img);
        
        const label = document.createElement('p');
        label.style.fontSize = '0.8em';
        label.style.margin = '5px 0 0 0';
        label.style.color = '#00CCCC';
        label.innerText = `Slot ${i + 1}`;
        slotDiv.appendChild(label);

        galleryContainer.appendChild(slotDiv);
    }
}


// ------------------ Profile (View Other User) ------------------
function renderViewGallery(username, targetElement) {
    const users = JSON.parse(localStorage.getItem('users'));
    const user = users[username];
    targetElement.innerHTML = '';
    
    const galleryImages = user.gallery || Array(GALLERY_SIZE).fill(DEFAULT_GALLERY_ITEM);
    let galleryContent = '';
    let hasImages = false;

    galleryImages.forEach((imgUrl, index) => {
        if (imgUrl !== DEFAULT_GALLERY_ITEM) {
            hasImages = true;
            galleryContent += `
                <div class="gallery-slot" style="border: none; background: transparent; padding: 0;">
                    <img class="gallery-image-display" 
                         src="${imgUrl}" 
                         alt="${username}'s Gallery Image ${index + 1}"
                         style="cursor: default; border: 2px solid #006666;">
                </div>
            `;
        }
    });

    if (hasImages) {
        targetElement.innerHTML = galleryContent;
    } else {
        targetElement.innerHTML = '<p style="font-style: italic; color: #555555; padding: 10px;">User has no images in their gallery.</p>';
    }
}


function viewProfile(username){
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-input').value = ''; 
    
    const users=JSON.parse(localStorage.getItem('users'));
    const user = users[username];
    if (!user) return alert("User not found.");

    let totalReactions = 0;
    user.posts.forEach(p => {
        if(p.reactions) {
            REACTIONS.forEach(r => totalReactions += p.reactions[r] ? p.reactions[r].length : 0);
        }
    });

    document.getElementById('profile-pic-view').src = user.profilePic;
    document.getElementById('view-username').innerText = username;
    document.getElementById('view-owner-tag').innerHTML = username === 'Tr3vN0x' ? '<span class="verified">‚úîÔ∏è Owner</span>' : '';
    document.getElementById('view-bio').innerText = user.bio || 'No bio set.';
    document.getElementById('view-posts-count').innerText = user.posts.length;
    document.getElementById('view-likes-received').innerText = totalReactions;

    renderViewGallery(username, document.getElementById('view-gallery'));
    renderUserPosts(username, document.getElementById('view-user-posts'));
    
    showTab('view-profile');
}

// ------------------ Search Functionality ------------------
function searchUsers() {
    const input = document.getElementById('search-input').value.toLowerCase();
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '';
    
    if (input.length < 2) {
        return;
    }

    const users = JSON.parse(localStorage.getItem('users'));
    const userKeys = Object.keys(users);
    
    const matchedUsers = userKeys.filter(username => 
        username.toLowerCase().includes(input)
    );

    if (matchedUsers.length > 0) {
        matchedUsers.forEach(username => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerText = username;
            resultItem.onclick = () => viewProfile(username);
            resultsDiv.appendChild(resultItem);
        });
    } else {
        const noResultItem = document.createElement('div');
        noResultItem.className = 'search-result-item';
        noResultItem.innerText = 'No users found.';
        resultsDiv.appendChild(noResultItem);
    }
}

// ------------------ Posts & Reactions & Comments ------------------

// NEW: Function to preview the image and store the Data URL
function previewPostImage() {
    const fileInput = document.getElementById('post-image-upload');
    const previewContainer = document.getElementById('post-image-preview');
    const previewImage = document.getElementById('post-image-tag');
    const file = fileInput.files[0];
    
    currentPostImage = null;

    if (file) {
        if (!file.type.startsWith('image/')) {
            alert("Only image files are allowed in posts.");
            fileInput.value = ''; 
            previewContainer.style.display = 'none';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            currentPostImage = e.target.result; // Store the Data URL globally
            previewImage.src = currentPostImage;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        previewContainer.style.display = 'none';
    }
}

function addPost(){
    const text=document.getElementById('post-text').value.trim();
    
    if(!text && !currentPostImage){alert("Cannot post empty text or image"); return;}
    
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    
    // Create new post object including the stored image URL
    users[currentUser].posts.unshift({
        text,
        imageUrl: currentPostImage, // Use the stored image URL
        date:Date.now(), 
        reactions: {like: [], heart: [], star: []}, 
        comments: []
    }); 
    
    localStorage.setItem('users',JSON.stringify(users));
    
    // Reset inputs and temporary image variable
    document.getElementById('post-text').value='';
    document.getElementById('post-image-upload').value = '';
    document.getElementById('post-image-preview').style.display = 'none';
    currentPostImage = null;

    loadUser(); 
}

function toggleReaction(postUser, postIndex, reactionType){
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    const post = users[postUser].posts[postIndex];
    
    if(!post.reactions) post.reactions = {like: [], heart: [], star: []}; 

    REACTIONS.forEach(r => {
        const index = post.reactions[r].indexOf(currentUser);
        if (index !== -1) {
            post.reactions[r].splice(index, 1);
        }
    });

    const indexInTargetReaction = post.reactions[reactionType].indexOf(currentUser);
    if (indexInTargetReaction === -1) {
        post.reactions[reactionType].push(currentUser);
    } 
    
    localStorage.setItem('users',JSON.stringify(users));
    
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}


function addComment(postUser, postIndex) {
    const currentUser = localStorage.getItem('currentUser');
    const commentInput = document.getElementById(`comment-input-${postUser}-${postIndex}`);
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const users = JSON.parse(localStorage.getItem('users'));
    const post = users[postUser].posts[postIndex];

    if (!post.comments) post.comments = []; 

    post.comments.push({
        user: currentUser,
        text: commentText
    });

    localStorage.setItem('users', JSON.stringify(users));
    
    commentInput.value = '';
    
    if (document.getElementById('home').style.display === 'block') {
        renderPosts();
    } else if (document.getElementById('view-profile').style.display === 'block') {
        viewProfile(postUser);
    } else if (document.getElementById('profile').style.display === 'block') {
        loadUser();
    }
}


function renderComments(comments) {
    let html = '<div class="comments-section">';
    html += '<h4>Comments:</h4>';
    
    if (comments.length === 0) {
        html += '<p style="margin-left: 10px; font-style: italic; color: #555555;">No comments yet.</p>';
    } else {
        comments.forEach(c => {
            html += `<div class="comment">
                        <span class="comment-user clickable-username" onclick="viewProfile('${c.user}')">${c.user}</span>: ${c.text}
                     </div>`;
        });
    }
    html += '</div>';
    return html;
}

function renderPostActions(postUser, postIndex, reactions, currentUser) {
    let actionsHTML = '';
    const reactionEmojis = {
        'like': 'üëç',
        'heart': '‚ù§Ô∏è',
        'star': '‚≠êÔ∏è'
    };

    REACTIONS.forEach(type => {
        const count = reactions[type] ? reactions[type].length : 0;
        const isActive = reactions[type].includes(currentUser);
        const buttonClass = isActive ? 'active-reaction' : '';
        
        actionsHTML += `
            <button class="${buttonClass}" onclick="toggleReaction('${postUser}', ${postIndex}, '${type}')">
                ${reactionEmojis[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}
            </button>
            <span class="reaction-count">${count}</span>
        `;
    });
    return actionsHTML;
}

// Helper to render the post image if available
function renderPostImage(imageUrl) {
    if (imageUrl) {
        return `
            <div class="post-image-container">
                <img src="${imageUrl}" class="post-image" alt="Post Image">
            </div>
        `;
    }
    return '';
}

function renderUserPosts(username, targetElement) {
    const users = JSON.parse(localStorage.getItem('users'));
    const currentUser = localStorage.getItem('currentUser');
    const userPosts = users[username].posts;
    targetElement.innerHTML = '';

    userPosts.forEach((p, index) => {
        const postId = `${username}-${index}`; 
        const div = document.createElement('div'); 
        div.className = 'post';
        
        if (!p.comments) p.comments = [];

        div.innerHTML = `
            <div class="post-header">
                <img src="${users[username].profilePic}" class="profile-image-small" alt="${username}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${username}')">${username}</span>${username==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            
            ${renderPostImage(p.imageUrl)} <div class="post-actions">
                ${renderPostActions(username, index, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment...">
                <button onclick="addComment('${username}', ${index})">Comment</button>
            </div>
        `;
        targetElement.appendChild(div);
    });
}

function renderPosts(){
    const postsDiv=document.getElementById('posts'); postsDiv.innerHTML='';
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    const allPosts=[];
    
    for(let user in users){
        users[user].posts.forEach((p, index) => {
            allPosts.push({
                user,
                text: p.text,
                imageUrl: p.imageUrl, // INCLUDE IMAGE URL
                date: p.date,
                profilePic: users[user].profilePic,
                postIndex: index, 
                reactions: p.reactions || {like: [], heart: [], star: []},
                comments: p.comments || []
            });
        });
    }
    
    allPosts.sort((a,b)=>b.date-a.date);
    
    allPosts.forEach(p=>{
        const postId = `${p.user}-${p.postIndex}`; 
        const div=document.createElement('div'); div.className='post';
        div.innerHTML=`
            <div class="post-header">
                <img src="${p.profilePic}" class="profile-image-small" alt="${p.user}'s profile picture">
                <strong><span class="clickable-username" onclick="viewProfile('${p.user}')">${p.user}</span>${p.user==='Tr3vN0x'?'<span class="verified">‚úîÔ∏è Owner</span>':''}</strong>
                <span class="post-timestamp">${formatTimestamp(p.date)}</span>
            </div>
            <div class="post-content">${p.text}</div>
            
            ${renderPostImage(p.imageUrl)} <div class="post-actions">
                ${renderPostActions(p.user, p.postIndex, p.reactions, currentUser)}
            </div>
            
            ${renderComments(p.comments)}

            <div class="comment-input-area">
                <input type="text" id="comment-input-${postId}" placeholder="Write a comment..." class="comment-input">
                <button onclick="addComment('${p.user}', ${p.postIndex})">Comment</button>
            </div>
        `;
        postsDiv.appendChild(div);
    });
}

// ------------------ Settings ------------------
function changeUsername(){
    const newName=document.getElementById('change-username').value.trim();
    if(!newName) return alert("Username cannot be empty");
    const users=JSON.parse(localStorage.getItem('users'));
    const currentUser=localStorage.getItem('currentUser');
    if(users[newName]) return alert("Username taken");
    
    if (currentUser === 'Tr3vN0x') return alert("The owner's username cannot be changed.");
    
    users[newName]=users[currentUser]; 
    delete users[currentUser];
    
    for (let userKey in users) {
        users[userKey].posts.forEach(post => {
            if (post.reactions) {
                REACTIONS.forEach(r => {
                    const index = post.reactions[r].indexOf(currentUser);
                    if (index !== -1) {
                        post.reactions[r][index] = newName;
                    }
                });
            }
            if (post.comments) {
                post.comments.forEach(comment => {
                    if (comment.user === currentUser) {
                        comment.user = newName;
                    }
                });
            }
        });
    }

    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('currentUser',newName);
    
    document.getElementById('change-username').value = '';
    loadUser();
    
    alert("Username changed! You must log in again with your new username.");
    logout(); 
}

// ------------------ Check login on reload ------------------
if(localStorage.getItem('currentUser')) initApp(); else {showLogin();}
</script>

</body>
</html>
