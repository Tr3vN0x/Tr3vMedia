<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Spark Plan MVP</title>
    
    <style>
        /* --- General and Reset --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #15171e; 
            color: #f0f0f0;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            height: 90vh; 
            position: relative;
            overflow: hidden; /* Hide content when views switch */
        }

        /* --- Match Feed Container --- */
        #matching-container {
            padding: 20px 10px 100px; 
            max-width: 420px;
            margin: 0 auto;
        }
        
        #header {
            text-align: center;
            padding: 10px 0;
            color: #ffaa00;
        }

        #card-stack {
            position: relative;
            height: 550px; 
            margin-bottom: 20px;
        }

        /* üÉè The Card Itself */
        .gamer-card {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #2a2a44;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            padding: 25px;
            display: flex; flex-direction: column;
            cursor: grab;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }
        
        .card-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #3c3c5c; padding-bottom: 15px; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #ff4560; }
        .username { margin: 0; font-size: 1.8em; flex-grow: 1; }
        .game-details { background: #1e1e2f; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .tag {
            display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; margin-right: 8px; margin-top: 8px; color: #fff;
        }
        .role { background: #ff4560; } .rank { background: #5c6fff; } .platform { background: #ffaa00; } .vibe { background: #7c7c7c; }

        /* Action Buttons */
        #action-buttons { display: flex; justify-content: space-around; position: absolute; bottom: 20px; width: 100%; }
        .action-btn {
            padding: 15px 35px; border: none; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s;
        }
        .skip { background: #5c6fff; color: white; }
        .request { background: #3dd022; color: white; }
        .test-btn { background: #ffaa00; color: #1e1e2f;}
        .loading { text-align: center; padding: 50px; }

        /* --- Chat Container --- */
        #chat-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; 
            flex-direction: column;
            background: #1e1e2f; 
            border-radius: 10px;
        }

        .chat-header { display: flex; align-items: center; padding: 15px; background: #2a2a44; border-bottom: 1px solid #3c3c5c; }
        #back-to-main-btn { background: none; border: none; color: #ffaa00; font-size: 1.2em; cursor: pointer; margin-right: 15px; }
        #messages-list { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        /* Message Bubbles */
        .message { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 0.95em; word-wrap: break-word; }
        .message-time { display: block; font-size: 0.7em; color: #a0a0b0; margin-top: 5px; text-align: right; }
        .message.sent { align-self: flex-end; background: #3dd022; color: #1e1e2f; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: #5c6fff; color: white; border-bottom-left-radius: 4px; }
        .system-message { text-align: center; color: #ffaa00; font-style: italic; font-size: 0.8em; margin: 10px 0; }

        /* Message Input Form */
        #message-form { display: flex; padding: 15px; background: #2a2a44; border-top: 1px solid #3c3c5c; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #3c3c5c; border-radius: 20px; background: #1e1e2f; color: white; margin-right: 10px; }
        #send-btn { padding: 10px 20px; background: #ffaa00; color: #1e1e2f; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="matching-container">
            <h1 id="header">Find Your Duo</h1>
            
            <div id="card-stack">
                <div class="loading">Loading Gamer Cards...</div>
            </div>

            <div id="action-buttons">
                <button id="skip-btn" class="action-btn skip" disabled>SKIP</button>
                <button id="request-btn" class="action-btn request" disabled>DUO REQUEST</button>
            </div>

            <button id="accept-test-btn" class="action-btn test-btn" style="position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); width: 90%;">TEST: Accept Request</button>
        </div>
        
        <div id="chat-container"> 
            <header class="chat-header">
                <button id="back-to-main-btn">‚Üê Back</button>
                <h2 id="chat-partner-name">Chat with Duo</h2>
            </header>
            
            <div id="messages-list">
            </div>
            
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type your message..." required>
                <button type="submit" id="send-btn">Send</button>
            </form>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Your Keys) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
            authDomain: "duoup-cfae6.firebaseapp.com",
            projectId: "duoup-cfae6",
            storageBucket: "duoup-cfae6.firebasestorage.app",
            messagingSenderId: "812263060524",
            appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
            measurementId: "G-46B67F90FK"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- 2. CORE DOM ELEMENTS ---
        const matchingContainerEl = document.getElementById('matching-container');
        const cardStackEl = document.getElementById('card-stack');
        const skipBtn = document.getElementById('skip-btn');
        const requestBtn = document.getElementById('request-btn');
        const chatContainerEl = document.getElementById('chat-container');
        const messagesListEl = document.getElementById('messages-list');
        const messageFormEl = document.getElementById('message-form');
        const messageInputEl = document.getElementById('message-input');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const acceptTestBtn = document.getElementById('accept-test-btn'); // New test button

        // --- 3. GLOBAL STATE ---
        let currentUserId = null; 
        let cards = [];
        let currentIndex = 0;
        let currentChatId = null;
        let unsubscribeMessages = null;

        // --- 4. AUTH & INITIALIZATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                console.log("User authenticated:", currentUserId);
                fetchGamerCards();
            } else {
                console.warn("User not logged in. Login logic needs to be implemented.");
                cardStackEl.innerHTML = '<h2>Please log in to see cards.</h2>';
            }
        });
        
        // --- UI/NAVIGATION HELPERS ---
        function generateChatId(uid1, uid2) {
            const sortedUids = [uid1, uid2].sort();
            return sortedUids.join('_');
        }

        function showChatScreen(partnerUid, partnerName) {
            if (!currentUserId) return;

            const chatId = generateChatId(currentUserId, partnerUid);
            currentChatId = chatId;
            
            document.getElementById('chat-partner-name').textContent = `Chat with ${partnerName}`;

            matchingContainerEl.style.display = 'none';
            chatContainerEl.style.display = 'flex';
            
            startChatListener(chatId);
        }

        backToMainBtn.addEventListener('click', () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            matchingContainerEl.style.display = 'block';
            chatContainerEl.style.display = 'none';
        });


        // -----------------------------------------------------------------
        // MATCH FEED LOGIC (Sending Request)
        // -----------------------------------------------------------------
        async function fetchGamerCards() {
            skipBtn.disabled = false;
            requestBtn.disabled = false;
            
            const cardsRef = db.collection('gamerCards');
            const q = cardsRef
                .where('gameSlug', '==', 'valorant') 
                .where('isActive', '==', true)     
                .limit(10); 

            try {
                const querySnapshot = await q.get();
                cards = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderCurrentCard();

            } catch (error) {
                console.error("Error fetching documents:", error);
                cardStackEl.innerHTML = `<p>Error loading cards.</p>`;
            }
        }

        function renderCurrentCard() {
            // ... (Render logic remains the same) ...
            if (!currentUserId || cards.length === 0 || currentIndex >= cards.length) {
                cardStackEl.innerHTML = '<h2>No more Duos found!</h2>';
                skipBtn.disabled = true;
                requestBtn.disabled = true;
                return;
            }
            
            const cardData = cards[currentIndex];
            const newCardEl = document.createElement('div');
            newCardEl.className = 'gamer-card';
            newCardEl.dataset.targetUserId = cardData.userId;
            
            const username = cardData.username || 'Gamer';
            const profileImg = cardData.profileImageUrl || 'https://via.placeholder.com/150';
            const description = cardData.description || 'No description provided.';
            
            newCardEl.innerHTML = `
                <div class="card-header">
                    <img src="${profileImg}" alt="Profile" class="profile-img">
                    <h2 class="username">${username}</h2>
                </div>
                <div class="game-details">
                    <div class="game-info">
                        <h3>${cardData.gameSlug ? cardData.gameSlug.toUpperCase().replace('_', ' ') : 'UNKNOWN GAME'}</h3>
                        <span class="tag role">ROLE: ${cardData.inGameRole || 'Any'}</span>
                        <span class="tag rank">RANK: ${cardData.skillLevel || 'Casual'}</span>
                    </div>
                </div>
                <div class="card-bio">
                    <p>${description}</p>
                    <span class="tag platform">${cardData.platform || 'Unknown Platform'}</span>
                    <span class="tag vibe">#${cardData.vibe || 'Neutral'}</span>
                </div>
            `;
            cardStackEl.innerHTML = '';
            cardStackEl.appendChild(newCardEl);
        }

        function swipeCard(action) {
            // ... (Swipe logic remains the same) ...
            const currentCardEl = document.querySelector('.gamer-card');
            if (!currentCardEl) return;

            let translateX = (action === 'request') ? '500px' : '-500px';

            currentCardEl.style.transform = `translateX(${translateX}) rotate(${action === 'request' ? '10deg' : '-10deg'})`;
            currentCardEl.style.opacity = '0';

            setTimeout(() => {
                currentIndex++;
                renderCurrentCard();
            }, 500);
        }

        skipBtn.addEventListener('click', () => {
            if (currentIndex < cards.length) {
                swipeCard('skip');
            }
        });

        requestBtn.addEventListener('click', async () => {
            if (currentIndex >= cards.length || !currentUserId) return;
            
            const cardData = cards[currentIndex];
            
            const friendRequest = {
                senderId: currentUserId, 
                receiverId: cardData.userId,
                gameSlug: cardData.gameSlug,
                status: 'pending', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };
            
            try {
                await db.collection('friendRequests').add(friendRequest);
                console.log(`Duo Request SENT to User ID: ${cardData.userId}`);
                swipeCard('request');
                
            } catch (error) {
                console.error("Error sending Duo Request:", error);
                alert(`Failed to send request. Error: ${error.message}`);
            }
        });

        // -----------------------------------------------------------------
        // CLIENT-SIDE TRANSACTION LOGIC (REPLACING CLOUD FUNCTION)
        // This is the essential part for Spark Plan compliance.
        // -----------------------------------------------------------------

        /**
         * Simulates a user (Receiver) accepting a request sent by another user (Sender).
         * This logic uses a Firestore Transaction to guarantee atomic updates.
         */
        async function acceptFriendRequestAndCreateChat(requestId, senderId, receiverId, gameSlug, senderName) {
            
            if (!currentUserId || currentUserId !== receiverId) {
                alert("Authentication error: Cannot accept a request unless you are the intended receiver.");
                return;
            }

            const requestRef = db.collection('friendRequests').doc(requestId);
            const chatMembers = [senderId, receiverId].sort();
            const chatId = chatMembers.join('_');
            const chatDocRef = db.collection('chats').doc(chatId);

            try {
                await db.runTransaction(async (transaction) => {
                    // Check Request Status
                    const requestDoc = await transaction.get(requestRef);
                    if (!requestDoc.exists || requestDoc.data().status !== 'pending') {
                        throw new Error("Request is no longer pending or does not exist.");
                    }
                    
                    // A. Update the Request Status to 'accepted'
                    transaction.update(requestRef, {
                        status: 'accepted',
                        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // B. Create the Chat Document
                    const chatData = {
                        members: chatMembers,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: `You Duod Up for ${gameSlug}! Say hello.`,
                        unreadCount: { 
                            [senderId]: 0, 
                            [receiverId]: 0 
                        }
                    };
                    transaction.set(chatDocRef, chatData, { merge: true });
                });
                
                // C. Add Initial System Message (Must be outside the Transaction)
                await chatDocRef.collection('messages').add({
                    senderId: 'SYSTEM', 
                    content: `Congratulations! Match accepted for ${gameSlug}. Start chatting!`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });

                console.log(`Match accepted and chat created: ${chatId}`);
                showChatScreen(senderId, senderName); 
                
            } catch (error) {
                console.error("Client-Side Match Transaction Failed:", error);
                alert(`Failed to complete match due to a database error. (Did the other user accept first? Check console.)`);
            }
        }

        // --- CHAT DISPLAY LOGIC ---
        function renderMessage(messageData) {
            // ... (Message render logic remains the same) ...
            const isSent = messageData.senderId === currentUserId;
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = messageData.timestamp ? new Date(messageData.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';

            messageEl.innerHTML = `
                <p>${messageData.content}</p>
                <span class="message-time">${time}</span>
            `;
            
            messagesListEl.appendChild(messageEl);
            messagesListEl.scrollTop = messagesListEl.scrollHeight;
        }

        function startChatListener(chatId) {
            // ... (Real-time listener logic remains the same) ...
            if (unsubscribeMessages) unsubscribeMessages();
            messagesListEl.innerHTML = '<div class="system-message">Connecting to Duo Chat...</div>';

            const messagesRef = db.collection('chats').doc(chatId).collection('messages');
            const q = messagesRef.orderBy('timestamp', 'asc');

            unsubscribeMessages = q.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        renderMessage(change.doc.data());
                    }
                });
            }, error => {
                console.error("Chat listener error:", error);
                messagesListEl.innerHTML = `<div class="system-message error">Error loading chat.</div>`;
            });
        }

        // --- SEND MESSAGE FUNCTION ---
        messageFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInputEl.value.trim();
            
            if (!content || !currentChatId || !currentUserId) return;

            try {
                // 1. Write the new message to the messages subcollection
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    senderId: currentUserId,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'text'
                });
                
                // 2. Update the parent chat document (for inbox sorting)
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: content,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                messageInputEl.value = ''; 

            } catch (error) {
                console.error("Error sending message:", error);
            }
        });

        // -----------------------------------------------------------------
        // TEST BUTTON LOGIC (FOR SIMULATION)
        // -----------------------------------------------------------------
        acceptTestBtn.addEventListener('click', () => {
            // This simulates you, the receiver, accepting a request from a sender.
            
            // !!! IMPORTANT: YOU MUST REPLACE THESE PLACEHOLDERS !!!
            const testRequestId = 'REQUEST_ID_FROM_DB'; // Find a pending request document ID
            const testSenderId = 'SENDER_UID_FROM_DB'; // The UID of the person who sent that request
            const testSenderName = 'Test Partner';
            
            if (testRequestId === 'REQUEST_ID_FROM_DB' || testSenderId === 'SENDER_UID_FROM_DB' || !currentUserId) {
                alert("Please replace the test UIDs and Request ID in the 'acceptTestBtn' function to simulate a match.");
                return;
            }

            // Note: We hardcode 'valorant' as the game for the test
            acceptFriendRequestAndCreateChat(
                testRequestId, 
                testSenderId, 
                currentUserId, // You are the receiver
                'valorant',
                testSenderName
            );
        });
        
    </script>
</body>
</html>
