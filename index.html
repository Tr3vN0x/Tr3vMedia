<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duoup - Final MVP (Fixed)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- Base Mobile Styles (Default) --- */
        body {
            font-family: 'Roboto', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
            background: #15171e; color: #f0f0f0;
        }
        #app-container {
            /* Mobile/Small Tablet size */
            width: 100%; max-width: 600px; height: 100vh; position: relative;
            display: flex; flex-direction: column; background: #1e1e2f; 
            overflow-y: auto; /* Fix mobile scrolling */
        }
        
        /* --- Shared Styles --- */
        /* ... (All your existing CSS remains unchanged) ... */
    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="desktop-nav" style="display: none;">
            <div class="nav-item active" data-view="matching-view">
                <span class="material-icons">favorite</span>
                <span>Match</span>
            </div>
            <div class="nav-item" data-view="inbox-view">
                <span class="material-icons">chat</span>
                <span>Duos</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>

        <div id="top-bar">
            <h1>Duoup</h1>
            <button id="profile-btn" class="icon-btn" onclick="switchView('profile-view')">
                <span class="material-icons">person</span>
            </button>
        </div>

        <div id="content-area">
            <!-- --- All views remain unchanged --- -->
        </div>

        <div id="bottom-nav">
            <div class="nav-item active" data-view="matching-view">
                <span class="material-icons">favorite</span>
                <span>Match</span>
            </div>
            <div class="nav-item" data-view="inbox-view">
                <span class="material-icons">chat</span>
                <span>Duos</span>
            </div>
            <div class="nav-item" data-view="profile-view">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Corrected) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
            authDomain: "duoup-cfae6.firebaseapp.com",
            projectId: "duoup-cfae6",
            storageBucket: "duoup-cfae6.appspot.com", // Fixed
            messagingSenderId: "812263060524",
            appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
            measurementId: "G-46B67F90FK"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- 2. GLOBAL STATE ---
        let currentUserId = null; 
        let isSigningUp = true; 
        let cards = [];
        let currentIndex = 0;
        let currentChatId = null;
        let unsubscribeMessages = null;
        let unsubscribeChats = null;

        // --- 3. CORE DOM ELEMENTS ---
        // ... (All your DOM selections remain unchanged) ...

        // --- 4. NAVIGATION / UI HELPERS ---
        function isDesktop() { return window.matchMedia("(min-width: 768px)").matches; }

        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => { view.style.display = 'none'; });
            
            const activeView = document.getElementById(viewId);
            activeView.style.display = isDesktop() && viewId !== 'inbox-view' ? 'block' : 'flex';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewId) item.classList.add('active');
            });

            if (viewId === 'matching-view' && cards.length === 0) fetchGamerCards();
            if (viewId === 'inbox-view') fetchChatList();
            if (viewId === 'profile-view') loadProfileEditData();
            
            if (!isDesktop() && viewId !== 'inbox-view') singleChatViewEl.style.display = 'none';
        }

        // ... attachNavListeners(), AUTH LOGIC ... (unchanged) ...

        // --- 5. AUTHENTICATION LOGIC (with improved email validation) ---
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        authMainBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value.trim();
            authMessageEl.textContent = '';
            
            if (!emailPattern.test(email) || password.length < 6) {
                authMessageEl.textContent = 'Please enter a valid email and a password of at least 6 characters.';
                return;
            }

            try {
                if (isSigningUp) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createInitialUserDocument(userCredential.user.uid, email);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                authMessageEl.textContent = 'Error: ' + error.message;
            }
        });

        // --- 6. PROFILE EDITING LOGIC (unchanged) ---
        // ... loadProfileEditData(), updateProfileBtn, updateCardBtn ...

        // --- 7. MATCH FEED LOGIC (fixed to fetch username/profile) ---
        async function fetchGamerCards() {
            if (!currentUserId) return;
            skipBtn.disabled = false;
            requestBtn.disabled = false;
            
            const cardsRef = db.collection('gamerCards');
            const q = cardsRef
                .where('gameSlug', '==', 'valorant')
                .where('isActive', '==', true)
                .limit(10);

            try {
                const querySnapshot = await q.get();
                cards = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentIndex = 0;
                renderCurrentCard();
            } catch (error) {
                cardStackEl.innerHTML = `<p style="color: #ff4560;">Error: Failed to load cards. Check console for details.</p>`;
            }
        }

        async function renderCurrentCard() {
            if (cards.length === 0 || currentIndex >= cards.length) {
                cardStackEl.innerHTML = '<h2>No more Duos found!</h2>';
                skipBtn.disabled = true;
                requestBtn.disabled = true;
                return;
            }

            const cardData = cards[currentIndex];
            const userDoc = await db.collection('users').doc(cardData.userId).get();
            const userData = userDoc.exists ? userDoc.data() : {};
            
            const username = userData.username || 'Gamer';
            const profileImg = userData.profileImageUrl || 'https://via.placeholder.com/150';
            const description = cardData.description || 'No description provided.';

            const newCardEl = document.createElement('div');
            newCardEl.className = 'gamer-card';
            newCardEl.dataset.targetUserId = cardData.userId;

            newCardEl.innerHTML = `
                <div class="card-header">
                    <img src="${profileImg}" alt="Profile" class="profile-img">
                    <h2 class="username">${username}</h2>
                </div>
                <div class="game-details">
                    <div class="game-info">
                        <h3>${cardData.gameSlug ? cardData.gameSlug.toUpperCase().replace('_', ' ') : 'UNKNOWN GAME'}</h3>
                        <span class="tag role">ROLE: ${cardData.inGameRole || 'Any'}</span>
                        <span class="tag rank">RANK: ${cardData.skillLevel || 'Casual'}</span>
                    </div>
                </div>
                <div class="card-bio">
                    <p>${description}</p>
                    <span class="tag platform">${cardData.platform || 'Unknown Platform'}</span>
                    <span class="tag vibe">#${cardData.vibe || 'Neutral'}</span>
                </div>
            `;
            cardStackEl.innerHTML = '';
            cardStackEl.appendChild(newCardEl);
        }

        // --- 8 & 9. CHAT LOGIC remains unchanged ---
        // ... swipeCard(), requestBtn, fetchChatList(), renderChatListItem(), startChatListener(), messageFormEl ...

        updateAuthUI();
    </script>
</body>
</html>
