<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DuoUp</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <header>
        <h1>DuoUp</h1>
        <button id="loginButton" onclick="login()">Log In with Google</button>
        <div id="currentUserDisplay" style="display:none;">Welcome, <span id="userName"></span>! <button onclick="logout()">Logout</button></div>
    </header>

    <main id="appContent" style="display:none;">
        
        <nav id="tabs">
            <button onclick="showTab('suggestedTab')">Suggested Players</button>
            <button onclick="showTab('friendsTab')">Duos / Requests</button>
            <button onclick="showTab('messagingTab')">Messages</button>
        </nav>

        <section id="suggestedTab" class="tab-content active-tab">
            <h2>Suggested Players</h2>
            <div id="allUsersTab" class="card-container">Loading...</div>
        </section>

        <section id="friendsTab" class="tab-content" style="display:none;">
            <h2>Incoming Requests</h2>
            <div id="pendingRequestsTab" class="card-container">Loading...</div>
            
            <h2>My Active Duos</h2>
            <div id="acceptedDuosTab" class="card-container">Loading...</div>
        </section>

        <section id="messagingTab" class="tab-content" style="display:none;">
            <div class="chat-layout">
                <div id="chatListContainer" class="chat-sidebar">Loading...</div>
                <div id="activeChatWindow" class="chat-main">Select a Duo to start chatting.</div>
            </div>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
            authDomain: "duoup-cfae6.firebaseapp.com",
            projectId: "duoup-cfae6",
            storageBucket: "duoup-cfae6.firebasestorage.app",
            messagingSenderId: "812263060524",
            appId: "1:812263060524:web:ac09c3ae610db1cd110d89",
            measurementId: "G-46B67F90FK"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <script>
        
        // --- Global Caches ---
        let allUsersCache = [];
        let friendRequestCache = {}; 
        let currentUser = null; 
        let currentActiveTab = 'suggestedTab';

        // --- Utility Functions ---
        function getOtherParticipantId(requestData) {
            if (!currentUser || !requestData) return null;
            return requestData.senderId === currentUser.uid ? requestData.receiverId : requestData.senderId;
        }

        function findUserInCache(uid) {
            return allUsersCache.find(u => u.id === uid);
        }

        // --- UI/Tab Control ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active-tab');
            });
            const tabElement = document.getElementById(tabId);
            if(tabElement) {
                tabElement.style.display = 'block';
                tabElement.classList.add('active-tab');
            }
            currentActiveTab = tabId;
            
            // Trigger load function for the tab
            if (tabId === 'suggestedTab') loadAllUsers(false);
            if (tabId === 'friendsTab') loadFriends();
            if (tabId === 'messagingTab') loadChatList();
        }

        // -----------------------------------------------------------------------------
        // I. AUTHENTICATION & INITIALIZATION
        // -----------------------------------------------------------------------------
        
        function login(){ 
            auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()); 
        }

        function logout(){
            auth.signOut();
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('currentUserDisplay').style.display = 'block';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('appContent').style.display = 'block';
                
                await initializeUser(user);
                await loadAllUsers(false); // Start by loading all users and status
            } else {
                currentUser = null;
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('currentUserDisplay').style.display = 'none';
                document.getElementById('appContent').style.display = 'none';
            }
        });

        async function initializeUser(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                await userRef.set({
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
            }
        }

        // -----------------------------------------------------------------------------
        // II. DATA LOADING (The Fixes)
        // -----------------------------------------------------------------------------

        async function loadDuoCache() {
            if(!currentUser) return false;
            try {
                // Query must match the 'allow read' rule on /friendRequests
                const requestsSnap = await db.collection('friendRequests')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                friendRequestCache = {};
                requestsSnap.docs.forEach(doc => {
                    const data = doc.data();
                    const otherUid = getOtherParticipantId(data);
                    if (otherUid) {
                        friendRequestCache[otherUid] = data;
                    }
                });
                return true;
            } catch (e) {
                 console.error("Error loading Duo Cache (Permissions Issue):", e);
                 alert("Error loading Duo status. Check console for details.");
                 return false; 
            }
        }

        async function loadAllUsers(silent = false){
            if(!currentUser) return;
            const container=document.getElementById('allUsersTab');
            if (!silent && container) container.innerHTML="<h3>Loading Suggested Players...</h3>";
            
            try{
                const snapshot=await db.collection('users').get();
                allUsersCache=snapshot.docs.map(d=>({id:d.id,...d.data()}));
            }catch(e){ 
                if (!silent && container) container.innerHTML=`<p style="width:100%; text-align:center; color:red;">Error loading users. Check /users rules.</p>`;
                return;
            }
            
            const cacheLoaded = await loadDuoCache(); 
            if (!cacheLoaded) {
                if (!silent && container) container.innerHTML=`<p style="width:100%; text-align:center; color:red;">Cannot load duo status. See console for details.</p>`; 
                return;
            }

            if (!silent && container) {
                container.innerHTML=""; 
                allUsersCache.forEach(user=>{
                    if(user.id===currentUser.uid) return;
                    const requestStatus = friendRequestCache[user.id]; 
                    const card=renderUserCard(user.id, user, requestStatus); 
                    if(card) container.appendChild(card);
                });
            }
        }


        async function loadFriends() {
            if (!currentUser) return;
            await loadAllUsers(true); 

            const requestContainer = document.getElementById('pendingRequestsTab');
            const duoContainer = document.getElementById('acceptedDuosTab');

            if (requestContainer) requestContainer.innerHTML = '<h3>Loading Requests...</h3>';
            if (duoContainer) duoContainer.innerHTML = '<h3>Loading Duos...</h3>';

            // --- 1. Pending Requests (Sent TO the current user) ---
            const pendingRequests = Object.values(friendRequestCache).filter(req => 
                req.status === 'pending' && req.receiverId === currentUser.uid
            );
            
            if (requestContainer) {
                requestContainer.innerHTML = '';
                if (pendingRequests.length === 0) {
                    requestContainer.innerHTML = '<p>No pending friend requests.</p>';
                } else {
                    pendingRequests.forEach(req => {
                        const senderUser = findUserInCache(req.senderId);
                        if(senderUser) {
                            requestContainer.appendChild(renderRequestCard(req.participants.join('_'), senderUser, req)); 
                        }
                    });
                }
            }

            // --- 2. Accepted Duos ---
            const acceptedDuos = Object.values(friendRequestCache).filter(req => req.status === 'accepted');

            if (duoContainer) {
                duoContainer.innerHTML = '';
                if (acceptedDuos.length === 0) {
                    duoContainer.innerHTML = '<p>No active Duos. Send or accept a request!</p>';
                } else {
                    acceptedDuos.forEach(req => {
                        const otherUid = getOtherParticipantId(req);
                        const otherUser = findUserInCache(otherUid);
                        if (otherUser) {
                            duoContainer.appendChild(renderDuoCard(req.participants.join('_'), otherUser, req));
                        }
                    });
                }
            }
        }

        async function loadChatList() {
            if (!currentUser) return;
            await loadDuoCache(); 

            const chatListContainer = document.getElementById('chatListContainer');
            if (!chatListContainer) return;

            chatListContainer.innerHTML = '<h3>Loading Chats...</h3>';

            try {
                const acceptedDuos = Object.values(friendRequestCache).filter(req => req.status === 'accepted');

                chatListContainer.innerHTML = '';
                if (acceptedDuos.length === 0) {
                    chatListContainer.innerHTML = '<p>No active chats. Start a Duo first.</p>';
                    return;
                }

                acceptedDuos.forEach(request => {
                    const otherUid = getOtherParticipantId(request);
                    const otherUser = findUserInCache(otherUid);
                    if (otherUser) {
                        chatListContainer.appendChild(renderChatListItem(request.participants.join('_'), otherUser));
                    }
                });

            } catch(e) {
                console.error("Error loading chat list:", e);
                chatListContainer.innerHTML = `<p style="color:red;">Failed to load chats. Check /chats rules.</p>`;
            }
        }

        // -----------------------------------------------------------------------------
        // III. DATA WRITING (Actions)
        // -----------------------------------------------------------------------------
        
        async function sendFriendRequest(receiverUid) {
            if (!currentUser) return;

            const participants = [currentUser.uid, receiverUid].sort();
            const requestId = participants.join('_'); 
            const requestRef = db.collection('friendRequests').doc(requestId);

            try {
                await requestRef.set({
                    senderId: currentUser.uid,
                    receiverId: receiverUid,
                    status: 'pending', 
                    sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: participants 
                }, { merge: true });

                alert(`Request sent to ${findUserInCache(receiverUid).displayName}!`);
                await loadAllUsers(true); // Silent reload
            } catch (error) {
                console.error("Error sending request:", error);
                alert("Failed to send request. Check your 'create' rule for /friendRequests.");
            }
        }

        async function acceptRequest(requestId) {
            const requestRef = db.collection('friendRequests').doc(requestId);
            try {
                await requestRef.update({
                    status: 'accepted', // Checked by the 'update' rule
                    handledAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
                // Optional: Automatically create a chat document here if needed
                // await createChatDocument(requestId); 
                
                alert("Request accepted!");
                loadFriends(); 
            } catch (error) {
                console.error("Error accepting request:", error);
                alert("Failed to accept request. Check your 'update' rule for /friendRequests.");
            }
        }
        
        // --- Placeholder Rendering Functions (Implement the HTML generation) ---
        function renderUserCard(uid, userData, requestStatus) {
            const card = document.createElement('div');
            const statusText = requestStatus ? `Status: ${requestStatus.status}` : 'Status: None';
            
            let actionButton = '';
            if (!requestStatus) {
                actionButton = `<button onclick="sendFriendRequest('${uid}')">Send Request</button>`;
            } else if (requestStatus.status === 'pending' && requestStatus.receiverId === currentUser.uid) {
                actionButton = `<button disabled>Pending Acceptance</button>`; // Or show button to accept if user is receiver
            } else if (requestStatus.status === 'pending' && requestStatus.senderId === currentUser.uid) {
                actionButton = `<button disabled>Sent</button>`;
            } else if (requestStatus.status === 'accepted') {
                actionButton = `<button disabled>Duos!</button>`;
            }

            card.className = 'player-card'; // Add CSS class for styling
            card.innerHTML = `
                <h4>${userData.displayName}</h4>
                <p>${statusText}</p>
                ${actionButton}
            `;
            return card;
        }

        function renderRequestCard(requestId, userData, requestData) {
            const card = document.createElement('div');
            card.className = 'request-card';
            card.innerHTML = `
                <h4>Request from: ${userData.displayName}</h4>
                <button onclick="acceptRequest('${requestId}')">Accept</button>
                <button onclick="deleteRequest('${requestId}')">Reject/Delete</button>
            `;
            return card;
        }

        function renderDuoCard(requestId, userData, requestData) {
            const card = document.createElement('div');
            card.className = 'duo-card';
            card.innerHTML = `
                <h4>Duo: ${userData.displayName}</h4>
                <button onclick="startChat('${requestId}')">Message</button>
            `;
            return card;
        }

        function renderChatListItem(requestId, userData) {
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.innerHTML = `Chat with ${userData.displayName}`;
            item.onclick = () => { /* Logic to load messages into activeChatWindow using requestId */ };
            return item;
        }

        function startChat(requestId) {
            // Placeholder: Logic to load chat messages for the given requestId
            document.getElementById('activeChatWindow').innerHTML = `Loading chat for request ID: ${requestId}...`;
        }
        
        // --- Initial setup for the redirect flow ---
        if (auth.isSignInWithRedirectResult) {
            auth.getRedirectResult().then((result) => {
                if (result.user) {
                    // User signed in successfully
                }
            }).catch((error) => {
                console.error("Redirect sign-in error:", error);
                alert("Login failed: " + error.message);
            });
        }
        
    </script>

</body>
</html>
