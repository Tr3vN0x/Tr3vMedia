<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUO UP - Secure Friendship Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        :root {
            --color-primary: #00e0ff; /* Neon Cyan */
            --color-secondary: #ff00e0; /* Neon Pink */
            --color-dark: #1a1a2e; /* Dark Blue/Black background */
            --color-background: #0f0f1a;
            --color-text: #e0e0e0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin-top: 20px;
            padding: 20px;
            background: var(--color-dark);
            box-shadow: 0 0 15px var(--color-primary);
            border-radius: 8px;
        }

        header {
            width: 100%;
            padding: 20px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--color-primary);
            text-shadow: 0 0 5px var(--color-primary), 0 0 10px var(--color-primary);
            font-size: 2.5em;
            margin: 0;
        }

        #auth-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--color-secondary);
        }

        /* --- Tabs Navigation --- */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-primary);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            color: var(--color-primary);
        }

        .tab-button.active {
            color: var(--color-secondary);
            font-weight: bold;
            text-shadow: 0 0 5px var(--color-secondary);
        }
        
        /* --- Content Area --- */
        .tab-content {
            display: none;
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-content.active {
            display: block;
        }
        
        /* --- Card Styling --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding-top: 15px;
        }

        .card {
            background: #2a2a44;
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--color-primary);
            cursor: pointer;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-secondary);
            margin-bottom: 10px;
        }
        
        .card button {
            margin-top: 10px;
            width: 100%;
        }

        /* --- Neon Buttons --- */
        .neon-btn {
            background: none;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--color-primary);
        }

        .neon-btn:hover {
            background: var(--color-primary);
            color: var(--color-dark);
            text-shadow: none;
            box-shadow: 0 0 15px var(--color-primary);
        }
        
        .neon-btn.remove {
            border-color: red;
            color: red;
            box-shadow: 0 0 5px red;
        }
        .neon-btn.remove:hover {
            background: red;
            color: white;
            box-shadow: 0 0 15px red;
        }
        .neon-btn.add {
            border-color: limegreen;
            color: limegreen;
            box-shadow: 0 0 5px limegreen;
        }
        .neon-btn.add:hover {
            background: limegreen;
            color: var(--color-dark);
            box-shadow: 0 0 15px limegreen;
        }

        /* --- Status & Rating --- */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .skill-rating {
            color: gold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<header>
    <h1>DUO UP</h1>
    <div id="auth-status">Loading authentication status...</div>
</header>

<div class="container">
    <div id="logged-in-controls" class="tabs" style="display: none;">
        <button class="tab-button active" onclick="showTab('profile')">Profile</button>
        <button class="tab-button" onclick="showTab('friends')">Friends</button>
        <button class="tab-button" onclick="showTab('requests')">Requests (<span id="request-count">0</span>)</button>
        <button class="tab-button" onclick="showTab('suggested')">Suggested</button>
        <button class="tab-button neon-btn remove" onclick="logout()">Logout</button>
    </div>

    <div id="login-tab" class="tab-content active">
        <h2>Login / Register</h2>
        <form id="auth-form">
            <input type="email" id="email" placeholder="Email" required style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="password" id="password" placeholder="Password" required style="width: 100%; padding: 10px; margin-bottom: 15px;">
            <button type="submit" class="neon-btn" onclick="document.getElementById('auth-form').dataset.mode='login'">Log In</button>
            <button type="submit" class="neon-btn add" onclick="document.getElementById('auth-form').dataset.mode='register'">Register</button>
        </form>
    </div>

    <div id="profile-tab" class="tab-content">
        <h2>My Profile</h2>
        <div id="profile-details">Loading profile...</div>
        <form id="profile-form" style="margin-top: 20px;">
            <input type="text" id="profile-nickname" placeholder="Nickname" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <textarea id="profile-bio" placeholder="Bio" style="width: 100%; padding: 10px; margin-bottom: 10px;"></textarea>
            <button type="submit" class="neon-btn">Save Profile</button>
        </form>
    </div>
    
    <div id="friends-tab" class="tab-content card-grid">
        </div>

    <div id="requests-tab" class="tab-content card-grid">
        </div>

    <div id="suggested-tab" class="tab-content card-grid">
        </div>

</div> <script>
// NOTE: REPLACE THIS CONFIG WITH YOUR OWN FIREBASE PROJECT CONFIG
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

let currentUser = null;
const DEFAULT_AVATAR = "https://via.placeholder.com/150";

// DOM Elements (redefined for clarity in the script block)
const authStatus = document.getElementById('auth-status');
const loggedInControls = document.getElementById('logged-in-controls');
const loginTab = document.getElementById('login-tab');
const profileTab = document.getElementById('profile-tab');
const friendsTab = document.getElementById('friends-tab');
const requestsTab = document.getElementById('requests-tab');
const suggestedTab = document.getElementById('suggested-tab');
const requestCountSpan = document.getElementById('request-count');


// ==========================================================
// UTILITY FUNCTIONS
// ==========================================================

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) targetTab.classList.add('active');

    const targetButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
    if (targetButton) targetButton.classList.add('active');

    // Trigger data loads when switching to the tab
    if (tabName === 'friends') loadFriends();
    if (tabName === 'requests') loadRequests();
    if (tabName === 'suggested') loadSuggested();
}

// Utility for status display
function renderStatus(status) {
    let color = 'gray';
    if (status === 'Online') color = 'limegreen';
    if (status === 'In-Game') color = 'red';
    return `<span class="status-indicator" style="background-color:${color};"></span> ${status || 'Offline'}`;
}

// Utility for skill rating display
function renderSkillRating(rating) {
    if (rating === undefined || rating === null) return '';
    const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
    return `<div class="skill-rating">${stars}</div>`;
}

/**
 * Calculates the consistent, sorted Document ID for a friendship record.
 * This is CRITICAL for security and querying.
 * @param {string} uid1 
 * @param {string} uid2 
 * @returns {string} e.g., "uidA_uidB"
 */
function getFriendshipId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
}


// ==========================================================
// A. AUTHENTICATION & PROFILE
// ==========================================================

document.getElementById('auth-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const mode = e.currentTarget.dataset.mode;

    try {
        if (mode === 'register') {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            // Create initial user profile document
            await db.collection("users").doc(userCredential.user.uid).set({
                nickname: email.split('@')[0],
                bio: 'New DUO UP user!',
                profileImageUrl: DEFAULT_AVATAR,
                status: 'Online',
                skillRating: 3,
                games: ['Fortnite', 'Valorant'],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await auth.signInWithEmailAndPassword(email, password);
        }
    } catch (error) {
        alert(error.message);
        console.error("Auth Error:", error);
    }
});

function logout() {
    auth.signOut().then(() => {
        alert("Logged out successfully.");
    });
}

auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        authStatus.textContent = `Logged in as: ${user.email}`;
        loggedInControls.style.display = 'flex';
        loginTab.classList.remove('active');
        showTab('profile'); // Default view
        loadUserProfile(user.uid);
        loadUnreadCount();
        
    } else {
        currentUser = null;
        authStatus.textContent = 'Logged out';
        loggedInControls.style.display = 'none';
        showTab('login');
    }
});

async function loadUserProfile(userId) {
    const doc = await db.collection("users").doc(userId).get();
    if (doc.exists) {
        const u = doc.data();
        document.getElementById('profile-details').innerHTML = `
            <img class="avatar" src="${u.profileImageUrl || DEFAULT_AVATAR}">
            <h3>${u.nickname}</h3>
            <p>Status: ${renderStatus(u.status)}</p>
            <p>Skill: ${renderSkillRating(u.skillRating)}</p>
            <p>Bio: ${u.bio}</p>
        `;
        document.getElementById('profile-nickname').value = u.nickname || '';
        document.getElementById('profile-bio').value = u.bio || '';
    }
}

document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    
    const nickname = document.getElementById('profile-nickname').value;
    const bio = document.getElementById('profile-bio').value;

    try {
        await db.collection("users").doc(currentUser.uid).update({
            nickname: nickname,
            bio: bio,
            // Example of updating skill rating
            skillRating: parseInt(document.getElementById('profile-details').querySelector('.skill-rating')?.textContent.length || 3),
            status: 'Online' // Always set status to Online when user updates profile
        });
        alert("Profile updated successfully!");
        loadUserProfile(currentUser.uid);
    } catch (error) {
        alert("Profile update failed (check your 'users' security rule): " + error.message);
        console.error("Profile Update Error:", error);
    }
});


// ==========================================================
// B. FRIEND REQUESTS (SEND/ACCEPT/REJECT) - UPDATED!
// ==========================================================

async function sendFriendRequest(receiverId) {
    if (!currentUser || currentUser.uid === receiverId) return;

    // Check for existing request/friendship before sending
    const status = await getFriendshipStatus(receiverId);
    if (status !== 'none') {
        alert(`Request not sent. Status is already: ${status}.`);
        return;
    }

    try {
        await db.collection("friendRequests").add({
            senderId: currentUser.uid,
            receiverId: receiverId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Friend request sent!");
        loadSuggested();
    } catch (error) {
        alert("Request failed (check 'friendRequests' security rule): " + error.message);
        console.error("Send Request Error:", error);
    }
}

/**
 * Accepts a friend request: deletes the request and creates the permanent 'friends' record.
 */
function acceptRequest(requestId, senderId){
  if (!currentUser) return;

  const friendshipId = getFriendshipId(currentUser.uid, senderId); 
  
  db.runTransaction(async (transaction) => {
    const requestRef = db.collection("friendRequests").doc(requestId);
    const friendsRef = db.collection("friends").doc(friendshipId);

    // 1. Delete the pending request document (Rule 2 delete check)
    transaction.delete(requestRef);

    // 2. Create the permanent relationship record (Rule 3 create check)
    transaction.set(friendsRef, {
        users: [currentUser.uid, senderId], // Array for security/querying
        createdAt: firebase.firestore.FieldValue.serverTimestamp() // Used in rule validation
    });

  }).then(() => {
    alert("Request accepted! You are now friends.");
    loadRequests(); 
    loadFriends();
    loadSuggested();
  }).catch(err => {
    alert("Accept Request failed (Check 'friendRequests' and 'friends' rules): " + err.message);
    console.error("Accept Request Error:", err);
  });
}

// Rejection is a simple delete (already defined)
function rejectRequest(requestId){
    if (!currentUser) return;
    db.collection("friendRequests").doc(requestId).delete()
        .then(() => {
            alert("Request rejected.");
            loadRequests();
        })
        .catch(error => {
            console.error("Error rejecting request: ", error);
            alert("Rejection failed: " + error.message);
        });
}

async function loadRequests() {
    requestsTab.innerHTML = "<h3>Incoming Requests</h3><p>Loading requests...</p>";
    if (!currentUser) return;

    try {
        const snapshot = await db.collection("friendRequests")
            .where('receiverId', '==', currentUser.uid)
            .get();

        requestsTab.innerHTML = "<h3>Incoming Requests</h3>";
        if (snapshot.empty) {
            requestsTab.innerHTML += "<p>No new requests.</p>";
            return;
        }

        const senderIds = snapshot.docs.map(doc => doc.data().senderId);
        
        // Fetch sender details
        const senderPromises = senderIds.map(id => db.collection("users").doc(id).get());
        const senderDocs = await Promise.all(senderPromises);

        snapshot.docs.forEach((requestDoc, index) => {
            const senderData = senderDocs[index].data();
            if (!senderData) return;
            
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                <div class="card-content">
                    <img class="avatar" src="${senderData.profileImageUrl || DEFAULT_AVATAR}">
                    <strong>${senderData.nickname}</strong>
                    ${renderStatus(senderData.status)}
                    ${renderSkillRating(senderData.skillRating)}
                </div>
                <button class="neon-btn add" onclick="acceptRequest('${requestDoc.id}', '${senderData.uid}')">Accept</button>
                <button class="neon-btn remove" onclick="rejectRequest('${requestDoc.id}')">Reject</button>
            `;
            requestsTab.appendChild(card);
        });

    } catch (error) {
        console.error("Error loading requests:", error);
        requestsTab.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
    }
}

function loadUnreadCount() {
    if (!currentUser) {
        requestCountSpan.textContent = '0';
        return;
    }
    // Listen for real-time changes to update the count instantly
    db.collection("friendRequests")
        .where('receiverId', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            requestCountSpan.textContent = snapshot.size;
        });
}


// ==========================================================
// C. FRIEND REMOVAL - UPDATED!
// ==========================================================

/**
 * Removes a friend by deleting the permanent 'friends' document.
 */
function removeFriend(friendId){
  if(!confirm("Are you sure you want to remove this friend?")) return;
  if (!currentUser) return;

  // Find the correct friendship ID (sorted)
  const friendshipId = getFriendshipId(currentUser.uid, friendId);
  
  // Single delete operation on the new collection (Rule 3 delete check)
  db.collection("friends").doc(friendshipId).delete().then(() => {
    alert("Friend removed successfully.");
    loadFriends(); 
    loadSuggested();
  }).catch(err => {
    alert("Removal failed (Check 'friends' delete rule): " + err.message);
    console.error("Remove Friend Error:", err);
  });
}


// ==========================================================
// D. DATA LOADERS - UPDATED TO USE 'friends' COLLECTION
// ==========================================================

/**
 * Gets the relationship status between current user and targetUid.
 * Used to filter suggested users.
 */
async function getFriendshipStatus(targetUid) {
    // CRITICAL: Must check the new 'friends' collection
    const friendshipId = getFriendshipId(currentUser.uid, targetUid);

    // 1. Check for existing friendship
    const friendDoc = await db.collection("friends").doc(friendshipId).get();
    if (friendDoc.exists) return 'friend';

    // 2. Check for pending request (sent or received)
    const sentQuery = await db.collection("friendRequests")
        .where('senderId', '==', currentUser.uid)
        .where('receiverId', '==', targetUid)
        .limit(1).get();
    if (!sentQuery.empty) return 'pending_sent';

    const receivedQuery = await db.collection("friendRequests")
        .where('senderId', '==', targetUid)
        .where('receiverId', '==', currentUser.uid)
        .limit(1).get();
    if (!receivedQuery.empty) return 'pending_received';
    
    return 'none';
}

/**
 * Loads the list of current friends by querying the 'friends' collection.
 */
async function loadFriends(){
  friendsTab.innerHTML="<h3>My Friends</h3><p>Loading friends...</p>";
  if (!currentUser) return;
  
  try {
      // Step 1: Query the 'friends' collection where the current user is a participant
      const friendsSnap = await db.collection("friends")
          .where("users", "array-contains", currentUser.uid)
          .get();
          
      friendsTab.innerHTML = "<h3>My Friends</h3><div class='card-grid'>"; 
      
      if(friendsSnap.empty){ 
        friendsTab.innerHTML="<h3>My Friends</h3><p>No friends yet. Time to find a duo!</p>"; 
        return; 
      }
      
      // Step 2: Extract the UIDs of the actual friends
      const friendIds = friendsSnap.docs.map(doc => {
          const usersArray = doc.data().users;
          // Find the UID that is NOT the current user's UID
          return usersArray.find(uid => uid !== currentUser.uid);
      });
      
      // Step 3: Fetch the full profile data for all friends simultaneously (read from 'users')
      const friendPromises = friendIds.map(fid => db.collection("users").doc(fid).get());
      const friendDocs = await Promise.all(friendPromises);
      
      friendsTab.querySelector('.card-grid').innerHTML = ''; // Clear loading text

      friendDocs.forEach(doc => {
        if (!doc.exists) return; 
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        
        const ratingHtml = renderSkillRating(u.skillRating);
        const statusHtml = renderStatus(u.status);

        card.innerHTML = `
            <div class="card-content">
                <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
                <strong>${u.nickname}</strong>
                ${ratingHtml}
                ${statusHtml}
                <p style="font-size:0.8em; margin: 5px 0;">Games: ${u.games?.slice(0, 2).join(', ') || 'N/A'}</p>
            </div>
            <button class="neon-btn" onclick="event.stopPropagation(); viewProfile('${doc.id}')">View Profile</button>
            <button class="neon-btn remove" onclick="event.stopPropagation(); removeFriend('${doc.id}')">Remove</button>
        `;
        friendsTab.querySelector('.card-grid').appendChild(card);
      });
      friendsTab.innerHTML += "</div>"; // Close card-grid
  } catch (error) {
      friendsTab.innerHTML = `<p style="color:red;">Error loading friends: ${error.message}</p>`;
      console.error("Friends Load Error:", error);
  }
}

/**
 * Loads suggested users, skipping current friends and users with pending requests.
 */
async function loadSuggested(){
    suggestedTab.innerHTML="<h3>Suggested Duos</h3><p>Loading suggestions...</p>";
    if (!currentUser) return;

    try {
        // Step 1: Fetch all user documents (excluding current user)
        const allUsersSnapshot = await db.collection("users").limit(20).get();
        let suggestedUsers = [];

        suggestedTab.innerHTML = "<h3>Suggested Duos</h3><div class='card-grid'>";

        // Step 2: Filter users who are already friends or have a pending request
        for (const doc of allUsersSnapshot.docs) {
            const targetUid = doc.id;
            if (targetUid === currentUser.uid) continue;

            const status = await getFriendshipStatus(targetUid);
            
            if (status === 'none') {
                const u = doc.data();
                suggestedUsers.push(u);
                
                const card = document.createElement("div");
                card.className = "card";
                const ratingHtml = renderSkillRating(u.skillRating);
                const statusHtml = renderStatus(u.status);

                card.innerHTML = `
                    <div class="card-content">
                        <img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
                        <strong>${u.nickname}</strong>
                        ${ratingHtml}
                        ${statusHtml}
                        <p style="font-size:0.8em; margin: 5px 0;">Games: ${u.games?.slice(0, 2).join(', ') || 'N/A'}</p>
                    </div>
                    <button class="neon-btn" onclick="event.stopPropagation(); viewProfile('${u.uid}')">View Profile</button>
                    <button class="neon-btn add" onclick="event.stopPropagation(); sendFriendRequest('${u.uid}')">Add Friend</button>
                `;
                suggestedTab.querySelector('.card-grid').appendChild(card);
            }
        }
        
        if (suggestedUsers.length === 0) {
            suggestedTab.querySelector('.card-grid').innerHTML = "<p>No new duos suggested.</p>";
        }
        suggestedTab.innerHTML += "</div>"; // Close card-grid

    } catch (error) {
        suggestedTab.innerHTML = `<p style="color:red;">Error loading suggested users: ${error.message}</p>`;
        console.error("Suggested Load Error:", error);
    }
}

// Simple placeholder for viewing a profile (can be expanded later)
function viewProfile(uid) {
    alert(`Viewing profile for UID: ${uid}. You would load a detailed profile view here.`);
}
</script>

</body>
</html>
