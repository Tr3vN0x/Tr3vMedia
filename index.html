<script>
// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey:"AIzaSyDVHxatohLvJNqIHXjf1ZXdmmWX5W1EpNw",
  authDomain:"duoup-cfae6.firebaseapp.com",
  projectId:"duoup-cfae6",
  storageBucket:"duoup-cfae6.firebasestorage.app",
  messagingSenderId:"812263060524",
  appId:"1:812263060524:web:ac09c3ae610db1cd110d89"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const suggestedTab = document.getElementById("suggestedTab");
const requestsTab = document.getElementById("requestsTab");
const friendsTab = document.getElementById("friendsTab");
const profileTab = document.getElementById("profileTab"); 

// Profile Input Elements
const currentAvatar = document.getElementById("currentAvatar");
const nicknameInput = document.getElementById("nicknameInput");
const bioInput = document.getElementById("bioInput");
const gamesInput = document.getElementById("gamesInput");
const avatarUrlInput = document.getElementById("avatarUrlInput");


let currentUser = null;

// ---------------- LOGIN/AUTH ----------------
function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    loginPage.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }
  loginPage.classList.add("hidden");
  dashboard.classList.remove("hidden");
  currentUser = user;

  const userDoc = await db.collection("users").doc(user.uid).get();
  if(!userDoc.exists){
    // Initial profile creation with new fields
    await db.collection("users").doc(user.uid).set({
      uid: user.uid,
      nickname: user.displayName||"Player",
      bio: "", 
      games: [], 
      friends: [],
      nicknames: {}, // New Field for friend overrides
      profileImageUrl: user.photoURL||DEFAULT_AVATAR
    });
  }

  const data = (await db.collection("users").doc(user.uid).get()).data();
  document.getElementById("welcome").innerText = "Welcome, "+data.nickname;

  // Initial loads
  loadSuggested();
  loadRequests();
  loadFriends();
  loadProfileEditor(data); 
});

function logout(){ 
    auth.signOut(); 
}

function showTab(tab){
  // Reset visibility for all tabs
  suggestedTab.classList.add("hidden");
  requestsTab.classList.add("hidden");
  friendsTab.classList.add("hidden");
  profileTab.classList.add("hidden"); 

  document.getElementById(tab+"Tab").classList.remove("hidden");

  // If showing profile, ensure data is loaded
  if (tab === 'profile') {
      db.collection("users").doc(currentUser.uid).get().then(doc => {
          loadProfileEditor(doc.data());
      });
  }
}

// ---------------- PROFILE EDITOR FUNCTIONS ----------------

function loadProfileEditor(data){
    data = data || {};
    nicknameInput.value = data.nickname || currentUser.displayName || "Player";
    bioInput.value = data.bio || "";
    gamesInput.value = (data.games || []).join(', ');
    avatarUrlInput.value = data.profileImageUrl || currentUser.photoURL || "";
    currentAvatar.src = data.profileImageUrl || currentUser.photoURL || DEFAULT_AVATAR;
}

async function saveProfile(){
    if (!currentUser) return;

    // Basic validation
    const newNickname = nicknameInput.value.trim();
    if (newNickname.length < 2) {
        alert("Nickname must be at least 2 characters long.");
        return;
    }

    const gamesArray = gamesInput.value.split(',').map(game => game.trim()).filter(game => game !== '');

    const profileUpdates = {
        nickname: newNickname,
        bio: bioInput.value.trim(),
        games: gamesArray,
        profileImageUrl: avatarUrlInput.value.trim() || DEFAULT_AVATAR
    };

    try {
        await db.collection("users").doc(currentUser.uid).update(profileUpdates);
        alert("Profile updated successfully!");
        
        // Update welcome message immediately
        document.getElementById("welcome").innerText = "Welcome, "+newNickname;
        
        // Refresh friend/suggested lists as nickname/avatar might change
        loadSuggested();
        loadFriends();

    } catch(error) {
        alert("Error saving profile. Please check your security rules (allow update: if request.auth != null) and try again.");
        console.error("Profile Save Error:", error);
    }
}

// ---------------- NEW NICKNAME OVERRIDE FUNCTION ----------------

async function saveFriendNickname(friendId, currentNickname) {
    const customName = prompt(`Enter a nickname for ${currentNickname}:`, currentNickname);
    
    if (customName === null) {
        // User cancelled the prompt
        return;
    }

    const trimmedName = customName.trim();
    if (trimmedName === '') {
        alert("Nickname cannot be empty.");
        return;
    }

    const myRef = db.collection("users").doc(currentUser.uid);
    const nicknameField = `nicknames.${friendId}`;
    
    try {
        // Use an update operation to set the specific field within the 'nicknames' map
        await myRef.update({
            [nicknameField]: trimmedName
        });
        
        alert(`Nickname for ${currentNickname} saved as "${trimmedName}".`);
        loadFriends(); // Refresh the list to show the new nickname
    } catch (error) {
        alert("Failed to save friend nickname. Check your security rules.");
        console.error("Save Nickname Error:", error);
    }
}


// ---------------- LOAD FUNCTIONS ----------------

async function loadSuggested(){
  suggestedTab.innerHTML="<p>Loading suggested users...</p>";
  
  try {
      const usersSnap = await db.collection("users").get(); 
      // Fetch current user data to get friend and request lists
      const me = (await db.collection("users").doc(currentUser.uid).get()).data();
      suggestedTab.innerHTML = ""; 

      const myFriends = me.friends || [];
      const mySentRequestsSnap = await db.collection("friendRequests").where("senderId", "==", currentUser.uid).get();
      const myReceivedRequestsSnap = await db.collection("friendRequests").where("receiverId", "==", currentUser.uid).get();

      const pendingUsers = new Set();
      mySentRequestsSnap.forEach(doc => pendingUsers.add(doc.data().receiverId));
      myReceivedRequestsSnap.forEach(doc => pendingUsers.add(doc.data().senderId));

      let suggestedCount = 0;
      usersSnap.forEach(doc=>{
        if(doc.id === currentUser.uid) return; 
        if(myFriends.includes(doc.id)) return; 
        if(pendingUsers.has(doc.id)) return; 
        
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        
        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">${u.games.slice(0, 1).join(', ')}...</p>` : '';

        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
          ${gamesPreview}
          <button class="neon-btn" onclick="sendRequest('${doc.id}')">Send Request</button>`;
        suggestedTab.appendChild(card);
        suggestedCount++;
      });

      if (suggestedCount === 0) {
          suggestedTab.innerHTML="<p>No suggested players available right now.</p>";
      }
  } catch(error) {
      suggestedTab.innerHTML = `<p style="color:red;">Error loading suggested users: ${error.message}</p>`;
      console.error("Suggested Load Error:", error);
  }
}

async function loadRequests(){
  requestsTab.innerHTML="<p>Loading requests...</p>";
  
  try {
      const snap = await db.collection("friendRequests").where("receiverId","==",currentUser.uid).get();
      requestsTab.innerHTML = ""; 
      if(snap.empty){ 
        requestsTab.innerHTML="<p>No friend requests</p>"; 
        return; 
      }

      const requestPromises = snap.docs.map(async doc => {
        const r = doc.data();
        const senderDoc = await db.collection("users").doc(r.senderId).get();
        if (!senderDoc.exists) return null; 
        return { 
          requestId: doc.id,
          senderId: r.senderId,
          user: senderDoc.data()
        };
      });
      
      const requestsData = (await Promise.all(requestPromises)).filter(item => item !== null);

      requestsData.forEach(data => {
        const u = data.user;
        const card = document.createElement("div");
        card.className = "card";

        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">${u.games.slice(0, 1).join(', ')}...</p>` : '';

        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${u.nickname}</strong>
          ${gamesPreview}
          <button class="neon-btn" onclick="acceptRequest('${data.requestId}','${data.senderId}')">Accept</button>
          <button class="neon-btn" onclick="rejectRequest('${data.requestId}')">Reject</button>`;
        requestsTab.appendChild(card);
      });
  } catch (error) {
      requestsTab.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
      console.error("Requests Load Error:", error);
  }
}

async function loadFriends(){
  friendsTab.innerHTML="<p>Loading friends...</p>";
  
  try {
      // Fetch current user data (including the new 'nicknames' map)
      const meDoc = await db.collection("users").doc(currentUser.uid).get();
      const me = meDoc.data();
      friendsTab.innerHTML = ""; 
      
      const myFriends = me.friends || [];
      const myNicknames = me.nicknames || {}; // The new map for custom names

      if(myFriends.length===0){ 
        friendsTab.innerHTML="<p>No friends yet. Time to find a duo!</p>"; 
        return; 
      }
      
      const friendPromises = myFriends.map(fid => db.collection("users").doc(fid).get());
      const friendDocs = await Promise.all(friendPromises);

      friendDocs.forEach(doc => {
        if (!doc.exists) return; 
        const u = doc.data();
        const card = document.createElement("div");
        card.className = "card";
        
        // Determine the display nickname: use custom name if set, otherwise use global nickname
        const displayNickname = myNicknames[doc.id] || u.nickname;

        const gamesPreview = (u.games && u.games.length > 0) ? `<p style="font-size:0.8em; margin: 5px 0;">${u.games.slice(0, 1).join(', ')}...</p>` : '';

        card.innerHTML = `<img class="avatar" src="${u.profileImageUrl||DEFAULT_AVATAR}">
          <strong>${displayNickname}</strong>
          ${gamesPreview}
          <button class="neon-btn" onclick="saveFriendNickname('${doc.id}', '${u.nickname}')">Edit Nickname</button>
          <button class="neon-btn remove" onclick="removeFriend('${doc.id}')">Remove</button>`;
        friendsTab.appendChild(card);
      });
  } catch (error) {
      friendsTab.innerHTML = `<p style="color:red;">Error loading friends: ${error.message}</p>`;
      console.error("Friends Load Error:", error);
  }
}

// ---------------- FRIEND ACTIONS ---------------- (Unchanged)
async function sendRequest(receiverId){
  try {
      const existingRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", currentUser.uid)
        .where("receiverId", "==", receiverId)
        .get();

      const reverseRequestSnap = await db.collection("friendRequests")
        .where("senderId", "==", receiverId)
        .where("receiverId", "==", currentUser.uid)
        .get();

      if (!existingRequestSnap.empty || !reverseRequestSnap.empty) {
        alert("A friend request is already pending with this user!");
        return; 
      }

      await db.collection("friendRequests").add({
        senderId: currentUser.uid,
        receiverId: receiverId
      });
      
      alert("Request sent!"); 
      loadSuggested(); 
  } catch(err) {
      alert("Error sending request: " + err.message);
      console.error("Send Request Error:", err);
  }
}

function acceptRequest(requestId,senderId){
  const meRef = db.collection("users").doc(currentUser.uid);
  const senderRef = db.collection("users").doc(senderId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayUnion(senderId)});
    transaction.update(senderRef, {friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
    transaction.delete(db.collection("friendRequests").doc(requestId));
  }).then(() => {
    alert("Request accepted! You are now friends.");
    loadRequests();
    loadFriends();
    loadSuggested(); 
  }).catch(err => {
    alert("Transaction failed (Accept Request): " + err.message);
    console.error("Accept Request Error:", err);
  });
}

function rejectRequest(requestId){
  db.collection("friendRequests").doc(requestId).delete().then(() => {
    alert("Request rejected.");
    loadRequests();
  }).catch(err => {
    alert("Error rejecting request: " + err.message);
    console.error("Reject Request Error:", err);
  });
}

function removeFriend(friendId){
  if(!confirm("Are you sure you want to remove this friend?")) return;

  const meRef = db.collection("users").doc(currentUser.uid);
  const friendRef = db.collection("users").doc(friendId);
  
  db.runTransaction(async (transaction) => {
    transaction.update(meRef, {friends: firebase.firestore.FieldValue.arrayRemove(friendId)});
    transaction.update(friendRef, {friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)});
    
    // Optional: Remove custom nickname when removing the friend
    // Note: This requires the Security Rule to allow the update on the user's document
    // transaction.update(meRef, { [`nicknames.${friendId}`]: firebase.firestore.FieldValue.delete() });
    
  }).then(() => {
    alert("Friend removed successfully.");
    loadFriends(); 
    loadSuggested(); 
  }).catch(err => {
    alert("Removal failed (Remove Friend): " + err.message);
    console.error("Remove Friend Error:", err);
  });
}

// ---------------- CHAT FUNCTIONS (ALL REMOVED) ----------------

</script>
